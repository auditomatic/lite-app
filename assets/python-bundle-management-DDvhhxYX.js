const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/data-vendor-CllpzWXw.js","assets/ui-vendor-DgwC-sRC.js","assets/vue-vendor-BZxY9vkr.js","assets/utils-vendor-X1Ah6TN4.js","assets/index-C2iZHtnC.js","assets/index-DLndv8Bi.css"])))=>i.map(i=>d[i]);
var T=Object.defineProperty;var P=(o,e,n)=>e in o?T(o,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[e]=n;var _=(o,e,n)=>P(o,typeof e!="symbol"?e+"":e,n);import{a as p,_ as g}from"./index-C2iZHtnC.js";import{TrialBundleExportService as S}from"./trial-bundle.service-kqpPtmVH.js";import{k as w}from"./ui-vendor-DgwC-sRC.js";import{f as h,c as b}from"./vue-vendor-BZxY9vkr.js";import"./utils-vendor-X1Ah6TN4.js";import"./data-vendor-CllpzWXw.js";let v=null;async function k(){return v||(v=(await g(async()=>{const{default:o}=await import("./data-vendor-CllpzWXw.js").then(e=>e.j);return{default:o}},__vite__mapDeps([0,1,2,3]))).default),v}class B{constructor(){_(this,"trialBundleService",new S);_(this,"RUNTIME_VERSION","1.0.0");_(this,"REQUIRED_PACKAGES",["requests>=2.28.0","pandas>=2.0.0","openpyxl>=3.0.0","jsonpath-ng>=1.5.0","pydantic>=2.0.0","click>=8.0.0","rich>=13.0.0","python-dotenv>=1.0.0"])}async exportTrialBundle(e,n={}){try{p.info("PYTHON_BUNDLE: Starting export",{trialId:e,options:n});const t=await this.trialBundleService.exportTrialBundle(e,{includeResults:!1,skipDownload:!0});if(!t.ok)return{ok:!1,error:t.error};const r=t.value.bundle.configuration.trial,{db:u}=await g(async()=>{const{db:f}=await import("./index-C2iZHtnC.js").then(y=>y.s);return{db:f}},__vite__mapDeps([4,2,1,3,0,5])),a=await u.apiCalls.where("trialId").equals(e).toArray(),d=await this.buildTrialConfig(r,a),s=await this.getPythonRuntime(n.runtimeVersion||this.RUNTIME_VERSION),l=await k(),i=new l,c=i.folder("auditomatic_trial");for(const[f,y]of Object.entries(s.package))c.file(f,y);const E=i.folder("data");if(E.file("trial_config.json",JSON.stringify(d,null,2)),n.includeApiKeys){const f=this.getApiKeysTemplate(r);E.file("api_keys.json",JSON.stringify(f,null,2))}i.folder("output"),i.file("requirements.txt",s.requirements),i.file("run.py",s.runScript),i.file("README.md",s.readme);const m=await i.generateAsync({type:"blob"}),I=new Date().toISOString().split("T")[0],R=`${r.name.replace(/[^a-zA-Z0-9-_]/g,"_")}_export_${I}.zip`,A={zipBlob:m,filename:R,sizeBytes:m.size,manifest:{runtimeVersion:this.RUNTIME_VERSION,trialId:r.id,trialName:r.name,apiCallCount:a.length,requiredPackages:this.REQUIRED_PACKAGES}};return p.info("PYTHON_BUNDLE: Export complete",{trialId:e,filename:R,sizeKB:Math.round(m.size/1024),apiCallCount:a.length}),{ok:!0,value:A}}catch(t){return p.error("PYTHON_BUNDLE: Export failed",t),{ok:!1,error:t instanceof Error?t:new Error("Export failed")}}}async buildTrialConfig(e,n){const t=await this.trialBundleService.exportTrialBundle(e.id,{includeResults:!1,skipDownload:!0});if(!t.ok)throw t.error;return{version:"1.0",metadata:{trial_id:e.id,trial_name:e.name,export_date:new Date().toISOString(),runtime_version:this.RUNTIME_VERSION},trial:t.value.bundle.configuration.trial,api_calls:n.map(r=>({id:r.id,order:r.order,trialId:r.trialId,configurationIndex:r.configurationIndex,prompt:r.prompt,variables:r.variables||{},variableIndices:r.variableIndices||{},status:"pending",created:r.created})),api_keys:{}}}async getPythonRuntime(e){return this.loadActualRuntimeFiles(e)}getApiKeysTemplate(e){var r,u;const n={},t=new Set;for(const a of e.configurations)((u=(r=a.providerSnapshot)==null?void 0:r.auth)==null?void 0:u.type)!=="none"&&t.add(a.provider);for(const a of t)n[a]="YOUR_API_KEY_HERE";return n}async loadActualRuntimeFiles(e){if(e!=="1.0.0")throw new Error(`Unsupported runtime version: ${e}`);const{getRuntimeFiles:n}=await g(async()=>{const{getRuntimeFiles:t}=await import("./python-runtime-v1.0.0-Csl3nLQv.js");return{getRuntimeFiles:t}},[]);return n()}}function F(){const o=new B,e=h(!1),n=h(0),t=h(null),r=b(()=>{var s,l;return e.value?"exporting":(s=t.value)!=null&&s.ok?"success":(l=t.value)!=null&&l.error?"error":"idle"});async function u(s,l={}){try{e.value=!0,n.value=0,l.showProgress!==!1&&w.loading({content:"Preparing Python bundle export...",key:"python-export",duration:0}),n.value=30;const i=await o.exportTrialBundle(s,{includeApiKeys:l.includeApiKeys});if(!i.ok)throw i.error;return n.value=70,l.showProgress!==!1&&w.loading({content:"Downloading bundle...",key:"python-export",duration:0}),typeof window<"u"&&(window.__TAURI__||window.__TAURI_INTERNALS__)?await N(i.value.zipBlob,i.value.filename):await x(i.value.zipBlob,i.value.filename),n.value=100,t.value=i,l.showProgress!==!1&&w.success({content:`Python bundle exported successfully! (${Math.round(i.value.sizeBytes/1024)}KB)`,key:"python-export",duration:3}),{ok:!0,value:void 0}}catch(i){p.error("Python bundle export failed:",i);const c=i instanceof Error?i.message:"Export failed";return t.value={ok:!1,error:c},l.showProgress!==!1&&w.error({content:`Export failed: ${c}`,key:"python-export",duration:5}),{ok:!1,error:i instanceof Error?i:new Error(c)}}finally{e.value=!1}}async function a(s){return{estimatedSize:"50-100KB",requiresApiKeys:!0,runtimeVersion:"1.0.0"}}function d(){e.value=!1,n.value=0,t.value=null}return{isExporting:e,exportProgress:n,exportStatus:r,lastExportResult:t,exportPythonBundle:u,getExportInfo:a,resetExportState:d}}async function x(o,e){const n=window.URL.createObjectURL(o),t=document.createElement("a");t.href=n,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(n)}async function N(o,e){var n,t;try{const r=window.__TAURI__||window.__TAURI_INTERNALS__;if(!((n=r==null?void 0:r.dialog)!=null&&n.save)||!((t=r==null?void 0:r.fs)!=null&&t.writeFile))throw new Error("Tauri dialog or fs API not available");const{save:u}=r.dialog,{writeFile:a}=r.fs,d=await u({defaultPath:e,filters:[{name:"ZIP Archive",extensions:["zip"]}]});if(d){const s=await o.arrayBuffer(),l=new Uint8Array(s);await a(d,l)}}catch(r){p.warn("Tauri save failed, falling back to browser download:",r),await x(o,e)}}export{F as usePythonBundleManagement};
