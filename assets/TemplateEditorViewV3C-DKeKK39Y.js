import{j as X,a as ue}from"./index-DNH2rO2k.js";import{d as Y,f as E,c as O,w as G,R as u,Y as r,S as a,a0 as ae,n as J,q as me,a2 as fe,y as Ke,_ as S,k as g,V as _,F as N,W as z,a3 as te,Z as h,G as C,$ as q,a4 as de,B as je,b as qe,u as H,a1 as He,o as Ge,X as Je}from"./vue-vendor-DPw1dQYc.js";import{u as Xe}from"./useV4Templates-D7Hv-U9q.js";import{u as Ye}from"./useV4TemplateCommands-CmYqVvbU.js";import{u as le}from"./useV4VariableLists-BGYLqZm3.js";import{n as Q,am as Ze,r as Qe,an as ge,x as be,O as _e,J as ye,ab as et,ac as tt,ad as at,ae as lt,G as st,a4 as it,a5 as nt,a6 as ot,a7 as rt,af as ut,N as ve}from"./ui-vendor-IRGmExUJ.js";import{P as dt}from"./ParserSelector-W-0A4f45.js";import"./utils-vendor-B76-F3_P.js";import"./useV4LiveQuery-Do0jdBW3.js";import"./useV4CrossTab-B4Q30vfJ.js";import"./parser.store-DNpIlETj.js";const vt={class:"template-editor"},ct=["placeholder","rows","data-testid","aria-label"],pt=Y({__name:"TemplateEditorV3C",props:{modelValue:{},label:{},placeholder:{default:"Enter your prompt template..."},required:{type:Boolean},rows:{default:4},variables:{default:()=>[]},variableColors:{default:()=>({})}},emits:["update:modelValue"],setup(K,{expose:D,emit:c}){const B=K,R=c,b=E(),$=E(),M=E(!1),x=O({get:()=>B.modelValue,set:f=>R("update:modelValue",f)}),T=O(()=>{let f=t(x.value);return f=f.replace(/\{\{(\w+)\}\}/g,(m,s)=>{const n=/^\w+$/.test(s),v=B.variableColors[s];return n&&v?`<span class="variable-highlight" style="background-color: ${v.bg}; box-shadow: 0 0 0 1px ${v.bg};">${t(m)}</span>`:n?`<span class="variable-highlight">${t(m)}</span>`:`<span class="variable-error">${t(m)}</span>`}),f=f.replace(/\n/g,"<br>"),f=f.replace(/  /g," &nbsp;"),f.endsWith("<br>")||(f+="<br>"),f});function t(f){const m=document.createElement("div");return m.textContent=f,m.innerHTML}function w(){!b.value||!$.value||($.value.scrollTop=b.value.scrollTop,$.value.scrollLeft=b.value.scrollLeft)}return G(x,async()=>{await Ke(),w()}),D({focus:()=>b.value?.focus()}),(f,m)=>{const s=me("dompurify-html");return r(),u("div",vt,[a("div",{class:ae(["editor-container",{focused:M.value}])},[J(a("div",{ref_key:"highlightRef",ref:$,class:"editor-highlight","aria-hidden":"true"},null,512),[[s,T.value,"template"]]),J(a("textarea",{ref_key:"textareaRef",ref:b,"onUpdate:modelValue":m[0]||(m[0]=n=>x.value=n),class:"editor-textarea",placeholder:f.placeholder,rows:f.rows,"data-testid":f.$attrs["data-testid"]||"textarea-template-editor","aria-label":f.$attrs["aria-label"]||"Template editor textarea",onFocus:m[1]||(m[1]=n=>M.value=!0),onBlur:m[2]||(m[2]=n=>M.value=!1),onScroll:w},null,40,ct),[[fe,x.value]])],2)])}}}),mt=X(pt,[["__scopeId","data-v-da627e6e"]]),ft={class:"variable-chip-input"},gt={key:0,class:"attributed-list-display"},bt={class:"list-header"},_t={class:"source-name"},yt={key:0,class:"attribute-breakdown"},ht={key:0,class:"separator"},kt={class:"total-conditions"},wt={class:"attributed-chips-container"},$t={class:"item-name"},Ct={key:0,class:"attributes-wrapper"},Vt={key:1,class:"direct-values"},Lt={key:0,class:"simple-list-display"},Tt={class:"list-header"},It={class:"source-name"},St={class:"tag-input-wrapper"},Rt={class:"custom-tag-input"},Et={class:"tag-container tag-container-readonly"},xt=["title"],Wt={key:0,class:"readonly-hint"},Pt={key:0,class:"helper-text"},Mt={key:1,class:"tag-input-wrapper"},Bt={class:"custom-tag-input"},Ft={class:"tag-container"},Ut={class:"floating-actions"},At=["title"],Nt=["onClick","data-testid","aria-label"],Dt=["placeholder","aria-label","onKeydown"],Ot={key:0,class:"helper-text"},zt=Y({__name:"VariableChipInputV3C",props:{values:{},listRef:{},listName:{},source:{},placeholder:{},attributedSamples:{},attributeBreakdown:{},attributeKeys:{},previewValues:{},totalCount:{}},emits:["update:values","clear-source","clear-list","select-list"],setup(K,{emit:D}){const c=K,B=D,R=E(""),b=E();function $(){return[{bg:"#d1fae5",text:"#166534"},{bg:"#e9d5ff",text:"#7c2d12"},{bg:"#fed7aa",text:"#c2410c"},{bg:"#fce7f3",text:"#be185d"},{bg:"#fef3c7",text:"#92400e"}]}function M(s){return c.attributeKeys?Object.entries(s).map(([n,v])=>{const i=c.attributeKeys.indexOf(n)%5;return{value:v,colorIndex:i}}):[]}function x(s){B("update:values",s),c.source&&B("clear-source")}function T(){const s=R.value.trim();s&&(c.values.includes(s)||x([...c.values,s]),R.value="")}function t(s){s.preventDefault();const v=(s.clipboardData?.getData("text")||"").split(/\r?\n/).map(i=>i.trim()).filter(i=>i.length>0);if(v.length>0){const i=new Set(c.values),p=v.filter(I=>!i.has(I));p.length>0&&x([...c.values,...p]),R.value=""}}function w(s){const n=[...c.values];n.splice(s,1),x(n)}function f(){if(R.value===""&&c.values.length>0){const s=[...c.values];s.pop(),x(s)}}function m(){x([]),c.source&&B("clear-source")}return(s,n)=>{const v=Q;return r(),u("div",ft,[s.listRef&&s.attributedSamples?(r(),u("div",gt,[a("div",bt,[n[6]||(n[6]=a("span",{class:"source-label"},"From list:",-1)),a("span",_t,_(s.listName||"Unknown List"),1),s.attributeBreakdown&&s.attributeBreakdown.parts.length>0?(r(),u("div",yt,[(r(!0),u(N,null,z(s.attributeBreakdown.parts,(i,p)=>(r(),u(N,{key:`part-${i.text}-${p}`},[a("span",{class:"attribute-part",style:te({backgroundColor:$()[i.colorIndex].bg,color:$()[i.colorIndex].text})},_(i.text),5),p<s.attributeBreakdown.parts.length-1?(r(),u("span",ht," × ")):S("",!0)],64))),128)),n[4]||(n[4]=a("span",{class:"arrow"}," → ",-1)),a("span",kt,_(s.attributeBreakdown.totalItems)+" conditions",1)])):S("",!0),g(v,{size:"small",danger:"",onClick:n[0]||(n[0]=i=>s.$emit("clear-list")),"data-testid":"btn-remove-list","aria-label":"Remove linked variable list"},{default:h(()=>n[5]||(n[5]=[C(" Remove List ")])),_:1,__:[5]})]),a("div",wt,[n[9]||(n[9]=a("span",{class:"sample-hint"},"Sample values:",-1)),(r(!0),u(N,null,z(s.attributedSamples,i=>(r(),u("div",{key:i.value,class:"attributed-item-chip"},[a("span",$t,_(i.value),1),i.attributes?(r(),u("span",Ct,[n[7]||(n[7]=C(" (")),(r(!0),u(N,null,z(M(i.attributes),(p,I)=>(r(),u("span",{key:`attr-${p.value}-${I}`,class:"attribute-value",style:te({backgroundColor:$()[p.colorIndex].bg,color:$()[p.colorIndex].text})},_(p.value),5))),128)),n[8]||(n[8]=C(") "))])):S("",!0)]))),128))])])):(r(),u("div",Vt,[s.source?(r(),u("div",Lt,[a("div",Tt,[n[12]||(n[12]=a("span",{class:"source-label"},"From list:",-1)),a("span",It,_(s.source.listName),1),n[13]||(n[13]=a("span",{class:"edit-hint"},"(Unlink list to edit)",-1)),g(v,{size:"small",type:"primary",onClick:n[1]||(n[1]=i=>s.$emit("clear-source")),"data-testid":"btn-unlink-list","aria-label":"Unlink list and edit values directly"},{default:h(()=>n[10]||(n[10]=[C(" Unlink List and Edit Directly ")])),_:1,__:[10]}),g(v,{size:"small",danger:"",onClick:m,"data-testid":"btn-clear-values","aria-label":"Remove all values from list"},{default:h(()=>n[11]||(n[11]=[C(" Remove List ")])),_:1,__:[11]})]),a("div",St,[a("div",Rt,[a("div",Et,[(r(!0),u(N,null,z(s.values,(i,p)=>(r(),u("div",{key:`${i}-${p}`,class:"tag tag-readonly"},[a("span",{class:"tag-text",title:i.length>100?i:""},_(i.length>100?i.substring(0,100)+"...":i),9,xt)]))),128)),s.values.length===0?(r(),u("span",Wt," Values from linked list will appear here ")):S("",!0)]),s.values.length>0?(r(),u("div",Pt,_(s.values.length)+" values ",1)):S("",!0)])])])):S("",!0),s.source?S("",!0):(r(),u("div",Mt,[a("div",Bt,[a("div",Ft,[a("div",Ut,[s.values.length>0?(r(),q(v,{key:0,size:"small",danger:"",onClick:m,"data-testid":"btn-clear-all","aria-label":"Clear all values"},{default:h(()=>n[14]||(n[14]=[C(" Clear ")])),_:1,__:[14]})):S("",!0),g(v,{size:"small",onClick:n[2]||(n[2]=i=>s.$emit("select-list")),"data-testid":"btn-select-list","aria-label":"Replace values with a variable list"},{default:h(()=>n[15]||(n[15]=[C(" Replace with List ")])),_:1,__:[15]})]),(r(!0),u(N,null,z(s.values,(i,p)=>(r(),u("div",{key:`${i}-${p}`,class:"tag"},[a("span",{class:"tag-text",title:i.length>100?i:""},_(i.length>100?i.substring(0,100)+"...":i),9,At),a("button",{type:"button",class:"tag-remove",onClick:I=>w(p),"data-testid":`btn-remove-tag-${p}`,"aria-label":`Remove value ${i}`}," × ",8,Nt)]))),128)),J(a("input",{ref_key:"inputField",ref:b,"onUpdate:modelValue":n[3]||(n[3]=i=>R.value=i),placeholder:s.placeholder,class:"tag-input-field","data-testid":"input-variable-value","aria-label":s.placeholder||"Enter variable value",onKeydown:[de(je(T,["prevent"]),["enter"]),de(f,["backspace"])],onPaste:t},null,40,Dt),[[fe,R.value]])]),s.values.length>0?(r(),u("div",Ot,_(s.values.length)+" values ",1)):S("",!0)])]))]))])}}}),ce=X(zt,[["__scopeId","data-v-33f1ece4"]]),Kt={class:"variable-preview-cycler"},jt={class:"preview-controls"},qt={key:0,class:"cycle-info","data-testid":"cycle-info",role:"status","aria-live":"polite"},Ht=["aria-label"],Gt={key:0,class:"preview-content"},Jt={key:0,class:"no-variables"},Xt={key:1,class:"single-preview","data-testid":"single-preview"},Yt={class:"preview-template","data-testid":"preview-template",role:"region","aria-label":"Preview of filled-in prompt"},Zt={key:2,class:"cycling-preview","data-testid":"cycling-preview"},Qt={class:"preview-template","data-testid":"preview-template-cycling",role:"region","aria-label":"Preview of filled-in prompt with cycling variables"},ea={class:"variable-legend"},ta=["data-testid"],aa={class:"variable-value"},la=Y({__name:"VariablePreviewCyclerV3C",props:{template:{},variableBindings:{},variables:{},variableListRefs:{}},emits:["toggle-preview"],setup(K,{emit:D}){const c=K,B=D,{variableLists:R}=le(),b=E(!1),$=E(0);let M=null;const x=["variable-highlight-blue","variable-highlight-green","variable-highlight-purple","variable-highlight-orange","variable-highlight-pink","variable-highlight-teal"],T=O(()=>{let i=[];if(c.variableBindings?i=Object.keys(c.variableBindings):c.variables&&(i=Object.keys(c.variables)),c.variableListRefs){const p=Object.keys(c.variableListRefs);i=[...new Set([...i,...p])]}return i}),t=O(()=>{if(T.value.length===0)return[];const i=[],p=R.value;for(const V of T.value){let k=[];if(c.variableBindings){const P=c.variableBindings[V];if(P.type==="value"&&P.values)k=[...P.values];else if(P.type==="list"&&P.listId){const L=p.find(U=>U.id===P.listId);L&&(L.category==="simple"&&L.values?k=[...L.values]:L.category==="attributed"&&L.items&&(k=L.items.map(U=>U.value)))}}else if(c.variables&&c.variables[V]&&c.variables[V].length>0)k=[...c.variables[V]];else if(c.variableListRefs&&c.variableListRefs[V]){const P=c.variableListRefs[V],L=p.find(U=>U.id===P);L&&(L.category==="simple"&&L.values?k=[...L.values]:L.category==="attributed"&&L.items&&(k=L.items.map(U=>U.value)))}k.length>0&&i.push({name:V,values:k})}if(i.length===0)return[];function I(V){return V.reduce((k,P)=>k.flatMap(L=>P.map(U=>[...L,U])),[[]])}const F=i.map(V=>V.values);return I(F).map(V=>{const k={};return i.forEach((P,L)=>{k[P.name]=V[L]}),k})});function w(){b.value=!b.value,B("toggle-preview",b.value),b.value&&t.value.length>1?f():m()}function f(){m(),M=setInterval(()=>{$.value=($.value+1)%t.value.length},1e3)}function m(){M&&(clearInterval(M),M=null)}function s(i){return x[i%x.length]}function n(i){let p=v(c.template);return T.value.forEach((I,F)=>{if(i[I]!==void 0){const W=v(I),V=new RegExp(`\\{\\{\\s*${W}\\s*\\}\\}`,"g"),P=`<span class="${s(F)}">${v(String(i[I]))}</span>`;p=p.replace(V,P)}}),p}function v(i){const p=document.createElement("div");return p.textContent=i,p.innerHTML}return G(()=>c.template,()=>{$.value=0}),G(t,i=>{i.length===0?m():b.value&&i.length>1&&f(),$.value>=i.length&&($.value=0)}),qe(()=>{m()}),(i,p)=>{const I=Q,F=me("dompurify-html");return r(),u("div",Kt,[a("div",jt,[g(I,{type:b.value?"default":"primary",ghost:!b.value,onClick:w,class:"toggle-button","data-testid":"btn-toggle-preview-mode","aria-label":b.value?"Return to editor mode":"Preview filled-in prompts","aria-pressed":b.value},{default:h(()=>[b.value?(r(),q(H(Qe),{key:1})):(r(),q(H(Ze),{key:0})),C(" "+_(b.value?"Return to Editor Mode":"Preview Filled-In Prompts"),1)]),_:1},8,["type","ghost","aria-label","aria-pressed"]),b.value&&t.value.length>1?(r(),u("div",qt,[a("span",{class:"cycle-counter","data-testid":"cycle-counter","aria-label":`Showing combination ${$.value+1} of ${t.value.length}`},_($.value+1)+" / "+_(t.value.length),9,Ht),p[0]||(p[0]=a("span",{class:"cycle-hint"},"Auto-cycling every second",-1))])):S("",!0)]),b.value?(r(),u("div",Gt,[t.value.length===0?(r(),u("div",Jt,[g(H(ge)),p[1]||(p[1]=a("span",null,"No variables detected in template",-1))])):t.value.length===1?(r(),u("div",Xt,[J(a("div",Yt,null,512),[[F,n(t.value[0]),"template"]])])):(r(),u("div",Zt,[J(a("div",Qt,null,512),[[F,n(t.value[$.value]),"template"]]),a("div",ea,[(r(!0),u(N,null,z(T.value,(W,V)=>(r(),u("div",{key:W,class:"legend-item","data-testid":`legend-item-${W}`},[a("span",{class:ae(s(V))},_(W),3),a("span",aa,_(t.value[$.value][W]),1)],8,ta))),128))])]))])):S("",!0)])}}}),sa=X(la,[["__scopeId","data-v-3ff835e5"]]),ia={class:"list-selector"},na={key:0,class:"loading-container"},oa={key:0,class:"list-grid"},ra=["onClick"],ua={class:"list-header"},da={class:"item-count"},va={key:0,class:"list-description"},ca={class:"list-preview"},pa={key:0,class:"preview-more"},ma={key:1,class:"attributed-badge"},fa={key:1,class:"empty-state"},ga=Y({__name:"ListSelectorV3C",props:{modelValue:{type:Boolean},listType:{}},emits:["update:modelValue","select"],setup(K,{emit:D}){const c=K,B=D,{variableLists:R,loading:b,error:$}=le(),M=O(()=>{if(!R.value)return[];let t=[];return c.listType==="all"?t=R.value.filter(w=>w.category!=="tabular"):c.listType==="simple"?t=R.value.filter(w=>w.category==="simple"):c.listType==="refusal"&&(t=R.value.filter(w=>w.category==="refusal")),t}),x=t=>t.category==="attributed"&&t.items?t.items.slice(0,5).map(w=>w.value):t.values?.slice(0,5)??[],T=t=>{B("select",t),B("update:modelValue",!1)};return(t,w)=>{const f=_e,m=ye,s=Q,n=be;return r(),q(n,{open:t.modelValue,title:"Select List",width:"80vw",style:{maxWidth:"800px"},"onUpdate:open":w[1]||(w[1]=v=>t.$emit("update:modelValue",v)),onCancel:w[2]||(w[2]=v=>t.$emit("update:modelValue",!1))},{footer:h(()=>[g(s,{onClick:w[0]||(w[0]=v=>t.$emit("update:modelValue",!1))},{default:h(()=>w[3]||(w[3]=[C(" Cancel ")])),_:1,__:[3]})]),default:h(()=>[a("div",ia,[H(b)?(r(),u("div",na,[g(f,{size:"large",tip:"Loading lists..."})])):H($)?(r(),q(m,{key:1,type:"error",message:H($).message||"Failed to load lists",class:"error-alert"},null,8,["message"])):(r(),u(N,{key:2},[M.value.length>0?(r(),u("div",oa,[(r(!0),u(N,null,z(M.value,v=>(r(),u("div",{key:v.id,class:"list-option",onClick:i=>T(v)},[a("div",ua,[a("h4",null,_(v.name),1),a("span",da,_(v.itemCount)+" items",1)]),v.description?(r(),u("p",va,_(v.description),1)):S("",!0),a("div",ca,[(r(!0),u(N,null,z(x(v),(i,p)=>(r(),u("span",{key:`${v.id}-preview-${p}-${i}`,class:"preview-value"},_(i),1))),128)),v.itemCount>5?(r(),u("span",pa," +"+_(v.itemCount-5)+" more ",1)):S("",!0)]),v.category==="attributed"?(r(),u("div",ma," Attributed List ")):S("",!0)],8,ra))),128))])):(r(),u("div",fa," No "+_(t.listType)+" lists available ",1))],64))])]),_:1},8,["open"])}}}),pe=X(ga,[["__scopeId","data-v-e370cd75"]]),ba={class:"template-editor-page"},_a={class:"header-content"},ya={class:"page-title"},ha={class:"design-form-container"},ka={key:0,class:"loading-container"},wa={class:"name-desc-row"},$a={key:0,class:"variable-hint"},Ca={key:0,class:"variables-container"},Va={class:"variable-label"},La={class:"variable-content"},Ta={class:"parser-row"},Ia={style:{flex:"1"}},Sa={class:"refusal-row"},Ra={class:"refusal-content"},Ea={class:"refusal-input-wrapper"},xa={class:"refusal-helper-overlay"},Wa={class:"refusal-mode-inline"},Pa={key:0,class:"values-count"},Ma={class:"footer-content"},Ba={class:"stats"},Fa={class:"actions"},Ua={class:"pricing-content"},Aa={key:0,class:"token-stats"},Na={class:"stats-grid"},Da={class:"pricing-placeholder"},Oa=Y({__name:"TemplateEditorViewV3C",setup(K){const D=He(),c=Je(),{templates:B,loading:R}=Xe(),{variableLists:b}=le(),{createTemplate:$,updateTemplate:M,isExecuting:x}=Ye(),T=O(()=>D.params.id),t=E({name:"",description:"",template:"",parserId:null,refusalWords:[],refusalWordsListRef:"",refusalWordsSource:null,refusalMode:"parse_anyway"}),w=O(()=>R.value||x.value),f=E([]),m=E({}),s=E({}),n=E({}),v=E(!1),i=E(!1),p=E("all"),I=E(""),F=E(!1),W=E(null),V=[{bg:"#E8D5F2",text:"#6B21A8"},{bg:"#D5F2E8",text:"#047857"},{bg:"#FFE4D6",text:"#C2410C"},{bg:"#D6E4FF",text:"#1E40AF"},{bg:"#F3E8D5",text:"#92400E"}],k=O(()=>{if(!t.value.template)return[];const l=/\{\{([^}]+)\}\}/g,e=new Set;let o;for(;(o=l.exec(t.value.template))!==null;){const y=o[1].trim();/^\w+$/.test(y)&&e.add(y)}return Array.from(e)}),P=O(()=>{const l={};return k.value.forEach((e,o)=>{l[e]=V[o%V.length]}),l}),L=O(()=>{let l=1;for(const e of k.value){const o=m.value[e]||[],y=s.value[e];if(y){const A=b.value.find(j=>j.id===y);A&&(l*=A.itemCount||1)}else o.length>0&&(l*=o.length)}return{total:l,formatted:l.toLocaleString()}});function U(l){const e=k.value.indexOf(l);return V[e%V.length]}function he(l){return`{{${l}}}`}function ke(l){}function we(l){const e=s.value[l];return e?b.value.find(y=>y.id===e)?.name:void 0}function $e(l){const e=s.value[l];return e?b.value.find(y=>y.id===e)?.itemCount:void 0}function Ce(l){const e=s.value[l];if(!e)return;const o=b.value.find(y=>y.id===e);if(!(!o||o.category!=="attributed"||!o.items))return o.items.slice(0,10)}function Ve(l){const e=s.value[l];if(!e)return;const o=b.value.find(A=>A.id===e);if(!o||o.category!=="attributed")return;const y=[];return o.attributeKeys&&y.push(...o.attributeKeys.map((A,j)=>({text:A,colorIndex:j%5}))),{parts:y,totalItems:o.itemCount||0}}function Le(l){const e=s.value[l];if(!e)return;const o=b.value.find(y=>y.id===e);return o?.attributeKeys?[...o.attributeKeys]:void 0}function Te(l){const e=s.value[l];if(!e)return;const o=b.value.find(y=>y.id===e);if(!(!o||o.category!=="simple"))return o.values?.slice(0,10)}function Ie(l,e){m.value[l]=e}function Se(l){n.value[l]=null}function Re(l){s.value[l]="",m.value[l]=[]}function Ee(l){I.value=l,p.value="all",v.value=!0}function xe(l){I.value&&(l.category==="simple"?(m.value[I.value]=[...l.values||[]],s.value[I.value]="",n.value[I.value]={listId:l.id,listName:l.name}):(s.value[I.value]=l.id,m.value[I.value]=[],n.value[I.value]=null)),v.value=!1}function We(){return t.value.refusalWordsListRef?b.value.find(e=>e.id===t.value.refusalWordsListRef)?.name:void 0}function Pe(){t.value.refusalWordsListRef="",t.value.refusalWords=[]}function Me(l){(l.category==="simple"||l.category==="refusal")&&l.values&&(t.value.refusalWords=[...l.values],t.value.refusalWordsListRef="",t.value.refusalWordsSource=null),i.value=!1}function Be(l,e){}function se(){c.push({name:"templates"})}async function ie(){try{if(f.value=[],!t.value.name.trim()){f.value.push("Template name is required");return}if(!t.value.template.trim()){f.value.push("Template content is required");return}const l={};for(const o of k.value)s.value[o]?l[o]={type:"list",listId:s.value[o]}:m.value[o]?.length>0&&(l[o]={type:"value",values:[...m.value[o]]});const e={name:t.value.name,description:t.value.description,template:t.value.template,variables:l,category:"Custom",tags:[],parserId:t.value.parserId||void 0,refusalWords:t.value.refusalWords.length>0?[...t.value.refusalWords]:void 0,refusalMode:t.value.refusalMode};if(T.value){const o=await M(T.value,e);if(o.ok)ve.success("Template updated successfully");else{f.value=[o.error.message];return}}else{const o=await $(e);if(o.ok)ve.success("Template created successfully");else{f.value=[o.error.message];return}}c.push({name:"templates"})}catch(l){ue.error("Failed to save template:",l),f.value=[l instanceof Error?l.message:"Failed to save template"]}}function ne(){if(!T.value)return;const l=B.value.find(e=>e.id===T.value);if(!l){R.value||(f.value=["Template not found"]);return}t.value.name=l.name,t.value.description=l.description||"",t.value.template=l.template,t.value.parserId=l.parserId||null,t.value.refusalWords=l.refusalWords?[...l.refusalWords]:[],t.value.refusalMode=l.refusalMode||(l.rejectRefusalWords?"replace_content":"parse_anyway"),m.value={},s.value={},n.value={};for(const[e,o]of Object.entries(l.variables))if(o.type==="list"&&o.listId){const y=b.value.find(A=>A.id===o.listId);y&&(y.category==="simple"||y.category==="refusal"?(m.value[e]=[...y.values||[]],s.value[e]="",n.value[e]={listId:y.id,listName:y.name}):(s.value[e]=o.listId,m.value[e]=[],n.value[e]=null))}else o.type==="value"&&o.values&&(m.value[e]=[...o.values])}G(F,async l=>{l&&!W.value&&(W.value={promptTokens:Math.ceil(t.value.template.length/4),totalEstimate:Math.ceil(t.value.template.length/3),variableTokens:{}})}),Ge(()=>{T.value,T.value,T.value&&ne()});let oe=T.value;return G([()=>D.params.id,B,b],(l,e)=>{const o=T.value;if(o){const y=o!==oe,A=e&&l[1]!==e[1],j=e&&l[2]!==e[2];(y||A||j)&&ne()}oe=o},{immediate:!0}),(l,e)=>{const o=Q,y=tt,A=_e,j=it,ee=st,re=ot,Fe=nt,Ue=ye,Ae=rt,Ne=lt,De=ut,Oe=et,ze=be;return r(),u("div",ba,[g(Oe,null,{default:h(()=>[g(y,{class:"editor-header"},{default:h(()=>[a("div",_a,[g(o,{type:"text",onClick:se,class:"back-button","data-testid":"btn-back-to-templates"},{icon:h(()=>[g(H(at))]),default:h(()=>[e[14]||(e[14]=C(" Back to Templates "))]),_:1,__:[14]}),a("h1",ya,_(T.value?"Edit Template":"Create Template"),1)])]),_:1}),g(Ne,{class:"editor-content"},{default:h(()=>[a("div",ha,[w.value?(r(),u("div",ka,[g(A,{size:"large",tip:"Loading template..."})])):(r(),q(Ae,{key:1,model:t.value,layout:"vertical",onFinish:ie},{default:h(()=>[a("div",wa,[e[15]||(e[15]=a("label",{class:"inline-field-label"},"Name",-1)),g(ee,{name:"name",rules:[{required:!0,message:"Required"}],class:"name-field"},{default:h(()=>[g(j,{value:t.value.name,"onUpdate:value":e[0]||(e[0]=d=>t.value.name=d),placeholder:"Enter template name",size:"large","data-testid":"input-template-name","aria-label":"Template name"},null,8,["value"])]),_:1}),e[16]||(e[16]=a("label",{class:"inline-field-label"},"Description",-1)),g(ee,{name:"description",class:"desc-field"},{default:h(()=>[g(j,{value:t.value.description,"onUpdate:value":e[1]||(e[1]=d=>t.value.description=d),placeholder:"Optional description",size:"large","data-testid":"input-template-description","aria-label":"Template description"},null,8,["value"])]),_:1})]),g(ee,{label:"Template",name:"template",rules:[{required:!0,message:"Required"}],class:"template-form-item"},{default:h(()=>[k.value.length===0?(r(),u("div",$a,[g(H(ge)),e[17]||(e[17]=a("span",null,[C("Type a prompt and use double curly braces to add a variable with conditions to vary, like "),a("code",null,"{{name}}"),C(" or "),a("code",null,"{{system_prompt}}"),C(". Variable names cannot contain spaces or punctuation except underscores (_).")],-1))])):S("",!0),g(mt,{modelValue:t.value.template,"onUpdate:modelValue":e[2]||(e[2]=d=>t.value.template=d),placeholder:"Enter your prompt template... Use {{variable}} for variables",rows:7,variables:k.value,"variable-colors":P.value,"data-testid":"template-editor","aria-label":"Prompt template editor"},null,8,["modelValue","variables","variable-colors"]),k.value.length>0&&t.value.template?(r(),q(sa,{key:1,template:t.value.template,variables:m.value,"variable-list-refs":s.value,onTogglePreview:ke},null,8,["template","variables","variable-list-refs"])):S("",!0)]),_:1}),k.value.length>0?(r(),u("div",Ca,[(r(!0),u(N,null,z(k.value,d=>(r(),u("div",{key:d,class:"variable-row"},[a("div",Va,[e[18]||(e[18]=a("span",{class:"variable-text"},"Variable:",-1)),a("span",{style:te({backgroundColor:U(d).bg,color:U(d).text}),class:"variable-badge"},_(he(d)),5)]),a("div",La,[g(ce,{values:m.value[d]||[],"list-ref":s.value[d],"list-name":we(d),source:n.value[d]||null,placeholder:`Enter a value for {{${d}}} and hit enter`,"attributed-samples":Ce(d),"attribute-breakdown":Ve(d),"attribute-keys":Le(d),"preview-values":Te(d),"total-count":$e(d),"onUpdate:values":Z=>Ie(d,Z),onClearSource:Z=>Se(d),onClearList:Z=>Re(d),onSelectList:Z=>Ee(d)},null,8,["values","list-ref","list-name","source","placeholder","attributed-samples","attribute-breakdown","attribute-keys","preview-values","total-count","onUpdate:values","onClearSource","onClearList","onSelectList"])])]))),128))])):S("",!0),a("div",Ta,[e[19]||(e[19]=a("label",{class:"row-label"},"Response Parser",-1)),a("div",Ia,[g(dt,{modelValue:t.value.parserId,"onUpdate:modelValue":e[3]||(e[3]=d=>t.value.parserId=d),placeholder:"Select Parser (Optional - leave blank for full response)","allow-clear":!0,context:"template-editor",onChange:Be},null,8,["modelValue"])])]),a("div",Sa,[e[22]||(e[22]=a("label",{class:"row-label"},"Parse Refusals",-1)),a("div",Ra,[a("div",Ea,[g(ce,{values:t.value.refusalWords,"list-ref":t.value.refusalWordsListRef,"list-name":We(),source:t.value.refusalWordsSource||null,placeholder:"Enter a refusal word and hit enter (e.g., cannot, unable, refuse)","onUpdate:values":e[4]||(e[4]=d=>t.value.refusalWords=d),onClearSource:e[5]||(e[5]=d=>t.value.refusalWordsSource=null),onClearList:e[6]||(e[6]=d=>Pe()),onSelectList:e[7]||(e[7]=d=>i.value=!0)},null,8,["values","list-ref","list-name","source"]),a("div",xa,[a("div",Wa,[a("span",{class:ae(["mode-label-inline",{"disabled-label":t.value.refusalWords.length===0}])}," When detected (original response is always saved): ",2),g(Fe,{value:t.value.refusalMode,"onUpdate:value":e[8]||(e[8]=d=>t.value.refusalMode=d),class:"refusal-mode-select-inline","data-testid":"select-refusal-mode","aria-label":"Select refusal handling mode",size:"small",disabled:t.value.refusalWords.length===0,placeholder:t.value.refusalWords.length===0?"Add refusal words to enable":""},{default:h(()=>[g(re,{value:"parse_anyway"},{default:h(()=>e[20]||(e[20]=[C(" Parse normally, flag as refused ")])),_:1,__:[20]}),g(re,{value:"replace_content"},{default:h(()=>e[21]||(e[21]=[C(" Parse as 'REFUSED' ")])),_:1,__:[21]})]),_:1},8,["value","disabled","placeholder"])]),t.value.refusalWords.length>0?(r(),u("div",Pa,_(t.value.refusalWords.length)+" values ",1)):S("",!0)])])])]),f.value.length>0?(r(),q(Ue,{key:1,type:"error","show-icon":"",class:"error-alert"},{message:h(()=>[C(_(f.value.join(", ")),1)]),_:1})):S("",!0)]),_:1},8,["model"]))])]),_:1}),g(De,{class:"editor-footer"},{default:h(()=>[a("div",Ma,[a("div",Ba,_(k.value.length)+" variables • "+_(L.value.formatted)+" combinations ",1),a("div",Fa,[g(o,{size:"large",onClick:e[9]||(e[9]=d=>F.value=!0),"data-testid":"btn-calculate-pricing","aria-label":"Calculate pricing for this template"},{default:h(()=>e[23]||(e[23]=[C(" Calculate Pricing ")])),_:1,__:[23]}),g(o,{size:"large",onClick:se,"data-testid":"btn-cancel-template","aria-label":"Cancel and go back to templates"},{default:h(()=>e[24]||(e[24]=[C(" Cancel ")])),_:1,__:[24]}),g(o,{size:"large",type:"primary",onClick:ie,"data-testid":"btn-save-template","aria-label":"Save template and go back to templates"},{default:h(()=>e[25]||(e[25]=[C(" Save ")])),_:1,__:[25]})])])]),_:1})]),_:1}),g(pe,{modelValue:v.value,"onUpdate:modelValue":e[10]||(e[10]=d=>v.value=d),"list-type":p.value,onSelect:xe},null,8,["modelValue","list-type"]),g(pe,{modelValue:i.value,"onUpdate:modelValue":e[11]||(e[11]=d=>i.value=d),"list-type":"refusal",onSelect:Me},null,8,["modelValue"]),g(ze,{open:F.value,"onUpdate:open":e[13]||(e[13]=d=>F.value=d),title:"Cost Estimation",width:"90vw",style:{maxWidth:"1000px"}},{footer:h(()=>[g(o,{onClick:e[12]||(e[12]=d=>F.value=!1)},{default:h(()=>e[31]||(e[31]=[C("Close")])),_:1,__:[31]})]),default:h(()=>[a("div",Ua,[W.value?(r(),u("div",Aa,[e[26]||(e[26]=a("h4",null,"Token Analysis",-1)),a("div",Na,[a("div",null,"Min: "+_(W.value.promptTokens),1),a("div",null,"Max: "+_(W.value.totalEstimate),1),a("div",null,"Avg: "+_(Math.round((W.value.promptTokens+W.value.totalEstimate)/2)),1),a("div",null,"Variables: "+_(Object.keys(W.value.variableTokens).length),1)])])):S("",!0),a("div",Da,[e[30]||(e[30]=a("p",null,"Pricing calculation will be implemented with V3 backend integration.",-1)),a("p",null,[e[27]||(e[27]=C("Template: ")),a("strong",null,_(t.value.name||"Untitled"),1)]),a("p",null,[e[28]||(e[28]=C("Variables: ")),a("strong",null,_(k.value.length),1)]),a("p",null,[e[29]||(e[29]=C("Combinations: ")),a("strong",null,_(L.value.formatted),1)])])])]),_:1},8,["open"])])}}}),el=X(Oa,[["__scopeId","data-v-aaf97597"]]);export{el as default};
