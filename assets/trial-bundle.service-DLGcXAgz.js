const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/useV4TrialCommands-B-MkumuI.js","assets/index-BSSvTawe.js","assets/vue-vendor-BZxY9vkr.js","assets/ui-vendor-DgwC-sRC.js","assets/utils-vendor-X1Ah6TN4.js","assets/data-vendor-CllpzWXw.js","assets/index-DLndv8Bi.css"])))=>i.map(i=>d[i]);
import{d as o,a as f,_ as m}from"./index-BSSvTawe.js";import{F as g}from"./data-vendor-CllpzWXw.js";import"./vue-vendor-BZxY9vkr.js";import"./ui-vendor-DgwC-sRC.js";import"./utils-vendor-X1Ah6TN4.js";class y{async exportTrialBundle(e,t={}){try{const a=await o.trials.get(e);if(!a)return{ok:!1,error:new Error(`Trial not found: ${e}`)};const s=await this.buildBundle(a,t),r=t.includeResults?"complete":"draft",l=this.generateFilename(a,r);return t.skipDownload||await this.saveBundle(s,l,t.format||"json"),{ok:!0,value:{bundle:s,filename:l}}}catch(a){return f.error("Failed to export trial bundle:",a),{ok:!1,error:a instanceof Error?a:new Error("Export failed")}}}async buildBundle(e,t){let a=[],s;(t.includeResults||t.includeApiCalls)&&(a=await o.apiCalls.where("trialId").equals(e.id).toArray(),s=this.calculateSummary(a));let r;if(e.type==="template"&&e.templateConfig){if(e.templateConfig.templateId){const n=await o.template_prompts.get(e.templateConfig.templateId);n&&(r=this.createTemplateSnapshot(n))}if(!r){const n={};if(e.templateConfig.variables)for(const[d,c]of Object.entries(e.templateConfig.variables))n[d]={type:c.type,listId:c.listId,values:c.values,placeholder:c.placeholder};r={id:e.templateConfig.templateId||"unknown",name:e.templateConfig.templateName||"Unknown Template",template:e.templateConfig.template,variables:n,outputType:e.templateConfig.outputType,extractPattern:e.templateConfig.extractPattern,refusalWords:e.templateConfig.refusalWords,rejectRefusalWords:e.templateConfig.rejectRefusalWords}}}const l=await this.loadVariableLists(e),i={version:"1.0",metadata:{exportDate:new Date,trialId:e.id,trialName:e.name,trialStatus:e.status,apiCallCount:a.length},configuration:{trial:e,template:r,variableLists:l}};return t.includeResults&&(a.length>0||s)&&(i.execution={apiCalls:a,summary:s}),i}createTemplateSnapshot(e){return{id:e.id,name:e.name,description:e.description,template:e.template,category:e.category,tags:e.tags?[...e.tags]:void 0,variables:e.variables?{...e.variables}:void 0,outputType:e.outputType,extractPattern:e.extractPattern,refusalWords:e.refusalWords?[...e.refusalWords]:void 0,rejectRefusalWords:e.rejectRefusalWords}}async loadVariableLists(e){var a,s;const t=new Set;if(e.type==="template"&&((a=e.templateConfig)!=null&&a.variables))for(const r of Object.values(e.templateConfig.variables))r.type==="list"&&r.listId&&t.add(r.listId);return e.type==="spreadsheet"&&((s=e.spreadsheetConfig)!=null&&s.datasetId)&&t.add(e.spreadsheetConfig.datasetId),t.size>0?await o.variableLists.where("id").anyOf(Array.from(t)).toArray():[]}calculateSummary(e){var n,d,c;let t=0,a=0,s=0,r=0,l=0,i=0;for(const u of e)switch(u.status){case"completed":t++,(n=u.result)!=null&&n.latency&&(r+=u.result.latency,l++),(c=(d=u.result)==null?void 0:d.usage)!=null&&c.total_tokens&&(i+=u.result.usage.total_tokens);break;case"failed":a++;break;case"cancelled":s++;break}return{totalCalls:e.length,completed:t,failed:a,cancelled:s,averageLatency:l>0?r/l:void 0,totalTokens:i>0?i:void 0,estimatedCost:this.estimateCost(i)}}estimateCost(e){if(e)return e/1e3*.01}generateFilename(e,t="complete"){const a=new Date().toISOString().split("T")[0],s=e.name.replace(/[^a-z0-9]/gi,"_").toLowerCase();return`trial_${t}_${s}_${a}.json`}async saveBundle(e,t,a){let s;a==="compressed"?s=JSON.stringify(e):s=JSON.stringify(e,null,2);const r=new Blob([s],{type:"application/json"});g.saveAs(r,t)}}class w{async importTrialBundle(e,t={}){var a,s;try{const r=JSON.parse(e);if(!r.version||!((a=r.configuration)!=null&&a.trial))return{ok:!1,error:new Error("Invalid bundle format")};const l=await this.importVariableLists(r.configuration.variableLists||[]);let i;r.configuration.template&&(i=await this.importTemplate(r.configuration.template));const n=await this.createTrialFromBundle(r.configuration.trial,l,i,t.namePrefix,t.importAsCompleted);return n.ok?(t.importAsCompleted&&t.importResults&&((s=r.execution)!=null&&s.apiCalls)&&await this.importApiCalls(r.execution.apiCalls,n.value,r.configuration.trial.id),{ok:!0,value:{trialId:n.value}}):n}catch(r){return f.error("Failed to import trial bundle:",r),{ok:!1,error:r instanceof Error?r:new Error("Import failed")}}}async importVariableLists(e){const t=new Map;for(const a of e){const s=await this.findDuplicateList(a);if(s)t.set(a.id,s.id);else{const r=this.generateId("list"),l={...a,id:r,created:new Date,updated:new Date};await o.variableLists.add(l),t.set(a.id,r)}}return t}async findDuplicateList(e){const t=await o.variableLists.where("name").equals(e.name).toArray();for(const a of t)if(this.listsAreIdentical(a,e))return a}listsAreIdentical(e,t){if(e.category!==t.category)return!1;switch(e.category){case"simple":return JSON.stringify(e.values)===JSON.stringify(t.values);case"attributed":return JSON.stringify(e.items)===JSON.stringify(t.items);case"tabular":return JSON.stringify(e.tabularData)===JSON.stringify(t.tabularData);default:return!1}}async importTemplate(e){const t=await this.findDuplicateTemplate(e);if(t)return f.info(`Using existing template: ${t.name} (${t.id})`),t.id;const a={id:this.generateId("template"),name:e.name||"Imported Template",description:e.description,template:e.template,category:e.category,tags:e.tags||[],type:"template",isDefault:!1,variables:e.variables||{},outputType:e.outputType,extractPattern:e.extractPattern,refusalWords:e.refusalWords,rejectRefusalWords:e.rejectRefusalWords,created:new Date,updated:new Date};return f.info(`Creating new template: ${a.name} with ${Object.keys(a.variables).length} variables`),await o.template_prompts.add(a),a.id}async findDuplicateTemplate(e){const t=await o.template_prompts.where("name").equals(e.name||"").toArray();for(const s of t)if(this.templatesAreIdentical(s,e))return s;const a=await o.template_prompts.toArray();for(const s of a)if(this.templatesAreIdentical(s,e))return s}templatesAreIdentical(e,t){if(e.template!==t.template||e.outputType!==t.outputType||e.extractPattern!==t.extractPattern||e.rejectRefusalWords!==t.rejectRefusalWords)return!1;const a=JSON.stringify(e.refusalWords||[]),s=JSON.stringify(t.refusalWords||[]);if(a!==s)return!1;const r=JSON.stringify(e.variables||{}),l=JSON.stringify(t.variables||{});return r===l}async createTrialFromBundle(e,t,a,s,r){try{const l=r?"completed":"draft",i={...e,id:this.generateId("trial"),name:(s||"Imported: ")+e.name,status:l,created:new Date,started:r?e.started:void 0,completed:r?e.completed:void 0,progress:r?{...e.progress}:{total:0,completed:0,failed:0,cancelled:0,pending:0,running:0,networkErrors:0}};if(i.type==="template"&&i.templateConfig&&(a&&(i.templateConfig.templateId=a),i.templateConfig.variables)){for(const[,n]of Object.entries(i.templateConfig.variables))if(n.type==="list"&&n.listId){const d=t.get(n.listId);d&&(n.listId=d)}}if(i.type==="spreadsheet"&&i.spreadsheetConfig){const n=t.get(i.spreadsheetConfig.datasetId);n&&(i.spreadsheetConfig.datasetId=n)}if(await o.trials.add(i),!r){const{v4TrialOperations:n}=await m(async()=>{const{v4TrialOperations:c}=await import("./useV4TrialCommands-B-MkumuI.js").then(u=>u.v);return{v4TrialOperations:c}},__vite__mapDeps([0,1,2,3,4,5,6])),d=await n.generateApiCalls(i,i.repeatCount||1);i.progress.total=d.length,i.progress.pending=d.length,await o.trials.put(i),d.length>0&&await o.apiCalls.bulkAdd(d)}return{ok:!0,value:i.id}}catch(l){return{ok:!1,error:l instanceof Error?l:new Error("Failed to create trial")}}}async importApiCalls(e,t,a){const s=e.map(r=>({...r,id:this.generateId("call"),trialId:t,created:new Date}));await o.apiCalls.bulkAdd(s)}generateId(e){const t=Date.now().toString(36),a=Math.random().toString(36).substring(2,9);return`${e}_${t}_${a}`}}const S=new y,T=new w;export{y as TrialBundleExportService,w as TrialBundleImportService,S as trialBundleExportService,T as trialBundleImportService};
