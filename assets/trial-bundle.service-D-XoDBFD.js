const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/useV4TrialCommands-CQ3HwgdO.js","assets/index-B-vGjx5F.js","assets/vue-vendor-DPw1dQYc.js","assets/ui-vendor-IRGmExUJ.js","assets/utils-vendor-B76-F3_P.js","assets/index-DaHEOU6Y.css"])))=>i.map(i=>d[i]);
import{d as o,a as u,_ as m}from"./index-B-vGjx5F.js";import{a as g}from"./data-vendor-BIyl9aCN.js";import"./vue-vendor-DPw1dQYc.js";import"./ui-vendor-IRGmExUJ.js";import"./utils-vendor-B76-F3_P.js";var y=g();class w{async exportTrialBundle(e,a={}){try{const t=await o.trials.get(e);if(!t)return{ok:!1,error:new Error(`Trial not found: ${e}`)};const r=await this.buildBundle(t,a),s=a.includeResults?"complete":"draft",n=this.generateFilename(t,s);return a.skipDownload||await this.saveBundle(r,n,a.format||"json"),{ok:!0,value:{bundle:r,filename:n}}}catch(t){return u.error("Failed to export trial bundle:",t),{ok:!1,error:t instanceof Error?t:new Error("Export failed")}}}async buildBundle(e,a){let t=[],r;(a.includeResults||a.includeApiCalls)&&(t=await o.apiCalls.where("trialId").equals(e.id).toArray(),r=this.calculateSummary(t));let s;if(e.type==="template"&&e.templateConfig){if(e.templateConfig.templateId){const l=await o.template_prompts.get(e.templateConfig.templateId);l&&(s=this.createTemplateSnapshot(l))}if(!s){const l={};if(e.templateConfig.variables)for(const[d,c]of Object.entries(e.templateConfig.variables))l[d]={type:c.type,listId:c.listId,values:c.values,placeholder:c.placeholder};s={id:e.templateConfig.templateId||"unknown",name:e.templateConfig.templateName||"Unknown Template",template:e.templateConfig.template,variables:l,outputType:e.templateConfig.outputType,extractPattern:e.templateConfig.extractPattern,refusalWords:e.templateConfig.refusalWords,refusalMode:e.templateConfig.refusalMode,rejectRefusalWords:e.templateConfig.rejectRefusalWords}}}const n=await this.loadVariableLists(e),i={version:"1.0",metadata:{exportDate:new Date,trialId:e.id,trialName:e.name,trialStatus:e.status,apiCallCount:t.length},configuration:{trial:e,template:s,variableLists:n}};return a.includeResults&&(t.length>0||r)&&(i.execution={apiCalls:t,summary:r}),i}createTemplateSnapshot(e){return{id:e.id,name:e.name,description:e.description,template:e.template,category:e.category,tags:e.tags?[...e.tags]:void 0,variables:e.variables?{...e.variables}:void 0,outputType:e.outputType,extractPattern:e.extractPattern,refusalWords:e.refusalWords?[...e.refusalWords]:void 0,refusalMode:e.refusalMode,rejectRefusalWords:e.rejectRefusalWords}}async loadVariableLists(e){const a=new Set;if(e.type==="template"&&e.templateConfig?.variables)for(const t of Object.values(e.templateConfig.variables))t.type==="list"&&t.listId&&a.add(t.listId);return e.type==="spreadsheet"&&e.spreadsheetConfig?.datasetId&&a.add(e.spreadsheetConfig.datasetId),a.size>0?await o.variableLists.where("id").anyOf(Array.from(a)).toArray():[]}calculateSummary(e){let a=0,t=0,r=0,s=0,n=0,i=0;for(const l of e)switch(l.status){case"completed":a++,l.result?.latency&&(s+=l.result.latency,n++),l.result?.usage?.total_tokens&&(i+=l.result.usage.total_tokens);break;case"failed":t++;break;case"cancelled":r++;break}return{totalCalls:e.length,completed:a,failed:t,cancelled:r,averageLatency:n>0?s/n:void 0,totalTokens:i>0?i:void 0,estimatedCost:this.estimateCost(i)}}estimateCost(e){if(e)return e/1e3*.01}generateFilename(e,a="complete"){const t=new Date().toISOString().split("T")[0],r=e.name.replace(/[^a-z0-9]/gi,"_").toLowerCase();return`trial_${a}_${r}_${t}.json`}async saveBundle(e,a,t){let r;t==="compressed"?r=JSON.stringify(e):r=JSON.stringify(e,null,2);const s=new Blob([r],{type:"application/json"});y.saveAs(s,a)}}class v{async importTrialBundle(e,a={}){try{const t=JSON.parse(e);if(!t.version||!t.configuration?.trial)return{ok:!1,error:new Error("Invalid bundle format")};const r=await this.importVariableLists(t.configuration.variableLists||[]);let s;t.configuration.template&&(s=await this.importTemplate(t.configuration.template));const n=await this.createTrialFromBundle(t.configuration.trial,r,s,a.namePrefix,a.importAsCompleted);return n.ok?(a.importAsCompleted&&a.importResults&&t.execution?.apiCalls&&await this.importApiCalls(t.execution.apiCalls,n.value,t.configuration.trial.id),{ok:!0,value:{trialId:n.value}}):n}catch(t){return u.error("Failed to import trial bundle:",t),{ok:!1,error:t instanceof Error?t:new Error("Import failed")}}}async importVariableLists(e){const a=new Map;for(const t of e){const r=await this.findDuplicateList(t);if(r)a.set(t.id,r.id);else{const s=this.generateId("list"),n={...t,id:s,created:new Date,updated:new Date};await o.variableLists.add(n),a.set(t.id,s)}}return a}async findDuplicateList(e){const a=await o.variableLists.where("name").equals(e.name).toArray();for(const t of a)if(this.listsAreIdentical(t,e))return t}listsAreIdentical(e,a){if(e.category!==a.category)return!1;switch(e.category){case"simple":return JSON.stringify(e.values)===JSON.stringify(a.values);case"attributed":return JSON.stringify(e.items)===JSON.stringify(a.items);case"tabular":return JSON.stringify(e.tabularData)===JSON.stringify(a.tabularData);default:return!1}}async importTemplate(e){const a=await this.findDuplicateTemplate(e);if(a)return`${a.name}${a.id}`,a.id;const t={id:this.generateId("template"),name:e.name||"Imported Template",description:e.description,template:e.template,category:e.category,tags:e.tags||[],type:"template",isDefault:!1,variables:e.variables||{},outputType:e.outputType,extractPattern:e.extractPattern,refusalWords:e.refusalWords,refusalMode:e.refusalMode,rejectRefusalWords:e.rejectRefusalWords,created:new Date,updated:new Date};return`${t.name}${Object.keys(t.variables).length}`,await o.template_prompts.add(t),t.id}async findDuplicateTemplate(e){const a=await o.template_prompts.where("name").equals(e.name||"").toArray();for(const r of a)if(this.templatesAreIdentical(r,e))return r;const t=await o.template_prompts.toArray();for(const r of t)if(this.templatesAreIdentical(r,e))return r}templatesAreIdentical(e,a){if(e.template!==a.template||e.outputType!==a.outputType||e.extractPattern!==a.extractPattern||e.refusalMode!==a.refusalMode||e.rejectRefusalWords!==a.rejectRefusalWords)return!1;const t=JSON.stringify(e.refusalWords||[]),r=JSON.stringify(a.refusalWords||[]);if(t!==r)return!1;const s=JSON.stringify(e.variables||{}),n=JSON.stringify(a.variables||{});return s===n}async createTrialFromBundle(e,a,t,r,s){try{const n=s?"completed":"draft",i={...e,id:this.generateId("trial"),name:(r||"Imported: ")+e.name,status:n,created:new Date,started:s?e.started:void 0,completed:s?e.completed:void 0,progress:s?{...e.progress}:{total:0,completed:0,failed:0,cancelled:0,pending:0,running:0,networkErrors:0}};if(i.type==="template"&&i.templateConfig&&(t&&(i.templateConfig.templateId=t),i.templateConfig.variables)){for(const[,l]of Object.entries(i.templateConfig.variables))if(l.type==="list"&&l.listId){const d=a.get(l.listId);d&&(l.listId=d)}}if(i.type==="spreadsheet"&&i.spreadsheetConfig){const l=a.get(i.spreadsheetConfig.datasetId);l&&(i.spreadsheetConfig.datasetId=l)}if(await o.trials.add(i),!s){const{v4TrialOperations:l}=await m(async()=>{const{v4TrialOperations:c}=await import("./useV4TrialCommands-CQ3HwgdO.js").then(p=>p.c);return{v4TrialOperations:c}},__vite__mapDeps([0,1,2,3,4,5])),d=await l.generateApiCalls(i,i.repeatCount||1);i.progress.total=d.length,i.progress.pending=d.length,await o.trials.put(i),d.length>0&&await o.apiCalls.bulkAdd(d)}return{ok:!0,value:i.id}}catch(n){return{ok:!1,error:n instanceof Error?n:new Error("Failed to create trial")}}}async importApiCalls(e,a,t){const r=e.map(s=>({...s,id:this.generateId("call"),trialId:a,created:new Date}));await o.apiCalls.bulkAdd(r)}generateId(e){const a=Date.now().toString(36),t=Math.random().toString(36).substring(2,9);return`${e}_${a}_${t}`}}const T=new w,_=new v;export{w as TrialBundleExportService,v as TrialBundleImportService,T as trialBundleExportService,_ as trialBundleImportService};
