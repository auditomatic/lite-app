var e=Object.defineProperty,t=(t,a,n)=>((t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n)(t,"symbol"!=typeof a?a+"":a,n);import{ag as a,f as n,c as s,ah as r}from"./vendor-BxfGckcK.js";import{l as o}from"./db-COX2g2xv.js";import{a as i,d as l,i as c}from"./index-JX8mTFJZ.js";import{v as u}from"./variables-db-DFlmKEoQ.js";import{p}from"./registry-aRYPBFJZ.js";const d=new class{extractVariables(e){const t=[...e.matchAll(/\{\{(\w+)\}\}/g)];return[...new Set(t.map(e=>e[1]))]}validateTemplate(e){const t=[];if(!e.trim())return{isValid:!1,errors:["Template cannot be empty"],variables:[]};(e.match(/\{\{/g)||[]).length!==(e.match(/\}\}/g)||[]).length&&t.push("Mismatched braces - ensure all {{variables}} are properly closed");/\{\{[^}]*\{\{/.test(e)&&t.push("Nested braces are not allowed");/\{\{\s*\}\}/.test(e)&&t.push("Empty variable placeholders are not allowed");const a=e.match(/\{\{([^}]*)\}\}/g)?.filter(e=>{const t=e.slice(2,-2).trim();return!/^\w+$/.test(t)});a&&a.length>0&&t.push("Variable names must contain only letters, numbers, and underscores");const n=this.extractVariables(e);return{isValid:0===t.length,errors:t,variables:n}}createTestPrompt(e,t,a=0){let n=e;for(const[s,r]of Object.entries(t))if(r&&r.length>0){const e=r[a%r.length]||r[0];n=n.replace(new RegExp(`\\{\\{${s}\\}\\}`,"g"),e)}return n}renderTemplate(e,t){let a=e;for(const[n,s]of Object.entries(t))a=a.replace(new RegExp(`\\{\\{${n}\\}\\}`,"g"),s);return a}getMissingVariables(e,t){return this.extractVariables(e).filter(e=>!t[e]||0===t[e]?.length)}},g=class e{calculateTotalPermutations(e){const t=Object.values(e).filter(e=>e>0);return 0===t.length?0:t.reduce((e,t)=>e*t,1)}getPermutationInfo(t){const a=this.calculateTotalPermutations(t);let n,s;return n=a>999999?`${(a/1e6).toFixed(1)}M`:a>9999?`${(a/1e3).toFixed(0)}k`:a.toLocaleString(),a>e.VERY_LARGE_THRESHOLD?s="Very large trial - may take hours and significant API costs":a>e.LARGE_THRESHOLD&&(s="Large trial - consider sampling or filtering"),{total:a,isLarge:a>e.LARGE_THRESHOLD,formatted:n,warning:s}}*generatePermutations(e,t=1/0){const a=Object.keys(e),n=a.map(t=>e[t]);if(0===a.length)return;let s=0;const r=function*(e,o){if(s>=t)return;if(e===a.length)return yield{...o},void s++;const i=a[e],l=n[e];for(const a of l){if(s>=t)return;o[i]=a,yield*r(e+1,o)}};yield*r(0,{})}getSamplePermutations(e,t=5){const a=[],n=this.generatePermutations(e,t);for(const s of n)a.push(s);return a}estimateTrialMetrics(e,t,a=2e3,n=.01){const s=e*t,r=s*a*.7;return{totalCalls:s,estimatedTimeMinutes:Math.ceil(r/6e4),estimatedCostUSD:s*n}}shouldSample(t,a=e.LARGE_THRESHOLD){const n=this.calculateTotalPermutations(t);if(n<=a)return{shouldSample:!1};let s;return s=n>1e6?1e3:n>1e5?5e3:Math.min(1e4,Math.floor(.1*n)),{shouldSample:!0,recommendedSampleSize:s}}*generateStratifiedSample(e,t){const a=this.calculateTotalPermutations(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,t.length])));if(a<=t)return void(yield*this.generatePermutations(e));const n=Math.floor(a/t);let s=0,r=0;for(const o of this.generatePermutations(e))if(s%n===0&&r<t&&(yield o,r++),s++,r>=t)break}};t(g,"LARGE_THRESHOLD",1e4),t(g,"VERY_LARGE_THRESHOLD",1e5);const m=new g;const h=new class{getOutputTokenLimit(e,t,a){const n=p.getProvider(e);if(!n)return 128;const s=n.modelRules.find(e=>new RegExp(e.pattern).test(t));if(!s)return 128;return this.findOutputLengthValue(s.params,a)??128}findOutputLengthValue(e,t){if(e&&t)for(const[a,n]of Object.entries(e)){if(!0===n.is_output_length)return t[a]??n.default;if("object"===n.type&&n.properties){const e=this.findOutputLengthValue(n.properties,t[a]||{});if(void 0!==e)return e}}}buildAPIRequest(e,t,a,n,s){const r=p.getProvider(e.provider);if(!r)throw new Error(`Unknown provider: ${e.provider}`);const o=r.api.endpoints.chat||r.api.endpoints.generate;if(!o)throw new Error(`No endpoint configured for provider: ${e.provider}`);const i=`${n||r.api.baseUrl}${o}`,l=this.buildHeaders(r,a);let c=t;s?.promptTransform?.append&&(c=t+s.promptTransform.append);return{url:i,method:"POST",headers:l,body:this.buildRequestBody(r,e,c)}}buildHeaders(e,t){const a={"Content-Type":"application/json"};return e.headers&&Object.assign(a,e.headers),"none"!==e.auth.type&&t&&("bearer"===e.auth.type?a.Authorization=`Bearer ${t}`:"header"===e.auth.type&&e.auth.header&&(a[e.auth.header]=t)),a}buildRequestBody(e,t,a){const n=e.requestTransform,s={...t.params};let r={model:t.model.startsWith(`${t.provider}:`)?t.model.substring(t.provider.length+1):t.model};return n?.promptKey&&(n.wrapPrompt?r[n.promptKey]=[{role:n.messageRole||"user",content:a}]:r[n.promptKey]=a),n?.nestParams?r[n.nestParams]=s:Object.assign(r,s),r=this.applyProviderSpecificTransforms(e.id,r),r}applyProviderSpecificTransforms(e,t){switch(e){case"openai-chat":t.response_format&&"string"==typeof t.response_format&&(t.response_format={type:t.response_format});break;case"openai-responses":t.messages&&(t.input=t.messages[0].content,delete t.messages);break;case"anthropic":if(t.messages&&void 0===t.max_tokens)throw new Error("Anthropic requires max_tokens parameter")}return t}extractResponseContent(e,t){if(!t||"object"!=typeof t)return"";switch(e){case"openai-chat":case"openrouter":return t.choices?.[0]?.message?.content||"";case"openai-responses":const e=t.output?.[0];if("message"===e?.type){const t=e.content?.[0];if("output_text"===t?.type)return t.text||""}return"";case"anthropic":const a=t.content?.[0];return"text"===a?.type?a.text||"":a?.text||"";case"ollama-chat":return t.message?.content||"";case"ollama-generate":return t.response||"";default:return t.content||t.response||t.choices?.[0]?.message?.content||t.message?.content||""}}extractUsageInfo(e,t){if(!t||"object"!=typeof t)return{};switch(e){case"openai-chat":case"openrouter":return{prompt_tokens:t.usage?.prompt_tokens,completion_tokens:t.usage?.completion_tokens,total_tokens:t.usage?.total_tokens};case"openai-responses":return{prompt_tokens:t.usage?.input_tokens,completion_tokens:t.usage?.output_tokens,total_tokens:t.usage?.total_tokens};case"anthropic":return{prompt_tokens:t.usage?.input_tokens,completion_tokens:t.usage?.output_tokens,total_tokens:(t.usage?.input_tokens||0)+(t.usage?.output_tokens||0)};case"ollama-chat":case"ollama-generate":return{prompt_tokens:t.prompt_eval_count,completion_tokens:t.eval_count,total_tokens:(t.prompt_eval_count||0)+(t.eval_count||0)};default:return{}}}isErrorResponse(e){return!e||(!(!e.error&&!e.errors)||(!!(e.status&&e.status>=400)||"error"===e.type))}extractErrorMessage(e){return e?e.error?.message?e.error.message:e.error&&"string"==typeof e.error?e.error:e.message&&"error"===e.type?e.message:e.errors?.[0]?.message?e.errors[0].message:JSON.stringify(e):"Empty response"}};const f=new class{constructor(){t(this,"tokenCountCache",new Map)}async calculateDesignTokens(e){try{const t=this.getDesignCacheKey(e),a=this.tokenCountCache.get(t);if(a&&a.calculated&&Date.now()-a.calculated.getTime()<36e5)return a;console.log(`Calculating tokens for design: ${e.name}`);const n=e.promptTemplate.replace(/\{\{[^}]+\}\}/g,""),s=await this.countTokens(n),r=await this.getVariableValues(e),o={};for(const[e,p]of Object.entries(r)){if(0===p.length){o[e]={min:0,max:0,avg:0};continue}const t=await Promise.all(p.map(e=>this.countTokens(e)));o[e]={min:Math.min(...t),max:Math.max(...t),avg:Math.round(t.reduce((e,t)=>e+t,0)/t.length)}}let i=s,l=s,c=s;for(const e of Object.values(o))i+=e.min,l+=e.max,c+=e.avg;const u={minTokens:i,maxTokens:l,avgTokens:c,sampleSize:Object.values(r).reduce((e,t)=>e+t.length,0),calculated:new Date,isAccurate:!1};return console.log(`Token calculation complete: ${e.name}`),this.tokenCountCache.set(t,u),u}catch(t){return console.error("Failed to calculate design tokens:",t),{minTokens:0,maxTokens:0,avgTokens:0,sampleSize:0,calculated:new Date}}}async calculateDesignTokensAccurate(e,t){try{const a=this.getDesignCacheKey(e)+":accurate",n=this.tokenCountCache.get(a);if(n&&n.calculated&&n.isAccurate&&Date.now()-n.calculated.getTime()<36e5)return n;t?.({stage:"preparing",current:0,total:1,message:"Loading tiktoken encoder..."});const s=(await i(()=>import("./index-CDFlJ0dN.js"),[],import.meta.url)).encodingForModel("gpt-4"),r=e.promptTemplate.replace(/\{\{[^}]+\}\}/g,""),o=s.encode(r).length,l=await this.getVariableValues(e),c=Object.values(l).reduce((e,t)=>e+t.length,0);let u=0;const p={};for(const[e,i]of Object.entries(l)){if(0===i.length){p[e]={min:0,max:0,avg:0};continue}const a=[],n=50;for(let r=0;r<i.length;r+=n){const o=i.slice(r,r+n);await new Promise(e=>setTimeout(e,0));for(const n of o){const r=s.encode(n).length;a.push(r),u++,t?.({stage:"encoding",current:u,total:c,message:`Encoding ${e}: ${Math.round(u/c*100)}%`})}}p[e]={min:Math.min(...a),max:Math.max(...a),avg:Math.round(a.reduce((e,t)=>e+t,0)/a.length)}}let d=o,g=o,m=o;for(const e of Object.values(p))d+=e.min,g+=e.max,m+=e.avg;const h={minTokens:d,maxTokens:g,avgTokens:m,sampleSize:c,calculated:new Date,isAccurate:!0};return t?.({stage:"complete",current:c,total:c,message:"Token calculation complete!"}),this.tokenCountCache.set(a,h),h}catch(a){return console.error("Failed to calculate accurate tokens:",a),this.calculateDesignTokens(e)}}async calculateCostEstimate(e,t,a){const n=await this.calculateDesignTokens(e),s=this.getOutputTokenLimit(t.provider,t.modelId,a),r=t.capabilities?.inputCostPerToken||0,o=t.capabilities?.outputCostPerToken||0,i={min:n.minTokens*r+s*o,max:n.maxTokens*r+s*o,avg:n.avgTokens*r+s*o},l=await this.getVariableCounts(e),c=m.calculateTotalPermutations(l);return{inputTokens:n,outputTokens:s,costPerCall:i,totalCost:{min:i.min*c,max:i.max*c,avg:i.avg*c}}}getOutputTokenLimit(e,t,a){return h.getOutputTokenLimit(e,t,a)}async countTokens(e){return e&&0!==e.length?Math.ceil(e.length/4):0}async getVariableCounts(e){const t={};for(const[a,n]of Object.entries(e.variableBindings||{}))if("direct"===n.type&&n.values)t[a]=n.values.length;else if("list"===n.type&&n.listId){const e=await u.getListValues(n.listId);t[a]=e.length}return t}async getVariableValues(e){const t={};try{for(const[n,s]of Object.entries(e.variableBindings||{}))if("direct"===s.type&&s.values)t[n]=s.values;else if("list"===s.type&&s.listId)try{const e=await u.getListValues(s.listId);t[n]=e}catch(a){console.warn(`Failed to get list values for ${n}:`,a),t[n]=[]}}catch(a){console.error("Error getting variable values:",a)}return t}getDesignCacheKey(e){const t=JSON.stringify(e.variableBindings);return`${e.id}:${e.promptTemplate}:${t}`}clearCache(){this.tokenCountCache.clear()}},v=a("designs",()=>{const e=n([]),t=n(!1),a=n(null);let i=null,u=!1;async function p(e){const t=new Date,a=c(),n=d.validateTemplate(e.promptTemplate);if(!n.isValid)throw new Error(`Invalid template: ${n.errors.join(", ")}`);let s;if(e.variableBindings&&Object.keys(e.variableBindings).length>0)try{s=await f.calculateDesignTokens({...e,id:a,created:t,updated:t})}catch(o){console.warn("Failed to calculate token estimate:",o)}const r={...e,id:a,created:t,updated:t,tokenEstimate:s};try{return await l.designs.add(r),a}catch(o){throw console.error("Failed to create design:",o),new Error("Failed to create design")}}async function g(e){try{const t=await l.designs.get(e);return console.log("getDesign retrieved:",t),t}catch(t){return void console.error("Failed to get design:",t)}}const m=s(()=>e.value.map(e=>{const t=d.extractVariables(e.promptTemplate),a=Object.values(e.variableBindings||{}).some(e=>"list"===e.type);return{...e,variableCount:t.length,hasExtraction:!!e.extractPattern,hasListRefs:a}})),h=s(()=>e.value.slice().sort((e,t)=>t.updated.getTime()-e.updated.getTime())),v=s(()=>h.value.slice(0,5));return{designs:r(e),isLoading:r(t),error:r(a),designsWithStats:m,designsByDate:h,recentDesigns:v,initialize:async function(){if(!i){t.value=!0,a.value=null;try{i=o(()=>l.designs.orderBy("updated").reverse().toArray()).subscribe({next:async a=>{e.value=a,t.value=!1,a.length>0&&setTimeout(()=>{!async function(e){if(!u){u=!0;try{const t=2,a=e.filter(e=>!e.tokenEstimate&&e.variableBindings&&Object.keys(e.variableBindings).length>0);for(let e=0;e<a.length;e+=t){const n=a.slice(e,e+t);await Promise.all(n.map(async e=>{console.log(`Calculating missing token estimate for design: ${e.name}`);try{const t=await f.calculateDesignTokens(e);await l.designs.update(e.id,{tokenEstimate:t})}catch(t){console.warn(`Failed to calculate token estimate for ${e.name}:`,t)}})),e+t<a.length&&await new Promise(e=>setTimeout(e,50))}}finally{u=!1}}}(a)},1e3)},error:e=>{console.error("Designs store subscription error:",e),a.value="Failed to load designs",t.value=!1}})}catch(n){console.error("Failed to initialize designs store:",n),a.value="Failed to initialize designs",t.value=!1}}},createDesign:p,updateDesign:async function(e,t){try{if(void 0!==t.promptTemplate){const e=d.validateTemplate(t.promptTemplate);if(!e.isValid)throw new Error(`Invalid template: ${e.errors.join(", ")}`)}const n=await l.designs.get(e);if(!n)throw new Error("Design not found");let s=n.tokenEstimate;if(void 0!==t.promptTemplate||void 0!==t.variableBindings){const e={...n,...t};if(e.variableBindings&&Object.keys(e.variableBindings).length>0)try{s=await f.calculateDesignTokens(e)}catch(a){console.warn("Failed to calculate token estimate:",a)}else s=void 0}console.log("updateDesign called with id:",e,"changes:",t),await l.designs.update(e,{...t,tokenEstimate:s,updated:new Date}),console.log("Design updated successfully")}catch(a){throw console.error("Failed to update design:",a),new Error("Failed to update design")}},deleteDesign:async function(e){try{if(await l.trials.where("designId").equals(e).count()>0)throw new Error("Cannot delete design - it is used in existing trials");await l.designs.delete(e)}catch(t){if(console.error("Failed to delete design:",t),t instanceof Error)throw t;throw new Error("Failed to delete design")}},getDesign:g,getAllDesigns:async function(){try{return await l.designs.toArray()}catch(e){return console.error("Failed to get all designs:",e),[]}},duplicateDesign:async function(t,a){const n=await g(t);if(!n)throw new Error("Design not found");const s=a||`${n.name} (copy)`;let r=s,o=1;for(;e.value.some(e=>e.name===r);)r=`${s} ${o}`,o++;return p({name:r,description:n.description,promptTemplate:n.promptTemplate,variableBindings:n.variableBindings,outputType:n.outputType,extractPattern:n.extractPattern,refusalWords:n.refusalWords,rejectRefusalWords:n.rejectRefusalWords})},searchDesigns:t=>{if(!t.trim())return e.value;const a=t.toLowerCase().trim();return e.value.filter(e=>{if(e.name.toLowerCase().includes(a)||e.description?.toLowerCase().includes(a))return!0;return d.extractVariables(e.promptTemplate).some(e=>e.toLowerCase().includes(a))})},destroy:function(){i&&(i.unsubscribe(),i=null)}}});export{f as a,h as b,m as p,d as t,v as u};
