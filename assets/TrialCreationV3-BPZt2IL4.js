import{f as R,c as O,d as Y,o as ne,b as ye,w as K,R as h,a0 as ae,_ as z,n as Ce,k as d,S as e,Z as $,V as _,q as be,a3 as he,F as Q,W as X,Y as f,G as A,u as x,r as ke,y as $e,$ as W,e as Te,z as we,p as Ie,a1 as Se,X as Pe}from"./vue-vendor-DPw1dQYc.js";import{e as ue,a as q,d as xe,j as G,f as De,c as Me}from"./index-33ibDqAi.js";import{u as Ee}from"./useV4Templates-DdX8BCkJ.js";import{u as pe}from"./useV4VariableLists-CbjQajz6.js";import{u as oe}from"./useV4Models-DZwNS6Tw.js";import{u as ie,a as Ne}from"./useV4TrialCommands-DqvT_mpe.js";import{u as Ae}from"./execution-control-v4-n5IrjNU4.js";import{n as Z,T as le,aG as me,R as Le,Y as Oe,a4 as ve,aH as ce,O as Ve,F as ze,P as ee,aI as Re,a7 as je,a2 as Fe,a3 as Be,G as Ue,aj as qe,H as Je,q as He,o as We,w as Ke,aJ as Ye,J as Ge,x as fe,ad as Ze,ag as ge,X as Qe,I as Xe,ao as et,$ as tt,Z as at,N as te}from"./ui-vendor-IRGmExUJ.js";import{G as st}from"./GenericModelSelectorModalV3-3vzEvtM-.js";import{u as re}from"./useCostEstimation-BKxivU92.js";import"./utils-vendor-B76-F3_P.js";import"./useV4LiveQuery-Do0jdBW3.js";import"./useV4CrossTab-CWEIPJG6.js";import"./useV4ProviderParameters-Crt7xRO-.js";function nt(U){const{templates:D}=Ee(),{variableLists:n}=pe(),{enabledModels:I}=oe(),{runningTrials:c}=ie(),S=Ae(),{createTrial:b}=Ne(),p=R(null),v=R(""),y=R(""),k=R(1),P=R([]),j=R(!1),L=R(!1),u=O(()=>D.value||[]),i=O(()=>[]),M=O(()=>{if(!p.value)return 0;if(p.value.type==="template"){const l=p.value;if(!l.variables)return 1;let w=1;for(const[,E]of Object.entries(l.variables))if(E.type==="value"&&E.values)w*=E.values.length;else if(E.type==="list"&&E.listId){const J=n.value.find(H=>H.id===E.listId);J&&(J.category==="simple"?w*=J.values?.length||0:J.category==="attributed"?w*=J.items?.length||0:J.category==="tabular"&&(w*=J.itemCount||0))}return w}else return 0}),N=O(()=>M.value*P.value.length*k.value),F=O(()=>{let l=0;for(const w of P.value){const E=o(w);l+=E*M.value*k.value}return l}),B=O(()=>p.value!==null&&P.value.length>0&&v.value.trim()!=="");function T(l){p.value=l,v.value=V(l)}function V(l){const w=l||p.value;if(!w)return"New Trial";const E=new Date().toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return`${w.name} - ${E}`}function o(l){if(!p.value)return 0;const w=I.value.find(de=>de.provider===l.provider&&de.modelId===l.modelId);if(!w?.capabilities)return 0;const E=a(),J=l.parameters?.max_tokens||l.parameters?.maxTokens||256,H=ue(E,w.capabilities.inputCostPerToken)||0,_e=ue(J,w.capabilities.outputCostPerToken)||0;return H+_e}function a(){return p.value&&p.value.type==="template"?150:100}function t(l){P.value.push(l)}function s(l){P.value.splice(l,1)}async function r(){if(B.value){j.value=!0;try{const l=JSON.parse(JSON.stringify(p.value)),w={name:v.value,description:"",type:l.type,configurations:JSON.parse(JSON.stringify(P.value)),repeatCount:k.value,templateConfig:l.type==="template"?{template:l.template,variables:l.variables,parserId:l.parserId,refusalWords:l.refusalWords,refusalMode:l.refusalMode,rejectRefusalWords:l.rejectRefusalWords}:void 0,spreadsheetConfig:l.type==="spreadsheet"?{promptPattern:l.promptPattern,datasetId:l.datasetId,parserId:l.parserId}:void 0},E=await b(w);if(E.ok)return E.value;throw E.error}finally{j.value=!1}}}async function g(){const l=await r();if(l)return c.value.length>0?{trialId:l,needsConfirmation:!0,runningTrial:c.value[0]}:await C(l)}async function C(l){const w=await S.startTrialWithStreaming(l);if(w.ok){const E=w.value.progress$.subscribe({next:H=>{H.type},error:H=>{q.error("V4: Creation view stream error:",H)}}),J=w.value.calls$.subscribe({next:H=>{H.length},error:H=>{q.error("V4: Creation view calls stream error:",H)}});return setTimeout(()=>{E.unsubscribe(),J.unsubscribe()},1e3),{trialId:l,needsConfirmation:!1}}else throw w.error}async function m(){try{await S.initialize()}catch(l){q.error("V4: Failed to initialize execution control in creation view:",l)}if(U.value.type==="duplicate"&&U.value.sourceTrialId){const l=await xe.trials.get(U.value.sourceTrialId);if(l){if(v.value=`Copy of ${l.name}`,k.value=l.repeatCount||1,l.configurations&&(P.value=l.configurations.map(w=>({name:w.modelSnapshot?.displayName||w.modelId,provider:w.provider,modelId:w.modelId,parameters:w.parameters||{}}))),l.type==="template"&&l.templateConfig?.template){const w=u.value.find(E=>E.template===l.templateConfig?.template);w&&T(w)}else if(l.type==="spreadsheet"&&l.spreadsheetConfig?.datasetId){const w=i.value.find(E=>E.datasetId===l.spreadsheetConfig?.datasetId);w&&T(w)}}}}return{selectedPrompt:p,trialName:v,description:y,repeatCount:k,configurations:P,creating:j,showModelSelector:L,templates:u,spreadsheets:i,variableLists:n,enabledModels:I,runningTrials:c,totalCombinations:M,totalExperiments:N,totalCost:F,canProceed:B,selectPrompt:T,generateTrialName:V,addConfiguration:t,removeConfiguration:s,getConfigCostPerCall:o,createTrialAsDraft:r,createAndStartTrial:g,initialize:m}}const ot={key:0,class:"preview-controls"},it={class:"template-name"},lt={key:0,class:"cycle-info"},rt={key:1,class:"variable-legend"},dt={class:"variable-value"},ut=Y({__name:"TemplatePreviewV3",props:{template:{},variableLists:{default:()=>[]},cycling:{type:Boolean,default:!0},cyclingSpeed:{default:1e3},showControls:{type:Boolean,default:!1},displayMode:{default:"block"},showLegend:{type:Boolean,default:!1},maxLines:{default:0}},emits:["update:paused","back-to-select"],setup(U,{emit:D}){const n=U,I=D,c=R(0),S=R(!1);let b=null;const p=["variable-highlight-blue","variable-highlight-green","variable-highlight-purple","variable-highlight-orange","variable-highlight-pink","variable-highlight-teal"],v=O(()=>n.template.type==="template"?n.template.template:n.template.type==="spreadsheet"?n.template.promptPattern:""),y=O(()=>{if(n.template.type==="spreadsheet"){const t=n.template,s=n.variableLists.find(r=>r.id===t.datasetId);return s?.category==="tabular"&&s.tabularData?.rows?s.tabularData.rows.map(r=>{const g={};return Object.keys(r).forEach(C=>{let m=C.replace(/[^a-zA-Z0-9_]/g,"_");/^[a-zA-Z]/.test(m)||(m="col_"+m),m=m.replace(/_+/g,"_").replace(/_+$/,""),g[m]=String(r[C]||"")}),g}):[]}const T=[];if(n.template.variables){for(const[t,s]of Object.entries(n.template.variables))if(s.type==="value"&&s.values)T.push({name:t,values:[...s.values]});else if(s.type==="list"&&s.listId){const r=n.variableLists.find(g=>g.id===s.listId);r&&(r.category==="simple"&&r.values?T.push({name:t,values:[...r.values]}):r.category==="attributed"&&r.items&&T.push({name:t,values:r.items.map(g=>g.value)}))}}if(T.length===0)return[];const V=t=>t.reduce((s,r)=>s.flatMap(g=>r.map(C=>[...g,C])),[[]]),o=T.map(t=>t.values);return V(o).map(t=>{const s={};return T.forEach((r,g)=>{s[r.name]=t[g]}),s})}),k=O(()=>y.value.length),P=O(()=>y.value.length===0?null:y.value[c.value]||y.value[0]),j=O(()=>{const T=v.value;if(!T)return"";const V=P.value;if(!V||Object.keys(V).length===0)return i(T).replace(/\n/g,"<br>");let o=i(T);if(Object.keys(V).sort((t,s)=>s.length-t.length).forEach((t,s)=>{const r=V[t],g=i(r),C=u(s),m=new RegExp(`{{\\s*${M(t)}\\s*}}`,"g");o=o.replace(m,`<span class="${C} variable-value">${g}</span>`)}),o=o.replace(/\n/g,"<br>"),n.maxLines>0){const t=o.split("<br>");t.length>n.maxLines&&(o=t.slice(0,n.maxLines).join("<br>")+'<br><span class="line-clamp-indicator">...</span>')}return o}),L=O(()=>n.displayMode==="inline"&&n.maxLines>0?{display:"-webkit-box","-webkit-line-clamp":n.maxLines,"-webkit-box-orient":"vertical",overflow:"hidden"}:{});function u(T){return p[T%p.length]}function i(T){const V=document.createElement("div");return V.textContent=T,V.innerHTML}function M(T){return T.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function N(){S.value=!S.value,I("update:paused",S.value)}function F(){!n.cycling||S.value||k.value<=1||(b=setInterval(()=>{c.value=(c.value+1)%k.value},n.cyclingSpeed))}function B(){b&&(clearInterval(b),b=null)}return ne(()=>{n.cycling&&!S.value&&F()}),ye(()=>{B()}),K(()=>S.value,T=>{T||!n.cycling?B():F()}),K(()=>n.cycling,T=>{T?S.value||F():(B(),c.value=0)}),K(()=>n.cyclingSpeed,()=>{n.cycling&&!S.value&&(B(),F())}),K(k,()=>{c.value=0}),(T,V)=>{const o=Z,a=le,t=be("dompurify-html");return f(),h("div",{class:ae(["template-preview",[`preview-${T.displayMode}`,{"preview-cycling":T.cycling&&!S.value}]])},[T.showControls?(f(),h("div",ot,[d(o,{type:"link",onClick:V[0]||(V[0]=s=>T.$emit("back-to-select")),class:"back-to-select"},{default:$(()=>[d(x(me)),V[1]||(V[1]=A(" Back to Select Template "))]),_:1,__:[1]}),e("h3",it,_(n.template.name),1),d(o,{onClick:N,size:"small",type:S.value?"default":"primary",disabled:!T.cycling||k.value<=1},{default:$(()=>[A(_(S.value?"Start":"Pause")+" Variable Selection ",1)]),_:1},8,["type","disabled"]),T.cycling&&k.value>1?(f(),h("span",lt,_(c.value+1)+" / "+_(k.value),1)):z("",!0),d(a,{color:n.template.type==="template"?"blue":"green",class:"source-badge"},{default:$(()=>[A(_(n.template.type==="template"?"Prompt Design":"Spreadsheet Design"),1)]),_:1},8,["color"])])):z("",!0),Ce(e("div",{class:"preview-content",style:he(L.value)},null,4),[[t,j.value,"template"]]),T.showLegend&&P.value&&Object.keys(P.value).length>0?(f(),h("div",rt,[(f(!0),h(Q,null,X(P.value,(s,r,g)=>(f(),h("div",{key:r,class:"legend-item"},[e("span",{class:ae(u(g))},_(r),3),e("span",dt,_(s),1)]))),128))])):z("",!0)],2)}}}),se=G(ut,[["__scopeId","data-v-499c064e"]]),ct={class:"design-selection"},pt={class:"design-selector","data-testid":"template-design-selector"},mt={key:0,class:"no-designs-state"},vt={class:"no-designs-content"},ft={key:1,class:"no-designs-state"},gt={class:"no-designs-content"},_t={key:2,class:"design-list","data-testid":"design-list"},yt=["data-template-id","data-template-name","onClick"],Ct={class:"design-header"},bt={class:"design-title-section"},ht={class:"design-name"},kt={key:0,class:"design-inline-description"},$t={class:"design-date"},Tt={class:"design-stats"},wt={class:"stat-item"},It={class:"stat-value"},St={class:"stat-item"},Pt={class:"stat-value"},xt={class:"stat-item"},Dt={class:"stat-value"},Mt={class:"design-selector","data-testid":"spreadsheet-design-selector"},Et={key:0,class:"no-designs-state"},Nt={class:"no-designs-content"},At={key:1,class:"design-list","data-testid":"design-list"},Lt=["data-spreadsheet-id","data-spreadsheet-name","onClick"],Ot={class:"design-header"},Vt={class:"design-title-section"},zt={class:"design-name"},Rt={key:0,class:"design-inline-description"},jt={class:"design-date"},Ft={class:"design-stats"},Bt={class:"stat-item"},Ut={class:"stat-value"},qt={class:"stat-item"},Jt={class:"stat-value"},Ht={class:"stat-item"},Wt={class:"stat-value"},Kt=Y({__name:"TrialDesignSelectionV3",props:{templates:{},spreadsheets:{},variableLists:{}},emits:["select","create-template","create-spreadsheet"],setup(U){const D=De(),n=U,I=R("template"),c=R(""),S=R(""),b=O(()=>{if(!c.value)return n.templates;const u=c.value.toLowerCase();return n.templates.filter(i=>i.name.toLowerCase().includes(u)||(i.description||"").toLowerCase().includes(u))}),p=O(()=>{if(!S.value)return n.spreadsheets;const u=S.value.toLowerCase();return n.spreadsheets.filter(i=>i.name.toLowerCase().includes(u)||(i.description||"").toLowerCase().includes(u))});function v(u){const i=typeof u=="string"?new Date(u):u,N=new Date().getTime()-i.getTime(),F=Math.floor(N/(1e3*60*60*24));if(F===0){const B=Math.floor(N/36e5);if(B===0){const T=Math.floor(N/6e4);return T<=1?"just now":`${T} min ago`}return B===1?"1 hour ago":`${B} hours ago`}else return F===1?"yesterday":F<7?`${F} days ago`:i.toLocaleDateString("en-US",{month:"short",day:"numeric"})}function y(u){return u.variables?Object.keys(u.variables).length:0}function k(u){if(!u.variables)return 1;let i=1;for(const[,M]of Object.entries(u.variables))if(M.type==="value"&&M.values)i*=M.values.length;else if(M.type==="list"&&M.listId){const N=n.variableLists.find(F=>F.id===M.listId);N&&(N.category==="simple"?i*=N.values?.length||0:N.category==="attributed"?i*=N.items?.length||0:N.category==="tabular"&&(i*=N.itemCount||0))}return i}function P(u){return n.variableLists.find(M=>M.id===u.datasetId)?.itemCount||0}function j(u){const i=n.variableLists.find(M=>M.id===u.datasetId);return i?.category==="tabular"&&i.tabularData?.columns?i.tabularData.columns.length:0}function L(u){if(!u)return"???";try{if("template"in u&&u.template)return`~${D.estimateTokens(u.template)}`;if("promptPattern"in u&&u.promptPattern)return`~${D.estimateTokens(u.promptPattern)}`}catch(i){q.warn("Failed to estimate tokens:",i)}return"???"}return(u,i)=>{const M=ve,N=Ve,F=Z,B=le,T=Oe,V=Le;return f(),h("div",ct,[d(V,{activeKey:I.value,"onUpdate:activeKey":i[6]||(i[6]=o=>I.value=o),size:"large"},{default:$(()=>[d(T,{key:"template",tab:"Prompt Designs (one API call per combination)"},{default:$(()=>[e("div",pt,[d(M,{value:c.value,"onUpdate:value":i[0]||(i[0]=o=>c.value=o),placeholder:"Search prompt designs...",size:"large",class:"design-search","data-testid":"input-template-search",allowClear:""},{prefix:$(()=>[d(x(ce))]),_:1},8,["value"]),!u.templates||u.templates.length===0?(f(),h("div",mt,[e("div",vt,[d(N,{size:"large",tip:"Loading templates..."})])])):b.value.length===0?(f(),h("div",ft,[e("div",gt,[i[8]||(i[8]=e("p",null,"No prompt designs found",-1)),d(F,{type:"primary",onClick:i[1]||(i[1]=o=>u.$emit("create-template"))},{default:$(()=>[d(x(ze)),i[7]||(i[7]=A(" Create Prompt Design "))]),_:1,__:[7]})])])):(f(),h("div",_t,[(f(!0),h(Q,null,X(b.value,o=>(f(),h("div",{key:o.id,class:"design-item","data-testid":"template-item","data-template-id":o.id,"data-template-name":o.name,onClick:a=>u.$emit("select",o)},[e("div",Ct,[e("div",bt,[e("h4",ht,[A(_(o.name)+" ",1),o.description?(f(),h("span",kt,"- "+_(o.description),1)):z("",!0)])]),e("span",$t,_(v(o.updated)),1)]),d(se,{template:o,"variable-lists":u.variableLists,cycling:!0,"show-controls":!1,"display-mode":"inline","max-lines":5,class:"design-preview"},null,8,["template","variable-lists"]),e("div",Tt,[d(B,{size:"small",color:"blue",class:"output-type-tag"},{default:$(()=>[A(_(o.outputType||"text"),1)]),_:2},1024),e("span",wt,[e("span",It,_(y(o)),1),i[9]||(i[9]=e("span",{class:"stat-label"},"vars",-1))]),i[12]||(i[12]=e("span",{class:"stat-divider"},"•",-1)),e("span",St,[e("span",Pt,_(k(o)),1),i[10]||(i[10]=e("span",{class:"stat-label"},"combos",-1))]),i[13]||(i[13]=e("span",{class:"stat-divider"},"•",-1)),e("span",xt,[e("span",Dt,_(L(o)),1),i[11]||(i[11]=e("span",{class:"stat-label"},"tokens",-1))])])],8,yt))),128)),e("div",{class:"design-item design-item-create","data-testid":"btn-create-design",onClick:i[2]||(i[2]=o=>u.$emit("create-template"))},[d(x(ee),{style:{"font-size":"24px"}}),i[14]||(i[14]=e("span",null,"Create New Design",-1))])]))])]),_:1}),d(T,{key:"spreadsheet",tab:"Spreadsheet Designs (one API call per row)"},{default:$(()=>[e("div",Mt,[d(M,{value:S.value,"onUpdate:value":i[3]||(i[3]=o=>S.value=o),placeholder:"Search spreadsheet designs...",size:"large",class:"design-search","data-testid":"input-spreadsheet-search",allowClear:""},{prefix:$(()=>[d(x(ce))]),_:1},8,["value"]),p.value.length===0?(f(),h("div",Et,[e("div",Nt,[i[16]||(i[16]=e("p",null,"No spreadsheet designs found",-1)),d(F,{type:"primary",onClick:i[4]||(i[4]=o=>u.$emit("create-spreadsheet"))},{default:$(()=>[d(x(Re)),i[15]||(i[15]=A(" Create Spreadsheet Design "))]),_:1,__:[15]})])])):(f(),h("div",At,[(f(!0),h(Q,null,X(p.value,o=>(f(),h("div",{key:o.id,class:"design-item","data-testid":"spreadsheet-item","data-spreadsheet-id":o.id,"data-spreadsheet-name":o.name,onClick:a=>u.$emit("select",o)},[e("div",Ot,[e("div",Vt,[e("h4",zt,[A(_(o.name)+" ",1),o.description?(f(),h("span",Rt,"- "+_(o.description),1)):z("",!0)])]),e("span",jt,_(v(o.updated)),1)]),d(se,{template:o,"variable-lists":u.variableLists,cycling:!0,"show-controls":!1,"display-mode":"inline","max-lines":5,class:"design-preview"},null,8,["template","variable-lists"]),e("div",Ft,[d(B,{size:"small",color:"green",class:"output-type-tag"},{default:$(()=>[A(_(o.outputType||"text"),1)]),_:2},1024),e("span",Bt,[e("span",Ut,_(P(o)),1),i[17]||(i[17]=e("span",{class:"stat-label"},"rows",-1))]),i[20]||(i[20]=e("span",{class:"stat-divider"},"•",-1)),e("span",qt,[e("span",Jt,_(j(o)),1),i[18]||(i[18]=e("span",{class:"stat-label"},"cols",-1))]),i[21]||(i[21]=e("span",{class:"stat-divider"},"•",-1)),e("span",Ht,[e("span",Wt,_(L(o)),1),i[19]||(i[19]=e("span",{class:"stat-label"},"tokens",-1))])])],8,Lt))),128)),e("div",{class:"design-item design-item-create","data-testid":"btn-create-spreadsheet",onClick:i[5]||(i[5]=o=>u.$emit("create-spreadsheet"))},[d(x(ee),{style:{"font-size":"24px"}}),i[22]||(i[22]=e("span",null,"Create New Spreadsheet Design",-1))])]))])]),_:1})]),_:1},8,["activeKey"])])}}}),Yt=G(Kt,[["__scopeId","data-v-db101528"]]),Gt={class:"trial-metadata-form"},Zt=Y({__name:"TrialMetadataV3",props:{name:{},repeatCount:{default:1},description:{default:""},totalCombinations:{default:0}},emits:["update:name","update:repeatCount","update:description"],setup(U,{emit:D}){const n=U,I=D,c=ke({name:n.name,repeatCount:n.repeatCount,description:n.description||""}),S=O(()=>{if(n.totalCombinations>0&&c.repeatCount>1){const p=n.totalCombinations*c.repeatCount;return`Each prompt will be run ${c.repeatCount} times (${p} total calls)`}return"Number of times to run each prompt"});function b(){I("update:name",c.name),I("update:repeatCount",c.repeatCount),I("update:description",c.description)}return K(()=>n.name,p=>{c.name=p}),K(()=>n.repeatCount,p=>{c.repeatCount=p}),K(()=>n.description,p=>{c.description=p||""}),(p,v)=>{const y=ve,k=Ue,P=Be,j=qe,L=Fe,u=Je,i=je;return f(),h("div",Gt,[d(i,{layout:"vertical",model:c},{default:$(()=>[d(L,{gutter:24},{default:$(()=>[d(P,{span:18},{default:$(()=>[d(k,{label:"Trial Name",rules:[{required:!0,message:"Please enter a trial name"}]},{default:$(()=>[d(y,{value:c.name,"onUpdate:value":v[0]||(v[0]=M=>c.name=M),size:"large",placeholder:"e.g., GPT-4 Performance Test",onChange:b},null,8,["value"])]),_:1})]),_:1}),d(P,{span:6},{default:$(()=>[d(k,{label:"Repeat Count",help:S.value},{default:$(()=>[d(j,{value:c.repeatCount,"onUpdate:value":v[1]||(v[1]=M=>c.repeatCount=M),min:1,max:100,size:"large",style:{width:"100%"},onChange:b},null,8,["value"])]),_:1},8,["help"])]),_:1})]),_:1}),d(k,{label:"Description (Optional)"},{default:$(()=>[d(u,{value:c.description,"onUpdate:value":v[2]||(v[2]=M=>c.description=M),placeholder:"Add any notes about this trial...",rows:2,onChange:b},null,8,["value"])]),_:1})]),_:1},8,["model"])])}}}),Qt=G(Zt,[["__scopeId","data-v-b945eb57"]]),Xt={class:"model-configuration"},ea={key:0,class:"quick-add-section"},ta={class:"quick-add-models"},aa={class:"provider-name"},sa={class:"model-name"},na={key:0,class:"param-info"},oa={class:"configuration-table"},ia={class:"table-header"},la={style:{display:"inline-flex","align-items":"center",gap:"0"}},ra={key:0,class:"model-name-cell"},da={class:"model-name"},ua={class:"model-id"},ca={key:1,class:"parameter-tags"},pa={key:2,class:"cost-cell"},ma={class:"cost-value"},va={key:0,class:"cost-summary"},fa={class:"cost-summary-item"},ga={class:"cost-summary-item"},_a={class:"total-cost"},ya=Y({__name:"ModelConfigurationV3",props:{configurations:{},totalCombinations:{},repeatCount:{},tokenData:{}},emits:["add-configuration","remove-configuration"],setup(U,{emit:D}){const n=U,I=D,{models:c}=oe(),{trials:S}=ie(),{estimateTotalCost:b,multiplyEstimate:p}=re(),v=R(!1),y=O(()=>{const a=new Map;if(S.value&&S.value.length>0){const C=S.value.filter(m=>m.status!=="draft").slice(0,10);for(const m of C)if(m.configurations){for(const l of m.configurations){const w=JSON.stringify(l.parameters||{}),E=`${l.provider}-${l.modelId}-${w}`;if(a.has(E)||a.set(E,l),a.size>=15)break}if(a.size>=15)break}}const t=new Set(n.configurations.map(C=>{const m=JSON.stringify(C.parameters||{});return`${C.provider}-${C.modelId}-${m}`})),s=Array.from(a.values()).filter(C=>{const m=JSON.stringify(C.parameters||{}),l=`${C.provider}-${C.modelId}-${m}`;if(t.has(l))return!1;const w=c.value?.find(E=>E.provider===C.provider&&E.modelId===C.modelId);return!(!w||!w.enabled)}),r=[{provider:"openai-chat",modelId:"gpt-4o-mini",params:{temperature:0,max_completion_tokens:1e3}},{provider:"openai-chat",modelId:"gpt-4.1-nano",params:{temperature:0,max_completion_tokens:500}},{provider:"anthropic",modelId:"claude-3-5-haiku-latest",params:{temperature:0,max_tokens:1e3}},{provider:"openrouter",modelId:"meta-llama/llama-4-maverick",params:{temperature:.8,max_tokens:2e3,provider:{require_parameters:!0}}},{provider:"openrouter",modelId:"mistralai/mistral-nemo",params:{temperature:.7,max_tokens:1500,provider:{require_parameters:!0}}},{provider:"ollama-generate",modelId:"qwen2.5:0.5b",params:{temperature:0,num_predict:500,stream:!1}},{provider:"ollama-generate",modelId:"llama3.2:1b",params:{temperature:0,num_predict:1e3,stream:!1}}],g=[];for(const C of r){const m=JSON.stringify(C.params),l=`${C.provider}-${C.modelId}-${m}`;if(!t.has(l)&&!a.has(l)){const w=c.value?.find(E=>E.provider===C.provider&&E.modelId===C.modelId);w&&w.enabled&&g.push({provider:C.provider,modelId:C.modelId,parameters:C.params,providerSnapshot:{},modelSnapshot:w})}}return[...s,...g].slice(0,10)}),k=[{title:"Model",key:"name",width:"35%"},{title:"Parameters",key:"parameters",width:"35%"},{title:"Cost",key:"cost",width:"20%"},{title:"",key:"actions",width:"10%"}],P=O(()=>n.configurations.map((a,t)=>({key:`${a.provider}-${a.modelId}-${t}`,...a}))),j=O(()=>n.totalCombinations*n.configurations.length*n.repeatCount),L=O(()=>n.tokenData?n.configurations.reduce((a,t)=>{const s=c.value?.find(C=>C.provider===t.provider&&C.modelId===t.modelId);if(!s)return a;const r=b(n.tokenData.totalTokens,n.tokenData.combinationCount,s,t.parameters),g=n.repeatCount>1?p(r,n.repeatCount):r;return a+g.cost.total.expected},0):0);function u(a){if(!n.tokenData)return"?? (no token data)";const t=c.value?.find(l=>l.provider===a.provider&&l.modelId===a.modelId);if(!t)return"?? (model not found)";const s=b(n.tokenData.totalTokens,n.tokenData.combinationCount,t,a.parameters);if(!s.meta.hasValidCost||s.cost.total.expected===-1)return"?? (no pricing data)";const r=n.repeatCount>1?p(s,n.repeatCount):s,g=r.cost.total.min,C=r.cost.total.max,m=r.cost.total.expected;return Math.abs(C-g)<1e-4?`$${i(m)}`:`$${i(g)}-$${i(C)}`}function i(a){if(a===0)return"0.00";if(a<.01){let t=2,s=a;for(;s<.1;)s*=10,t++;return a.toFixed(t)}return a<1?a.toFixed(3):a<10?a.toFixed(2):a<100?a.toFixed(1):Math.round(a).toLocaleString()}function M(a){const t={},s=["temperature","max_tokens","max_completion_tokens","num_predict","maxTokens","top_p","top_k","reasoning_effort"];for(const r of s)a[r]!==void 0&&a[r]!==null&&(t[r]=a[r]);for(const[r,g]of Object.entries(a))g!=null&&!s.includes(r)&&(t[r]=g);return t}function N(a){return a.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase())}function F(a){if(!a||Object.keys(a).length===0)return"";const t=[];return a.temperature!==void 0&&t.push(`T:${a.temperature}`),a.max_tokens!==void 0?t.push(`${a.max_tokens}t`):a.maxTokens!==void 0?t.push(`${a.maxTokens}t`):a.num_predict!==void 0&&t.push(`${a.num_predict}t`),a.top_p!==void 0&&t.push(`p:${a.top_p}`),t.length>0?`(${t.join(", ")})`:""}function B(a){const t=Me.validateParameters(a.provider,a.modelId,a.parameters||{});if(!t.valid){q.error("Quick Add validation failed:",{provider:a.provider,modelId:a.modelId,parameters:a.parameters,errors:t.errors}),alert(`Cannot add model configuration: ${t.errors?.join(", ")||"Invalid parameters"}`);return}const s={name:a.modelSnapshot?.displayName||a.modelId,provider:a.provider,modelId:a.modelId,parameters:{...a.parameters}};I("add-configuration",s),V()}function T(a){I("add-configuration",a),v.value=!1,V()}async function V(){await $e(),requestAnimationFrame(()=>{const a=[".step-content",".creation-content",".trial-configuration",".trial-creation-content"];let t=!1;for(const s of a){const r=document.querySelector(s);if(r&&r.scrollHeight>r.clientHeight){`${s}${r.scrollHeight}`,r.scrollTop=r.scrollHeight,t=!0;break}}t||setTimeout(()=>{const s=document.querySelector(".step-content")||document.querySelector(".creation-content");s?(`${s.scrollHeight}`,s.scrollTop=s.scrollHeight):q.warn("No scrollable container found")},100)})}function o(a){I("remove-configuration",a)}return(a,t)=>{const s=Z,r=He,g=le,C=We;return f(),h("div",Xt,[y.value.length>0?(f(),h("div",ea,[t[2]||(t[2]=e("h4",null,"Quick Add Recent Models",-1)),e("div",ta,[(f(!0),h(Q,null,X(y.value,m=>(f(),W(s,{key:`${m.provider}-${m.modelId}-${JSON.stringify(m.parameters)}`,size:"small",onClick:l=>B(m),class:"quick-add-button",title:`Add ${m.modelSnapshot?.displayName||m.modelId} (${m.provider}) with recent parameters`},{default:$(()=>[d(x(ee)),e("span",aa,_(m.provider)+"/",1),e("span",sa,_(m.modelSnapshot?.displayName||m.modelId),1),F(m.parameters)?(f(),h("span",na,_(F(m.parameters)),1)):z("",!0)]),_:2},1032,["onClick","title"]))),128))])])):z("",!0),e("div",oa,[e("div",ia,[e("h3",la,[d(r,{placement:"topLeft"},{title:$(()=>t[3]||(t[3]=[A(" Add models to test with your template and configure their parameters like temperature, max tokens, etc. ")])),default:$(()=>[t[4]||(t[4]=e("span",null,"Model Configurations to Test",-1))]),_:1,__:[4]}),t[6]||(t[6]=e("span",null,"  ",-1)),d(s,{type:"primary",size:"small",onClick:t[0]||(t[0]=m=>v.value=!0)},{default:$(()=>[d(x(ee)),t[5]||(t[5]=A(" Add Model "))]),_:1,__:[5]})])]),d(C,{columns:k,"data-source":P.value,pagination:!1,locale:{emptyText:"No models configured. Add at least one model to proceed."},"row-key":"key"},{bodyCell:$(({column:m,record:l,index:w})=>[m.key==="name"?(f(),h("div",ra,[e("span",da,_(l.name),1),e("span",ua,_(l.provider)+":"+_(l.modelId),1)])):m.key==="parameters"?(f(),h("div",ca,[(f(!0),h(Q,null,X(M(l.parameters),(E,J)=>(f(),W(g,{key:J},{default:$(()=>[A(_(N(J))+": "+_(E),1)]),_:2},1024))),128))])):m.key==="cost"?(f(),h("div",pa,[e("span",ma,_(u(l)),1),t[7]||(t[7]=e("span",{class:"cost-label"},"total trial cost",-1))])):m.key==="actions"?(f(),W(s,{key:3,type:"text",danger:"",size:"small",onClick:E=>o(w)},{default:$(()=>[d(x(Ke))]),_:2},1032,["onClick"])):z("",!0)]),_:1},8,["data-source"]),a.configurations.length>0?(f(),h("div",va,[e("div",fa,[t[8]||(t[8]=e("span",null,"Total experiments:",-1)),e("strong",null,_(j.value),1)]),e("div",ga,[t[9]||(t[9]=e("span",null,"Estimated total cost:",-1)),e("strong",_a,"$"+_(i(L.value)),1)])])):z("",!0)]),d(st,{visible:v.value,"onUpdate:visible":t[1]||(t[1]=m=>v.value=m),mode:"trial","trial-context":{totalCombinations:a.totalCombinations,tokenData:a.tokenData??null},"existing-configurations":a.configurations,onAddConfiguration:T},null,8,["visible","trial-context","existing-configurations"])])}}}),Ca=G(ya,[["__scopeId","data-v-67e13ee2"]]),ba={class:"trial-configuration"},ha={class:"configuration-sections"},ka={class:"config-section"},$a={class:"config-section"},Ta=["aria-expanded"],wa={class:"section-title"},Ia={class:"expand-hint"},Sa={key:0,class:"design-info"},Pa={class:"design-stats"},xa={class:"stat"},Da={class:"stat-value"},Ma={class:"stat"},Ea={class:"stat-value"},Na={class:"config-section"},Aa=Y({__name:"TrialConfiguration",setup(U){const D=Te("trialCreation"),{calculateTemplateTokens:n,calculatePromptTokens:I}=re(),c=R(!1),S=R(!1),b=O(()=>D.selectedPrompt.value),p=O(()=>{const v=b.value;if(!v)return null;try{if(v.type==="template"){const y=v.template,k=v.variables,P=D.variableLists?.value;return y?n(y,k||{},P||[]):null}else if(v.type==="spreadsheet"){const y=v.promptPattern;if(!y)return null;const k=I(y),P=D.totalCombinations.value;return{totalTokens:k*P,combinationCount:P,perCallAverage:k}}else return null}catch(y){return q.error("Error calculating tokenData:",y),null}});return(v,y)=>(f(),h("div",ba,[e("div",ha,[e("section",ka,[y[6]||(y[6]=e("h2",{class:"section-title"},"Trial Details",-1)),d(Qt,{name:x(D).trialName.value,"repeat-count":x(D).repeatCount.value,description:x(D).description?.value||"","total-combinations":x(D).totalCombinations.value,"onUpdate:name":y[0]||(y[0]=k=>x(D).trialName.value=k),"onUpdate:repeatCount":y[1]||(y[1]=k=>x(D).repeatCount.value=k),"onUpdate:description":y[2]||(y[2]=k=>x(D).description.value=k)},null,8,["name","repeat-count","description","total-combinations"])]),e("section",$a,[e("button",{class:"collapsible-header",onClick:y[3]||(y[3]=k=>c.value=!c.value),"aria-expanded":c.value},[d(x(Ye),{class:ae([{expanded:c.value},"expand-icon"])},null,8,["class"]),e("h2",wa,[y[7]||(y[7]=A("Selected Design Preview ")),e("span",Ia,"(click to "+_(c.value?"collapse":"expand")+")",1)])],8,Ta),c.value?(f(),h("div",Sa,[d(se,{template:b.value,"variable-lists":x(D).variableLists.value,cycling:S.value,"show-controls":!0,"display-mode":"block","show-legend":!0,"onUpdate:paused":y[4]||(y[4]=k=>S.value=!k),onBackToSelect:y[5]||(y[5]=k=>v.$emit("back"))},null,8,["template","variable-lists","cycling"]),e("div",Pa,[e("div",xa,[y[8]||(y[8]=e("span",{class:"stat-label"},"Total Combinations:",-1)),e("span",Da,_(x(D).totalCombinations.value),1)]),e("div",Ma,[y[9]||(y[9]=e("span",{class:"stat-label"},"Total Input Tokens:",-1)),e("span",Ea,_(p.value!==null?`${p.value.totalTokens.toLocaleString()} total (${p.value.combinationCount.toLocaleString()} calls)`:"??"),1)])])])):z("",!0)]),e("section",Na,[y[10]||(y[10]=e("h2",{class:"section-title"},"Add Models and Set Parameters",-1)),d(Ca,{configurations:x(D).configurations.value,"total-combinations":x(D).totalCombinations.value,"repeat-count":x(D).repeatCount.value,"token-data":p.value,onAddConfiguration:x(D).addConfiguration,onRemoveConfiguration:x(D).removeConfiguration},null,8,["configurations","total-combinations","repeat-count","token-data","onAddConfiguration","onRemoveConfiguration"])])])]))}}),La=G(Aa,[["__scopeId","data-v-794621cc"]]),Oa={class:"trial-submission"},Va={class:"review-section"},za={class:"summary-card"},Ra={class:"summary-item"},ja={class:"value"},Fa={class:"summary-item"},Ba={class:"value"},Ua={class:"summary-item"},qa={class:"value"},Ja={key:0,class:"summary-item"},Ha={class:"value"},Wa={key:1,class:"summary-item"},Ka={class:"value"},Ya={class:"summary-item"},Ga={class:"value"},Za={key:2,class:"summary-item"},Qa={class:"value"},Xa={class:"summary-item"},es={class:"value highlight"},ts={key:3,class:"summary-item"},as={key:0,class:"value highlight"},ss={key:1,class:"value"},ns={class:"configurations-review"},os={class:"config-header"},is={class:"config-name"},ls={class:"config-model"},rs={class:"config-params"},ds={key:0,class:"running-trials-warning"},us={class:"action-buttons"},cs={key:0},ps={key:1},ms={key:2},vs=Y({__name:"TrialSubmission",props:{trialConfig:{},design:{}},emits:["back","create-draft","create-and-start","export-python"],setup(U,{emit:D}){const n=U,I=D,{runningTrials:c}=ie(),{variableLists:S}=pe(),{models:b}=oe(),{calculateTemplateTokens:p,calculatePromptTokens:v,estimateTotalCost:y,sumEstimates:k}=re(),P=R(null),j=R(!1),L=R(!1),u=O(()=>c.value.length>0),i=O(()=>c.value.length),M=O(()=>{if(!n.trialConfig.configurations)return 0;let t=1;if(n.design.type==="template"&&n.design.variables)for(const[,r]of Object.entries(n.design.variables)){const g=r;if(g.type==="value"&&g.values)t*=g.values.length;else if(g.type==="list"&&g.listId){const C=S.value?.find(m=>m.id===g.listId);C&&(C.category==="simple"?t*=C.values?.length||0:C.category==="attributed"?t*=C.items?.length||0:C.category==="tabular"&&(t*=C.itemCount||0))}}else n.design.type==="spreadsheet"&&(t=S.value?.find(g=>g.id===n.design.datasetId)?.itemCount||0);const s=n.trialConfig.repeatCount||1;return t*n.trialConfig.configurations.length*s}),N=O(()=>{if(!n.trialConfig.configurations||n.trialConfig.configurations.length===0)return-1;let t=null;if(n.design.type==="template"){const g=n.trialConfig.templateConfig?.template||n.design.template||"",C=n.trialConfig.templateConfig?.variables||n.design.variables||{};t=p(g,C,S.value)}else if(n.design.type==="spreadsheet"){const g=n.trialConfig.spreadsheetConfig?.promptPattern||n.design.promptPattern||"",C=v(g),m=M.value/n.trialConfig.configurations.length;t={totalTokens:C*m,combinationCount:m,perCallAverage:C}}if(!t||t.totalTokens===0)return q.error("TrialSubmission: No prompt content found for cost estimation",{type:n.design.type,hasTemplate:!!n.trialConfig.templateConfig?.template||!!n.design.template,hasPromptPattern:!!n.trialConfig.spreadsheetConfig?.promptPattern||!!n.design.promptPattern}),-1;const s=n.trialConfig.configurations.map(g=>{const C=b.value?.find(m=>m.provider===g.provider&&m.modelId===g.modelId);return C?y(t.totalTokens,t.combinationCount,C,g.parameters):null}).filter(Boolean);return s.length===0?-1:k(s).cost.total.expected});function F(t){const s=[];"temperature"in t&&s.push(`temperature=${t.temperature}`),"max_tokens"in t&&s.push(`max_tokens=${t.max_tokens}`),"top_p"in t&&s.push(`top_p=${t.top_p}`);const r=Object.keys(t).length-s.length;return r>0&&s.push(`+${r} more`),s.join(", ")}function B(){return{name:n.trialConfig.name||"",description:n.trialConfig.description,type:n.design.type,configurations:n.trialConfig.configurations||[],repeatCount:n.trialConfig.repeatCount||1,templateConfig:n.trialConfig.templateConfig,spreadsheetConfig:n.trialConfig.spreadsheetConfig}}async function T(){P.value="draft";try{const t=B();I("create-draft",t)}finally{P.value=null}}async function V(){j.value=!0;try{const t=B();I("export-python",t)}finally{j.value=!1}}function o(){u.value||N.value>10&&N.value!==-1?L.value=!0:a()}async function a(){L.value=!1,P.value="start";try{const t=B();I("create-and-start",t)}finally{P.value=null}}return(t,s)=>{const r=Z,g=Ge,C=fe;return f(),h("div",Oa,[d(r,{type:"link",onClick:s[0]||(s[0]=m=>t.$emit("back")),class:"back-button"},{default:$(()=>[d(x(Ze)),s[3]||(s[3]=A(" Back to Configuration "))]),_:1,__:[3]}),e("div",Va,[s[15]||(s[15]=e("h2",null,"Review & Create Trial",-1)),e("div",za,[s[13]||(s[13]=e("h3",null,"Trial Summary",-1)),e("div",Ra,[s[4]||(s[4]=e("span",{class:"label"},"Name:",-1)),e("span",ja,_(t.trialConfig.name),1)]),e("div",Fa,[s[5]||(s[5]=e("span",{class:"label"},"Type:",-1)),e("span",Ba,_(t.design.type==="template"?"Template":"Spreadsheet"),1)]),e("div",Ua,[s[6]||(s[6]=e("span",{class:"label"},"Design:",-1)),e("span",qa,_(t.design.name),1)]),t.design.type==="template"?(f(),h("div",Ja,[s[7]||(s[7]=e("span",{class:"label"},"Variables:",-1)),e("span",Ha,_(Object.keys(t.design.variables||{}).length)+" variables configured ",1)])):z("",!0),t.design.type==="spreadsheet"?(f(),h("div",Wa,[s[8]||(s[8]=e("span",{class:"label"},"Dataset:",-1)),e("span",Ka,_(t.design.rowCount)+" rows",1)])):z("",!0),e("div",Ya,[s[9]||(s[9]=e("span",{class:"label"},"Model Configurations:",-1)),e("span",Ga,_(t.trialConfig.configurations?.length||0)+" models",1)]),t.trialConfig.repeatCount&&t.trialConfig.repeatCount>1?(f(),h("div",Za,[s[10]||(s[10]=e("span",{class:"label"},"Repeat Count:",-1)),e("span",Qa,_(t.trialConfig.repeatCount)+" times per prompt",1)])):z("",!0),e("div",Xa,[s[11]||(s[11]=e("span",{class:"label"},"Total API Calls:",-1)),e("span",es,_(M.value),1)]),N.value!==-1?(f(),h("div",ts,[s[12]||(s[12]=e("span",{class:"label"},"Estimated Cost:",-1)),N.value>0?(f(),h("span",as,"$"+_(N.value.toFixed(4)),1)):(f(),h("span",ss,"Unable to estimate (no prompt content)"))])):z("",!0)]),e("div",ns,[s[14]||(s[14]=e("h3",null,"Model Configurations",-1)),(f(!0),h(Q,null,X(t.trialConfig.configurations,(m,l)=>(f(),h("div",{key:`review-config-${l}`,class:"config-review-item"},[e("div",os,[e("span",is,_(m.name||m.modelId),1),e("span",ls,_(m.provider)+":"+_(m.modelId),1)]),e("div",rs,_(F(m.parameters)),1)]))),128))]),u.value?(f(),h("div",ds,[d(g,{message:"Running Trials Detected",description:`You have ${i.value} trial(s) currently running. Starting a new trial may affect performance.`,type:"warning","show-icon":""},null,8,["description"])])):z("",!0)]),e("div",us,[d(r,{size:"large",onClick:T,loading:P.value==="draft"},{default:$(()=>[d(x(ge)),s[16]||(s[16]=A(" Create as Draft "))]),_:1,__:[16]},8,["loading"]),d(r,{size:"large",onClick:V,loading:j.value},{default:$(()=>[d(x(Qe)),s[17]||(s[17]=A(" Export to Python "))]),_:1,__:[17]},8,["loading"]),d(r,{type:"primary",size:"large",onClick:o,loading:P.value==="start"},{default:$(()=>[d(x(Xe)),s[18]||(s[18]=A(" Create and Start "))]),_:1,__:[18]},8,["loading"])]),d(C,{visible:L.value,"onUpdate:visible":s[1]||(s[1]=m=>L.value=m),title:"Confirm Trial Creation",onOk:a,onCancel:s[2]||(s[2]=m=>L.value=!1)},{default:$(()=>[s[19]||(s[19]=e("p",null,"You are about to create and start a trial with:",-1)),e("ul",null,[e("li",null,_(M.value)+" API calls",1),N.value>0?(f(),h("li",cs,"Estimated cost: $"+_(N.value.toFixed(4)),1)):N.value===-1?(f(),h("li",ps,"Cost estimation unavailable")):z("",!0),u.value?(f(),h("li",ms,_(i.value)+" other trial(s) running",1)):z("",!0)]),s[20]||(s[20]=e("p",null,"Do you want to proceed?",-1))]),_:1,__:[19,20]},8,["visible"])])}}}),fs=G(vs,[["__scopeId","data-v-b8e71998"]]),gs={class:"conflict-content"},_s={class:"warning-section"},ys={class:"warning-text"},Cs={class:"trial-info"},bs={class:"summary-grid"},hs={class:"summary-item"},ks={class:"value"},$s={class:"summary-item"},Ts={class:"value"},ws={key:0,class:"summary-item"},Is={class:"value"},Ss={class:"modal-footer"},Ps=Y({__name:"TrialConflictModal",props:{visible:{type:Boolean},runningTrial:{},trialConfig:{},totalApiCalls:{},estimatedCost:{}},emits:["update:visible","cancel","create-draft"],setup(U,{emit:D}){const n=U,I=D,c=R(!1);function S(){I("update:visible",!1),I("cancel")}async function b(){if(n.trialConfig){c.value=!0;try{I("create-draft",n.trialConfig),I("update:visible",!1)}finally{c.value=!1}}}return(p,v)=>{const y=Z,k=fe;return f(),W(k,{visible:p.visible,title:"Running Trial Detected",closable:!1,"mask-closable":!1,width:"600px",onCancel:S},{footer:$(()=>[e("div",Ss,[d(y,{onClick:S,disabled:c.value},{default:$(()=>v[8]||(v[8]=[A(" Cancel ")])),_:1,__:[8]},8,["disabled"]),d(y,{type:"primary",onClick:b,loading:c.value},{default:$(()=>[d(x(ge)),v[9]||(v[9]=A(" Create Draft "))]),_:1,__:[9]},8,["loading"])])]),default:$(()=>[e("div",gs,[e("div",_s,[d(x(et),{class:"warning-icon"}),e("div",ys,[v[2]||(v[2]=e("h3",null,"Another trial is currently running",-1)),e("p",null,[v[0]||(v[0]=A(' The trial "')),e("strong",null,_(p.runningTrial?.name),1),v[1]||(v[1]=A('" is currently executing. You can only run one trial at a time. '))])])]),v[7]||(v[7]=e("div",{class:"message-section"},[e("p",null,"You can only run one trial at a time. Your new trial will be saved as a draft and you can start it manually after the current trial finishes, or you can pause or cancel the running trial, then start your new draft trial.")],-1)),e("div",Cs,[v[6]||(v[6]=e("h4",null,"New Trial Summary:",-1)),e("div",bs,[e("div",hs,[v[3]||(v[3]=e("span",{class:"label"},"Name:",-1)),e("span",ks,_(p.trialConfig?.name),1)]),e("div",$s,[v[4]||(v[4]=e("span",{class:"label"},"API Calls:",-1)),e("span",Ts,_(p.totalApiCalls),1)]),p.estimatedCost>0?(f(),h("div",ws,[v[5]||(v[5]=e("span",{class:"label"},"Estimated Cost:",-1)),e("span",Is,"$"+_(p.estimatedCost.toFixed(4)),1)])):z("",!0)])])])]),_:1},8,["visible"])}}}),xs=G(Ps,[["__scopeId","data-v-6c2d242e"]]),Ds={class:"trial-creation-content"},Ms={class:"step-content"},Es={key:1,class:"modal-footer"},Ns={key:2,class:"create-actions"},As={key:2,class:"view-footer"},Ls={key:0,class:"validation-errors"},Os={class:"create-actions"},Vs=Y({__name:"TrialCreationContent",props:{mode:{},initialData:{}},emits:["cancel","create-template","create-spreadsheet","created","created-and-started","export-python"],setup(U,{expose:D,emit:n}){const I=U,c=n,S=O(()=>({type:I.initialData?.type||"create",sourceTrialId:I.initialData?.sourceTrialId})),b=nt(we(S));Ie("trialCreation",b);const p=R(0),v=R(!1),y=R(null),k=R(null),P=R(null);D({currentStep:p});const j=O(()=>{if(I.mode==="view")return b.selectedPrompt.value!==null&&b.canProceed.value&&b.configurations.value.length>0;switch(p.value){case 0:return b.selectedPrompt.value!==null;case 1:return b.canProceed.value;default:return!0}}),L=O(()=>{const o=[];return b.selectedPrompt.value||o.push("Select a template or spreadsheet"),b.configurations.value.length===0&&o.push("Add at least one model configuration"),b.trialName.value.trim()===""&&o.push("Enter a trial name"),o.join(" • ")});function u(){const o=JSON.parse(JSON.stringify(b.selectedPrompt.value));return{name:b.trialName.value,description:b.description?.value||"",type:o.type,configurations:JSON.parse(JSON.stringify(b.configurations.value)),repeatCount:b.repeatCount.value,templateConfig:o.type==="template"?{template:o.template,variables:o.variables,parserId:o.parserId,outputType:o.outputType,extractPattern:o.extractPattern,refusalWords:o.refusalWords,refusalMode:o.refusalMode,rejectRefusalWords:o.rejectRefusalWords}:void 0,spreadsheetConfig:o.type==="spreadsheet"?{promptPattern:o.promptPattern,datasetId:o.datasetId}:void 0}}function i(o){b.selectPrompt(o),I.mode==="view"&&(p.value=1)}async function M(){try{const o=await b.createTrialAsDraft();o&&c("created",o)}catch(o){q.error("Failed to create draft trial:",o)}}async function N(){try{const o=await b.createAndStartTrial();o&&(o.needsConfirmation?(y.value=u(),k.value=o.trialId,P.value="runningTrial"in o?o.runningTrial:null,v.value=!0):c("created-and-started",o.trialId))}catch(o){q.error("Failed to create and start trial:",o)}}async function F(){c("export-python",u())}function B(){V()}async function T(){try{k.value&&c("created",k.value),V()}catch(o){q.error("Failed to handle draft creation:",o)}}function V(){v.value=!1,y.value=null,k.value=null,P.value=null}return ne(async()=>{if(await b.initialize(),I.initialData?.templateId&&I.initialData?.promptSource==="template"){const o=()=>{const a=b.templates.value.find(t=>t.id===I.initialData?.templateId);return a?(b.selectPrompt(a),p.value=1,!0):!1};if(!o()){const a=K(()=>b.templates.value,()=>{o()&&a()},{immediate:!0});setTimeout(()=>a(),3e3)}}}),K(p,()=>{I.mode==="view"&&window.scrollTo(0,0)}),(o,a)=>{const t=at,s=tt,r=Z;return f(),h("div",Ds,[o.mode==="modal"?(f(),W(s,{key:0,current:p.value,class:"creation-steps"},{default:$(()=>[d(t,{title:"Select Design"}),d(t,{title:"Configure Trial"}),d(t,{title:"Review & Create"})]),_:1},8,["current"])):z("",!0),e("div",Ms,[p.value===0?(f(),W(Yt,{key:0,templates:x(b).templates.value,spreadsheets:x(b).spreadsheets.value,"variable-lists":x(b).variableLists.value,onSelect:i,onCreateTemplate:a[0]||(a[0]=g=>o.$emit("create-template")),onCreateSpreadsheet:a[1]||(a[1]=g=>o.$emit("create-spreadsheet"))},null,8,["templates","spreadsheets","variable-lists"])):p.value===1?(f(),W(La,{key:1,onBack:a[2]||(a[2]=g=>p.value--)})):p.value===2?(f(),W(fs,{key:2,"trial-config":u(),design:x(b).selectedPrompt.value,onBack:a[3]||(a[3]=g=>p.value--),onCreateDraft:M,onCreateAndStart:N,onExportPython:F},null,8,["trial-config","design"])):z("",!0)]),I.mode==="modal"?(f(),h("div",Es,[d(r,{onClick:a[4]||(a[4]=g=>o.$emit("cancel"))},{default:$(()=>a[8]||(a[8]=[A("Cancel")])),_:1,__:[8]}),p.value>0?(f(),W(r,{key:0,onClick:a[5]||(a[5]=g=>p.value--)},{default:$(()=>a[9]||(a[9]=[A(" Back ")])),_:1,__:[9]})):z("",!0),p.value<2?(f(),W(r,{key:1,type:"primary",disabled:!j.value,onClick:a[6]||(a[6]=g=>p.value++)},{default:$(()=>a[10]||(a[10]=[A(" Next ")])),_:1,__:[10]},8,["disabled"])):z("",!0),p.value===2?(f(),h("div",Ns,[d(r,{type:"primary",disabled:!j.value,onClick:M},{default:$(()=>a[11]||(a[11]=[A(" Create Draft ")])),_:1,__:[11]},8,["disabled"]),d(r,{type:"primary",disabled:!j.value,onClick:N},{default:$(()=>a[12]||(a[12]=[A(" Create & Start ")])),_:1,__:[12]},8,["disabled"])])):z("",!0)])):z("",!0),I.mode==="view"?(f(),h("div",As,[j.value?z("",!0):(f(),h("div",Ls,_(L.value),1)),e("div",Os,[d(r,{size:"large",disabled:!j.value,onClick:F},{default:$(()=>a[13]||(a[13]=[A(" Export Python ")])),_:1,__:[13]},8,["disabled"]),d(r,{type:"primary",size:"large",disabled:!j.value,onClick:M},{default:$(()=>a[14]||(a[14]=[A(" Create Draft ")])),_:1,__:[14]},8,["disabled"]),d(r,{type:"primary",size:"large",disabled:!j.value,onClick:N},{default:$(()=>a[15]||(a[15]=[A(" Create & Start ")])),_:1,__:[15]},8,["disabled"])])])):z("",!0),d(xs,{visible:v.value,"onUpdate:visible":a[7]||(a[7]=g=>v.value=g),"running-trial":P.value,"trial-config":y.value,"total-api-calls":x(b).totalExperiments.value,"estimated-cost":x(b).totalCost.value,onCancel:B,onCreateDraft:T},null,8,["visible","running-trial","trial-config","total-api-calls","estimated-cost"])])}}}),zs=G(Vs,[["__scopeId","data-v-951de972"]]),Rs={class:"trial-creation-view"},js={class:"creation-header"},Fs={class:"header-title"},Bs={class:"creation-content"},Us=Y({__name:"TrialCreationV3",setup(U){const D=Se(),n=Pe(),I=R(),c=R(null);async function S(){const L=D.query;if(L.duplicate){const u=L.duplicate;I.value={type:"duplicate",sourceTrialId:u}}else L.designId&&L.promptSource==="template"&&(I.value={type:"create",templateId:L.designId,promptSource:"template"})}function b(){n.push("/trials")}function p(){c.value&&(c.value.currentStep=0)}async function v(L){te.success("Trial created as draft"),n.push({path:"/trials",query:{trialId:L,tab:"details"}})}async function y(L){te.success("Trial created and started"),n.push({path:"/trials",query:{trialId:L,tab:"tasks"}})}async function k(){te.info("Python export not yet implemented")}function P(){n.push("/templates/new")}function j(){n.push("/spreadsheet")}return ne(()=>{S()}),(L,u)=>{const i=Z;return f(),h("div",Rs,[e("div",js,[e("div",Fs,[u[1]||(u[1]=e("h1",null,"Create New Trial",-1)),c.value?.currentStep===1?(f(),W(i,{key:0,type:"link",class:"back-button",onClick:p},{default:$(()=>[d(x(me)),u[0]||(u[0]=A(" Back to Select Template "))]),_:1,__:[0]})):z("",!0)]),d(i,{onClick:b},{default:$(()=>u[2]||(u[2]=[A("Cancel")])),_:1,__:[2]})]),e("div",Bs,[d(zs,{ref_key:"creationContentRef",ref:c,mode:"view","initial-data":I.value,onCancel:b,onCreated:v,onCreatedAndStarted:y,onExportPython:k,onCreateTemplate:P,onCreateSpreadsheet:j},null,8,["initial-data"])])])}}}),nn=G(Us,[["__scopeId","data-v-38a5dd3b"]]);export{nn as default};
