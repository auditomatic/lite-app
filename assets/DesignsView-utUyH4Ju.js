var e=Object.defineProperty,t=(t,a,s)=>((t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s)(t,"symbol"!=typeof a?a+"":a,s);import{d as a,i as s,b as l,e as n,f as r,g as i,p as o,F as u,D as c,t as d,r as p,j as m,q as v,m as g,U as f,s as b,V as y,W as h,w as _,X as w,n as k,B as x,o as V,I as $,u as S,k as C}from"./vendor-DdqHZeTC.js";import{D,_ as E,u as T,a as L}from"./index-DWYxkL85.js";import{u as j}from"./variableLists-CQERIwvm.js";import{t as I}from"./llm-BtshXLMj.js";import{s as A}from"./safeJson-BfKuju6h.js";import"./db-ftwlfnxb.js";import"./apiLogger-wE3EW76_.js";const N=class e{constructor(){t(this,"schemas",new Map)}static getInstance(){return e.instance||(e.instance=new e,e.instance.initializeSchemas()),e.instance}initializeSchemas(){this.registerSchema("design",{required:["name","prompt_template"],rules:[{field:"name",type:"string",min:1,max:200,message:"Name must be 1-200 characters"},{field:"prompt_template",type:"string",min:1,message:"Prompt template is required"},{field:"description",type:"string",max:1e3,message:"Description must be under 1000 characters"},{field:"variable_list_refs",type:"array",message:"Variable list refs must be an array"},{field:"compound_variables",type:"array",message:"Compound variables must be an array"},{field:"tags",type:"array",message:"Tags must be an array"},{field:"prompt_template",type:"custom",customValidator:e=>this.validatePromptTemplate(e),message:"Prompt template contains invalid variable syntax"}]}),this.registerSchema("run",{required:["design_id","name","models"],rules:[{field:"design_id",type:"string",min:1,message:"Design ID is required"},{field:"name",type:"string",min:1,max:200,message:"Name must be 1-200 characters"},{field:"models",type:"array",min:1,message:"At least one model is required"},{field:"status",type:"string",message:"Status must be a string"},{field:"status",type:"custom",customValidator:e=>["pending","running","completed","failed","cancelled"].includes(e),message:"Status must be one of: pending, running, completed, failed, cancelled"},{field:"models",type:"custom",customValidator:this.validateModelArray.bind(this),message:"Models array contains invalid entries"}]}),this.registerSchema("task",{required:["run_id","model","prompt"],rules:[{field:"run_id",type:"string",min:1,message:"Run ID is required"},{field:"model",type:"string",min:1,message:"Model is required"},{field:"prompt",type:"string",min:1,message:"Prompt is required"},{field:"status",type:"string",message:"Status must be a string"},{field:"status",type:"custom",customValidator:e=>["pending","running","completed","failed"].includes(e),message:"Status must be one of: pending, running, completed, failed"},{field:"usage",type:"custom",customValidator:this.validateTokenUsage.bind(this),message:"Token usage object is invalid"}]}),this.registerSchema("variable_list",{required:["name","values"],rules:[{field:"name",type:"string",min:1,max:200,message:"Name must be 1-200 characters"},{field:"values",type:"array",min:1,message:"At least one value is required"},{field:"description",type:"string",max:1e3,message:"Description must be under 1000 characters"},{field:"attribution",type:"string",max:500,message:"Attribution must be under 500 characters"},{field:"values",type:"custom",customValidator:this.validateVariableValues.bind(this),message:"Variable values contain invalid entries"}]}),this.registerSchema("model",{required:["id","provider","name"],rules:[{field:"id",type:"string",min:1,message:"Model ID is required"},{field:"provider",type:"string",min:1,message:"Provider is required"},{field:"name",type:"string",min:1,message:"Model name is required"},{field:"enabled",type:"boolean",message:"Enabled must be a boolean"},{field:"context_length",type:"number",min:1,message:"Context length must be positive"},{field:"input_cost",type:"number",min:0,message:"Input cost must be non-negative"},{field:"output_cost",type:"number",min:0,message:"Output cost must be non-negative"}]}),this.registerSchema("provider",{required:["id","name","base_url"],rules:[{field:"id",type:"string",min:1,message:"Provider ID is required"},{field:"name",type:"string",min:1,message:"Provider name is required"},{field:"base_url",type:"url",message:"Base URL must be a valid URL"},{field:"timeout",type:"number",min:1e3,max:3e5,message:"Timeout must be 1-300 seconds"},{field:"rate_limit",type:"number",min:1,message:"Rate limit must be positive"}]})}registerSchema(e,t){this.schemas.set(e,t)}async validateEntity(e,t,a={}){const s=this.schemas.get(e);if(!s)return{valid:!1,errors:[{field:"_schema",value:e,message:`No schema found for entity type: ${e}`,type:"error"}],warnings:[]};const l=[],n=[],r={...t};if(s.required)for(const i of s.required)i in t&&void 0!==t[i]&&null!==t[i]&&""!==t[i]||l.push({field:i,value:t[i],message:`${i} is required`,type:"error"});for(const i of s.rules){const e=t[i.field],s=this.validateField(i,e);s.error&&l.push({field:i.field,value:e,message:s.error,type:"error"}),s.warning&&n.push({field:i.field,value:e,message:s.warning,type:"warning"}),a.coerceTypes&&void 0!==s.coercedValue&&(r[i.field]=s.coercedValue)}if(!a.allowExtraFields){const e=new Set([...s.required||[],...s.optional||[],...s.rules.map(e=>e.field)]);for(const s in t)e.has(s)||(a.stripExtraFields?(delete r[s],n.push({field:s,value:t[s],message:`Extra field '${s}' was stripped`,type:"warning"})):n.push({field:s,value:t[s],message:`Extra field '${s}' is not allowed`,type:"warning"}))}return{valid:0===l.length,errors:l,warnings:n,data:r}}validateField(e,t){if(null==t)return{};switch(e.type){case"required":if(""===t||null==t)return{error:e.message||`${e.field} is required`};break;case"string":if("string"!=typeof t)return{error:e.message||`${e.field} must be a string`};if(void 0!==e.min&&t.length<e.min)return{error:e.message||`${e.field} must be at least ${e.min} characters`};if(void 0!==e.max&&t.length>e.max)return{error:e.message||`${e.field} must be at most ${e.max} characters`};if(e.pattern&&!e.pattern.test(t))return{error:e.message||`${e.field} does not match required pattern`};break;case"number":const a="string"==typeof t?parseFloat(t):t;return isNaN(a)||"number"!=typeof a?{error:e.message||`${e.field} must be a number`}:void 0!==e.min&&a<e.min?{error:e.message||`${e.field} must be at least ${e.min}`}:void 0!==e.max&&a>e.max?{error:e.message||`${e.field} must be at most ${e.max}`}:{coercedValue:a};case"boolean":if("boolean"!=typeof t)return"true"===t||"false"===t?{coercedValue:"true"===t}:{error:e.message||`${e.field} must be a boolean`};break;case"array":if(!Array.isArray(t))return{error:e.message||`${e.field} must be an array`};if(void 0!==e.min&&t.length<e.min)return{error:e.message||`${e.field} must have at least ${e.min} items`};if(void 0!==e.max&&t.length>e.max)return{error:e.message||`${e.field} must have at most ${e.max} items`};break;case"object":if("object"!=typeof t||Array.isArray(t))return{error:e.message||`${e.field} must be an object`};break;case"email":if("string"!=typeof t||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return{error:e.message||`${e.field} must be a valid email address`};break;case"url":try{new URL(t)}catch{return{error:e.message||`${e.field} must be a valid URL`}}break;case"custom":if(e.customValidator){const a=e.customValidator(t);if(!1===a)return{error:e.message||`${e.field} failed custom validation`};if("string"==typeof a)return{error:a}}}return{}}validatePromptTemplate(e){if("string"!=typeof e)return"Prompt template must be a string";if((e.match(/\{\{/g)||[]).length!==(e.match(/\}\}/g)||[]).length)return"Unmatched template braces in prompt template";const t=/\{\{([^}]+)\}\}/g,a=[];let s;for(;null!==(s=t.exec(e));){const e=s[1].trim();/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)||a.push(e)}return!(a.length>0)||`Invalid variable names: ${a.join(", ")}`}validateModelArray(e){if(!Array.isArray(e))return"Models must be an array";if(0===e.length)return"At least one model is required";for(const t of e)if("string"!=typeof t||""===t.trim())return"All models must be non-empty strings";return!0}validateTokenUsage(e){if(!e)return!0;if("object"!=typeof e)return"Token usage must be an object";const t=["prompt_tokens","completion_tokens","total_tokens"];for(const a of t)if(!(a in e)||"number"!=typeof e[a]||e[a]<0)return`Token usage.${a} must be a non-negative number`;return e.total_tokens===e.prompt_tokens+e.completion_tokens||"Token usage total_tokens must equal prompt_tokens + completion_tokens"}validateVariableValues(e){if(!Array.isArray(e))return"Variable values must be an array";if(0===e.length)return"At least one variable value is required";for(let t=0;t<e.length;t++){const a=e[t];if("string"!=typeof a||""===a.trim())return`Variable value at index ${t} must be a non-empty string`}return new Set(e).size===e.length||"Variable values must be unique"}async validateMultiple(e,t={}){return await Promise.all(e.map(e=>this.validateEntity(e.type,e.data,t)))}getSchema(e){return this.schemas.get(e)}listSchemas(){return Array.from(this.schemas.keys())}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}isValidUrl(e){try{return new URL(e),!0}catch{return!1}}sanitizeString(e,t=1e3){return e.trim().substring(0,t)}};t(N,"instance");let R=N;R.getInstance();const U=class e{constructor(){t(this,"dbService"),t(this,"validationService"),this.dbService=D.getInstance(),this.validationService=R.getInstance()}static getInstance(){return e.instance||(e.instance=new e),e.instance}async importDesigns(e,t={}){const a={success:!1,designs:[],errors:[],warnings:[],converted:0};try{let l=[];if(Array.isArray(e))l=e;else{if(!e||"object"!=typeof e)return a.errors.push("Invalid import data format"),a;l=[e]}for(let e=0;e<l.length;e++){const n=l[e];try{if(t.convertTemplateFormat&&n.prompt_template){const t=n.prompt_template;n.prompt_template=this.convertTemplateFormat(t),n.prompt_template!==t&&(a.converted++,a.warnings.push(`Converted template format for design "${n.name||`#${e+1}`}"`))}if(n.variables&&"object"==typeof n.variables&&(n.variables=this.normalizeVariableFormat(n.variables)),!t.allowDuplicateNames){const e=await this.dbService.findAll("designs");if(e.success&&e.data){const t=new Set(e.data.map(e=>e.name));t.has(n.name)&&(n.name=await this.generateUniqueName(n.name,t),a.warnings.push(`Renamed design to avoid duplicate: ${n.name}`))}}if(!t.skipValidation){const t=await this.validationService.validateEntity("design",n);if(!t.valid){a.errors.push(`Design #${e+1}: ${t.errors.map(e=>e.message).join(", ")}`);continue}}const s=await this.dbService.create("designs",n);s.success&&s.data?a.designs.push(s.data):a.errors.push(`Failed to create design #${e+1}: ${s.error}`)}catch(s){a.errors.push(`Error processing design #${e+1}: ${s instanceof Error?s.message:"Unknown error"}`)}}return a.success=a.designs.length>0,a}catch(s){return a.errors.push(`Import failed: ${s instanceof Error?s.message:"Unknown error"}`),a}}async exportDesigns(e,t={}){try{const a=[];for(const t of e){const e=await this.dbService.read("designs",t);e.success&&e.data&&a.push(e.data)}if(0===a.length)return{success:!1,error:"No designs found to export"};const s=t.format||"json",l=(new Date).toISOString().slice(0,19).replace(/[:-]/g,"");if("json"===s){const e={exported_at:(new Date).toISOString(),version:"1.0",designs:a.map(e=>this.sanitizeDesignForExport(e,t))};return{success:!0,data:JSON.stringify(e,null,2),filename:`designs_export_${l}.json`}}if("csv"===s){return{success:!0,data:this.convertToCSV(a,t),filename:`designs_export_${l}.csv`}}return{success:!1,error:`Unsupported export format: ${s}`}}catch(a){return{success:!1,error:`Export failed: ${a instanceof Error?a.message:"Unknown error"}`}}}convertTemplateFormat(e){return e.replace(/\{([^{}\s]+)\}/g,"{{$1}}")}normalizeVariableFormat(e){const t={};for(const[a,s]of Object.entries(e))Array.isArray(s)?t[a]=s.map(e=>String(e)):t[a]="string"==typeof s?s.split(",").map(e=>e.trim()).filter(e=>e.length>0):[String(s)];return t}async generateUniqueName(e,t){let a=1,s=`${e} (${a})`;for(;t.has(s);)a++,s=`${e} (${a})`;return s}sanitizeDesignForExport(e,t){const{includeRuns:a=!1}=t;return{name:e.name,description:e.description,prompt_template:e.prompt_template,variables:e.variables,variable_list_refs:e.variable_list_refs,created_at:e.created_at,updated_at:e.updated_at}}convertToCSV(e,t){const a=[["name","description","prompt_template","variables","created_at"].join(",")];for(const s of e){const e=[this.escapeCsvValue(s.name||""),this.escapeCsvValue(s.description||""),this.escapeCsvValue(s.prompt_template||""),this.escapeCsvValue(JSON.stringify(s.variables||{})),this.escapeCsvValue(s.created_at||"")];a.push(e.join(","))}return a.join("\n")}escapeCsvValue(e){return e.includes(",")||e.includes('"')||e.includes("\n")?`"${e.replace(/"/g,'""')}"`:e}};t(U,"instance");let O=U;const q=class e{static getInstance(){return this.instance||(this.instance=new e),this.instance}constructor(){}validateTemplate(e){const t=[],a=[],s=[];if(!e.trim())return t.push("Template cannot be empty"),{isValid:!1,errors:t,warnings:a,detectedVariables:s};const l=e.match(/\{\{\s*([^}]*)\s*\}\}/g)||[],n=new Set;for(const r of l){const e=r.replace(/\{\{\s*|\s*\}\}/g,"").trim();e?/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)?(["id","name","template","design"].includes(e.toLowerCase())&&a.push(`Variable "${e}" uses a reserved name and may cause confusion`),n.add(e)):t.push(`Invalid variable name "${e}". Variables must start with a letter or underscore and contain only letters, numbers, and underscores.`):t.push(`Empty variable placeholder found: ${r}`)}return s.push(...Array.from(n)),0===s.length&&a.push("No variables detected. This design will generate the same prompt for all tasks."),s.length>10&&a.push(`Large number of variables (${s.length}). Consider grouping related variables into lists.`),e.includes("{{")&&!e.includes("}}")&&t.push("Unclosed variable placeholder detected"),e.includes("}}")&&!e.includes("{{")&&t.push("Unopened variable placeholder detected"),{isValid:0===t.length,errors:t,warnings:a,detectedVariables:s}}syncVariableArrays(e,t,a){const s={...t},l={...a};for(const n of e)n in s||n in l||(s[n]=[]);for(const n of Object.keys(s))e.includes(n)||delete s[n];for(const n of Object.keys(l))e.includes(n)||delete l[n];return{arrays:s,listRefs:l}}createTestPrompt(e,t,a,s){return e.replace(/\{\{\s*([^}]+)\s*\}\}/g,(e,l)=>{const n=l.trim();if(a[n]){const e=a[n],t=s.find(t=>t.id===e);if(t&&t.values&&t.values.length>0)return t.values[0]}const r=t[n];return r&&r.length>0?r[0]:`test_${n}`})}prepareDesignData(e,t,a,s){const l={};for(const[r,i]of Object.entries(a))t.includes(r)&&i.length>0&&!s[r]&&(l[r]=[...i]);const n={};for(const[r,i]of Object.entries(s))t.includes(r)&&(n[r]=i);return{name:e.name.trim(),description:e.description?.trim()||"",prompt_template:e.prompt_template.trim(),variables:l,variable_list_refs:n,output_format:e.output_format,output_type:e.output_type,extract_pattern:e.extract_pattern}}validateDesignCompleteness(e,t,a){const s=[];for(const l of e){const e=t[l]?.length>0,n=void 0!==a[l];e||n||s.push(l)}return{isComplete:0===s.length,missingVariables:s}}getVariableStats(e,t,a,s){let l=1;const n=[];for(const r of e)if(a[r]){const e=s["string"==typeof a[r]?parseInt(a[r]):a[r]]||0;n.push({name:r,type:"list",count:e}),e>0&&(l*=e)}else{const e=t[r]?.length||0;n.push({name:r,type:"direct",count:e}),e>0&&(l*=e)}return{totalCombinations:l,variableCount:e.length,variableInfo:n}}formatRelativeDate(e){const t=new Date(e),a=(new Date).getTime()-t.getTime(),s=Math.floor(a/864e5);return 0===s?"today":1===s?"yesterday":s<7?`${s} days ago`:t.toLocaleDateString()}};t(q,"instance",null);let P=q;const M={class:"design-form-fields"},F={class:"form-group"},J=["value"],z={class:"form-group"},B=["value"],W={class:"form-group"},Z=["value"],Y={key:0,class:"extraction-errors"},K={class:"error-list"},H={key:1,class:"extraction-warnings"},Q={class:"warning-list"},X={class:"form-group"},G=["value"],ee={key:2,class:"form-group"},te=["value"],ae=E(a({__name:"DesignFormFields",props:{formData:{}},emits:["update:form-data","template-change"],setup(e,{emit:t}){const a=e,p=t,m=P.getInstance(),v=s(()=>m.validateTemplate(a.formData.prompt_template));function g(e,t){const s={...a.formData,[e]:t};p("update:form-data",s),"prompt_template"===e&&p("template-change",t)}return(e,t)=>(n(),l("div",M,[r("div",F,[t[5]||(t[5]=r("label",{for:"design-name"},"Name",-1)),r("input",{id:"design-name",value:e.formData.name,type:"text",required:"",placeholder:"My Design",onInput:t[0]||(t[0]=e=>g("name",e.target.value))},null,40,J)]),r("div",z,[t[6]||(t[6]=r("label",{for:"design-description"},"Description (optional)",-1)),r("input",{id:"design-description",value:e.formData.description,type:"text",placeholder:"Brief description of this design",onInput:t[1]||(t[1]=e=>g("description",e.target.value))},null,40,B)]),r("div",W,[t[7]||(t[7]=r("label",{for:"design-template"},[o(" Prompt Template "),r("span",{class:"label-hint"},"Use {{variable}} for placeholders")],-1)),r("textarea",{id:"design-template",value:e.formData.prompt_template,required:"",rows:"6",placeholder:"You are a helpful assistant. Please {{action}} the following {{topic}}...",onInput:t[2]||(t[2]=e=>g("prompt_template",e.target.value))},null,40,Z)]),v.value.errors.length>0?(n(),l("div",Y,[t[8]||(t[8]=r("h4",null,"Template Errors",-1)),r("div",K,[(n(!0),l(u,null,c(v.value.errors,e=>(n(),l("div",{key:e,class:"error-item"},d(e),1))),128))])])):i("",!0),v.value.warnings.length>0?(n(),l("div",H,[t[9]||(t[9]=r("h4",null,"Template Warnings",-1)),r("div",Q,[(n(!0),l(u,null,c(v.value.warnings,e=>(n(),l("div",{key:e,class:"warning-item"},d(e),1))),128))])])):i("",!0),r("div",X,[t[11]||(t[11]=r("label",{for:"output-format"},"Output Format",-1)),r("select",{id:"output-format",value:e.formData.output_format,onChange:t[3]||(t[3]=e=>g("output_format",e.target.value))},t[10]||(t[10]=[r("option",{value:"text"}," Text ",-1),r("option",{value:"json"}," JSON function calling parser ",-1)]),40,G)]),"json"===e.formData.output_format?(n(),l("div",ee,[t[13]||(t[13]=r("label",{for:"output-type"},"JSON Output Type",-1)),r("select",{id:"output-type",value:e.formData.output_type,onChange:t[4]||(t[4]=e=>g("output_type",e.target.value))},t[12]||(t[12]=[r("option",{value:"string"}," String ",-1),r("option",{value:"number"}," Number ",-1),r("option",{value:"boolean"}," Boolean ",-1)]),40,te),t[14]||(t[14]=r("p",{class:"form-hint"},' The response will be structured as JSON with an "answer" field containing this type of value. ',-1))])):i("",!0)]))}}),[["__scopeId","data-v-a3fdd13c"]]),se={class:"tag-input"},le={class:"tag-container"},ne={class:"tag-text"},re=["aria-label","onClick"],ie=["placeholder","onKeydown"],oe={key:0,class:"helper-text"},ue=E(a({__name:"TagInput",props:{modelValue:{},placeholder:{},helperText:{},allowDuplicates:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:t}){const a=e,s=t,o=p(),w=p(""),k=p(null);function x(){const e=w.value.trim();if(e){if(!a.allowDuplicates&&a.modelValue.includes(e)){const t=a.modelValue.indexOf(e),s=document.querySelectorAll(".tag");return s[t]?.classList.add("tag-flash"),k.value&&clearTimeout(k.value),k.value=window.setTimeout(()=>{s[t]?.classList.remove("tag-flash")},300),void(w.value="")}s("update:modelValue",[...a.modelValue,e]),w.value=""}}function V(e){const t=[...a.modelValue];t.splice(e,1),s("update:modelValue",t)}function $(){""===w.value&&a.modelValue.length>0&&V(a.modelValue.length-1)}function S(e){e.preventDefault();const t=e.clipboardData?.getData("text");if(!t)return;const l=t.split(/[\n,\t]+/).map(e=>e.trim()).filter(e=>e),n=a.allowDuplicates?[...a.modelValue,...l]:[...a.modelValue,...l.filter(e=>!a.modelValue.includes(e))];s("update:modelValue",n)}return m(()=>{k.value&&clearTimeout(k.value)}),(e,t)=>(n(),l("div",se,[r("div",le,[v(f,{name:"tag-list",tag:"div",class:"tags"},{default:b(()=>[(n(!0),l(u,null,c(e.modelValue,(e,t)=>(n(),l("div",{key:`${e}-${t}`,class:"tag"},[r("span",ne,d(e),1),r("button",{type:"button",class:"tag-remove","aria-label":`Remove ${e}`,onClick:e=>V(t)}," × ",8,re)]))),128))]),_:1}),g(r("input",{ref_key:"inputRef",ref:o,"onUpdate:modelValue":t[0]||(t[0]=e=>w.value=e),placeholder:e.placeholder,class:"tag-input-field",onKeydown:[h(_(x,["prevent"]),["enter"]),h($,["backspace"])],onPaste:S},null,40,ie),[[y,w.value]])]),e.helperText?(n(),l("div",oe,d(e.helperText),1)):i("",!0)]))}}),[["__scopeId","data-v-f7f8d7d3"]]),ce={key:0,class:"variable-manager"},de={class:"detected-variables"},pe={class:"variable-header"},me={class:"variable-name"},ve={class:"variable-actions"},ge=["onClick"],fe=["onClick"],be={key:0,class:"list-reference"},ye={class:"list-info"},he={class:"list-count"},_e={key:1,class:"variable-values"},we={key:0,class:"variable-stats"},ke={class:"stats-summary"},xe={class:"stat-item"},Ve={class:"stat-value"},$e={class:"stat-item"},Se={class:"stat-value"},Ce={key:0,class:"missing-variables-warning"},De=E(a({__name:"VariableManager",props:{detectedVariables:{},variableArrays:{},variableListRefs:{},availableLists:{},listItemCounts:{}},emits:["update:variable-arrays","update:variable-list-refs","select-variable-list"],setup(e,{emit:t}){const a=e,p=t,m=P.getInstance(),g=s(()=>a.detectedVariables.filter(e=>e in a.variableArrays||e in a.variableListRefs)),f=s(()=>0===a.detectedVariables.length?null:m.getVariableStats(a.detectedVariables,a.variableArrays,a.variableListRefs,a.listItemCounts)),b=s(()=>{const{missingVariables:e}=m.validateDesignCompleteness(a.detectedVariables,a.variableArrays,a.variableListRefs);return e});function y(e){const t="string"==typeof e?parseInt(e):e,s=a.availableLists.find(e=>e.id===t);return s?.name||"Unknown List"}function h(e){const t="string"==typeof e?parseInt(e):e;return a.listItemCounts[t]||0}return(e,t)=>e.detectedVariables.length>0?(n(),l("div",ce,[t[6]||(t[6]=r("h3",null,"Detected Variables",-1)),r("div",de,[(n(!0),l(u,null,c(g.value,s=>(n(),l("div",{key:s,class:"variable-item"},[r("div",pe,[r("span",me,d(s),1),r("div",ve,[e.variableListRefs[s]?(n(),l("button",{key:1,type:"button",class:"btn btn-sm btn-danger",onClick:e=>function(e){const t={...a.variableListRefs};delete t[e];const s={...a.variableArrays,[e]:[]};p("update:variable-list-refs",t),p("update:variable-arrays",s)}(s)}," Remove List ",8,fe)):(n(),l("button",{key:0,type:"button",class:"btn btn-sm btn-secondary",onClick:t=>e.$emit("select-variable-list",s)}," Use List ",8,ge))])]),e.variableListRefs[s]?(n(),l("div",be,[r("div",ye,[t[0]||(t[0]=r("strong",null,"Using list:",-1)),o(" "+d(y(e.variableListRefs[s]))+" ",1),r("small",he,"("+d(h(e.variableListRefs[s]))+" items)",1)])])):(n(),l("div",_e,[t[1]||(t[1]=r("label",null,"Values:",-1)),v(ue,{"model-value":e.variableArrays[s]||[],placeholder:`Add values for ${s}`,"helper-text":"Press Enter to add each value","onUpdate:modelValue":e=>function(e,t){const s={...a.variableArrays,[e]:t};p("update:variable-arrays",s)}(s,e)},null,8,["model-value","placeholder","onUpdate:modelValue"])]))]))),128))]),f.value?(n(),l("div",we,[r("div",ke,[r("div",xe,[t[2]||(t[2]=r("span",{class:"stat-label"},"Variables:",-1)),r("span",Ve,d(f.value.variableCount),1)]),r("div",$e,[t[3]||(t[3]=r("span",{class:"stat-label"},"Total combinations:",-1)),r("span",Se,d(f.value.totalCombinations.toLocaleString()),1)])]),b.value.length>0?(n(),l("div",Ce,[t[4]||(t[4]=r("h5",null,"⚠️ Missing Variable Values",-1)),t[5]||(t[5]=r("p",null,"The following variables need values before the design can be used:",-1)),r("ul",null,[(n(!0),l(u,null,c(b.value,e=>(n(),l("li",{key:e},[r("code",null,d(e),1)]))),128))])])):i("",!0)])):i("",!0)])):i("",!0)}}),[["__scopeId","data-v-985e4e1a"]]),Ee={class:"json-testing-panel"},Te={class:"json-test-controls"},Le=["value"],je=["disabled"],Ie={key:0,class:"test-requirements"},Ae={class:"requirements-text"},Ne={key:0},Re={key:1},Ue={key:1,class:"json-api-result"},Oe={class:"result-section"},qe={class:"json-api-response"},Pe={class:"result-section"},Me={key:0,class:"test-status error"},Fe={key:1,class:"test-status success"},Je={key:2,class:"testing-progress"},ze={class:"progress-content"},Be=E(a({__name:"JsonTestingPanel",props:{availableModels:{},promptTemplate:{},outputType:{},variableArrays:{},variableListRefs:{},availableLists:{},detectedVariables:{}},setup(e){const t=e,a=P.getInstance(),o=p(""),m=p(!1),v=p(null),f=s(()=>!(!o.value||!t.promptTemplate||m.value||0!==b.value.length)),b=s(()=>{const{missingVariables:e}=a.validateDesignCompleteness(t.detectedVariables,t.variableArrays,t.variableListRefs);return e});function y(e){const a=t.availableModels.find(t=>t.id===e);return a?.name||e}async function h(){if(f.value){m.value=!0,v.value=null;try{const s=a.createTestPrompt(t.promptTemplate,t.variableArrays,t.variableListRefs,t.availableLists),l=await I(o.value,s,{temperature:.7,max_tokens:150,output_format:"json",output_type:t.outputType});let n,r=null;try{const e=A(l);if(null===e)throw new SyntaxError("Invalid JSON format in API response");r=e&&"object"==typeof e&&"answer"in e?JSON.stringify(e.answer,null,2):JSON.stringify(e,null,2)}catch(e){n=`JSON Parse Error: ${e instanceof Error?e.message:"Invalid JSON"}`}v.value={response:l,parsed:r,parseError:n}}catch(e){console.error("JSON API test failed:",e),v.value={response:`Error: ${e instanceof Error?e.message:"Unknown error"}`,parsed:null,parseError:"API call failed"}}finally{m.value=!1}}}return(e,t)=>(n(),l("div",Ee,[t[7]||(t[7]=r("h5",null,"Test with Live Model",-1)),r("div",Te,[g(r("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>o.value=e),class:"model-select"},[t[1]||(t[1]=r("option",{value:""}," Select a model ",-1)),(n(!0),l(u,null,c(e.availableModels,e=>(n(),l("option",{key:e.id,value:e.id},d(e.name),9,Le))),128))],512),[[w,o.value]]),r("button",{type:"button",class:"btn btn-sm btn-primary",disabled:!f.value,onClick:h},d(m.value?"Testing...":"Test JSON Parser"),9,je)]),!f.value&&o.value?(n(),l("div",Ie,[r("p",Ae,[e.promptTemplate?i("",!0):(n(),l("span",Ne,"⚠️ Prompt template is required")),b.value.length>0?(n(),l("span",Re," ⚠️ Variables need values: "+d(b.value.join(", ")),1)):i("",!0)])])):i("",!0),v.value?(n(),l("div",Ue,[r("div",Oe,[t[2]||(t[2]=r("h6",null,"Model Response:",-1)),r("pre",qe,d(v.value.response),1)]),r("div",Pe,[t[3]||(t[3]=r("h6",null,"Parsed JSON:",-1)),r("code",{class:k(["json-api-parsed",{error:v.value.parseError}])},d(v.value.parseError||v.value.parsed||"(no valid JSON)"),3)]),v.value.parseError?(n(),l("div",Me,t[4]||(t[4]=[r("span",{class:"status-icon"},"❌",-1),r("span",{class:"status-text"},"JSON parsing failed - check your prompt template",-1)]))):v.value.parsed?(n(),l("div",Fe,t[5]||(t[5]=[r("span",{class:"status-icon"},"✅",-1),r("span",{class:"status-text"},"JSON parsing successful",-1)]))):i("",!0)])):i("",!0),m.value?(n(),l("div",Je,[r("div",ze,[t[6]||(t[6]=r("div",{class:"loading-spinner"},null,-1)),r("span",null,"Testing JSON parser with "+d(y(o.value))+"...",1)])])):i("",!0)]))}}),[["__scopeId","data-v-33bd65b8"]]),We={class:"modal-content list-selection-modal"},Ze={class:"modal-header"},Ye={class:"modal-body"},Ke={key:0,class:"list-filters"},He=["value"],Qe={class:"list-options"},Xe={key:0,class:"no-lists"},Ge={key:1,class:"no-results"},et=["onClick"],tt={class:"list-main"},at={key:0,class:"list-description"},st={key:1,class:"list-preview"},lt={class:"preview-values"},nt={class:"list-meta"},rt={class:"list-count"},it={class:"list-datetime"},ot=["title"],ut={class:"modal-footer"},ct={class:"footer-info"},dt={class:"list-count-summary"},pt=E(a({__name:"VariableListSelector",props:{isVisible:{type:Boolean},variableName:{},availableLists:{}},emits:["close","select-list"],setup(e,{emit:t}){const a=e,m=t,v=P.getInstance(),f=p(""),b=p(""),h=s(()=>{const e=new Set;return a.availableLists.forEach(t=>{e.add(t.category||"general")}),Array.from(e).sort()}),x=s(()=>{let e=a.availableLists;if(f.value){const t=f.value.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.description&&e.description.toLowerCase().includes(t)||e.values&&e.values.some(e=>e.toLowerCase().includes(t)))}return b.value&&(e=e.filter(e=>(e.category||"general")===b.value)),e});function V(e){return v.formatRelativeDate(e.updated_at||e.created_at)}return(e,t)=>e.isVisible?(n(),l("div",{key:0,class:"modal-overlay nested-modal",onClick:t[4]||(t[4]=_(t=>e.$emit("close"),["self"]))},[r("div",We,[r("div",Ze,[r("div",null,[t[6]||(t[6]=r("div",{class:"modal-breadcrumb"},[r("span",null,"Create Design"),r("span",{class:"breadcrumb-separator"},"→"),r("span",{class:"breadcrumb-current"},"Select Variable List")],-1)),r("h3",null,[t[5]||(t[5]=o("Select Variable List for ")),r("code",null,d(e.variableName),1)])]),r("button",{class:"close-btn",onClick:t[0]||(t[0]=t=>e.$emit("close"))}," × ")]),r("div",Ye,[e.availableLists.length>0?(n(),l("div",Ke,[g(r("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>f.value=e),type:"text",placeholder:"Search lists...",class:"search-input"},null,512),[[y,f.value]]),g(r("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>b.value=e),class:"category-filter"},[t[7]||(t[7]=r("option",{value:""}," All Categories ",-1)),(n(!0),l(u,null,c(h.value,e=>(n(),l("option",{key:e,value:e},d(e),9,He))),128))],512),[[w,b.value]])])):i("",!0),r("div",Qe,[0===e.availableLists.length?(n(),l("div",Xe,t[8]||(t[8]=[r("div",{class:"no-lists-content"},[r("h4",null,"No variable lists available"),r("p",null,"Create variable lists in the Variables tab to use them in your designs.")],-1)]))):0===x.value.length?(n(),l("div",Ge,t[9]||(t[9]=[r("h4",null,"No lists match your search",-1),r("p",null,"Try adjusting your search terms or category filter.",-1)]))):i("",!0),(n(!0),l(u,null,c(x.value,e=>{return n(),l("div",{key:e.id,class:"list-option",onClick:t=>function(e){m("select-list",e)}(e)},[r("div",tt,[r("h4",null,d(e.name),1),e.description?(n(),l("p",at,d(e.description),1)):i("",!0),e.values&&e.values.length>0?(n(),l("div",st,[t[10]||(t[10]=r("span",{class:"preview-label"},"Sample values:",-1)),r("span",lt,d((a=e.values,a.length<=3?a.join(", "):`${a.slice(0,3).join(", ")}, ...`)),1)])):i("",!0)]),r("div",nt,[r("span",{class:k(["list-category",`category-${e.category||"general"}`])},d(e.category||"general"),3),r("span",rt,d(e.values?.length||0)+" items ",1),r("span",it,d(V(e)),1),e.attribute_keys?.length?(n(),l("span",{key:0,class:"attribute-keys",title:`Attributes: ${e.attribute_keys.join(", ")}`},d(e.attribute_keys.length)+" attributes ",9,ot)):i("",!0)])],8,et);var a}),128))])]),r("div",ut,[r("div",ct,[r("span",dt,d(x.value.length)+" of "+d(e.availableLists.length)+" lists ",1)]),r("button",{type:"button",class:"btn btn-secondary",onClick:t[3]||(t[3]=t=>e.$emit("close"))}," Cancel ")])])])):i("",!0)}}),[["__scopeId","data-v-cc9fa5b6"]]),mt={class:"regex-builder"},vt={class:"regex-header"},gt={class:"header-controls"},ft={key:0,class:"regex-presets"},bt={class:"preset-grid"},yt=["onClick"],ht={class:"preset-name"},_t={class:"preset-pattern"},wt={class:"regex-input-group"},kt={key:0,class:"simple-mode"},xt={key:1,class:"advanced-mode"},Vt={class:"advanced-field"},$t={class:"advanced-field"},St=["disabled"],Ct={key:1,class:"regex-error"},Dt={class:"regex-test-section"},Et={key:2,class:"test-results"},Tt={class:"match-list"},Lt={class:"match-label"},jt={class:"match-value"},It={key:3,class:"api-test-section"},At={class:"api-test-controls"},Nt=["value"],Rt=["disabled"],Ut={key:0,class:"api-result"},Ot={class:"api-response"},qt={class:"api-extracted"},Pt=E(a({__name:"RegexBuilder",props:{modelValue:{},promptTemplate:{},showApiTest:{type:Boolean},variables:{},variableListRefs:{}},emits:["update:modelValue"],setup(e,{emit:t}){const a=e,o=t,m=T(),v=p("object"==typeof a.modelValue),f=p("object"==typeof a.modelValue?a.modelValue.match:a.modelValue||""),b=p("object"==typeof a.modelValue&&a.modelValue.replace||""),h=p(""),_=p([]),k=p(""),V=p(!1),$=p(""),S=p(!1),C=p(null),D=s(()=>(v.value,f.value)),E=s(()=>m.models.filter(e=>e.enabled)),L=[{name:"Simple Answer",pattern:"(?:Answer|Response|Result)\\s*[:\\s]\\s*(.+?)(?:\\n|$)",description:'Extracts text after "Answer:", "Response:", or "Result:"'},{name:"Score/Rating Answer",pattern:"(?:Score|Rating)\\s*[:\\s]\\s*(\\d+(?:\\.\\d+)?)",description:"Extracts numeric scores or ratings"},{name:"First Number",pattern:"\\b(\\d+(?:\\.\\d+)?)\\b",description:"Extracts the first number (integer or decimal)"},{name:"Last Number",pattern:".*\\b(\\d+(?:\\.\\d+)?)\\b(?!.*\\b\\d+(?:\\.\\d+)?\\b)",description:"Extracts the last number in the text"},{name:"Dollar Amount",pattern:"\\$?([0-9]{1,3}(?:,[0-9]{3})*(?:\\.[0-9]{2})?)",description:"Extracts dollar amounts (e.g., $150,000.00) - includes commas"},{name:"Dollar Amount (Clean)",pattern:"\\$([0-9,]+)",replace:"$1",description:"Extracts dollar amounts, strips $ symbol (keeps commas for readability)"},{name:"Number (No Commas)",pattern:"([0-9,]+)",replace:"$1",description:"Extracts numbers and removes commas (e.g., 150,000 → 150000)"},{name:"Phone Number (Digits)",pattern:"(?:\\(?([0-9]{3})\\)?[-. ]?)?([0-9]{3})[-. ]?([0-9]{4})",replace:"$1$2$3",description:"Extracts phone numbers as digits only (e.g., (555) 123-4567 → 5551234567)"},{name:"Yes/No",pattern:"\\b((?:yes|no|YES|NO|Yes|No))\\b",description:"Extracts yes or no responses (case insensitive)"},{name:"JSON Value",pattern:'"result"\\s*:\\s*"([^"]+)"',description:"Extracts value from JSON result field"},{name:"Rating (1-5)",pattern:"\\b([1-5])(?:/5)?\\b",description:"Extracts ratings from 1 to 5"},{name:"Percentage",pattern:"\\b(\\d+(?:\\.\\d+)?)%",description:"Extracts percentage values"},{name:"First Word",pattern:"^\\s*(\\S+)",description:"Extracts the first word (non-whitespace sequence)"},{name:"Last Word",pattern:"(\\S+)\\s*$",description:"Extracts the last word in the text"},{name:"Text Until Punctuation",pattern:"^([^.!?;:,]+)",description:"Extracts text from start until first punctuation mark"},{name:"Text After Last Punctuation",pattern:"[.!?;:,]\\s*([^.!?;:,]+)\\s*$",description:"Extracts text after the last punctuation mark"},{name:"First Line",pattern:"^(.+?)(?:\\n|$)",description:"Extracts the first line of text"},{name:"Last Line",pattern:"(?:^|\\n)([^\\n]+)\\s*$",description:"Extracts the last line of text"},{name:"Between Quotes",pattern:'"([^"]+)"',description:"Extracts text between double quotes"},{name:"Category/Label",pattern:"(?:category|label|class|type)\\s*[:\\s]\\s*([^\\n\\r,.!?]+)",description:"Extracts category or label values (stops at punctuation)"},{name:"Everything",pattern:"^\\s*(.+?)\\s*$",description:"Extracts all text (removes leading/trailing whitespace)"},{name:"Main Content",pattern:"(?:^|\\n)\\s*([^\\n]+?)\\s*(?:\\n|$)",description:"Extracts the main line of content (ignores empty lines)"}];function j(){v.value&&b.value?o("update:modelValue",{match:f.value,replace:b.value}):o("update:modelValue",f.value),h.value&&N()}function A(){v.value=!v.value,j()}function N(){if(!f.value||!h.value)return _.value=[],void(k.value="");try{const e=v.value&&b.value?{match:f.value,replace:b.value}:f.value,t=U(h.value,e);t.length>=100?k.value="Showing first 100 matches (pattern matched more)":k.value="",_.value=t}catch(e){_.value=[],k.value=`Invalid regex: ${e instanceof Error?e.message:"Unknown error"}`}}async function R(){if($.value&&a.promptTemplate&&!S.value){S.value=!0,C.value=null;try{const e=function(e){if(!a.variables)return e.replace(/\{\{\s*([^}]+)\s*\}\}/g,"test");return e.replace(/\{\{\s*([^}]+)\s*\}\}/g,(e,t)=>{const s=t.trim(),l=a.variables?.[s];return l&&l.length>0?l[0]:`test_${s}`})}(a.promptTemplate),t=await I($.value,e,{temperature:.7,max_tokens:150,output_format:"text"}),s=U(t,D.value);C.value={response:t,extracted:s.length>0?s.join(", "):null}}catch(e){console.error("API test failed:",e),C.value={response:`Error: ${e instanceof Error?e.message:"Unknown error"}`,extracted:null}}finally{S.value=!1}}}function U(e,t){if(!t||!e)return[];try{const a="string"==typeof t?{match:t,replace:void 0}:t,s=new RegExp(a.match,"gm"),l=[];let n,r=0;const i=1e3,o=10;for(;null!==(n=s.exec(e))&&r<i&&l.length<o;)if(r++,n.index===s.lastIndex&&s.lastIndex++,n.groups){const e=Object.values(n.groups).filter(e=>void 0!==e);e.length>0&&l.push(e.join(" | "))}else if(n.length>1){const e=n.slice(1).filter(e=>void 0!==e);1===e.length?l.push(e[0]):e.length>1&&l.push(e.join(" | "))}else l.push(n[0]);return a.replace?l.map(e=>{try{const t=new RegExp(a.match,"g");return e.replace(t,a.replace)}catch(t){return console.warn("Error applying replace pattern:",t),e}}):l}catch(a){return console.error("Extraction failed:",a),[]}}return x(()=>a.modelValue,e=>{"object"==typeof e?(v.value=!0,f.value=e.match,b.value=e.replace||""):(f.value=e||"",b.value="")}),(e,t)=>(n(),l("div",mt,[r("div",vt,[t[6]||(t[6]=r("h4",null,"Extract Pattern",-1)),r("div",gt,[r("button",{type:"button",class:"btn btn-sm btn-outline-primary",onClick:A},d(v.value?"Simple":"Advanced"),1),r("button",{type:"button",class:"btn btn-sm btn-secondary",onClick:t[0]||(t[0]=e=>V.value=!V.value)},d(V.value?"Hide":"Show")+" Presets ",1)])]),V.value?(n(),l("div",ft,[t[7]||(t[7]=r("h5",null,"Common Patterns",-1)),r("div",bt,[(n(),l(u,null,c(L,e=>r("button",{key:e.name,type:"button",class:"preset-button",onClick:t=>function(e){f.value=e.pattern,"replace"in e?(b.value=e.replace||"",v.value=!0):b.value="",j()}(e)},[r("span",ht,d(e.name),1),r("code",_t,d(e.pattern),1)],8,yt)),64))])])):i("",!0),r("div",wt,[v.value?(n(),l("div",xt,[r("div",Vt,[t[8]||(t[8]=r("label",null,"Match Pattern:",-1)),g(r("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>f.value=e),type:"text",class:"regex-input",placeholder:"e.g., \\$?([0-9,]+)",spellcheck:"false",onInput:j},null,544),[[y,f.value]])]),r("div",$t,[t[9]||(t[9]=r("label",null,"Replace Pattern (optional):",-1)),g(r("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>b.value=e),type:"text",class:"regex-input",placeholder:"e.g., $1 (strips $ and commas)",spellcheck:"false",onInput:j},null,544),[[y,b.value]])])])):(n(),l("div",kt,[g(r("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>f.value=e),type:"text",class:"regex-input",placeholder:"e.g., Answer: (.+)",spellcheck:"false",onInput:j},null,544),[[y,f.value]])])),r("button",{type:"button",class:"btn btn-sm btn-primary",disabled:!f.value||!h.value,onClick:N}," Test ",8,St)]),k.value?(n(),l("div",Ct,d(k.value),1)):i("",!0),r("div",Dt,[t[10]||(t[10]=r("label",null,"Test Text",-1)),g(r("textarea",{"onUpdate:modelValue":t[4]||(t[4]=e=>h.value=e),rows:"3",placeholder:"Paste sample output to test your regex pattern",class:"test-textarea",onInput:N},null,544),[[y,h.value]])]),_.value.length>0?(n(),l("div",Et,[t[11]||(t[11]=r("h5",null,"Matches Found",-1)),r("div",Tt,[(n(!0),l(u,null,c(_.value,(e,t)=>(n(),l("div",{key:t,class:"match-item"},[r("span",Lt,"Match "+d(t+1)+":",1),r("code",jt,d(e),1)]))),128))])])):i("",!0),e.showApiTest?(n(),l("div",It,[t[15]||(t[15]=r("h5",null,"Test with API",-1)),r("div",At,[g(r("select",{"onUpdate:modelValue":t[5]||(t[5]=e=>$.value=e),class:"model-select"},[t[12]||(t[12]=r("option",{value:""}," Select a model ",-1)),(n(!0),l(u,null,c(E.value,e=>(n(),l("option",{key:e.id,value:e.id},d(e.name),9,Nt))),128))],512),[[w,$.value]]),r("button",{type:"button",class:"btn btn-sm btn-primary",disabled:!$.value||!e.promptTemplate||S.value,onClick:R},d(S.value?"Testing...":"Test with Model"),9,Rt)]),C.value?(n(),l("div",Ut,[t[13]||(t[13]=r("h6",null,"Model Response:",-1)),r("pre",Ot,d(C.value.response),1),t[14]||(t[14]=r("h6",null,"Extracted Value:",-1)),r("code",qt,d(C.value.extracted||"(no match)"),1)])):i("",!0)])):i("",!0)]))}}),[["__scopeId","data-v-a320e708"]]),Mt={class:"modal-content"},Ft={class:"modal-header"},Jt={class:"modal-body"},zt={key:2,class:"form-group"},Bt={class:"modal-footer"},Wt=["disabled"],Zt=E(a({__name:"DesignEditorModal",props:{design:{}},emits:["save","close"],setup(e,{emit:t}){const a=e,o=t,c=P.getInstance(),g=j(),f=T(),b=s(()=>!!a.design),y=p({name:"",description:"",prompt_template:"",output_format:"text",output_type:"string",extract_pattern:""}),h=p({}),w=p({}),k=p([]),S=p({}),C=p(null),D=s(()=>f.models.filter(e=>e.enabled)),E=s(()=>c.validateTemplate(y.value.prompt_template)),L=s(()=>{if(!y.value.name.trim()||!y.value.prompt_template.trim())return!1;if(!E.value.isValid)return!1;const{isComplete:e}=c.validateDesignCompleteness(E.value.detectedVariables,h.value,w.value);return e});function I(e){const t=c.syncVariableArrays(E.value.detectedVariables,h.value,w.value);h.value=t.arrays,w.value=t.listRefs}function A(e){C.value=e}async function N(e){if(C.value&&e.id){const t={...w.value,[C.value]:e.id},a={...h.value};if(delete a[C.value],w.value=t,h.value=a,!(e.id in S.value)){const t=await g.getListItems(e.id);S.value[e.id]=t.length}}C.value=null}function R(){if(!L.value)return;const e=c.prepareDesignData(y.value,E.value.detectedVariables,h.value,w.value);o("save",e)}function U(e){"Escape"===e.key&&o("close")}return x(()=>E.value.detectedVariables,()=>{const e=c.syncVariableArrays(E.value.detectedVariables,h.value,w.value);h.value=e.arrays,w.value=e.listRefs},{immediate:!0}),V(async()=>{document.addEventListener("keydown",U);const e=await g.loadVariableLists();k.value=e.sort((e,t)=>{const a=new Date(e.updated_at||e.created_at);return new Date(t.updated_at||t.created_at).getTime()-a.getTime()}),await f.loadModels();for(const t of k.value)if(t.id){const e=await g.getListItems(t.id);S.value[t.id]=e.length}if(a.design&&(y.value={name:a.design.name,description:a.design.description||"",prompt_template:a.design.prompt_template,output_format:a.design.output_format||"text",output_type:a.design.output_type||"string",extract_pattern:a.design.extract_pattern||""},a.design.variable_list_refs&&(w.value={...a.design.variable_list_refs}),a.design.variables))for(const[t,s]of Object.entries(a.design.variables))w.value[t]||(h.value[t]=Array.isArray(s)?s:[s])}),m(()=>{document.removeEventListener("keydown",U)}),(e,t)=>(n(),l(u,null,[r("div",{class:"modal-overlay",onClick:t[6]||(t[6]=_(t=>e.$emit("close"),["self"]))},[r("div",Mt,[r("div",Ft,[r("h2",null,d(b.value?"Edit":"Create")+" Design",1),r("button",{class:"close-btn",onClick:t[0]||(t[0]=t=>e.$emit("close"))}," × ")]),r("div",Jt,[r("form",{onSubmit:_(R,["prevent"])},[v(ae,{"form-data":y.value,"onUpdate:formData":t[1]||(t[1]=e=>y.value=e),onTemplateChange:I},null,8,["form-data"]),E.value.detectedVariables.length>0?(n(),$(De,{key:0,"detected-variables":E.value.detectedVariables,"variable-arrays":h.value,"variable-list-refs":w.value,"available-lists":k.value,"list-item-counts":S.value,"onUpdate:variableArrays":t[2]||(t[2]=e=>h.value=e),"onUpdate:variableListRefs":t[3]||(t[3]=e=>w.value=e),onSelectVariableList:A},null,8,["detected-variables","variable-arrays","variable-list-refs","available-lists","list-item-counts"])):i("",!0),"json"===y.value.output_format?(n(),$(Be,{key:1,"available-models":D.value,"prompt-template":y.value.prompt_template,"output-type":y.value.output_type,"variable-arrays":h.value,"variable-list-refs":w.value,"available-lists":k.value,"detected-variables":E.value.detectedVariables},null,8,["available-models","prompt-template","output-type","variable-arrays","variable-list-refs","available-lists","detected-variables"])):i("",!0),"text"===y.value.output_format?(n(),l("div",zt,[v(Pt,{modelValue:y.value.extract_pattern,"onUpdate:modelValue":t[4]||(t[4]=e=>y.value.extract_pattern=e),"prompt-template":y.value.prompt_template,"show-api-test":!0,variables:h.value},null,8,["modelValue","prompt-template","variables"])])):i("",!0)],32)]),r("div",Bt,[r("button",{type:"button",class:"btn btn-secondary",onClick:t[5]||(t[5]=t=>e.$emit("close"))}," Cancel "),r("button",{type:"submit",class:"btn btn-primary",disabled:!L.value,onClick:R},d(b.value?"Update":"Create")+" Design ",9,Wt)])])]),v(pt,{"is-visible":!!C.value,"variable-name":C.value,"available-lists":k.value,onClose:t[7]||(t[7]=e=>C.value=null),onSelectList:N},null,8,["is-visible","variable-name","available-lists"])],64))}}),[["__scopeId","data-v-40fa6a4c"]]),Yt={class:"designs-view"},Kt={class:"page-header"},Ht={class:"header-actions"},Qt=["disabled"],Xt={key:0,class:"loading-state"},Gt={key:1,class:"empty-state"},ea={key:2,class:"designs-container"},ta={class:"sort-controls"},aa={class:"designs-table"},sa={class:"design-main"},la={class:"design-info"},na={class:"design-header"},ra={class:"design-name"},ia={class:"design-output"},oa={key:0,class:"design-description"},ua={class:"design-meta"},ca={key:0},da={class:"design-actions"},pa=["onClick"],ma=["onClick"],va=["onClick"],ga=["onClick"],fa=["onClick"],ba=E(a({__name:"DesignsView",setup(e){const t=S(),a=L(),m=j(),v=p([]),f=p([]),b=p(!1),y=p(null),h=p("updated_at"),_=p("desc"),k=s(()=>[...v.value].sort((e,t)=>{let a,s;switch(h.value){case"name":a=e.name.toLowerCase(),s=t.name.toLowerCase();break;case"created_at":a=new Date(e.created_at||0).getTime(),s=new Date(t.created_at||0).getTime();break;case"updated_at":a=new Date(e.updated_at||e.created_at||0).getTime(),s=new Date(t.updated_at||t.created_at||0).getTime();break;default:return 0}return a<s?"asc"===_.value?-1:1:a>s?"asc"===_.value?1:-1:0}));async function x(){v.value=await a.loadDesigns()}async function D(e){try{y.value?.id?await a.updateDesign(y.value.id,e):await a.createDesign(e),await x(),E()}catch(t){console.error("Failed to save design:",t),alert(`Failed to save design: ${t instanceof Error?t.message:String(t)}`)}}function E(){b.value=!1,y.value=null}function T(){const e={version:"1.0",exportDate:(new Date).toISOString(),designs:v.value},t=JSON.stringify(e,null,2),a=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(a),l=document.createElement("a");l.href=s,l.download=`auditomatic_designs_${(new Date).getTime()}.json`,l.click(),URL.revokeObjectURL(s)}async function I(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{const t=e.target.files?.[0];if(t)try{const e=await t.text(),a=A(e);if(null===a)throw new SyntaxError("Invalid JSON format in imported file");const s=O.getInstance(),l=await s.importDesigns(a,{convertTemplateFormat:!0,allowDuplicateNames:!1,skipValidation:!1});if(!l.success&&l.errors.length>0)return void alert(`Import failed: ${l.errors.join(", ")}`);const n=l.designs.length;if(0===n)return void alert("No valid designs found to import");const r=`Import ${n} design${n>1?"s":""}? This will not affect existing designs.`;if(!confirm(r))return;await x();let i=[`Successfully imported ${l.designs.length} design${l.designs.length>1?"s":""}`];l.converted>0&&i.push(`${l.converted} template format${l.converted>1?"s":""} converted`),l.warnings.length>0&&i.push(`Warnings: ${l.warnings.join(", ")}`),alert(i.join(". "))}catch(a){console.error("Import error:",a);let e="Failed to import designs. ";a instanceof SyntaxError?e+="Invalid JSON format.":a instanceof Error&&a.message?e+=a.message:e+="Please check the file format.",alert(e)}},e.click()}function N(){}function R(){_.value="asc"===_.value?"desc":"asc"}function U(e){return e?new Date(e).toLocaleDateString():"N/A"}function q(e){const t=e.variables||{},a=e.variable_list_refs||{};if(0===Object.keys(t).length&&0===Object.keys(a).length)return"0 variables";const s=[];let l=1;for(const[n,r]of Object.entries(t))Array.isArray(r)&&r.length>0&&(s.push(`${n} (${r.length})`),l*=r.length);for(const[n,r]of Object.entries(a)){const e=f.value.find(e=>e.id===r);e&&e.values?.length>0&&(s.push(`${n} (${e.values.length})`),l*=e.values.length)}return 0===s.length?"0 variables":1===s.length?`${s[0]} = ${l} conditions`:`${s.join(" × ")} = ${l} conditions`}return V(async()=>{await x(),await async function(){f.value=await m.loadVariableLists()}()}),(e,s)=>(n(),l("div",Yt,[r("div",Kt,[s[2]||(s[2]=r("h2",null,"Prompt Designs",-1)),r("div",Ht,[r("button",{class:"btn btn-secondary",onClick:I}," Import "),r("button",{class:"btn btn-secondary",disabled:0===v.value.length,onClick:T}," Export All ",8,Qt),r("button",{class:"btn btn-primary",onClick:s[0]||(s[0]=e=>b.value=!0)}," New Design ")])]),C(a).loading?(n(),l("div",Xt,s[3]||(s[3]=[r("div",{class:"loading-spinner"},null,-1),r("p",null,"Loading designs...",-1)]))):0===v.value.length?(n(),l("div",Gt,s[4]||(s[4]=[r("p",null,"No designs yet. Create your first design!",-1)]))):(n(),l("div",ea,[r("div",ta,[s[6]||(s[6]=r("label",null,"Sort by:",-1)),g(r("select",{"onUpdate:modelValue":s[1]||(s[1]=e=>h.value=e),onChange:N},s[5]||(s[5]=[r("option",{value:"updated_at"}," Last Edited ",-1),r("option",{value:"name"}," Name ",-1),r("option",{value:"created_at"}," Created Date ",-1)]),544),[[w,h.value]]),r("button",{class:"sort-toggle",onClick:R},d("desc"===_.value?"↓":"↑"),1)]),r("div",aa,[(n(!0),l(u,null,c(k.value,e=>(n(),l("div",{key:e.id,class:"design-row"},[r("div",sa,[r("div",la,[r("div",na,[r("h3",ra,d(e.name),1),r("span",ia,d(e.output_format||"text"),1),e.description?(n(),l("span",oa,d(e.description),1)):i("",!0)]),r("p",ua,[o(d(q(e))+" • Created "+d(U(e.created_at))+" ",1),e.updated_at&&e.updated_at!==e.created_at?(n(),l("span",ca," • Updated "+d(U(e.updated_at)),1)):i("",!0)])]),r("div",da,[r("button",{class:"btn btn-secondary btn-small",onClick:t=>async function(e){if(e.id){const t=await a.getDesignById(e.id);y.value=t||e}else y.value=e}(e)}," Edit ",8,pa),r("button",{class:"btn btn-secondary btn-small",onClick:t=>function(e){const t={...e,id:void 0,name:`${e.name} (Copy)`,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};y.value=t}(e)}," Copy ",8,ma),r("button",{class:"btn btn-primary btn-small",onClick:a=>{return s=e.id,void t.push({name:"runs",query:{create:s.toString(),from:"designs"}});var s}}," Run ",8,va),r("button",{class:"btn btn-secondary btn-small",onClick:t=>function(e){const t={version:"1.0",exportDate:(new Date).toISOString(),design:e},a=JSON.stringify(t,null,2),s=new Blob([a],{type:"application/json"}),l=URL.createObjectURL(s),n=document.createElement("a");n.href=l,n.download=`design_${e.name.replace(/[^a-zA-Z0-9]/g,"_")}_${(new Date).toISOString().split("T")[0]}.json`,n.click(),URL.revokeObjectURL(l)}(e)}," Export ",8,ga),r("button",{class:"btn btn-danger btn-small",onClick:t=>async function(e){confirm("Are you sure you want to delete this design?")&&(await a.deleteDesign(e),await x())}(e.id)}," Delete ",8,fa)])])]))),128))])])),b.value||y.value?(n(),$(Zt,{key:3,design:y.value,onSave:D,onClose:E},null,8,["design"])):i("",!0)]))}}),[["__scopeId","data-v-40e7f6e9"]]);export{ba as default};
