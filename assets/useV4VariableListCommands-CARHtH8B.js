import{d as l,a as f}from"./index-NVW3ASE7.js";import{b as E}from"./useV4CrossTab-CpVQLO8Y.js";import{f as L,c as S}from"./vue-vendor-DPw1dQYc.js";class j{async create(e){try{const r=crypto.randomUUID(),t=new Date,s=this.validateCreateData(e);if(!s.valid)return{ok:!1,error:new Error(`Validation failed: ${s.errors.join(", ")}`)};const a={id:r,name:e.name,description:e.description,category:e.category,itemCount:this.calculateItemCount(e),created:t,updated:t};this.applyCategoryData(a,e);const i=Object.freeze(a);return await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.add(i)}),f.info("V4: Created variable list",{id:r,name:e.name,category:e.category}),E("variableLists","create"),{ok:!0,value:r}}catch(r){return f.error("V4: Failed to create variable list",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to create variable list")}}}async update(e,r){try{const t=await l.variableLists.get(e);if(!t)return{ok:!1,error:new Error("Variable list not found")};const s={...r,updated:new Date};if(this.hasContentChanges(r)){const a={...t,...r};s.itemCount=this.calculateItemCount(a)}return this.freezeUpdateData(s),await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.update(e,s)}),f.info("V4: Updated variable list",{id:e,updates:Object.keys(r)}),E("variableLists","update"),{ok:!0,value:void 0}}catch(t){return f.error("V4: Failed to update variable list",t),{ok:!1,error:t instanceof Error?t:new Error("Failed to update variable list")}}}async delete(e){try{const r=await l.variableLists.get(e);if(!r)return{ok:!1,error:new Error("Variable list not found")};const t=await this.findTemplateReferences(e);return t.length>0?{ok:!1,error:new Error(`Cannot delete list: referenced by ${t.length} templates. Remove references first.`)}:(await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.delete(e)}),f.info("V4: Deleted variable list",{id:e,name:r.name}),E("variableLists","delete"),{ok:!0,value:void 0})}catch(r){return f.error("V4: Failed to delete variable list",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to delete variable list")}}}async duplicate(e,r){try{const t=await l.variableLists.get(e);if(!t)return{ok:!1,error:new Error("Variable list not found")};const s={name:r||`${t.name} (Copy)`,description:t.description,category:t.category};return t.values&&(s.values=[...t.values]),t.items&&(s.items=t.items.map(a=>({value:a.value,attributes:{...a.attributes}}))),t.attributeKeys&&(s.attributeKeys=[...t.attributeKeys]),t.tabularData&&(s.tabularData={columns:[...t.tabularData.columns],rows:t.tabularData.rows.map(a=>({...a}))}),await this.create(s)}catch(t){return f.error("V4: Failed to duplicate variable list",t),{ok:!1,error:t instanceof Error?t:new Error("Failed to duplicate variable list")}}}async bulkCreate(e){try{const r=[],t=new Date;for(const a of e){const i=this.validateCreateData(a);if(!i.valid)return{ok:!1,error:new Error(`Bulk validation failed for "${a.name}": ${i.errors.join(", ")}`)}}const s=e.map(a=>{const i=crypto.randomUUID(),o={id:i,name:a.name,description:a.description,category:a.category,itemCount:this.calculateItemCount(a),created:t,updated:t};return this.applyCategoryData(o,a),r.push(i),Object.freeze(o)});return await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.bulkAdd(s)}),f.info("V4: Bulk created variable lists",{count:e.length}),{ok:!0,value:r}}catch(r){return f.error("V4: Failed to bulk create variable lists",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to bulk create variable lists")}}}async bulkUpdate(e){try{const r=e.map(i=>i.id),t=await l.variableLists.where("id").anyOf(r).toArray();if(t.length!==r.length){const i=new Set(t.map(n=>n.id)),o=r.filter(n=>!i.has(n));return{ok:!1,error:new Error(`Some variable lists not found: ${o.join(", ")}`)}}const s=new Date,a=e.map(({id:i,data:o})=>{const n={...o,updated:s};return this.freezeUpdateData(n),{key:i,changes:n}});return await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.bulkUpdate(a)}),f.info("V4: Bulk updated variable lists",{count:e.length}),{ok:!0,value:void 0}}catch(r){return f.error("V4: Failed to bulk update variable lists",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to bulk update variable lists")}}}async bulkDelete(e){try{return(await Promise.all(e.map(s=>this.findTemplateReferences(s)))).some(s=>s.length>0)?{ok:!1,error:new Error("Cannot bulk delete: some lists are referenced by templates")}:(await l.transaction("rw",l.variableLists,async()=>{await l.variableLists.bulkDelete(e)}),f.info("V4: Bulk deleted variable lists",{count:e.length}),{ok:!0,value:void 0})}catch(r){return f.error("V4: Failed to bulk delete variable lists",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to bulk delete variable lists")}}}async importFromCSV(e,r,t,s){try{const a=this.parseCSV(e);if(a.headers.length===0||a.rows.length===0)return{ok:!1,error:new Error("CSV file is empty or invalid")};let i;if(t==="attributed"){const o=a.headers.find(c=>c.toLowerCase()==="value"||c.toLowerCase()==="name");if(!o)return{ok:!1,error:new Error('CSV must have a "value" or "name" column for attributed lists')};const n=a.headers.filter(c=>c!==o),b=a.rows.map(c=>({value:c[o]||"",attributes:n.reduce((m,p)=>(m[p]=c[p]||"",m),{})})).filter(c=>c.value.trim()).map(c=>Object.freeze(c));i={name:r,description:s,category:t,items:b,attributeKeys:n}}else{const o=a.rows.map(n=>n[a.headers[0]]||"").filter(n=>n.trim());i={name:r,description:s,category:t,values:o}}return await this.create(i)}catch(a){return f.error("V4: Failed to import CSV",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to import CSV")}}}async exportToCSV(e){try{const r=await l.variableLists.get(e);if(!r)return{ok:!1,error:new Error("Variable list not found")};let t;if(r.category==="simple"||r.category==="refusal"){if(!r.values)return{ok:!1,error:new Error("List has no values")};t=`value
${r.values.join(`
`)}`}else if(r.category==="attributed"){if(!r.items||!r.attributeKeys)return{ok:!1,error:new Error("Attributed list has no items or keys")};const a=[["value",...r.attributeKeys].join(",")];r.items.forEach(i=>{const o=[this.escapeCSVValue(i.value),...r.attributeKeys.map(n=>this.escapeCSVValue(i.attributes[n]||""))];a.push(o.join(","))}),t=a.join(`
`)}else if(r.category==="tabular"){if(!r.tabularData)return{ok:!1,error:new Error("Tabular list has no data")};const s=r.tabularData.columns,a=[s.join(",")];r.tabularData.rows.forEach(i=>{const o=s.map(n=>this.escapeCSVValue(String(i[n]||"")));a.push(o.join(","))}),t=a.join(`
`)}else return{ok:!1,error:new Error(`Export not supported for category: ${r.category}`)};return{ok:!0,value:t}}catch(r){return f.error("V4: Failed to export CSV",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to export CSV")}}}async exportToJSON(e){try{const r=await l.variableLists.get(e);return r?{ok:!0,value:JSON.stringify(r,null,2)}:{ok:!1,error:new Error("Variable list not found")}}catch(r){return f.error("V4: Failed to export JSON",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to export JSON")}}}async validateCrossReferences(){try{return{ok:!0,value:{totalLists:await l.variableLists.count(),invalidReferences:[],missingLists:[]}}}catch(e){return f.error("V4: Failed to validate cross references",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to validate cross references")}}}async cleanupOrphanedReferences(){try{return{ok:!0,value:{removedReferences:0,affectedTemplates:[]}}}catch(e){return f.error("V4: Failed to cleanup orphaned references",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to cleanup orphaned references")}}}validateCreateData(e){const r=[];switch(e.name?.trim()||r.push("Name is required"),e.category||r.push("Category is required"),e.category){case"simple":case"refusal":(!e.values||e.values.length===0)&&r.push(`${e.category} lists require at least one value`);break;case"attributed":(!e.items||e.items.length===0)&&r.push("Attributed lists require at least one item"),(!e.attributeKeys||e.attributeKeys.length===0)&&r.push("Attributed lists require at least one attribute key");break;case"tabular":(!e.tabularData||!e.tabularData.columns||e.tabularData.columns.length===0)&&r.push("Tabular lists require at least one column"),(!e.tabularData||!e.tabularData.rows||e.tabularData.rows.length===0)&&r.push("Tabular lists require at least one row");break}return{valid:r.length===0,errors:r}}calculateItemCount(e){switch(e.category){case"simple":case"refusal":return e.values?.length||0;case"attributed":return e.items?.length||0;case"tabular":return e.tabularData?.rows?.length||0;default:return 0}}applyCategoryData(e,r){switch(r.category){case"simple":case"refusal":r.values&&(e.values=Object.freeze([...r.values]));break;case"attributed":r.items&&(e.items=Object.freeze(r.items.map(t=>Object.freeze({value:t.value,attributes:Object.freeze({...t.attributes})})))),r.attributeKeys&&(e.attributeKeys=Object.freeze([...r.attributeKeys]));break;case"tabular":r.tabularData&&(e.tabularData=Object.freeze({columns:Object.freeze([...r.tabularData.columns]),rows:Object.freeze(r.tabularData.rows.map(t=>Object.freeze({...t})))}));break}}hasContentChanges(e){return!!(e.values||e.items||e.attributeKeys||e.tabularData)}freezeUpdateData(e){e.values&&(e.values=Object.freeze([...e.values])),e.items&&(e.items=Object.freeze(e.items.map(r=>Object.freeze({value:r.value,attributes:Object.freeze({...r.attributes})})))),e.attributeKeys&&(e.attributeKeys=Object.freeze([...e.attributeKeys])),e.tabularData&&(e.tabularData=Object.freeze({columns:Object.freeze([...e.tabularData.columns]),rows:Object.freeze(e.tabularData.rows.map(r=>Object.freeze({...r})))}))}async findTemplateReferences(e){try{const r=await l.template_prompts.toArray(),t=[];for(const s of r)if(s.variables){for(const a of Object.values(s.variables))if(a.type==="list"&&a.listId===e){t.push(s.id);break}}return t}catch(r){return f.error("V4: Failed to find template references",r),[]}}parseCSV(e){const r=e.split(`
`).map(a=>a.trim()).filter(Boolean);if(r.length===0)return{headers:[],rows:[]};const t=this.parseCSVLine(r[0]);if(t.length===0)return{headers:[],rows:[]};const s=[];for(let a=1;a<r.length;a++){const i=this.parseCSVLine(r[a]);if(i.every(n=>!n.trim()))continue;const o={};t.forEach((n,b)=>{o[n]=i[b]||""}),s.push(o)}return{headers:t,rows:s}}parseCSVLine(e){const r=[];let t="",s=!1,a=0;for(;a<e.length;){const i=e[a];i==='"'?s&&e[a+1]==='"'?(t+='"',a+=2):(s=!s,a++):i===","&&!s?(r.push(t.trim()),t="",a++):(t+=i,a++)}return r.push(t.trim()),r}escapeCSVValue(e){return e?e.includes(",")||e.includes('"')||e.includes(`
`)?`"${e.replace(/"/g,'""')}"`:e:""}}const d=new j;function z(){const y=L(new Set),e=L(null),r=S(()=>y.value.size>0);function t(){e.value=null}async function s(u,w){y.value.add(u),e.value=null;try{const h=await w();return h.ok||(e.value=h.error),h}catch(h){const V=h instanceof Error?h:new Error("Command execution failed");return e.value=V,{ok:!1,error:V}}finally{y.value.delete(u)}}async function a(u){return s("create",()=>d.create(u))}async function i(u,w){return s("update",()=>d.update(u,w))}async function o(u){return s("delete",()=>d.delete(u))}async function n(u,w){return s("duplicate",()=>d.duplicate(u,w))}async function b(u){return s("bulkCreate",()=>d.bulkCreate(u))}async function c(u){return s("bulkUpdate",()=>d.bulkUpdate(u))}async function m(u){return s("bulkDelete",()=>d.bulkDelete(u))}async function p(u,w,h,V){return s("importCSV",()=>d.importFromCSV(u,w,h,V))}async function v(u){return s("exportCSV",()=>d.exportToCSV(u))}async function k(u){return s("exportJSON",()=>d.exportToJSON(u))}async function g(){return s("validate",()=>d.validateCrossReferences())}async function C(){return s("cleanup",()=>d.cleanupOrphanedReferences())}return{createVariableList:a,updateVariableList:i,deleteVariableList:o,duplicateVariableList:n,bulkCreateVariableLists:b,bulkUpdateVariableLists:c,bulkDeleteVariableLists:m,importFromCSV:p,exportToCSV:v,exportToJSON:k,validateCrossReferences:g,cleanupOrphanedReferences:C,isExecuting:r,lastError:e,clearError:t}}function x(){const y=L(null);function e(s,a){const i=[];let o=null;try{const b=s.split(`
`).map(p=>p.trim()).filter(Boolean);if(b.length===0)return i.push("CSV file is empty"),{valid:!1,errors:i,preview:o};const c=t(b[0]);if(c.length===0)return i.push("CSV headers are empty"),{valid:!1,errors:i,preview:o};const m=[];for(let p=1;p<Math.min(b.length,6);p++){const v=t(b[p]);if(v.every(g=>!g.trim()))continue;const k={};c.forEach((g,C)=>{k[g]=v[C]||""}),m.push(k)}if(a==="attributed"){const p=c.find(v=>v.toLowerCase()==="value"||v.toLowerCase()==="name");p?c.filter(k=>k!==p).length===0&&i.push("Attributed lists require at least one attribute column"):i.push('Attributed lists require a "value" or "name" column')}o={headers:c,rows:m,totalRows:b.length-1,validRows:m.length}}catch(b){i.push(`CSV parsing error: ${b instanceof Error?b.message:"Unknown error"}`)}const n={valid:i.length===0,errors:i,preview:o};return y.value=n,n}async function r(s,a,i,o){const n=e(s,i);return n.valid?d.importFromCSV(s,a,i,o):{ok:!1,error:new Error(`Validation failed: ${n.errors.join(", ")}`)}}function t(s){const a=[];let i="",o=!1,n=0;for(;n<s.length;){const b=s[n];b==='"'?o&&s[n+1]==='"'?(i+='"',n+=2):(o=!o,n++):b===","&&!o?(a.push(i.trim()),i="",n++):(i+=b,n++)}return a.push(i.trim()),a}return{validateCSV:e,importWithValidation:r,lastValidation:y}}export{x as a,z as u};
