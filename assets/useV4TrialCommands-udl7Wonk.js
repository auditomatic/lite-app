const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-rC-Eq4H2.js","assets/vue-vendor-DPw1dQYc.js","assets/ui-vendor-IRGmExUJ.js","assets/utils-vendor-B76-F3_P.js","assets/tauri-vendor-CZ7fMPM9.js","assets/index-BsU_NJBS.css"])))=>i.map(i=>d[i]);
import{a as l,l as M,d as i,k,i as L,_ as j,c as V}from"./index-rC-Eq4H2.js";import{f as $}from"./utils-vendor-B76-F3_P.js";import{s as _,c as I,o as R,b as F,h as q,f as S}from"./vue-vendor-DPw1dQYc.js";function Q(){const T=performance.now();l.info(`V4_TRIAL_SWITCH: useV4Trials() composable ENTRY at ${T}`);const t=_([]),e=_(!0),a=_(null);let r=null;const n=I(()=>t.value),c=()=>{const f=performance.now();l.info(`V4_TRIAL_SWITCH: setupLiveQuery() ENTRY at ${f}`),r&&(r.unsubscribe(),r=null);const o=M(async()=>{try{return(await i.trials.orderBy("created").reverse().toArray()).filter(h=>!k(h)).map(h=>Object.freeze({...h,created:h.created instanceof Date?h.created:new Date(h.created),started:h.started?h.started instanceof Date?h.started:new Date(h.started):void 0,completed:h.completed?h.completed instanceof Date?h.completed:new Date(h.completed):void 0}))}catch(s){throw l.error("V4_TRIALS: Failed to load trials:",s),s}});r=$(o).subscribe({next:s=>{t.value=s,e.value=!1,a.value=null,`${s.length}`},error:s=>{l.error("V4_TRIALS: Query error:",s),a.value=s instanceof Error?s:new Error("Failed to load trials"),e.value=!1}})},u=I(()=>n.value.filter(f=>f.status==="running")),p=I(()=>n.value.filter(f=>f.status==="draft")),m=I(()=>n.value.filter(f=>f.status==="completed")),d=I(()=>n.value.filter(f=>f.status==="paused")),w=I(()=>n.value.filter(f=>f.status==="failed")),b=I(()=>n.value.length),y=I(()=>{const f={total:n.value.length,byStatus:{draft:0,pending:0,running:0,paused:0,completed:0,cancelled:0,failed:0},totalApiCalls:0,completedApiCalls:0,failedApiCalls:0,averageCompletionRate:0};for(const o of n.value)f.byStatus[o.status]++,o.progress&&(f.totalApiCalls+=o.progress.total,f.completedApiCalls+=o.progress.completed,f.failedApiCalls+=o.progress.failed);return f.totalApiCalls>0&&(f.averageCompletionRate=f.completedApiCalls/f.totalApiCalls*100),f}),A=async()=>{e.value=!0,a.value=null;try{const s=(await i.trials.orderBy("created").reverse().toArray()).filter(g=>!k(g)).map(g=>Object.freeze({...g,created:g.created instanceof Date?g.created:new Date(g.created),started:g.started?g.started instanceof Date?g.started:new Date(g.started):void 0,completed:g.completed?g.completed instanceof Date?g.completed:new Date(g.completed):void 0}));t.value=s,e.value=!1,`${s.length}`}catch(f){l.error("V4_TRIALS: Refresh failed:",f),a.value=f instanceof Error?f:new Error("Failed to refresh trials"),e.value=!1}};return R(()=>{const f=performance.now();l.info(`V4_TRIAL_SWITCH: useV4Trials onMounted() ENTRY at ${f}`),l.info("V4_TRIALS: Mounting trials query composable");const o=performance.now();l.info(`V4_TRIAL_SWITCH: useV4Trials calling setupLiveQuery() at ${(o-f).toFixed(1)}ms`),c();const s=performance.now();l.info(`V4_TRIAL_SWITCH: useV4Trials setupLiveQuery() completed in ${(s-o).toFixed(1)}ms`)}),F(()=>{r&&(r.unsubscribe(),r=null)}),{trials:n,loading:e,error:a,runningTrials:u,draftTrials:p,completedTrials:m,pausedTrials:d,failedTrials:w,totalTrials:b,statistics:y,refresh:A}}function U(T){const t=_(null),e=_(!0),a=_(null);let r=null,n=null;const c=I(()=>(typeof T=="object"&&T!==null?T.value:T)?t.value:null),u=m=>{const d=performance.now();if(r&&(r.unsubscribe(),r=null),!m){t.value=null,e.value=!1;return}const w=M(async()=>{const b=performance.now();`${(b-d).toFixed(1)}`;const y=await i.trials.get(m);return`${(performance.now()-b).toFixed(1)}`,y?Object.freeze({...y,created:y.created instanceof Date?y.created:new Date(y.created),started:y.started?y.started instanceof Date?y.started:new Date(y.started):void 0,completed:y.completed?y.completed instanceof Date?y.completed:new Date(y.completed):void 0}):null});r=$(w).subscribe({next:b=>{const y=performance.now();t.value=b,e.value=!1,a.value=null,b&&`${b.id}${(y-d).toFixed(1)}`},error:b=>{l.error("V4_TRIALS: Single trial query error:",b),a.value=b instanceof Error?b:new Error("Failed to load trial"),e.value=!1}})},p=async()=>{const m=typeof T=="object"&&T!==null?T.value:T;if(!m){t.value=null,e.value=!1;return}e.value=!0,a.value=null;try{const d=await i.trials.get(m);d?t.value=Object.freeze({...d,created:d.created instanceof Date?d.created:new Date(d.created),started:d.started?d.started instanceof Date?d.started:new Date(d.started):void 0,completed:d.completed?d.completed instanceof Date?d.completed:new Date(d.completed):void 0}):t.value=null,e.value=!1}catch(d){l.error("V4_TRIALS: Refresh single trial failed:",d),a.value=d instanceof Error?d:new Error("Failed to refresh trial"),e.value=!1}};return typeof T=="object"&&T!==null?R(()=>{n=q(()=>{const m=T.value;u(m)})}):R(()=>{u(T)}),F(()=>{r&&(r.unsubscribe(),r=null),n&&(n(),n=null)}),{trial:c,loading:e,error:a,refresh:p}}class O{async createTrial(t){try{const e=this.validateTrialConfig(t);if(!e.ok)return{ok:!1,error:e.error};const a=await this.createConfigurationSnapshots(t.configurations);let r=t.templateConfig;if(t.type==="template"&&r){const u=await this.createVariableSnapshots(r.variables);r={...r,variables:u,hasSnapshots:!0}}const n={id:L("trial"),name:t.name,description:t.description,type:t.type,status:"draft",configurations:a,progress:{total:0,completed:0,failed:0,cancelled:0,pending:0,running:0,networkErrors:0},created:new Date,...t.repeatCount&&t.repeatCount>1?{repeatConfig:{callsPerPrompt:t.repeatCount}}:{},...t.type==="template"&&r?{templateConfig:r}:{},...t.type==="spreadsheet"&&t.spreadsheetConfig?{spreadsheetConfig:t.spreadsheetConfig}:{}},c=await this.generateApiCalls(n,t.repeatCount||1);return n.progress.total=c.length,n.progress.pending=c.length,await i.transaction("rw",i.trials,i.apiCalls,async()=>{await i.trials.add(n),c.length>0&&await i.apiCalls.bulkAdd(c)}),`${n.id}${c.length}`,{ok:!0,value:n.id}}catch(e){return l.error("V4_TRIALS: Failed to create trial:",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to create trial")}}}async updateTrial(t,e){try{return await i.transaction("rw",i.trials,async()=>{const a=await i.trials.get(t);if(!a)throw new Error(`Trial not found: ${t}`);const r={...a,...e,created:a.created};await i.trials.put(r)}),{ok:!0}}catch(a){return l.error("V4_TRIALS: Failed to update trial:",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to update trial")}}}async deleteTrial(t){try{return await i.transaction("rw",i.trials,i.apiCalls,async()=>{const e=await i.trials.get(t);if(!e)throw new Error(`Trial not found: ${t}`);if(e.status==="running")throw new Error("Cannot delete running trial");await i.apiCalls.where("trialId").equals(t).delete(),await i.trials.delete(t)}),`${t}`,{ok:!0}}catch(e){return l.error("V4_TRIALS: Failed to delete trial:",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to delete trial")}}}async duplicateTrial(t){try{const e=await i.trials.get(t);if(!e)return{ok:!1,error:new Error(`Source trial not found: ${t}`)};const a={name:`${e.name} (Copy)`,description:e.description,type:e.type,configurations:e.configurations.map(r=>({provider:r.provider,modelId:r.modelId,parameters:r.parameters,name:r.modelSnapshot?.displayName})),repeatCount:e.repeatCount,...e.type==="template"&&e.templateConfig?{templateConfig:e.templateConfig}:{},...e.type==="spreadsheet"&&e.spreadsheetConfig?{spreadsheetConfig:e.spreadsheetConfig}:{}};return this.createTrial(a)}catch(e){return l.error("V4_TRIALS: Failed to duplicate trial:",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to duplicate trial")}}}async updatePostParserId(t,e,a=!1){try{let r=[];if(a&&e){const{parserService:n}=await j(async()=>{const{parserService:u}=await import("./index-rC-Eq4H2.js").then(p=>p.J);return{parserService:u}},__vite__mapDeps([0,1,2,3,4,5])),c=await i.apiCalls.where("trialId").equals(t).and(u=>u.status==="completed"&&!!u.result?.content).toArray();`${c.length}`;for(const u of c){if(!u.result?.content)continue;const p=await n.execute(u.result.content,e);p.success&&r.push({callId:u.id,result:{...u.result,postParsedContent:p.value,postRefused:p.refused||!1}})}`${r.length}`}return await i.transaction("rw",i.trials,i.apiCalls,async()=>{const n=await i.trials.get(t);if(!n)throw new Error(`Trial not found: ${t}`);const c={...n,postParserId:e||void 0,postProcessingConfig:e?void 0:n.postProcessingConfig};if(await i.trials.put(c),r.length>0){`${r.length}`;for(const{callId:u,result:p}of r)await i.apiCalls.update(u,{result:p})}}),`${t}`,{ok:!0}}catch(r){return l.error("V4_TRIALS: Failed to update post-processing parser:",r),{ok:!1,error:r instanceof Error?r:new Error("Failed to update post-processing parser")}}}async updateTrialProgress(t){try{return await i.transaction("rw",i.trials,i.apiCalls,async()=>{const e=await i.trials.get(t);if(!e)throw new Error(`Trial not found: ${t}`);const a=await i.apiCalls.where("trialId").equals(t).toArray();let r=0,n=0,c=0,u=0,p=0;for(const d of a)switch(d.status){case"completed":r++;break;case"failed":n++,d.result?.errorType==="network_error_no_response"&&p++;break;case"cancelled":c++;break;case"running":u++;break}const m=e.progress.total-r-n-c-u;e.progress={total:e.progress.total,completed:r,failed:n,cancelled:c,pending:m,running:u,networkErrors:p},r+n+c>=e.progress.total&&e.status==="running"&&(e.status="completed",e.completed=new Date),await i.trials.put(e)}),{ok:!0}}catch(e){return l.error("V4_TRIALS: Failed to update trial progress:",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to update progress")}}}async generateApiCalls(t,e){return`${t.id}${t.type}`,t.type==="template"&&t.templateConfig?this.generateTemplateApiCalls(t,t.templateConfig,e):t.type==="spreadsheet"&&t.spreadsheetConfig?this.generateSpreadsheetApiCalls(t,t.spreadsheetConfig,e):t.type==="playground"?[]:(l.warn(`V4_TRIALS: Unknown trial type or missing config for trial ${t.id}`),[])}async generateTemplateApiCalls(t,e,a){if(!e)return[];const r=[];let n=0;const c=await this.generateVariableCombinations(e.variables);`${c.length}`;for(let u=0;u<a;u++)for(let p=0;p<t.configurations.length;p++)for(const m of c){const d=this.substituteVariables(e.template,m.variables),w={id:L("call"),trialId:t.id,configurationIndex:p,order:n++,variables:m.variables,variableAttributes:m.variableAttributes,variableIndices:m.variableIndices,prompt:d,status:"pending",retryCount:0,created:new Date};r.push(w)}return`${r.length}`,r}async generateSpreadsheetApiCalls(t,e,a){if(!e)return[];const r=[];let n=0;const c=await i.variableLists.get(e.datasetId);if(!c||c.category!=="tabular"||!c.tabularData?.rows)return l.warn(`V4_TRIALS: Dataset ${e.datasetId} not found or invalid`),[];for(let u=0;u<a;u++)for(const p of c.tabularData.rows){const m=this.substituteVariables(e.promptPattern,p);for(let d=0;d<t.configurations.length;d++){const w={id:L("call"),trialId:t.id,configurationIndex:d,order:n++,variables:p,prompt:m,status:"pending",retryCount:0,created:new Date};r.push(w)}}return`${r.length}`,r}async generateVariableCombinations(t){const e=Object.keys(t).sort();if(e.length===0)return[{variables:{}}];const a={};for(const u of e){const p=t[u];let m=[];const d=p;if(d.snapshot)m=d.snapshot.items.map(w=>({value:w.value,attributes:w.attributes}));else if(p.type==="value"&&p.values)m=p.values.map(w=>({value:w}));else if(p.type==="list"&&p.listId){const w=await i.variableLists.get(p.listId);w&&(w.category==="simple"&&w.values?m=w.values.map(b=>({value:b})):w.category==="attributed"&&w.items?m=w.items.map(b=>({value:b.value||b.name||String(b),attributes:b.attributes||{}})):w.category==="tabular"&&w.tabularData?.rows&&(m=w.tabularData.rows.map(b=>({value:b.name||b[Object.keys(b)[0]]||String(b)}))))}a[u]=m}const n=e.map(u=>Math.max(a[u].length,1)).reduce((u,p)=>u*p,1),c=[];for(let u=0;u<n;u++){const p={},m={},d={};let w=u;for(let y=e.length-1;y>=0;y--){const A=e[y],f=a[A];if(f.length>0){const o=w%f.length,s=f[o];p[A]=s.value,d[A]=o,s.attributes&&Object.keys(s.attributes).length>0&&(m[A]={...s.attributes}),w=Math.floor(w/f.length)}else p[A]="",d[A]=0}const b={variables:p};Object.keys(m).length>0&&(b.variableAttributes=m),Object.keys(d).length>0&&(b.variableIndices=d),c.push(b)}return c}substituteVariables(t,e){let a=t;for(const[r,n]of Object.entries(e)){const c=new RegExp(`\\{\\{\\s*${r}\\s*\\}\\}`,"g");a=a.replace(c,n)}return a}validateTrialConfig(t){if(!t.name||t.name.trim().length===0)return{ok:!1,error:new Error("Trial name is required")};if(!t.configurations||t.configurations.length===0)return{ok:!1,error:new Error("At least one model configuration is required")};for(const e of t.configurations){if(!V.getProvider(e.provider))return{ok:!1,error:new Error(`Provider not found: ${e.provider}`)};const r=V.validateParameters(e.provider,e.modelId,e.parameters);if(!r.valid)return{ok:!1,error:new Error(`Invalid parameters: ${r.errors?.join(", ")||"Validation failed"}`)}}if(t.type==="template"){if(!t.templateConfig||!t.templateConfig.template)return{ok:!1,error:new Error("Template is required for template trials")}}else if(t.type==="spreadsheet"&&(!t.spreadsheetConfig||!t.spreadsheetConfig.promptPattern))return{ok:!1,error:new Error("Prompt pattern is required for spreadsheet trials")};return{ok:!0}}async createConfigurationSnapshots(t){const e=[];for(const a of t){const r=V.getProvider(a.provider);if(!r)throw new Error(`Provider not found: ${a.provider}`);const c=(await i.models.where("provider").equals(a.provider).toArray()).find(p=>p.modelId===a.modelId),u={provider:a.provider,modelId:a.modelId,parameters:a.parameters,providerSnapshot:r,modelSnapshot:c||{id:`${a.provider}:${a.modelId}`,provider:a.provider,modelId:a.modelId,displayName:a.name||a.modelId,enabled:!0,source:"user"}};e.push(u)}return e}async createVariableSnapshots(t){const e={};for(const[a,r]of Object.entries(t)){const n={...r};if(r.type==="value"&&r.values)n.snapshot={source:{type:"direct",snapshotDate:new Date},items:r.values.map(c=>({value:c}))};else if(r.type==="list"&&r.listId){const c=await i.variableLists.get(r.listId);c&&(n.snapshot=await this.snapshotVariableList(c))}e[a]=n}return e}async snapshotVariableList(t){const e={source:{type:t.category,listId:t.id,listName:t.name,snapshotDate:new Date},items:[]};switch(t.category){case"simple":case"refusal":e.items=t.values?.map(a=>({value:a}))||[];break;case"attributed":e.items=t.items?.map(a=>({value:a.value,attributes:{...a.attributes}}))||[],e.attributeKeys=[...t.attributeKeys||[]];break;case"tabular":t.tabularData?.rows&&(e.items=t.tabularData.rows.map(a=>({value:a.name||a[Object.keys(a)[0]]||""})));break}return e}}const D=new O,B=Object.freeze(Object.defineProperty({__proto__:null,V4TrialOperations:O,v4TrialOperations:D},Symbol.toStringTag,{value:"Module"}));function G(){const T=S(!1),t=S(!1),e=S(!1),a=S(!1),r=S(null),n=async o=>{T.value=!0,r.value=null;try{const s=await D.createTrial(o);return s.ok?s.value:(r.value=s.error||new Error("Failed to create trial"),l.error("V4_TRIAL_COMMANDS: Create trial failed:",s.error)),s}finally{T.value=!1}},c=async(o,s,g)=>{try{const v=await i.template_prompts.get(o);if(!v)return{ok:!1,error:new Error(`Template not found: ${o}`)};const h={name:g||`${v.name} - ${new Date().toLocaleString()}`,description:v.description,type:"template",configurations:s,repeatCount:1,templateConfig:{template:v.template,templateId:v.id,templateName:v.name,variables:v.variables||{},outputType:v.outputType,extractPattern:v.extractPattern,refusalWords:v.refusalWords?[...v.refusalWords]:void 0,refusalMode:v.refusalMode,rejectRefusalWords:v.rejectRefusalWords}};return n(h)}catch(v){return l.error("V4_TRIAL_COMMANDS: Failed to create trial from template:",v),{ok:!1,error:v instanceof Error?v:new Error("Failed to create trial from template")}}},u=async(o,s,g,v)=>{try{const h=await i.variableLists.get(s);if(!h||h.category!=="tabular")return{ok:!1,error:new Error(`Dataset not found or not tabular: ${s}`)};const C={name:v||`Spreadsheet Trial - ${new Date().toLocaleString()}`,type:"spreadsheet",configurations:g,spreadsheetConfig:{promptPattern:o,datasetId:s}};return n(C)}catch(h){return l.error("V4_TRIAL_COMMANDS: Failed to create spreadsheet trial:",h),{ok:!1,error:h instanceof Error?h:new Error("Failed to create spreadsheet trial")}}},p=async(o,s)=>{t.value=!0,r.value=null;try{const g=await D.updateTrial(o,s);return g.ok||(r.value=g.error||new Error("Failed to update trial"),l.error("V4_TRIAL_COMMANDS: Update trial failed:",g.error)),g}finally{t.value=!1}},m=async(o,s)=>p(o,{status:s}),d=async o=>{e.value=!0,r.value=null;try{const s=await D.deleteTrial(o);return s.ok||(r.value=s.error||new Error("Failed to delete trial"),l.error("V4_TRIAL_COMMANDS: Delete trial failed:",s.error)),s}finally{e.value=!1}},w=async o=>{e.value=!0,r.value=null;try{return o.length,await i.transaction("rw",i.trials,i.apiCalls,async()=>{for(const s of o){const g=await i.trials.get(s);g&&g.status!=="running"&&(await i.apiCalls.where("trialId").equals(s).delete(),await i.trials.delete(s))}}),{ok:!0}}catch(s){return l.error("V4_TRIAL_COMMANDS: Failed to delete multiple trials:",s),r.value=s instanceof Error?s:new Error("Failed to delete trials"),{ok:!1,error:r.value}}finally{e.value=!1}},b=async o=>{a.value=!0,r.value=null;try{const s=await D.duplicateTrial(o);return s.ok?s.value:(r.value=s.error||new Error("Failed to duplicate trial"),l.error("V4_TRIAL_COMMANDS: Duplicate trial failed:",s.error)),s}finally{a.value=!1}},y=async o=>{try{let s=1;if(o.type==="template"&&o.templateConfig){const v=o.templateConfig.variables;for(const[,h]of Object.entries(v))if(h.type==="value"&&h.values)s*=h.values.length;else if(h.type==="list"&&h.listId){const C=await i.variableLists.get(h.listId);C&&(C.category==="simple"&&C.values?s*=C.values.length:C.category==="attributed"&&C.items?s*=C.items.length:C.category==="tabular"&&C.tabularData?.rows&&(s*=C.tabularData.rows.length))}}else if(o.type==="spreadsheet"&&o.spreadsheetConfig){const v=await i.variableLists.get(o.spreadsheetConfig.datasetId);v&&v.category==="tabular"&&v.tabularData?.rows&&(s=v.tabularData.rows.length)}return s*o.configurations.length*(o.repeatCount||1)}catch(s){return l.error("V4_TRIAL_COMMANDS: Failed to calculate API call count:",s),0}};return{createTrial:n,createTrialFromTemplate:c,createTrialFromSpreadsheet:u,updateTrial:p,updateTrialStatus:m,deleteTrial:d,deleteMultipleTrials:w,duplicateTrial:b,generateApiCallCount:y,estimateTrialCost:async o=>{try{const s=await y(o);let g=0;for(const v of o.configurations){const C=(await i.models.where("provider").equals(v.provider).toArray()).find(E=>E.modelId===v.modelId);if(C?.capabilities){const P=v.parameters?.max_tokens||v.parameters?.maxTokens||256,N=(C.capabilities.inputCostPerToken||0)*150,x=(C.capabilities.outputCostPerToken||0)*P;g+=(N+x)*s/o.configurations.length}}return g}catch(s){return l.error("V4_TRIAL_COMMANDS: Failed to estimate cost:",s),0}},validateTrialConfig:o=>!o.name||o.name.trim().length===0?{ok:!1,error:new Error("Trial name is required")}:!o.configurations||o.configurations.length===0?{ok:!1,error:new Error("At least one model configuration is required")}:o.type==="template"&&!o.templateConfig?{ok:!1,error:new Error("Template configuration is required for template trials")}:o.type==="spreadsheet"&&!o.spreadsheetConfig?{ok:!1,error:new Error("Spreadsheet configuration is required for spreadsheet trials")}:{ok:!0},isCreating:T,isUpdating:t,isDeleting:e,isDuplicating:a,lastError:r}}export{G as a,U as b,B as c,Q as u,D as v};
