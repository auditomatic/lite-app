import{f as z,c as A,d as H,o as ne,b as _e,w as G,R as b,a0 as ae,_ as V,n as ye,k as r,S as t,Z as $,V as _,q as Ce,a2 as be,F as Q,W as X,Y as v,G as L,u as x,r as he,$ as K,e as ke,z as $e,p as Te,a1 as we,X as Ie}from"./vue-vendor-Dnvc27xK.js";import{a as J,d as Se,h as Y,e as Pe,c as xe}from"./index-Cl7pIQF6.js";import{u as De}from"./useV4Templates-kO7BzvKY.js";import{a as pe}from"./useV4VariableLists-CxHEDf57.js";import{u as oe}from"./useV4Models-D3tTJsWQ.js";import{u as ie,a as Ee,b as Me}from"./useV4TrialCommands-BcZp6X9B.js";import{m as Z,T as le,aG as ce,R as Le,N as Ne,I as me,aH as ue,r as Ae,F as Ve,V as ee,aI as Oe,s as ze,ab as Re,ac as je,t as Be,z as Fe,w as Ue,X as Je,W as We,J as qe,aJ as Ke,G as Ge,M as ve,p as He,H as fe,aK as Ye,P as Ze,ao as Qe,ag as Xe,af as et,k as te}from"./ui-vendor-x6pj6AZw.js";import{G as tt}from"./GenericModelSelectorModalV3-DUsjXiUv.js";import{u as re}from"./useCostEstimation-B9Of6wR0.js";import"./utils-vendor-DgugrPw1.js";import"./data-vendor-Bm9xWgJa.js";import"./useV4LiveQuery-BxmuCaLK.js";import"./useV4ProviderParameters-DxfMM5Hu.js";function at(U){const{templates:D}=De(),{variableLists:a}=pe(),{enabledModels:I}=oe(),{runningTrials:p}=ie(),S=Me(),{createTrial:C}=Ee(),c=z(null),m=z(""),y=z(""),k=z(1),P=z([]),R=z(!1),N=z(!1),d=A(()=>D.value||[]),i=A(()=>[]),E=A(()=>{if(!c.value)return 0;if(c.value.type==="template"){const u=c.value;if(!u.variables)return 1;let T=1;for(const[,j]of Object.entries(u.variables))if(j.type==="value"&&j.values)T*=j.values.length;else if(j.type==="list"&&j.listId){const W=a.value.find(q=>q.id===j.listId);W&&(W.category==="simple"?T*=W.values?.length||0:W.category==="attributed"?T*=W.items?.length||0:W.category==="tabular"&&(T*=W.itemCount||0))}return T}else return 0}),M=A(()=>E.value*P.value.length*k.value),B=A(()=>{let u=0;for(const T of P.value){const j=e(T);u+=j*E.value*k.value}return u}),F=A(()=>c.value!==null&&P.value.length>0&&m.value.trim()!=="");function w(u){c.value=u,m.value=O(u)}function O(u){const T=u||c.value;if(!T)return"New Trial";const j=new Date().toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return`${T.name} - ${j}`}function e(u){if(!c.value)return 0;const T=I.value.find(de=>de.provider===u.provider&&de.modelId===u.modelId);if(!T?.capabilities)return 0;const j=s(),W=u.parameters?.max_tokens||u.parameters?.maxTokens||256,q=(T.capabilities.inputCostPerToken||0)*j,ge=(T.capabilities.outputCostPerToken||0)*W;return q+ge}function s(){return c.value&&c.value.type==="template"?150:100}function o(u){P.value.push(u)}function n(u){P.value.splice(u,1)}async function g(){if(F.value){R.value=!0;try{const u=JSON.parse(JSON.stringify(c.value)),T={name:m.value,description:"",type:u.type,configurations:JSON.parse(JSON.stringify(P.value)),repeatCount:k.value,templateConfig:u.type==="template"?{template:u.template,variables:u.variables,outputType:u.outputType,extractPattern:u.extractPattern,refusalWords:u.refusalWords,rejectRefusalWords:u.rejectRefusalWords}:void 0,spreadsheetConfig:u.type==="spreadsheet"?{promptPattern:u.promptPattern,datasetId:u.datasetId}:void 0},j=await C(T);if(j.ok)return j.value;throw j.error}finally{R.value=!1}}}async function l(){const u=await g();if(u)return p.value.length>0?{trialId:u,needsConfirmation:!0,runningTrial:p.value[0]}:await f(u)}async function f(u){const T=await S.startTrialWithStreaming(u);if(T.ok){const j=T.value.progress$.subscribe({next:q=>{q.type},error:q=>{J.error("V4: Creation view stream error:",q)}}),W=T.value.calls$.subscribe({next:q=>{q.length},error:q=>{J.error("V4: Creation view calls stream error:",q)}});return setTimeout(()=>{j.unsubscribe(),W.unsubscribe()},1e3),{trialId:u,needsConfirmation:!1}}else throw T.error}async function h(){try{await S.initialize()}catch(u){J.error("V4: Failed to initialize execution control in creation view:",u)}if(U.value.type==="duplicate"&&U.value.sourceTrialId){const u=await Se.trials.get(U.value.sourceTrialId);if(u){if(m.value=`Copy of ${u.name}`,k.value=u.repeatCount||1,u.configurations&&(P.value=u.configurations.map(T=>({name:T.modelSnapshot?.displayName||T.modelId,provider:T.provider,modelId:T.modelId,parameters:T.parameters||{}}))),u.type==="template"&&u.templateConfig?.template){const T=d.value.find(j=>j.template===u.templateConfig?.template);T&&w(T)}else if(u.type==="spreadsheet"&&u.spreadsheetConfig?.datasetId){const T=i.value.find(j=>j.datasetId===u.spreadsheetConfig?.datasetId);T&&w(T)}}}}return{selectedPrompt:c,trialName:m,description:y,repeatCount:k,configurations:P,creating:R,showModelSelector:N,templates:d,spreadsheets:i,variableLists:a,enabledModels:I,runningTrials:p,totalCombinations:E,totalExperiments:M,totalCost:B,canProceed:F,selectPrompt:w,generateTrialName:O,addConfiguration:o,removeConfiguration:n,getConfigCostPerCall:e,createTrialAsDraft:g,createAndStartTrial:l,initialize:h}}const st={key:0,class:"preview-controls"},nt={class:"template-name"},ot={key:0,class:"cycle-info"},it={key:1,class:"variable-legend"},lt={class:"variable-value"},rt=H({__name:"TemplatePreviewV3",props:{template:{},variableLists:{default:()=>[]},cycling:{type:Boolean,default:!0},cyclingSpeed:{default:1e3},showControls:{type:Boolean,default:!1},displayMode:{default:"block"},showLegend:{type:Boolean,default:!1},maxLines:{default:0}},emits:["update:paused","back-to-select"],setup(U,{emit:D}){const a=U,I=D,p=z(0),S=z(!1);let C=null;const c=["variable-highlight-blue","variable-highlight-green","variable-highlight-purple","variable-highlight-orange","variable-highlight-pink","variable-highlight-teal"],m=A(()=>a.template.type==="template"?a.template.template:a.template.type==="spreadsheet"?a.template.promptPattern:""),y=A(()=>{if(a.template.type==="spreadsheet"){const o=a.template,n=a.variableLists.find(g=>g.id===o.datasetId);return n?.category==="tabular"&&n.tabularData?.rows?n.tabularData.rows.map(g=>{const l={};return Object.keys(g).forEach(f=>{let h=f.replace(/[^a-zA-Z0-9_]/g,"_");/^[a-zA-Z]/.test(h)||(h="col_"+h),h=h.replace(/_+/g,"_").replace(/_+$/,""),l[h]=String(g[f]||"")}),l}):[]}const w=[];if(a.template.variables){for(const[o,n]of Object.entries(a.template.variables))if(n.type==="value"&&n.values)w.push({name:o,values:[...n.values]});else if(n.type==="list"&&n.listId){const g=a.variableLists.find(l=>l.id===n.listId);g&&(g.category==="simple"&&g.values?w.push({name:o,values:[...g.values]}):g.category==="attributed"&&g.items&&w.push({name:o,values:g.items.map(l=>l.value)}))}}if(w.length===0)return[];const O=o=>o.reduce((n,g)=>n.flatMap(l=>g.map(f=>[...l,f])),[[]]),e=w.map(o=>o.values);return O(e).map(o=>{const n={};return w.forEach((g,l)=>{n[g.name]=o[l]}),n})}),k=A(()=>y.value.length),P=A(()=>y.value.length===0?null:y.value[p.value]||y.value[0]),R=A(()=>{const w=m.value;if(!w)return"";const O=P.value;if(!O||Object.keys(O).length===0)return i(w).replace(/\n/g,"<br>");let e=i(w);if(Object.keys(O).sort((o,n)=>n.length-o.length).forEach((o,n)=>{const g=O[o],l=i(g),f=d(n),h=new RegExp(`{{\\s*${E(o)}\\s*}}`,"g");e=e.replace(h,`<span class="${f} variable-value">${l}</span>`)}),e=e.replace(/\n/g,"<br>"),a.maxLines>0){const o=e.split("<br>");o.length>a.maxLines&&(e=o.slice(0,a.maxLines).join("<br>")+'<br><span class="line-clamp-indicator">...</span>')}return e}),N=A(()=>a.displayMode==="inline"&&a.maxLines>0?{display:"-webkit-box","-webkit-line-clamp":a.maxLines,"-webkit-box-orient":"vertical",overflow:"hidden"}:{});function d(w){return c[w%c.length]}function i(w){const O=document.createElement("div");return O.textContent=w,O.innerHTML}function E(w){return w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function M(){S.value=!S.value,I("update:paused",S.value)}function B(){!a.cycling||S.value||k.value<=1||(C=setInterval(()=>{p.value=(p.value+1)%k.value},a.cyclingSpeed))}function F(){C&&(clearInterval(C),C=null)}return ne(()=>{a.cycling&&!S.value&&B()}),_e(()=>{F()}),G(()=>S.value,w=>{w||!a.cycling?F():B()}),G(()=>a.cycling,w=>{w?S.value||B():(F(),p.value=0)}),G(()=>a.cyclingSpeed,()=>{a.cycling&&!S.value&&(F(),B())}),G(k,()=>{p.value=0}),(w,O)=>{const e=Z,s=le,o=Ce("dompurify-html");return v(),b("div",{class:ae(["template-preview",[`preview-${w.displayMode}`,{"preview-cycling":w.cycling&&!S.value}]])},[w.showControls?(v(),b("div",st,[r(e,{type:"link",onClick:O[0]||(O[0]=n=>w.$emit("back-to-select")),class:"back-to-select"},{default:$(()=>[r(x(ce)),O[1]||(O[1]=L(" Back to Select Template "))]),_:1,__:[1]}),t("h3",nt,_(a.template.name),1),r(e,{onClick:M,size:"small",type:S.value?"default":"primary",disabled:!w.cycling||k.value<=1},{default:$(()=>[L(_(S.value?"Start":"Pause")+" Variable Selection ",1)]),_:1},8,["type","disabled"]),w.cycling&&k.value>1?(v(),b("span",ot,_(p.value+1)+" / "+_(k.value),1)):V("",!0),r(s,{color:a.template.type==="template"?"blue":"green",class:"source-badge"},{default:$(()=>[L(_(a.template.type==="template"?"Prompt Design":"Spreadsheet Design"),1)]),_:1},8,["color"])])):V("",!0),ye(t("div",{class:"preview-content",style:be(N.value)},null,4),[[o,R.value,"template"]]),w.showLegend&&P.value&&Object.keys(P.value).length>0?(v(),b("div",it,[(v(!0),b(Q,null,X(P.value,(n,g,l)=>(v(),b("div",{key:g,class:"legend-item"},[t("span",{class:ae(d(l))},_(g),3),t("span",lt,_(n),1)]))),128))])):V("",!0)],2)}}}),se=Y(rt,[["__scopeId","data-v-1ad1228f"]]),dt={class:"design-selection"},ut={class:"design-selector","data-testid":"template-design-selector"},pt={key:0,class:"no-designs-state"},ct={class:"no-designs-content"},mt={key:1,class:"no-designs-state"},vt={class:"no-designs-content"},ft={key:2,class:"design-list","data-testid":"design-list"},gt=["data-template-id","data-template-name","onClick"],_t={class:"design-header"},yt={class:"design-title-section"},Ct={class:"design-name"},bt={key:0,class:"design-inline-description"},ht={class:"design-date"},kt={class:"design-stats"},$t={class:"stat-item"},Tt={class:"stat-value"},wt={class:"stat-item"},It={class:"stat-value"},St={class:"stat-item"},Pt={class:"stat-value"},xt={class:"design-selector","data-testid":"spreadsheet-design-selector"},Dt={key:0,class:"no-designs-state"},Et={class:"no-designs-content"},Mt={key:1,class:"design-list","data-testid":"design-list"},Lt=["data-spreadsheet-id","data-spreadsheet-name","onClick"],Nt={class:"design-header"},At={class:"design-title-section"},Vt={class:"design-name"},Ot={key:0,class:"design-inline-description"},zt={class:"design-date"},Rt={class:"design-stats"},jt={class:"stat-item"},Bt={class:"stat-value"},Ft={class:"stat-item"},Ut={class:"stat-value"},Jt={class:"stat-item"},Wt={class:"stat-value"},qt=H({__name:"TrialDesignSelectionV3",props:{templates:{},spreadsheets:{},variableLists:{}},emits:["select","create-template","create-spreadsheet"],setup(U){const D=Pe(),a=U,I=z("template"),p=z(""),S=z(""),C=A(()=>{if(!p.value)return a.templates;const d=p.value.toLowerCase();return a.templates.filter(i=>i.name.toLowerCase().includes(d)||(i.description||"").toLowerCase().includes(d))}),c=A(()=>{if(!S.value)return a.spreadsheets;const d=S.value.toLowerCase();return a.spreadsheets.filter(i=>i.name.toLowerCase().includes(d)||(i.description||"").toLowerCase().includes(d))});function m(d){const i=typeof d=="string"?new Date(d):d,M=new Date().getTime()-i.getTime(),B=Math.floor(M/(1e3*60*60*24));if(B===0){const F=Math.floor(M/36e5);if(F===0){const w=Math.floor(M/6e4);return w<=1?"just now":`${w} min ago`}return F===1?"1 hour ago":`${F} hours ago`}else return B===1?"yesterday":B<7?`${B} days ago`:i.toLocaleDateString("en-US",{month:"short",day:"numeric"})}function y(d){return d.variables?Object.keys(d.variables).length:0}function k(d){if(!d.variables)return 1;let i=1;for(const[,E]of Object.entries(d.variables))if(E.type==="value"&&E.values)i*=E.values.length;else if(E.type==="list"&&E.listId){const M=a.variableLists.find(B=>B.id===E.listId);M&&(M.category==="simple"?i*=M.values?.length||0:M.category==="attributed"?i*=M.items?.length||0:M.category==="tabular"&&(i*=M.itemCount||0))}return i}function P(d){return a.variableLists.find(E=>E.id===d.datasetId)?.itemCount||0}function R(d){const i=a.variableLists.find(E=>E.id===d.datasetId);return i?.category==="tabular"&&i.tabularData?.columns?i.tabularData.columns.length:0}function N(d){if(!d)return"???";try{if("template"in d&&d.template)return`~${D.estimateTokens(d.template)}`;if("promptPattern"in d&&d.promptPattern)return`~${D.estimateTokens(d.promptPattern)}`}catch(i){J.warn("Failed to estimate tokens:",i)}return"???"}return(d,i)=>{const E=me,M=Ae,B=Z,F=le,w=Ne,O=Le;return v(),b("div",dt,[r(O,{activeKey:I.value,"onUpdate:activeKey":i[6]||(i[6]=e=>I.value=e),size:"large"},{default:$(()=>[r(w,{key:"template",tab:"Prompt Designs (one API call per combination)"},{default:$(()=>[t("div",ut,[r(E,{value:p.value,"onUpdate:value":i[0]||(i[0]=e=>p.value=e),placeholder:"Search prompt designs...",size:"large",class:"design-search","data-testid":"input-template-search",allowClear:""},{prefix:$(()=>[r(x(ue))]),_:1},8,["value"]),!d.templates||d.templates.length===0?(v(),b("div",pt,[t("div",ct,[r(M,{size:"large",tip:"Loading templates..."})])])):C.value.length===0?(v(),b("div",mt,[t("div",vt,[i[8]||(i[8]=t("p",null,"No prompt designs found",-1)),r(B,{type:"primary",onClick:i[1]||(i[1]=e=>d.$emit("create-template"))},{default:$(()=>[r(x(Ve)),i[7]||(i[7]=L(" Create Prompt Design "))]),_:1,__:[7]})])])):(v(),b("div",ft,[(v(!0),b(Q,null,X(C.value,e=>(v(),b("div",{key:e.id,class:"design-item","data-testid":"template-item","data-template-id":e.id,"data-template-name":e.name,onClick:s=>d.$emit("select",e)},[t("div",_t,[t("div",yt,[t("h4",Ct,[L(_(e.name)+" ",1),e.description?(v(),b("span",bt,"- "+_(e.description),1)):V("",!0)])]),t("span",ht,_(m(e.updated)),1)]),r(se,{template:e,"variable-lists":d.variableLists,cycling:!0,"show-controls":!1,"display-mode":"inline","max-lines":5,class:"design-preview"},null,8,["template","variable-lists"]),t("div",kt,[r(F,{size:"small",color:"blue",class:"output-type-tag"},{default:$(()=>[L(_(e.outputType||"text"),1)]),_:2},1024),t("span",$t,[t("span",Tt,_(y(e)),1),i[9]||(i[9]=t("span",{class:"stat-label"},"vars",-1))]),i[12]||(i[12]=t("span",{class:"stat-divider"},"•",-1)),t("span",wt,[t("span",It,_(k(e)),1),i[10]||(i[10]=t("span",{class:"stat-label"},"combos",-1))]),i[13]||(i[13]=t("span",{class:"stat-divider"},"•",-1)),t("span",St,[t("span",Pt,_(N(e)),1),i[11]||(i[11]=t("span",{class:"stat-label"},"tokens",-1))])])],8,gt))),128)),t("div",{class:"design-item design-item-create","data-testid":"btn-create-design",onClick:i[2]||(i[2]=e=>d.$emit("create-template"))},[r(x(ee),{style:{"font-size":"24px"}}),i[14]||(i[14]=t("span",null,"Create New Design",-1))])]))])]),_:1}),r(w,{key:"spreadsheet",tab:"Spreadsheet Designs (one API call per row)"},{default:$(()=>[t("div",xt,[r(E,{value:S.value,"onUpdate:value":i[3]||(i[3]=e=>S.value=e),placeholder:"Search spreadsheet designs...",size:"large",class:"design-search","data-testid":"input-spreadsheet-search",allowClear:""},{prefix:$(()=>[r(x(ue))]),_:1},8,["value"]),c.value.length===0?(v(),b("div",Dt,[t("div",Et,[i[16]||(i[16]=t("p",null,"No spreadsheet designs found",-1)),r(B,{type:"primary",onClick:i[4]||(i[4]=e=>d.$emit("create-spreadsheet"))},{default:$(()=>[r(x(Oe)),i[15]||(i[15]=L(" Create Spreadsheet Design "))]),_:1,__:[15]})])])):(v(),b("div",Mt,[(v(!0),b(Q,null,X(c.value,e=>(v(),b("div",{key:e.id,class:"design-item","data-testid":"spreadsheet-item","data-spreadsheet-id":e.id,"data-spreadsheet-name":e.name,onClick:s=>d.$emit("select",e)},[t("div",Nt,[t("div",At,[t("h4",Vt,[L(_(e.name)+" ",1),e.description?(v(),b("span",Ot,"- "+_(e.description),1)):V("",!0)])]),t("span",zt,_(m(e.updated)),1)]),r(se,{template:e,"variable-lists":d.variableLists,cycling:!0,"show-controls":!1,"display-mode":"inline","max-lines":5,class:"design-preview"},null,8,["template","variable-lists"]),t("div",Rt,[r(F,{size:"small",color:"green",class:"output-type-tag"},{default:$(()=>[L(_(e.outputType||"text"),1)]),_:2},1024),t("span",jt,[t("span",Bt,_(P(e)),1),i[17]||(i[17]=t("span",{class:"stat-label"},"rows",-1))]),i[20]||(i[20]=t("span",{class:"stat-divider"},"•",-1)),t("span",Ft,[t("span",Ut,_(R(e)),1),i[18]||(i[18]=t("span",{class:"stat-label"},"cols",-1))]),i[21]||(i[21]=t("span",{class:"stat-divider"},"•",-1)),t("span",Jt,[t("span",Wt,_(N(e)),1),i[19]||(i[19]=t("span",{class:"stat-label"},"tokens",-1))])])],8,Lt))),128)),t("div",{class:"design-item design-item-create","data-testid":"btn-create-spreadsheet",onClick:i[5]||(i[5]=e=>d.$emit("create-spreadsheet"))},[r(x(ee),{style:{"font-size":"24px"}}),i[22]||(i[22]=t("span",null,"Create New Spreadsheet Design",-1))])]))])]),_:1})]),_:1},8,["activeKey"])])}}}),Kt=Y(qt,[["__scopeId","data-v-db101528"]]),Gt={class:"trial-metadata-form"},Ht=H({__name:"TrialMetadataV3",props:{name:{},repeatCount:{default:1},description:{default:""},totalCombinations:{default:0}},emits:["update:name","update:repeatCount","update:description"],setup(U,{emit:D}){const a=U,I=D,p=he({name:a.name,repeatCount:a.repeatCount,description:a.description||""}),S=A(()=>{if(a.totalCombinations>0&&p.repeatCount>1){const c=a.totalCombinations*p.repeatCount;return`Each prompt will be run ${p.repeatCount} times (${c} total calls)`}return"Number of times to run each prompt"});function C(){I("update:name",p.name),I("update:repeatCount",p.repeatCount),I("update:description",p.description)}return G(()=>a.name,c=>{p.name=c}),G(()=>a.repeatCount,c=>{p.repeatCount=c}),G(()=>a.description,c=>{p.description=c||""}),(c,m)=>{const y=me,k=Be,P=je,R=Fe,N=Re,d=Ue,i=ze;return v(),b("div",Gt,[r(i,{layout:"vertical",model:p},{default:$(()=>[r(N,{gutter:24},{default:$(()=>[r(P,{span:18},{default:$(()=>[r(k,{label:"Trial Name",rules:[{required:!0,message:"Please enter a trial name"}]},{default:$(()=>[r(y,{value:p.name,"onUpdate:value":m[0]||(m[0]=E=>p.name=E),size:"large",placeholder:"e.g., GPT-4 Performance Test",onChange:C},null,8,["value"])]),_:1})]),_:1}),r(P,{span:6},{default:$(()=>[r(k,{label:"Repeat Count",help:S.value},{default:$(()=>[r(R,{value:p.repeatCount,"onUpdate:value":m[1]||(m[1]=E=>p.repeatCount=E),min:1,max:100,size:"large",style:{width:"100%"},onChange:C},null,8,["value"])]),_:1},8,["help"])]),_:1})]),_:1}),r(k,{label:"Description (Optional)"},{default:$(()=>[r(d,{value:p.description,"onUpdate:value":m[2]||(m[2]=E=>p.description=E),placeholder:"Add any notes about this trial...",rows:2,onChange:C},null,8,["value"])]),_:1})]),_:1},8,["model"])])}}}),Yt=Y(Ht,[["__scopeId","data-v-b945eb57"]]),Zt={class:"model-configuration"},Qt={key:0,class:"quick-add-section"},Xt={class:"quick-add-models"},ea={class:"provider-name"},ta={class:"model-name"},aa={key:0,class:"param-info"},sa={class:"configuration-table"},na={class:"table-header"},oa={style:{display:"inline-flex","align-items":"center",gap:"0"}},ia={key:0,class:"model-name-cell"},la={class:"model-name"},ra={class:"model-id"},da={key:1,class:"parameter-tags"},ua={key:2,class:"cost-cell"},pa={class:"cost-value"},ca={key:0,class:"cost-summary"},ma={class:"cost-summary-item"},va={class:"cost-summary-item"},fa={class:"total-cost"},ga=H({__name:"ModelConfigurationV3",props:{configurations:{},totalCombinations:{},repeatCount:{},tokenData:{}},emits:["add-configuration","remove-configuration"],setup(U,{emit:D}){const a=U,I=D,{models:p}=oe(),{trials:S}=ie(),{estimateTotalCost:C,multiplyEstimate:c}=re(),m=z(!1),y=A(()=>{const e=new Map;if(S.value&&S.value.length>0){const l=S.value.filter(f=>f.status!=="draft").slice(0,10);for(const f of l)if(f.configurations){for(const h of f.configurations){const u=JSON.stringify(h.parameters||{}),T=`${h.provider}-${h.modelId}-${u}`;if(e.has(T)||e.set(T,h),e.size>=15)break}if(e.size>=15)break}}const s=new Set(a.configurations.map(l=>{const f=JSON.stringify(l.parameters||{});return`${l.provider}-${l.modelId}-${f}`})),o=Array.from(e.values()).filter(l=>{const f=JSON.stringify(l.parameters||{}),h=`${l.provider}-${l.modelId}-${f}`;if(s.has(h))return!1;const u=p.value?.find(T=>T.provider===l.provider&&T.modelId===l.modelId);return!(!u||!u.enabled)}),n=[{provider:"openai-chat",modelId:"gpt-4o-mini",params:{temperature:0,max_completion_tokens:1e3}},{provider:"openai-chat",modelId:"gpt-4.1-nano",params:{temperature:0,max_completion_tokens:500}},{provider:"anthropic",modelId:"claude-3-5-haiku-latest",params:{temperature:0,max_tokens:1e3}},{provider:"openrouter",modelId:"meta-llama/llama-4-maverick",params:{temperature:.8,max_tokens:2e3}},{provider:"openrouter",modelId:"mistralai/mistral-nemo",params:{temperature:.7,max_tokens:1500}},{provider:"ollama-generate",modelId:"qwen2.5:0.5b",params:{temperature:0,num_predict:500,stream:!1}},{provider:"ollama-generate",modelId:"llama3.2:1b",params:{temperature:0,num_predict:1e3,stream:!1}}],g=[];for(const l of n){const f=JSON.stringify(l.params),h=`${l.provider}-${l.modelId}-${f}`;if(!s.has(h)&&!e.has(h)){const u=p.value?.find(T=>T.provider===l.provider&&T.modelId===l.modelId);u&&u.enabled&&g.push({provider:l.provider,modelId:l.modelId,parameters:l.params,providerSnapshot:{},modelSnapshot:u})}}return[...o,...g].slice(0,10)}),k=[{title:"Model",key:"name",width:"35%"},{title:"Parameters",key:"parameters",width:"35%"},{title:"Cost",key:"cost",width:"20%"},{title:"",key:"actions",width:"10%"}],P=A(()=>a.configurations.map((e,s)=>({key:`${e.provider}-${e.modelId}-${s}`,...e}))),R=A(()=>a.totalCombinations*a.configurations.length*a.repeatCount),N=A(()=>a.tokenData?a.configurations.reduce((e,s)=>{const o=p.value?.find(l=>l.provider===s.provider&&l.modelId===s.modelId);if(!o)return e;const n=C(a.tokenData.totalTokens,a.tokenData.combinationCount,o,s.parameters),g=a.repeatCount>1?c(n,a.repeatCount):n;return e+g.cost.total.expected},0):0);function d(e){if(!a.tokenData)return"?? (no token data)";const s=p.value?.find(h=>h.provider===e.provider&&h.modelId===e.modelId);if(!s)return"?? (model not found)";const o=C(a.tokenData.totalTokens,a.tokenData.combinationCount,s,e.parameters);if(!o.meta.hasValidCost||o.cost.total.expected===-1)return"?? (no pricing data)";const n=a.repeatCount>1?c(o,a.repeatCount):o,g=n.cost.total.min,l=n.cost.total.max,f=n.cost.total.expected;return Math.abs(l-g)<1e-4?`$${i(f)}`:`$${i(g)}-$${i(l)}`}function i(e){if(e===0)return"0.00";if(e<.01){let s=2,o=e;for(;o<.1;)o*=10,s++;return e.toFixed(s)}return e<1?e.toFixed(3):e<10?e.toFixed(2):e<100?e.toFixed(1):Math.round(e).toLocaleString()}function E(e){const s={},o=["temperature","max_tokens","max_completion_tokens","num_predict","maxTokens","top_p","top_k","reasoning_effort"];for(const n of o)e[n]!==void 0&&e[n]!==null&&(s[n]=e[n]);for(const[n,g]of Object.entries(e))g!=null&&!o.includes(n)&&(s[n]=g);return s}function M(e){return e.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase())}function B(e){if(!e||Object.keys(e).length===0)return"";const s=[];return e.temperature!==void 0&&s.push(`T:${e.temperature}`),e.max_tokens!==void 0?s.push(`${e.max_tokens}t`):e.maxTokens!==void 0?s.push(`${e.maxTokens}t`):e.num_predict!==void 0&&s.push(`${e.num_predict}t`),e.top_p!==void 0&&s.push(`p:${e.top_p}`),s.length>0?`(${s.join(", ")})`:""}function F(e){const s=xe.validateParameters(e.provider,e.modelId,e.parameters||{});if(!s.valid){J.error("Quick Add validation failed:",{provider:e.provider,modelId:e.modelId,parameters:e.parameters,errors:s.errors}),alert(`Cannot add model configuration: ${s.errors?.join(", ")||"Invalid parameters"}`);return}const o={name:e.modelSnapshot?.displayName||e.modelId,provider:e.provider,modelId:e.modelId,parameters:{...e.parameters}};I("add-configuration",o)}function w(e){I("add-configuration",e),m.value=!1}function O(e){I("remove-configuration",e)}return(e,s)=>{const o=Z,n=Je,g=le,l=We;return v(),b("div",Zt,[y.value.length>0?(v(),b("div",Qt,[s[2]||(s[2]=t("h4",null,"Quick Add Recent Models",-1)),t("div",Xt,[(v(!0),b(Q,null,X(y.value,f=>(v(),K(o,{key:`${f.provider}-${f.modelId}-${JSON.stringify(f.parameters)}`,size:"small",onClick:h=>F(f),class:"quick-add-button",title:`Add ${f.modelSnapshot?.displayName||f.modelId} (${f.provider}) with recent parameters`},{default:$(()=>[r(x(ee)),t("span",ea,_(f.provider)+"/",1),t("span",ta,_(f.modelSnapshot?.displayName||f.modelId),1),B(f.parameters)?(v(),b("span",aa,_(B(f.parameters)),1)):V("",!0)]),_:2},1032,["onClick","title"]))),128))])])):V("",!0),t("div",sa,[t("div",na,[t("h3",oa,[r(n,{placement:"topLeft"},{title:$(()=>s[3]||(s[3]=[L(" Add models to test with your template and configure their parameters like temperature, max tokens, etc. ")])),default:$(()=>[s[4]||(s[4]=t("span",null,"Model Configurations to Test",-1))]),_:1,__:[4]}),s[6]||(s[6]=t("span",null,"  ",-1)),r(o,{type:"primary",size:"small",onClick:s[0]||(s[0]=f=>m.value=!0)},{default:$(()=>[r(x(ee)),s[5]||(s[5]=L(" Add Model "))]),_:1,__:[5]})])]),r(l,{columns:k,"data-source":P.value,pagination:!1,locale:{emptyText:"No models configured. Add at least one model to proceed."},"row-key":"key"},{bodyCell:$(({column:f,record:h,index:u})=>[f.key==="name"?(v(),b("div",ia,[t("span",la,_(h.name),1),t("span",ra,_(h.provider)+":"+_(h.modelId),1)])):f.key==="parameters"?(v(),b("div",da,[(v(!0),b(Q,null,X(E(h.parameters),(T,j)=>(v(),K(g,{key:j},{default:$(()=>[L(_(M(j))+": "+_(T),1)]),_:2},1024))),128))])):f.key==="cost"?(v(),b("div",ua,[t("span",pa,_(d(h)),1),s[7]||(s[7]=t("span",{class:"cost-label"},"total trial cost",-1))])):f.key==="actions"?(v(),K(o,{key:3,type:"text",danger:"",size:"small",onClick:T=>O(u)},{default:$(()=>[r(x(qe))]),_:2},1032,["onClick"])):V("",!0)]),_:1},8,["data-source"]),e.configurations.length>0?(v(),b("div",ca,[t("div",ma,[s[8]||(s[8]=t("span",null,"Total experiments:",-1)),t("strong",null,_(R.value),1)]),t("div",va,[s[9]||(s[9]=t("span",null,"Estimated total cost:",-1)),t("strong",fa,"$"+_(i(N.value)),1)])])):V("",!0)]),r(tt,{visible:m.value,"onUpdate:visible":s[1]||(s[1]=f=>m.value=f),mode:"trial","trial-context":{totalCombinations:e.totalCombinations,tokenData:e.tokenData??null},"existing-configurations":e.configurations,onAddConfiguration:w},null,8,["visible","trial-context","existing-configurations"])])}}}),_a=Y(ga,[["__scopeId","data-v-1d4ece19"]]),ya={class:"trial-configuration"},Ca={class:"configuration-sections"},ba={class:"config-section"},ha={class:"config-section"},ka=["aria-expanded"],$a={class:"section-title"},Ta={class:"expand-hint"},wa={key:0,class:"design-info"},Ia={class:"design-stats"},Sa={class:"stat"},Pa={class:"stat-value"},xa={class:"stat"},Da={class:"stat-value"},Ea={class:"config-section"},Ma=H({__name:"TrialConfiguration",setup(U){const D=ke("trialCreation"),{calculateTemplateTokens:a,calculatePromptTokens:I}=re(),p=z(!1),S=z(!1),C=A(()=>D.selectedPrompt.value),c=A(()=>{const m=C.value;if(!m)return null;try{if(m.type==="template"){const y=m.template,k=m.variables,P=D.variableLists?.value;return y?a(y,k||{},P||[]):null}else if(m.type==="spreadsheet"){const y=m.promptPattern;if(!y)return null;const k=I(y),P=D.totalCombinations.value;return{totalTokens:k*P,combinationCount:P,perCallAverage:k}}else return null}catch(y){return J.error("Error calculating tokenData:",y),null}});return(m,y)=>(v(),b("div",ya,[t("div",Ca,[t("section",ba,[y[6]||(y[6]=t("h2",{class:"section-title"},"Trial Details",-1)),r(Yt,{name:x(D).trialName.value,"repeat-count":x(D).repeatCount.value,description:x(D).description?.value||"","total-combinations":x(D).totalCombinations.value,"onUpdate:name":y[0]||(y[0]=k=>x(D).trialName.value=k),"onUpdate:repeatCount":y[1]||(y[1]=k=>x(D).repeatCount.value=k),"onUpdate:description":y[2]||(y[2]=k=>x(D).description.value=k)},null,8,["name","repeat-count","description","total-combinations"])]),t("section",ha,[t("button",{class:"collapsible-header",onClick:y[3]||(y[3]=k=>p.value=!p.value),"aria-expanded":p.value},[r(x(Ke),{class:ae([{expanded:p.value},"expand-icon"])},null,8,["class"]),t("h2",$a,[y[7]||(y[7]=L("Selected Design Preview ")),t("span",Ta,"(click to "+_(p.value?"collapse":"expand")+")",1)])],8,ka),p.value?(v(),b("div",wa,[r(se,{template:C.value,"variable-lists":x(D).variableLists.value,cycling:S.value,"show-controls":!0,"display-mode":"block","show-legend":!0,"onUpdate:paused":y[4]||(y[4]=k=>S.value=!k),onBackToSelect:y[5]||(y[5]=k=>m.$emit("back"))},null,8,["template","variable-lists","cycling"]),t("div",Ia,[t("div",Sa,[y[8]||(y[8]=t("span",{class:"stat-label"},"Total Combinations:",-1)),t("span",Pa,_(x(D).totalCombinations.value),1)]),t("div",xa,[y[9]||(y[9]=t("span",{class:"stat-label"},"Total Input Tokens:",-1)),t("span",Da,_(c.value!==null?`${c.value.totalTokens.toLocaleString()} total (${c.value.combinationCount.toLocaleString()} calls)`:"??"),1)])])])):V("",!0)]),t("section",Ea,[y[10]||(y[10]=t("h2",{class:"section-title"},"Add Models and Set Parameters",-1)),r(_a,{configurations:x(D).configurations.value,"total-combinations":x(D).totalCombinations.value,"repeat-count":x(D).repeatCount.value,"token-data":c.value,onAddConfiguration:x(D).addConfiguration,onRemoveConfiguration:x(D).removeConfiguration},null,8,["configurations","total-combinations","repeat-count","token-data","onAddConfiguration","onRemoveConfiguration"])])])]))}}),La=Y(Ma,[["__scopeId","data-v-794621cc"]]),Na={class:"trial-submission"},Aa={class:"review-section"},Va={class:"summary-card"},Oa={class:"summary-item"},za={class:"value"},Ra={class:"summary-item"},ja={class:"value"},Ba={class:"summary-item"},Fa={class:"value"},Ua={key:0,class:"summary-item"},Ja={class:"value"},Wa={key:1,class:"summary-item"},qa={class:"value"},Ka={class:"summary-item"},Ga={class:"value"},Ha={key:2,class:"summary-item"},Ya={class:"value"},Za={class:"summary-item"},Qa={class:"value highlight"},Xa={key:3,class:"summary-item"},es={key:0,class:"value highlight"},ts={key:1,class:"value"},as={class:"configurations-review"},ss={class:"config-header"},ns={class:"config-name"},os={class:"config-model"},is={class:"config-params"},ls={key:0,class:"running-trials-warning"},rs={class:"action-buttons"},ds={key:0},us={key:1},ps={key:2},cs=H({__name:"TrialSubmission",props:{trialConfig:{},design:{}},emits:["back","create-draft","create-and-start","export-python"],setup(U,{emit:D}){const a=U,I=D,{runningTrials:p}=ie(),{variableLists:S}=pe(),{models:C}=oe(),{calculateTemplateTokens:c,calculatePromptTokens:m,estimateTotalCost:y,sumEstimates:k}=re(),P=z(null),R=z(!1),N=z(!1),d=A(()=>p.value.length>0),i=A(()=>p.value.length),E=A(()=>{if(!a.trialConfig.configurations)return 0;let o=1;if(a.design.type==="template"&&a.design.variables)for(const[,g]of Object.entries(a.design.variables)){const l=g;if(l.type==="value"&&l.values)o*=l.values.length;else if(l.type==="list"&&l.listId){const f=S.value?.find(h=>h.id===l.listId);f&&(f.category==="simple"?o*=f.values?.length||0:f.category==="attributed"?o*=f.items?.length||0:f.category==="tabular"&&(o*=f.itemCount||0))}}else a.design.type==="spreadsheet"&&(o=S.value?.find(l=>l.id===a.design.datasetId)?.itemCount||0);const n=a.trialConfig.repeatCount||1;return o*a.trialConfig.configurations.length*n}),M=A(()=>{if(!a.trialConfig.configurations||a.trialConfig.configurations.length===0)return-1;let o=null;if(a.design.type==="template"){const l=a.trialConfig.templateConfig?.template||a.design.template||"",f=a.trialConfig.templateConfig?.variables||a.design.variables||{};o=c(l,f,S.value)}else if(a.design.type==="spreadsheet"){const l=a.trialConfig.spreadsheetConfig?.promptPattern||a.design.promptPattern||"",f=m(l),h=E.value/a.trialConfig.configurations.length;o={totalTokens:f*h,combinationCount:h,perCallAverage:f}}if(!o||o.totalTokens===0)return J.error("TrialSubmission: No prompt content found for cost estimation",{type:a.design.type,hasTemplate:!!a.trialConfig.templateConfig?.template||!!a.design.template,hasPromptPattern:!!a.trialConfig.spreadsheetConfig?.promptPattern||!!a.design.promptPattern}),-1;const n=a.trialConfig.configurations.map(l=>{const f=C.value?.find(h=>h.provider===l.provider&&h.modelId===l.modelId);return f?y(o.totalTokens,o.combinationCount,f,l.parameters):null}).filter(Boolean);return n.length===0?-1:k(n).cost.total.expected});function B(o){const n=[];"temperature"in o&&n.push(`temperature=${o.temperature}`),"max_tokens"in o&&n.push(`max_tokens=${o.max_tokens}`),"top_p"in o&&n.push(`top_p=${o.top_p}`);const g=Object.keys(o).length-n.length;return g>0&&n.push(`+${g} more`),n.join(", ")}function F(){return{name:a.trialConfig.name||"",description:a.trialConfig.description,type:a.design.type,configurations:a.trialConfig.configurations||[],repeatCount:a.trialConfig.repeatCount||1,templateConfig:a.trialConfig.templateConfig,spreadsheetConfig:a.trialConfig.spreadsheetConfig}}async function w(){P.value="draft";try{const o=F();I("create-draft",o)}finally{P.value=null}}async function O(){R.value=!0;try{const o=F();I("export-python",o)}finally{R.value=!1}}function e(){d.value||M.value>10&&M.value!==-1?N.value=!0:s()}async function s(){N.value=!1,P.value="start";try{const o=F();I("create-and-start",o)}finally{P.value=null}}return(o,n)=>{const g=Z,l=Ge,f=ve;return v(),b("div",Na,[r(g,{type:"link",onClick:n[0]||(n[0]=h=>o.$emit("back")),class:"back-button"},{default:$(()=>[r(x(He)),n[3]||(n[3]=L(" Back to Configuration "))]),_:1,__:[3]}),t("div",Aa,[n[15]||(n[15]=t("h2",null,"Review & Create Trial",-1)),t("div",Va,[n[13]||(n[13]=t("h3",null,"Trial Summary",-1)),t("div",Oa,[n[4]||(n[4]=t("span",{class:"label"},"Name:",-1)),t("span",za,_(o.trialConfig.name),1)]),t("div",Ra,[n[5]||(n[5]=t("span",{class:"label"},"Type:",-1)),t("span",ja,_(o.design.type==="template"?"Template":"Spreadsheet"),1)]),t("div",Ba,[n[6]||(n[6]=t("span",{class:"label"},"Design:",-1)),t("span",Fa,_(o.design.name),1)]),o.design.type==="template"?(v(),b("div",Ua,[n[7]||(n[7]=t("span",{class:"label"},"Variables:",-1)),t("span",Ja,_(Object.keys(o.design.variables||{}).length)+" variables configured ",1)])):V("",!0),o.design.type==="spreadsheet"?(v(),b("div",Wa,[n[8]||(n[8]=t("span",{class:"label"},"Dataset:",-1)),t("span",qa,_(o.design.rowCount)+" rows",1)])):V("",!0),t("div",Ka,[n[9]||(n[9]=t("span",{class:"label"},"Model Configurations:",-1)),t("span",Ga,_(o.trialConfig.configurations?.length||0)+" models",1)]),o.trialConfig.repeatCount&&o.trialConfig.repeatCount>1?(v(),b("div",Ha,[n[10]||(n[10]=t("span",{class:"label"},"Repeat Count:",-1)),t("span",Ya,_(o.trialConfig.repeatCount)+" times per prompt",1)])):V("",!0),t("div",Za,[n[11]||(n[11]=t("span",{class:"label"},"Total API Calls:",-1)),t("span",Qa,_(E.value),1)]),M.value!==-1?(v(),b("div",Xa,[n[12]||(n[12]=t("span",{class:"label"},"Estimated Cost:",-1)),M.value>0?(v(),b("span",es,"$"+_(M.value.toFixed(4)),1)):(v(),b("span",ts,"Unable to estimate (no prompt content)"))])):V("",!0)]),t("div",as,[n[14]||(n[14]=t("h3",null,"Model Configurations",-1)),(v(!0),b(Q,null,X(o.trialConfig.configurations,(h,u)=>(v(),b("div",{key:`review-config-${u}`,class:"config-review-item"},[t("div",ss,[t("span",ns,_(h.name||h.modelId),1),t("span",os,_(h.provider)+":"+_(h.modelId),1)]),t("div",is,_(B(h.parameters)),1)]))),128))]),d.value?(v(),b("div",ls,[r(l,{message:"Running Trials Detected",description:`You have ${i.value} trial(s) currently running. Starting a new trial may affect performance.`,type:"warning","show-icon":""},null,8,["description"])])):V("",!0)]),t("div",rs,[r(g,{size:"large",onClick:w,loading:P.value==="draft"},{default:$(()=>[r(x(fe)),n[16]||(n[16]=L(" Create as Draft "))]),_:1,__:[16]},8,["loading"]),r(g,{size:"large",onClick:O,loading:R.value},{default:$(()=>[r(x(Ye)),n[17]||(n[17]=L(" Export to Python "))]),_:1,__:[17]},8,["loading"]),r(g,{type:"primary",size:"large",onClick:e,loading:P.value==="start"},{default:$(()=>[r(x(Ze)),n[18]||(n[18]=L(" Create and Start "))]),_:1,__:[18]},8,["loading"])]),r(f,{visible:N.value,"onUpdate:visible":n[1]||(n[1]=h=>N.value=h),title:"Confirm Trial Creation",onOk:s,onCancel:n[2]||(n[2]=h=>N.value=!1)},{default:$(()=>[n[19]||(n[19]=t("p",null,"You are about to create and start a trial with:",-1)),t("ul",null,[t("li",null,_(E.value)+" API calls",1),M.value>0?(v(),b("li",ds,"Estimated cost: $"+_(M.value.toFixed(4)),1)):M.value===-1?(v(),b("li",us,"Cost estimation unavailable")):V("",!0),d.value?(v(),b("li",ps,_(i.value)+" other trial(s) running",1)):V("",!0)]),n[20]||(n[20]=t("p",null,"Do you want to proceed?",-1))]),_:1,__:[19,20]},8,["visible"])])}}}),ms=Y(cs,[["__scopeId","data-v-b8e71998"]]),vs={class:"conflict-content"},fs={class:"warning-section"},gs={class:"warning-text"},_s={class:"trial-info"},ys={class:"summary-grid"},Cs={class:"summary-item"},bs={class:"value"},hs={class:"summary-item"},ks={class:"value"},$s={key:0,class:"summary-item"},Ts={class:"value"},ws={class:"modal-footer"},Is=H({__name:"TrialConflictModal",props:{visible:{type:Boolean},runningTrial:{},trialConfig:{},totalApiCalls:{},estimatedCost:{}},emits:["update:visible","cancel","create-draft"],setup(U,{emit:D}){const a=U,I=D,p=z(!1);function S(){I("update:visible",!1),I("cancel")}async function C(){if(a.trialConfig){p.value=!0;try{I("create-draft",a.trialConfig),I("update:visible",!1)}finally{p.value=!1}}}return(c,m)=>{const y=Z,k=ve;return v(),K(k,{visible:c.visible,title:"Running Trial Detected",closable:!1,"mask-closable":!1,width:"600px",onCancel:S},{footer:$(()=>[t("div",ws,[r(y,{onClick:S,disabled:p.value},{default:$(()=>m[8]||(m[8]=[L(" Cancel ")])),_:1,__:[8]},8,["disabled"]),r(y,{type:"primary",onClick:C,loading:p.value},{default:$(()=>[r(x(fe)),m[9]||(m[9]=L(" Create Draft "))]),_:1,__:[9]},8,["loading"])])]),default:$(()=>[t("div",vs,[t("div",fs,[r(x(Qe),{class:"warning-icon"}),t("div",gs,[m[2]||(m[2]=t("h3",null,"Another trial is currently running",-1)),t("p",null,[m[0]||(m[0]=L(' The trial "')),t("strong",null,_(c.runningTrial?.name),1),m[1]||(m[1]=L('" is currently executing. You can only run one trial at a time. '))])])]),m[7]||(m[7]=t("div",{class:"message-section"},[t("p",null,"You can only run one trial at a time. Your new trial will be saved as a draft and you can start it manually after the current trial finishes, or you can pause or cancel the running trial, then start your new draft trial.")],-1)),t("div",_s,[m[6]||(m[6]=t("h4",null,"New Trial Summary:",-1)),t("div",ys,[t("div",Cs,[m[3]||(m[3]=t("span",{class:"label"},"Name:",-1)),t("span",bs,_(c.trialConfig?.name),1)]),t("div",hs,[m[4]||(m[4]=t("span",{class:"label"},"API Calls:",-1)),t("span",ks,_(c.totalApiCalls),1)]),c.estimatedCost>0?(v(),b("div",$s,[m[5]||(m[5]=t("span",{class:"label"},"Estimated Cost:",-1)),t("span",Ts,"$"+_(c.estimatedCost.toFixed(4)),1)])):V("",!0)])])])]),_:1},8,["visible"])}}}),Ss=Y(Is,[["__scopeId","data-v-6c2d242e"]]),Ps={class:"trial-creation-content"},xs={class:"step-content"},Ds={key:1,class:"modal-footer"},Es={key:2,class:"create-actions"},Ms={key:2,class:"view-footer"},Ls={key:0,class:"validation-errors"},Ns={class:"create-actions"},As=H({__name:"TrialCreationContent",props:{mode:{},initialData:{}},emits:["cancel","create-template","create-spreadsheet","created","created-and-started","export-python"],setup(U,{expose:D,emit:a}){const I=U,p=a,S=A(()=>({type:I.initialData?.type||"create",sourceTrialId:I.initialData?.sourceTrialId})),C=at($e(S));Te("trialCreation",C);const c=z(0),m=z(!1),y=z(null),k=z(null),P=z(null);D({currentStep:c});const R=A(()=>{if(I.mode==="view")return C.selectedPrompt.value!==null&&C.canProceed.value&&C.configurations.value.length>0;switch(c.value){case 0:return C.selectedPrompt.value!==null;case 1:return C.canProceed.value;default:return!0}}),N=A(()=>{const e=[];return C.selectedPrompt.value||e.push("Select a template or spreadsheet"),C.configurations.value.length===0&&e.push("Add at least one model configuration"),C.trialName.value.trim()===""&&e.push("Enter a trial name"),e.join(" • ")});function d(){const e=JSON.parse(JSON.stringify(C.selectedPrompt.value));return{name:C.trialName.value,description:C.description?.value||"",type:e.type,configurations:JSON.parse(JSON.stringify(C.configurations.value)),repeatCount:C.repeatCount.value,templateConfig:e.type==="template"?{template:e.template,variables:e.variables,outputType:e.outputType,extractPattern:e.extractPattern,refusalWords:e.refusalWords,rejectRefusalWords:e.rejectRefusalWords}:void 0,spreadsheetConfig:e.type==="spreadsheet"?{promptPattern:e.promptPattern,datasetId:e.datasetId}:void 0}}function i(e){C.selectPrompt(e),I.mode==="view"&&(c.value=1)}async function E(){try{const e=await C.createTrialAsDraft();e&&p("created",e)}catch(e){J.error("Failed to create draft trial:",e)}}async function M(){try{const e=await C.createAndStartTrial();e&&(e.needsConfirmation?(y.value=d(),k.value=e.trialId,P.value="runningTrial"in e?e.runningTrial:null,m.value=!0):p("created-and-started",e.trialId))}catch(e){J.error("Failed to create and start trial:",e)}}async function B(){p("export-python",d())}function F(){O()}async function w(){try{k.value&&p("created",k.value),O()}catch(e){J.error("Failed to handle draft creation:",e)}}function O(){m.value=!1,y.value=null,k.value=null,P.value=null}return ne(async()=>{if(await C.initialize(),I.initialData?.templateId&&I.initialData?.promptSource==="template"){const e=()=>{const s=C.templates.value.find(o=>o.id===I.initialData?.templateId);return s?(C.selectPrompt(s),c.value=1,!0):!1};if(!e()){const s=G(()=>C.templates.value,()=>{e()&&s()},{immediate:!0});setTimeout(()=>s(),3e3)}}}),G(c,()=>{I.mode==="view"&&window.scrollTo(0,0)}),(e,s)=>{const o=et,n=Xe,g=Z;return v(),b("div",Ps,[e.mode==="modal"?(v(),K(n,{key:0,current:c.value,class:"creation-steps"},{default:$(()=>[r(o,{title:"Select Design"}),r(o,{title:"Configure Trial"}),r(o,{title:"Review & Create"})]),_:1},8,["current"])):V("",!0),t("div",xs,[c.value===0?(v(),K(Kt,{key:0,templates:x(C).templates.value,spreadsheets:x(C).spreadsheets.value,"variable-lists":x(C).variableLists.value,onSelect:i,onCreateTemplate:s[0]||(s[0]=l=>e.$emit("create-template")),onCreateSpreadsheet:s[1]||(s[1]=l=>e.$emit("create-spreadsheet"))},null,8,["templates","spreadsheets","variable-lists"])):c.value===1?(v(),K(La,{key:1,onBack:s[2]||(s[2]=l=>c.value--)})):c.value===2?(v(),K(ms,{key:2,"trial-config":d(),design:x(C).selectedPrompt.value,onBack:s[3]||(s[3]=l=>c.value--),onCreateDraft:E,onCreateAndStart:M,onExportPython:B},null,8,["trial-config","design"])):V("",!0)]),I.mode==="modal"?(v(),b("div",Ds,[r(g,{onClick:s[4]||(s[4]=l=>e.$emit("cancel"))},{default:$(()=>s[8]||(s[8]=[L("Cancel")])),_:1,__:[8]}),c.value>0?(v(),K(g,{key:0,onClick:s[5]||(s[5]=l=>c.value--)},{default:$(()=>s[9]||(s[9]=[L(" Back ")])),_:1,__:[9]})):V("",!0),c.value<2?(v(),K(g,{key:1,type:"primary",disabled:!R.value,onClick:s[6]||(s[6]=l=>c.value++)},{default:$(()=>s[10]||(s[10]=[L(" Next ")])),_:1,__:[10]},8,["disabled"])):V("",!0),c.value===2?(v(),b("div",Es,[r(g,{type:"primary",disabled:!R.value,onClick:E},{default:$(()=>s[11]||(s[11]=[L(" Create Draft ")])),_:1,__:[11]},8,["disabled"]),r(g,{type:"primary",disabled:!R.value,onClick:M},{default:$(()=>s[12]||(s[12]=[L(" Create & Start ")])),_:1,__:[12]},8,["disabled"])])):V("",!0)])):V("",!0),I.mode==="view"?(v(),b("div",Ms,[R.value?V("",!0):(v(),b("div",Ls,_(N.value),1)),t("div",Ns,[r(g,{size:"large",disabled:!R.value,onClick:B},{default:$(()=>s[13]||(s[13]=[L(" Export Python ")])),_:1,__:[13]},8,["disabled"]),r(g,{type:"primary",size:"large",disabled:!R.value,onClick:E},{default:$(()=>s[14]||(s[14]=[L(" Create Draft ")])),_:1,__:[14]},8,["disabled"]),r(g,{type:"primary",size:"large",disabled:!R.value,onClick:M},{default:$(()=>s[15]||(s[15]=[L(" Create & Start ")])),_:1,__:[15]},8,["disabled"])])])):V("",!0),r(Ss,{visible:m.value,"onUpdate:visible":s[7]||(s[7]=l=>m.value=l),"running-trial":P.value,"trial-config":y.value,"total-api-calls":x(C).totalExperiments.value,"estimated-cost":x(C).totalCost.value,onCancel:F,onCreateDraft:w},null,8,["visible","running-trial","trial-config","total-api-calls","estimated-cost"])])}}}),Vs=Y(As,[["__scopeId","data-v-483a6718"]]),Os={class:"trial-creation-view"},zs={class:"creation-header"},Rs={class:"header-title"},js={class:"creation-content"},Bs=H({__name:"TrialCreationV3",setup(U){const D=we(),a=Ie(),I=z(),p=z(null);async function S(){const N=D.query;if(N.duplicate){const d=N.duplicate;I.value={type:"duplicate",sourceTrialId:d}}else N.designId&&N.promptSource==="template"&&(I.value={type:"create",templateId:N.designId,promptSource:"template"})}function C(){a.push("/trials")}function c(){p.value&&(p.value.currentStep=0)}async function m(N){te.success("Trial created as draft"),a.push({path:"/trials",query:{trialId:N,tab:"details"}})}async function y(N){te.success("Trial created and started"),a.push({path:"/trials",query:{trialId:N,tab:"tasks"}})}async function k(){te.info("Python export not yet implemented")}function P(){a.push("/templates/new")}function R(){a.push("/spreadsheet")}return ne(()=>{S()}),(N,d)=>{const i=Z;return v(),b("div",Os,[t("div",zs,[t("div",Rs,[d[1]||(d[1]=t("h1",null,"Create New Trial",-1)),p.value?.currentStep===1?(v(),K(i,{key:0,type:"link",class:"back-button",onClick:c},{default:$(()=>[r(x(ce)),d[0]||(d[0]=L(" Back to Select Template "))]),_:1,__:[0]})):V("",!0)]),r(i,{onClick:C},{default:$(()=>d[2]||(d[2]=[L("Cancel")])),_:1,__:[2]})]),t("div",js,[r(Vs,{ref_key:"creationContentRef",ref:p,mode:"view","initial-data":I.value,onCancel:C,onCreated:m,onCreatedAndStarted:y,onExportPython:k,onCreateTemplate:P,onCreateSpreadsheet:R},null,8,["initial-data"])])])}}}),tn=Y(Bs,[["__scopeId","data-v-38a5dd3b"]]);export{tn as default};
