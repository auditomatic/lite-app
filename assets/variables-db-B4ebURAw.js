import{i as t}from"./index-HyoKRhI9.js";import{ag as e,f as r,c as a,ai as s}from"./vendor-DCf9YP3r.js";import{l as i}from"./db-CL8uhZCz.js";import{g as n}from"./defaultData-DyqJdH2z.js";import{l}from"./logger.service-_k__GSpu.js";const o=new class{parseCSV(t){const e=t.split("\n").map(t=>t.trim()).filter(Boolean);if(0===e.length)return{headers:[],rows:[]};const r=this.parseCSVLine(e[0]);if(0===r.length)return{headers:[],rows:[]};const a=[];for(let s=1;s<e.length;s++){const t=this.parseCSVLine(e[s]);if(t.every(t=>!t.trim()))continue;const i={};r.forEach((e,r)=>{i[e]=t[r]||""}),a.push(i)}return{headers:r,rows:a}}parseCSVLine(t){const e=[];let r="",a=!1,s=0;for(;s<t.length;){const i=t[s];'"'===i?a&&'"'===t[s+1]?(r+='"',s+=2):(a=!a,s++):","!==i||a?(r+=i,s++):(e.push(r.trim()),r="",s++)}return e.push(r.trim()),e}validateAttributedList(t,e){const r=[],a=[];if(0===t.length)return void 0===e?{valid:!0,errors:[],attributeKeys:[]}:{isValid:!0,errors:r,warnings:a};const s=t.filter(t=>!t.value.trim());s.length>0&&r.push(`${s.length} items have empty values`);const i=t.map(t=>t.value.trim().toLowerCase()),n=i.filter((t,e)=>i.indexOf(t)!==e);if(n.length>0&&a.push(`Duplicate values found: ${[...new Set(n)].join(", ")}`),Array.isArray(e))for(const o of e){const e=t.filter(t=>!t.attributes[o]?.trim());e.length>0&&r.push(`${e.length} items missing required attribute: ${o}`)}const l=new Set;t.forEach(t=>{Object.keys(t.attributes).forEach(t=>l.add(t))});if(t.filter(t=>Array.from(l).some(e=>!(e in t.attributes))).length>0&&a.push("Some items missing optional attributes"),void 0===e){const e=this.getAttributeKeys(t),a=[];return t.forEach(t=>{e.forEach(e=>{e in t.attributes||a.push(`Item '${t.value}' is missing attribute: ${e}`)}),Object.keys(t.attributes).forEach(r=>{e.includes(r)||a.push(`Item '${t.value}' has extra attribute: ${r}`)})}),{valid:0===r.length&&0===a.length,errors:[...r,...a],attributeKeys:e}}return{isValid:0===r.length,errors:r,warnings:a}}getAttributeStats(t){const e={};return t.forEach(t=>{Object.entries(t.attributes).forEach(([t,r])=>{e[t]||(e[t]=new Set),r?.trim()&&e[t].add(r.trim())})}),e}convertToAttributedList(t,e=[]){return t.map(t=>({value:t.trim(),attributes:e.reduce((t,e)=>(t[e]="",t),{})}))}parseJSON(t){try{return JSON.parse(t)}catch(e){throw new Error("Invalid JSON format")}}csvToAttributedItems(t){const e=t.headers.find(t=>"value"===t.toLowerCase()||"name"===t.toLowerCase());if(!e)throw new Error('CSV must have a "value" or "name" column');const r=t.headers.filter(t=>t!==e);return t.rows.map(t=>({value:t[e]||"",attributes:r.reduce((e,r)=>(e[r]=t[r]||"",e),{})})).filter(t=>t.value.trim())}exportToCSV(t){if(0===t.length)return"";const e=Array.from(new Set(t.flatMap(t=>Object.keys(t.attributes)))).sort(),r=[["value",...e].join(",")];return t.forEach(t=>{const a=[this.escapeCSVValue(t.value),...e.map(e=>this.escapeCSVValue(t.attributes[e]||""))];r.push(a.join(","))}),r.join("\n")}escapeCSVValue(t){return t?t.includes(",")||t.includes('"')||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t:""}async getListValues(e){const r=await t.variableLists.get(e);return r?"simple"===r.category&&r.values?r.values:"attributed"===r.category&&r.items?r.items.map(t=>t.value):[]:[]}async formatAsCSV(e){const r=await t.variableLists.get(e);return r?"simple"===r.category&&r.values?["value",...r.values].join("\n"):"attributed"===r.category&&r.items?this.exportToCSV(r.items):"":""}getAttributeKeys(t){const e=new Set;return t.forEach(t=>{t.attributes&&Object.keys(t.attributes).forEach(t=>e.add(t))}),Array.from(e).sort()}},u=e("variableLists",()=>{const e=r([]),o=r(!1),u=r(null);let c=null;const d=a(()=>e.value.filter(t=>"simple"===t.category)),v=a(()=>e.value.filter(t=>"attributed"===t.category)),f=a(()=>e.value.filter(t=>"refusal"===t.category)),m=a(()=>e.value.slice().sort((t,e)=>e.updated.getTime()-t.updated.getTime()));return{lists:e,isLoading:s(o),error:s(u),simpleLists:d,attributedLists:v,refusalLists:f,listsByDate:m,initialize:async function(){if(!c){o.value=!0,u.value=null;try{c=i(()=>t.variableLists.orderBy("updated").reverse().toArray()).subscribe({next:t=>{e.value=t,o.value=!1},error:t=>{l.error("Variable lists store subscription error",t),u.value="Failed to load variable lists",o.value=!1}})}catch(r){l.error("Failed to initialize variable lists store",r),u.value="Failed to initialize variable lists",o.value=!1}}},createList:async function(e){const r=new Date,a=n(),s={...e,id:a,created:r,updated:r};return await t.variableLists.add(s),a},updateList:async function(e,r){await t.variableLists.update(e,{...r,updated:new Date})},deleteList:async function(e){const r=(await t.designs.toArray()).filter(t=>t.variableBindings&&Object.values(t.variableBindings).some(t=>"list"===t.type&&t.listId===e));if(r.length>0){const t=r.map(t=>t.name).join(", ");throw new Error(`Cannot delete variable list - it is used in designs: ${t}`)}await t.variableLists.delete(e)},getList:async function(e){return await t.variableLists.get(e)},getAllLists:async function(){try{return await t.variableLists.toArray()}catch(e){return l.error("Failed to get all lists",e),[]}},destroy:function(){c&&(c.unsubscribe(),c=null)}}});export{u,o as v};
