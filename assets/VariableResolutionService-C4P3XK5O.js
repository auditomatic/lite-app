const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-BO1xIGYv.js","./vendor-w2iEWTO6.js","./db-BfRGDvSu.js","./index-BvirP0gA.css"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,r,o)=>((t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o)(t,"symbol"!=typeof r?r+"":r,o);import{c as r,f as o,d as n,D as a}from"./index-BO1xIGYv.js";import{a as s}from"./apiLogger-DxGnFuqw.js";class i extends Error{constructor(e,t,r,o){super(e),this.provider=t,this.statusCode=r,this.details=o,this.name="LLMError"}}function c(e,t,r,o,n,a,i,c,p,u){return s.createAPILog({url:e,method:t,headers:r,body:o},{status:n.status,headers:Object.fromEntries(n.headers.entries()),body:a,timing_ms:i},c||{prompt_tokens:0,completion_tokens:0,total_tokens:0},p,u)}async function p(e,t,r){const o=await n.providers.get(r),a=o?.timeout_ms||6e4,s=new AbortController,c=setTimeout(()=>{s.abort()},a);try{const r=await fetch(e,{...t,signal:s.signal});return clearTimeout(c),r}catch(p){if(clearTimeout(c),p instanceof Error&&"AbortError"===p.name)throw new i(`API call timed out after ${a}ms`,r,408,{timeout_ms:a});throw p}}async function u(e,t){const r=o(),n=await r.loadSettings();switch(t.provider){case"openai":if(!n.openai_api_key)throw new i("OpenAI API key not configured","openai");return async function(e,t,r){const o=Date.now(),n=r?`${r}/https://api.openai.com/v1/chat/completions`:"https://api.openai.com/v1/chat/completions",a={model:e.model,messages:[{role:"user",content:e.prompt}],temperature:e.temperature,max_tokens:e.max_tokens};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";a.functions=[{name:"provide_answer",description:"Provides an answer to the prompt",parameters:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],a.function_call={name:"provide_answer"}}const s={"Content-Type":"application/json",Authorization:`Bearer ${t}`},u=await p(n,{method:"POST",headers:s,body:JSON.stringify(a),referrerPolicy:"no-referrer"},"openai");if(!u.ok){const e=await u.json().catch(()=>({error:{message:u.statusText}}));throw new i(e.error?.message||"OpenAI API error","openai",u.status,e)}const l=await u.text(),m=JSON.parse(l),d=Date.now()-o,f=m.choices[0].message,_=c(n,"POST",s,a,u,l,d,m.usage,"openai",e.model);let h="",w="";if(f.function_call){const e=f.function_call.arguments;h=e;try{const t=JSON.parse(e);w=String(t.answer||"")}catch(g){w=e}}else h=f.content||"",w=h;return{content:h,extracted_value:w,usage:m.usage,response_time:d,api_call_log:_}}(e,n.openai_api_key,n.cors_proxy);case"anthropic":if(!n.anthropic_api_key)throw new i("Anthropic API key not configured","anthropic");return async function(e,t,r){const o=Date.now(),n=r?`${r}/https://api.anthropic.com/v1/messages`:"https://api.anthropic.com/v1/messages",a={model:e.model,messages:[{role:"user",content:e.prompt}],max_tokens:e.max_tokens,temperature:e.temperature},s={"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";a.tools=[{name:"provide_answer",description:"Provides an answer to the prompt",input_schema:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],a.tool_choice={type:"tool",name:"provide_answer"},s["anthropic-beta"]="tools-2024-04-04"}const u=await p(n,{method:"POST",headers:s,body:JSON.stringify(a),referrerPolicy:"no-referrer"},"anthropic");if(!u.ok){const e=await u.json().catch(()=>({error:{message:u.statusText}}));throw new i(e.error?.message||"Anthropic API error","anthropic",u.status,e)}const l=await u.text(),m=JSON.parse(l),d=Date.now()-o,f=c(n,"POST",s,a,u,l,d,m.usage,"anthropic",e.model);let _="",h="";if(m.content&&m.content.length>0){const e=m.content.find(e=>"tool_use"===e.type);if(e&&e.input)_=JSON.stringify(e.input),h=String(e.input.answer||"");else{const e=m.content.find(e=>"text"===e.type);_=e?.text||"",h=_}}return{content:_,extracted_value:h,usage:{prompt_tokens:m.usage.input_tokens,completion_tokens:m.usage.output_tokens,total_tokens:m.usage.input_tokens+m.usage.output_tokens},response_time:d,api_call_log:f}}(e,n.anthropic_api_key,n.cors_proxy);case"ollama":return async function(e,t){const r=Date.now(),o={model:e.model.startsWith("ollama:")?e.model.substring(7):e.model,prompt:e.prompt,temperature:e.temperature,options:{num_predict:e.max_tokens},stream:!1};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";o.format={type:"object",properties:{answer:{type:t}},required:["answer"]},o.prompt=e.prompt+'\n\nPlease respond with valid JSON in the format: {"answer": <your_answer>}'}const n={"Content-Type":"application/json"},a=await p(`${t}/api/generate`,{method:"POST",headers:n,body:JSON.stringify(o)},"ollama");if(!a.ok){const e=await a.text();throw new i(`Ollama API error: ${e}`,"ollama",a.status)}const s=await a.text(),u=JSON.parse(s),l=Date.now()-r,m=c(`${t}/api/generate`,"POST",n,o,a,s,l,{prompt_tokens:0,completion_tokens:0,total_tokens:0},"ollama",e.model),d=u.response||"";let f=d;if("json"===e.output_format)try{const e=JSON.parse(d);e&&"object"==typeof e&&"answer"in e&&(f=String(e.answer))}catch(_){f=d}return{content:d,extracted_value:f,response_time:l,api_call_log:m}}(e,n.ollama_base_url||"http://localhost:11434");case"openrouter":if(!n.openrouter_api_key)throw new i("OpenRouter API key not configured","openrouter");return async function(e,t,r){const o=Date.now(),n="https://openrouter.ai/api/v1",a=r?`${r}/${n}/chat/completions`:`${n}/chat/completions`,s={model:e.model,messages:[{role:"user",content:e.prompt}],temperature:e.temperature,max_tokens:e.max_tokens};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";s.functions=[{name:"provide_answer",description:"Provides an answer to the prompt",parameters:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],s.function_call={name:"provide_answer"}}const u={"Content-Type":"application/json",Authorization:`Bearer ${t}`,"HTTP-Referer":window.location.origin,"X-Title":"Auditomatic Lite"},l=await p(a,{method:"POST",headers:u,body:JSON.stringify(s),referrerPolicy:"no-referrer"},"openrouter");if(!l.ok){const e=await l.json().catch(()=>({error:{message:l.statusText}}));let t=e.error?.message||"OpenRouter API error";throw 401===l.status&&t.includes("No auth credentials found")&&(t="Invalid OpenRouter API key. Please check your API key in Settings."),new i(t,"openrouter",l.status,e)}const m=await l.text(),d=JSON.parse(m),f=Date.now()-o,_=d.choices[0].message,h=c(a,"POST",u,s,l,m,f,d.usage,"openrouter",e.model);let w="",g="";if(_.function_call){const e=_.function_call.arguments;w=e;try{const t=JSON.parse(e);g=String(t.answer||"")}catch(y){g=e}}else w=_.content||"",g=w;return{content:w,extracted_value:g,usage:d.usage,response_time:f,api_call_log:h}}(e,n.openrouter_api_key,n.cors_proxy);default:throw new i(`Unsupported provider: ${t.provider}`,t.provider)}}async function l(e,t,o){const{useModelsStore:n}=await r(async()=>{const{useModelsStore:e}=await import("./index-BO1xIGYv.js").then(e=>e.m);return{useModelsStore:e}},__vite__mapDeps([0,1,2,3]),import.meta.url),a=n().models.find(t=>t.id===e);if(!a)throw new Error(`Model ${e} not found`);return(await u({model:e,prompt:t,temperature:o?.temperature,max_tokens:o?.max_tokens,output_format:o?.output_format,output_type:o?.output_type},a)).content}const m=class e{constructor(){t(this,"dbService"),this.dbService=a.getInstance()}static getInstance(){return e.instance||(e.instance=new e),e.instance}async resolveDesignVariables(e,t=[]){const r={},o=e.variables||{};for(const[a,s]of Object.entries(o))Array.isArray(s)&&(r[a]=s);const n=e.variable_list_refs||{};for(const[a,s]of Object.entries(n)){let e=t.find(e=>e.id===s);if(!e){const t=await this.dbService.read("variable_lists",s);t.success&&t.data&&(e=t.data)}e&&e.values&&(r[a]=e.values)}return r}async resolveVariablesWithAttributes(e,t=[]){const r={},o={};if(e.variables)for(const[n,a]of Object.entries(e.variables))r[n]=a,o[n]=a.map(()=>({}));if(e.variable_list_refs)for(const[n,a]of Object.entries(e.variable_list_refs)){let e=t.find(e=>e.id===a);if(!e){const t=await this.dbService.read("variable_lists",a);t.success&&t.data&&(e=t.data)}e&&e.values&&(r[n]=e.values,"attributed"===e.category&&e.attributed_items?o[n]=e.attributed_items.map(e=>e.attributes):o[n]=e.values.map(()=>({})))}return{values:r,attributes:o}}extractTemplateVariables(e){if("string"!=typeof e)return[];const t=/\{\{([^}]+)\}\}/g,r=new Set;let o;for(;null!==(o=t.exec(e));){const e=o[1].trim();e&&/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)&&r.add(e)}return Array.from(r)}async validateTemplateVariables(e,t=[]){const r=this.extractTemplateVariables(e.prompt_template||""),o=await this.resolveDesignVariables(e,t),n=Object.keys(o),a=r.filter(e=>!n.includes(e)),s=n.filter(e=>!r.includes(e)),i=[];return s.length>0&&i.push(`Unused variables: ${s.join(", ")}`),{valid:0===a.length,missingVariables:a,unusedVariables:s,warnings:i}}processTemplate(e,t){let r=e;for(const[o,n]of Object.entries(t))if(!o.includes("_")||e.includes(`{{${o}}}`)){const e=new RegExp(`{{\\s*${o}\\s*}}`,"g");r=r.replace(e,n)}return r}generateCombinationsWithAttributes(e){const{values:t,attributes:r}=e,o=Object.keys(t);if(0===o.length)return[{}];const n=[];return function e(a,s){if(a===o.length)return void n.push({...s});const i=o[a],c=t[i],p=r[i]||[];for(let t=0;t<c.length;t++){const r=c[t],o=p[t]||{};s[i]=r;for(const[e,t]of Object.entries(o))s[`${i}_${e}`]=String(t);e(a+1,s),delete s[i];for(const e of Object.keys(o))delete s[`${i}_${e}`]}}(0,{}),n}};t(m,"instance");let d=m;export{i as L,d as V,u as c,l as t};
