import{i as c,C as v}from"./core-DucnQ6i4.js";const n="Request cancelled";async function j(m,e){const r=e==null?void 0:e.signal;if(r!=null&&r.aborted)throw new Error(n);const b=e==null?void 0:e.maxRedirections,l=e==null?void 0:e.connectTimeout,R=e==null?void 0:e.proxy,A=e==null?void 0:e.danger;e&&(delete e.maxRedirections,delete e.connectTimeout,delete e.proxy,delete e.danger);const o=e!=null&&e.headers?e.headers instanceof Headers?e.headers:new Headers(e.headers):new Headers,a=new Request(m,e),f=await a.arrayBuffer(),E=f.byteLength!==0?Array.from(new Uint8Array(f)):null;for(const[s,t]of a.headers)o.get(s)||o.set(s,t);const x=(o instanceof Headers?Array.from(o.entries()):Array.isArray(o)?o:Object.entries(o)).map(([s,t])=>[s,typeof t=="string"?t:t.toString()]);if(r!=null&&r.aborted)throw new Error(n);const y=await c("plugin:http|fetch",{clientConfig:{method:a.method,url:a.url,headers:x,data:E,maxRedirections:b,connectTimeout:l,proxy:R,danger:A}}),p=()=>c("plugin:http|fetch_cancel",{rid:y});if(r!=null&&r.aborted)throw p(),new Error(n);r==null||r.addEventListener("abort",()=>void p());const{status:w,statusText:g,url:H,headers:C,rid:L}=await c("plugin:http|fetch_send",{rid:y}),_=[101,103,204,205,304].includes(w)?null:new ReadableStream({start:s=>{const t=new v;t.onmessage=u=>{if(r!=null&&r.aborted){s.error(n);return}const d=new Uint8Array(u),T=d[d.byteLength-1],q=d.slice(0,d.byteLength-1);if(T==1){s.close();return}s.enqueue(q)},c("plugin:http|fetch_read_body",{rid:L,streamChannel:t}).catch(u=>{s.error(u)})}}),h=new Response(_,{status:w,statusText:g});return Object.defineProperty(h,"url",{value:H}),Object.defineProperty(h,"headers",{value:new Headers(C)}),h}export{j as fetch};
