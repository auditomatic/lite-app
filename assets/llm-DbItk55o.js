const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-niVOvZdn.js","./vendor-DdqHZeTC.js","./db-ftwlfnxb.js","./index-zWy5gnVS.css"])))=>i.map(i=>d[i]);
import{c as e,f as t,d as o}from"./index-niVOvZdn.js";import{a as r}from"./apiLogger-wE3EW76_.js";import{s as n}from"./safeJson-BfKuju6h.js";class s extends Error{constructor(e,t,o,r){super(e),this.provider=t,this.statusCode=o,this.details=r,this.name="LLMError"}}function a(e,t,o,n,s,a,i,p,c,u){return r.createAPILog({url:e,method:t,headers:o,body:n},{status:s.status,headers:Object.fromEntries(s.headers.entries()),body:a,timing_ms:i},p||{prompt_tokens:0,completion_tokens:0,total_tokens:0},c,u)}async function i(e,t,r){const n=await o.providers.get(r),a=n?.timeout_ms||6e4,i=new AbortController,p=setTimeout(()=>{i.abort()},a);try{const o=await fetch(e,{...t,signal:i.signal});return clearTimeout(p),o}catch(c){if(clearTimeout(p),c instanceof Error&&"AbortError"===c.name)throw new s(`API call timed out after ${a}ms`,r,408,{timeout_ms:a});throw c}}async function p(e,o){const r=t(),p=await r.loadSettings();switch(o.provider){case"openai":if(!p.openai_api_key)throw new s("OpenAI API key not configured","openai");return async function(e,t,o){const r=Date.now(),p=o?`${o}/https://api.openai.com/v1/chat/completions`:"https://api.openai.com/v1/chat/completions",c={model:e.model,messages:[{role:"user",content:e.prompt}],temperature:e.temperature,max_tokens:e.max_tokens};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";c.functions=[{name:"provide_answer",description:"Provides an answer to the prompt",parameters:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],c.function_call={name:"provide_answer"}}const u={"Content-Type":"application/json",Authorization:`Bearer ${t}`},m=await i(p,{method:"POST",headers:u,body:JSON.stringify(c),referrerPolicy:"no-referrer"},"openai");if(!m.ok){const e=await m.json().catch(()=>({error:{message:m.statusText}}));throw new s(e.error?.message||"OpenAI API error","openai",m.status,e)}const l=await m.text(),d=n(l),_=Date.now()-r;if(!d?.choices?.length)throw new s("Invalid OpenAI API response structure - missing choices array","openai",m.status,{received:d,raw_response:l.substring(0,500)});const h=d.choices[0].message,w=a(p,"POST",u,c,m,l,_,d.usage,"openai",e.model);let f="",y="";if(h.function_call){const e=h.function_call.arguments;f=e;try{const t=n(e);y=t&&"object"==typeof t?String(t.answer||""):e}catch(g){y=e}}else f=h.content||"",y=f;return{content:f,extracted_value:y,usage:d.usage,response_time:_,api_call_log:w}}(e,p.openai_api_key,p.cors_proxy);case"anthropic":if(!p.anthropic_api_key)throw new s("Anthropic API key not configured","anthropic");return async function(e,t,o){const r=Date.now(),p=o?`${o}/https://api.anthropic.com/v1/messages`:"https://api.anthropic.com/v1/messages",c={model:e.model,messages:[{role:"user",content:e.prompt}],max_tokens:e.max_tokens,temperature:e.temperature},u={"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";c.tools=[{name:"provide_answer",description:"Provides an answer to the prompt",input_schema:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],c.tool_choice={type:"tool",name:"provide_answer"},u["anthropic-beta"]="tools-2024-04-04"}const m=await i(p,{method:"POST",headers:u,body:JSON.stringify(c),referrerPolicy:"no-referrer"},"anthropic");if(!m.ok){const e=await m.json().catch(()=>({error:{message:m.statusText}}));throw new s(e.error?.message||"Anthropic API error","anthropic",m.status,e)}const l=await m.text(),d=n(l),_=Date.now()-r,h=a(p,"POST",u,c,m,l,_,d.usage,"anthropic",e.model);let w="",f="";if(!d?.content||!Array.isArray(d.content)||0===d.content.length)throw new s("Invalid Anthropic API response structure - missing or invalid content array","anthropic",m.status,{received:d,raw_response:l.substring(0,500)});const y=d.content.find(e=>"tool_use"===e.type);if(y&&y.input){try{w=JSON.stringify(y.input)}catch(g){console.warn("Failed to stringify tool use input:",g),w="[Complex Object]"}f=String(y.input?.answer||"")}else{const e=d.content.find(e=>"text"===e.type);w=e?.text||"",f=w}return{content:w,extracted_value:f,usage:{prompt_tokens:d.usage?.input_tokens||0,completion_tokens:d.usage?.output_tokens||0,total_tokens:(d.usage?.input_tokens||0)+(d.usage?.output_tokens||0)},response_time:_,api_call_log:h}}(e,p.anthropic_api_key,p.cors_proxy);case"ollama":return async function(e,t){const o=Date.now(),r={model:e.model.startsWith("ollama:")?e.model.substring(7):e.model,prompt:e.prompt,temperature:e.temperature,options:{num_predict:e.max_tokens},stream:!1};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";r.format={type:"object",properties:{answer:{type:t}},required:["answer"]},r.prompt=e.prompt+'\n\nPlease respond with valid JSON in the format: {"answer": <your_answer>}'}const p={"Content-Type":"application/json"},c=await i(`${t}/api/generate`,{method:"POST",headers:p,body:JSON.stringify(r)},"ollama");if(!c.ok){const e=await c.text();throw new s(`Ollama API error: ${e}`,"ollama",c.status)}const u=await c.text(),m=n(u),l=Date.now()-o,d=a(`${t}/api/generate`,"POST",p,r,c,u,l,{prompt_tokens:0,completion_tokens:0,total_tokens:0},"ollama",e.model);if(!m||"object"!=typeof m||"string"!=typeof m.response)throw new s("Invalid Ollama API response structure - missing or invalid response field","ollama",c.status,{received:m,raw_response:u.substring(0,500)});const _=m.response;let h=_;if("json"===e.output_format)try{const e=n(_);e&&"object"==typeof e&&"answer"in e&&(h=String(e.answer))}catch(w){h=_}return{content:_,extracted_value:h,response_time:l,api_call_log:d}}(e,p.ollama_base_url||"http://localhost:11434");case"openrouter":if(!p.openrouter_api_key)throw new s("OpenRouter API key not configured","openrouter");return async function(e,t,o){const r=Date.now(),p="https://openrouter.ai/api/v1",c=o?`${o}/${p}/chat/completions`:`${p}/chat/completions`,u={model:e.model,messages:[{role:"user",content:e.prompt}],temperature:e.temperature,max_tokens:e.max_tokens};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";u.functions=[{name:"provide_answer",description:"Provides an answer to the prompt",parameters:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],u.function_call={name:"provide_answer"}}const m={"Content-Type":"application/json",Authorization:`Bearer ${t}`,"HTTP-Referer":window.location.origin,"X-Title":"Auditomatic Lite"},l=await i(c,{method:"POST",headers:m,body:JSON.stringify(u),referrerPolicy:"no-referrer"},"openrouter");if(!l.ok){const e=await l.json().catch(()=>({error:{message:l.statusText}}));let t=e.error?.message||"OpenRouter API error";throw 401===l.status&&t.includes("No auth credentials found")&&(t="Invalid OpenRouter API key. Please check your API key in Settings."),new s(t,"openrouter",l.status,e)}const d=await l.text(),_=n(d),h=Date.now()-r;if(!_?.choices?.length)throw new s("Invalid OpenRouter API response structure - missing choices array","openrouter",l.status,{received:_,raw_response:d.substring(0,500)});const w=_.choices[0].message,f=a(c,"POST",m,u,l,d,h,_.usage,"openrouter",e.model);let y="",g="";if(w.function_call){const e=w.function_call.arguments;y=e;try{const t=n(e);g=t&&"object"==typeof t?String(t.answer||""):e}catch(v){g=e}}else y=w.content||"",g=y;return{content:y,extracted_value:g,usage:_.usage,response_time:h,api_call_log:f}}(e,p.openrouter_api_key,p.cors_proxy);default:throw new s(`Unsupported provider: ${o.provider}`,o.provider)}}async function c(t,o,r){const{useModelsStore:n}=await e(async()=>{const{useModelsStore:e}=await import("./index-niVOvZdn.js").then(e=>e.m);return{useModelsStore:e}},__vite__mapDeps([0,1,2,3]),import.meta.url),s=n().models.find(e=>e.id===t);if(!s)throw new Error(`Model ${t} not found`);return(await p({model:t,prompt:o,temperature:r?.temperature,max_tokens:r?.max_tokens,output_format:r?.output_format,output_type:r?.output_type},s)).content}export{s as L,p as c,c as t};
