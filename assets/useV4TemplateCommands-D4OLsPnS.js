import{c as k,d as l,a as p}from"./index-ByJJVjMq.js";import{b as V}from"./useV4VariableLists-sl-aI9KE.js";import{f as E,c as F}from"./vue-vendor-BZxY9vkr.js";class x{async create(t){try{const e=k("template"),a=await this.validateTemplate(t.template,t.variables);if(!a.isValid)return{ok:!1,error:new Error(`Template validation failed: ${a.errors.join(", ")}`)};if(t.variables){const i=await this.validateVariableListReferences(t.variables);if(!i.valid)return{ok:!1,error:new Error(`Invalid variable list references: ${i.errors.join(", ")}`)}}const s=new Date,n={id:e,name:t.name,description:t.description,type:"template",template:t.template,variables:t.variables?Object.freeze(this.deepFreezeVariables(t.variables)):Object.freeze({}),category:t.category||"Custom",tags:t.tags?Object.freeze([...t.tags]):Object.freeze([]),isDefault:!1,created:s,updated:s,outputType:t.outputType,extractPattern:t.extractPattern,refusalWords:t.refusalWords?Object.freeze([...t.refusalWords]):void 0,rejectRefusalWords:t.rejectRefusalWords},r=Object.freeze(n);return await l.transaction("rw",l.template_prompts,async()=>{await l.template_prompts.add(r)}),p.info("V4: Created template",{id:e,name:t.name,variableCount:Object.keys(t.variables||{}).length}),V("templates","create"),{ok:!0,value:e}}catch(e){return p.error("V4: Failed to create template",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to create template")}}}async update(t,e){try{const a=await l.template_prompts.get(t);if(!a)return{ok:!1,error:new Error("Template not found")};if(e.template!==void 0){const n=await this.validateTemplate(e.template,e.variables||a.variables);if(!n.isValid)return{ok:!1,error:new Error(`Template validation failed: ${n.errors.join(", ")}`)}}if(e.variables!==void 0){const n=await this.validateVariableListReferences(e.variables);if(!n.valid)return{ok:!1,error:new Error(`Invalid variable list references: ${n.errors.join(", ")}`)}}const s={...e,updated:new Date};return this.freezeUpdateData(s),await l.transaction("rw",l.template_prompts,async()=>{await l.template_prompts.update(t,s)}),p.info("V4: Updated template",{id:t,updates:Object.keys(e)}),V("templates","update"),{ok:!0,value:void 0}}catch(a){return p.error("V4: Failed to update template",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to update template")}}}async delete(t){try{const e=await l.template_prompts.get(t);return e?(await l.transaction("rw",l.template_prompts,async()=>{await l.template_prompts.delete(t)}),p.info("V4: Deleted template",{id:t,name:e.name}),V("templates","delete"),{ok:!0,value:void 0}):{ok:!1,error:new Error("Template not found")}}catch(e){return p.error("V4: Failed to delete template",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to delete template")}}}async duplicate(t,e){try{const a=await l.template_prompts.get(t);if(!a)return{ok:!1,error:new Error("Template not found")};const s={name:e||`${a.name} (Copy)`,description:a.description,template:a.template,variables:a.variables?this.deepCloneVariables(a.variables):void 0,category:a.category,tags:a.tags?[...a.tags]:void 0,outputType:a.outputType,extractPattern:a.extractPattern,refusalWords:a.refusalWords?[...a.refusalWords]:void 0,rejectRefusalWords:a.rejectRefusalWords};return await this.create(s)}catch(a){return p.error("V4: Failed to duplicate template",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to duplicate template")}}}async linkVariableList(t,e,a){try{const s=await l.template_prompts.get(t);if(!s)return{ok:!1,error:new Error("Template not found")};if(!await l.variableLists.get(a))return{ok:!1,error:new Error("Variable list not found")};const r={...s.variables,[e]:Object.freeze({type:"list",listId:a})};return await l.transaction("rw",l.template_prompts,async()=>{await l.template_prompts.update(t,{variables:Object.freeze(r),updated:new Date})}),p.info("V4: Linked variable list to template",{templateId:t,variableName:e,listId:a}),{ok:!0,value:void 0}}catch(s){return p.error("V4: Failed to link variable list",s),{ok:!1,error:s instanceof Error?s:new Error("Failed to link variable list")}}}async unlinkVariableList(t,e){try{const a=await l.template_prompts.get(t);if(!a)return{ok:!1,error:new Error("Template not found")};const{[e]:s,...n}=a.variables||{};return await l.transaction("rw",l.template_prompts,async()=>{await l.template_prompts.update(t,{variables:Object.freeze(n),updated:new Date})}),p.info("V4: Unlinked variable from template",{templateId:t,variableName:e}),{ok:!0,value:void 0}}catch(a){return p.error("V4: Failed to unlink variable list",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to unlink variable list")}}}async updateVariableListReferences(t,e){try{const a=await l.template_prompts.toArray(),s=[],n=[];for(const i of a){if(!i.variables)continue;let o=!1;const c={...i.variables};for(const[u,f]of Object.entries(i.variables))f.type==="list"&&f.listId===t&&(c[u]=Object.freeze({...f,listId:e}),o=!0);o&&(s.push(i.id),n.push({id:i.id,variables:Object.freeze(c)}))}n.length>0&&await l.transaction("rw",l.template_prompts,async()=>{const i=new Date;for(const o of n)await l.template_prompts.update(o.id,{variables:o.variables,updated:i})});const r={updatedTemplates:n.length,affectedTemplateIds:s};return p.info("V4: Updated variable list references",{oldListId:t,newListId:e,affectedCount:n.length}),{ok:!0,value:r}}catch(a){return p.error("V4: Failed to update variable list references",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to update variable list references")}}}async bulkCreate(t){try{const e=[],a=new Date;for(const n of t){const r=await this.validateTemplate(n.template,n.variables);if(!r.isValid)return{ok:!1,error:new Error(`Bulk validation failed for "${n.name}": ${r.errors.join(", ")}`)};if(n.variables){const i=await this.validateVariableListReferences(n.variables);if(!i.valid)return{ok:!1,error:new Error(`Invalid variable list references in "${n.name}": ${i.errors.join(", ")}`)}}}const s=t.map(n=>{const r=k("template"),i={id:r,name:n.name,description:n.description,type:"template",template:n.template,variables:n.variables?Object.freeze(this.deepFreezeVariables(n.variables)):Object.freeze({}),category:n.category||"Custom",tags:n.tags?Object.freeze([...n.tags]):Object.freeze([]),isDefault:!1,created:a,updated:a,outputType:n.outputType,extractPattern:n.extractPattern,refusalWords:n.refusalWords?Object.freeze([...n.refusalWords]):void 0,rejectRefusalWords:n.rejectRefusalWords};return e.push(r),Object.freeze(i)});return await l.transaction("rw",l.template_prompts,async()=>{await l.template_prompts.bulkAdd(s)}),p.info("V4: Bulk created templates",{count:t.length}),{ok:!0,value:e}}catch(e){return p.error("V4: Failed to bulk create templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk create templates")}}}async bulkUpdate(t){try{const e=t.map(r=>r.id),a=await l.template_prompts.where("id").anyOf(e).toArray();if(a.length!==e.length){const r=new Set(a.map(o=>o.id)),i=e.filter(o=>!r.has(o));return{ok:!1,error:new Error(`Some templates not found: ${i.join(", ")}`)}}const s=new Date,n=t.map(({id:r,data:i})=>{const o={...i,updated:s};return this.freezeUpdateData(o),{key:r,changes:o}});return await l.transaction("rw",l.template_prompts,async()=>{await l.template_prompts.bulkUpdate(n)}),p.info("V4: Bulk updated templates",{count:t.length}),{ok:!0,value:void 0}}catch(e){return p.error("V4: Failed to bulk update templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk update templates")}}}async bulkDelete(t){try{return await l.transaction("rw",l.template_prompts,async()=>{await l.template_prompts.bulkDelete(t)}),p.info("V4: Bulk deleted templates",{count:t.length}),{ok:!0,value:void 0}}catch(e){return p.error("V4: Failed to bulk delete templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to bulk delete templates")}}}async importTemplates(t){try{const e=JSON.parse(t),a=Array.isArray(e)?e:[e],s={imported:0,skipped:0,errors:[],invalidReferences:[]},n=[];for(const r of a)try{if(!r.name||!r.template){s.errors.push(`Template missing required fields: ${r.name||"unnamed"}`),s.skipped++;continue}const i=[];if(r.variables)for(const[,o]of Object.entries(r.variables))typeof o=="object"&&o!==null&&"type"in o&&o.type==="list"&&"listId"in o&&o.listId&&(await l.variableLists.get(o.listId)||i.push(o.listId));i.length>0&&s.invalidReferences.push({templateName:r.name,missingListIds:i}),n.push({name:r.name,description:r.description,template:r.template,variables:r.variables,category:r.category,tags:r.tags,outputType:r.outputType,extractPattern:r.extractPattern,refusalWords:r.refusalWords,rejectRefusalWords:r.rejectRefusalWords})}catch(i){s.errors.push(`Failed to process template ${r.name||"unnamed"}: ${i instanceof Error?i.message:"Unknown error"}`),s.skipped++}if(n.length>0){const r=await this.bulkCreate(n);r.ok?s.imported=r.value.length:s.errors.push(`Bulk import failed: ${r.error.message}`)}return{ok:!0,value:s}}catch(e){return p.error("V4: Failed to import templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to import templates")}}}async exportTemplates(t){try{const e=await l.template_prompts.where("id").anyOf(t).toArray();return{ok:!0,value:JSON.stringify(e,null,2)}}catch(e){return p.error("V4: Failed to export templates",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to export templates")}}}async exportTemplatesWithDependencies(t){try{const e=await l.template_prompts.where("id").anyOf(t).toArray();if(e.length===0)return{ok:!1,error:new Error("No templates found to export")};const a=new Set,s=[];for(const o of e){const c=[];if(o.variables)for(const u of Object.values(o.variables))u.type==="list"&&u.listId&&(a.add(u.listId),c.push(u.listId));s.push({template:o,dependencies:{variableListIds:c}})}const n=await l.variableLists.where("id").anyOf(Array.from(a)).toArray();return{ok:!0,value:JSON.stringify({version:"2.0",metadata:{exportDate:new Date,appVersion:"3.0.0"},templates:s,variableLists:n},null,2)}}catch(e){return p.error("V4: Failed to export templates with dependencies",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to export templates with dependencies")}}}async importTemplateBundle(t){var e;try{const a=JSON.parse(t);if(!a.version||!a.templates||!a.variableLists)return{ok:!1,error:new Error("Invalid bundle format")};const s={imported:0,skipped:0,errors:[],invalidReferences:[]},n={};for(const r of a.variableLists)try{const i=await this.findDuplicateVariableList(r);if(i)n[r.id]=i.id,p.info(`V4: Using existing variable list ${i.name} for imported list ${r.name}`);else{const o=k("list"),c={...r,id:o,created:new Date,updated:new Date};await l.variableLists.add(c),n[r.id]=o,p.info(`V4: Created new variable list ${r.name} with ID ${o}`)}}catch(i){s.errors.push(`Failed to import variable list ${r.name}: ${i instanceof Error?i.message:"Unknown error"}`)}for(const{template:r}of a.templates)try{if(r.variables){for(const c of Object.values(r.variables))if(c.type==="list"&&c.listId){const u=n[c.listId];u?c.listId=u:s.invalidReferences.push({templateName:r.name,missingListIds:[c.listId]})}}const i={name:r.name,description:r.description,template:r.template,variables:r.variables,category:r.category,tags:r.tags?[...r.tags]:void 0,outputType:r.outputType,extractPattern:r.extractPattern,refusalWords:r.refusalWords?[...r.refusalWords]:void 0,rejectRefusalWords:r.rejectRefusalWords},o=await this.create(i);o.ok?s.imported++:(s.errors.push(`Failed to create template ${r.name}: ${(e=o.error)==null?void 0:e.message}`),s.skipped++)}catch(i){s.errors.push(`Failed to import template ${r.name}: ${i instanceof Error?i.message:"Unknown error"}`),s.skipped++}return{ok:!0,value:s}}catch(a){return p.error("V4: Failed to import template bundle",a),{ok:!1,error:a instanceof Error?a:new Error("Failed to import template bundle")}}}async findDuplicateVariableList(t){const e=await l.variableLists.where("name").equals(t.name).toArray();for(const a of e)if(a.category===t.category&&a.itemCount===t.itemCount)return a;return null}async validateTemplateIntegrity(t){try{const e=t?await l.template_prompts.where("id").equals(t).toArray():await l.template_prompts.toArray(),a={totalTemplates:e.length,templatesWithInvalidReferences:[],orphanedReferences:[]},s=await l.variableLists.toArray(),n=new Set(s.map(r=>r.id));for(const r of e){if(!r.variables)continue;const i=[];for(const[o,c]of Object.entries(r.variables))c.type==="list"&&c.listId?n.has(c.listId)||(i.push({variableName:o,listId:c.listId,issue:"missing_list"}),a.orphanedReferences.push({templateId:r.id,variableName:o,listId:c.listId})):c.type==="list"&&!c.listId&&i.push({variableName:o,listId:"unknown",issue:"invalid_binding"});i.length>0&&a.templatesWithInvalidReferences.push({templateId:r.id,templateName:r.name,invalidVariables:i})}return{ok:!0,value:a}}catch(e){return p.error("V4: Failed to validate template integrity",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to validate template integrity")}}}async cleanupInvalidReferences(){try{const t=await this.validateTemplateIntegrity();if(!t.ok)return{ok:!1,error:t.error};const e={removedReferences:0,affectedTemplates:[]},a=t.value;if(a.orphanedReferences.length>0){const s=[],n=new Map;for(const i of a.orphanedReferences)n.has(i.templateId)||n.set(i.templateId,[]),n.get(i.templateId).push(i.variableName);const r=await l.template_prompts.where("id").anyOf(Array.from(n.keys())).toArray();for(const i of r){const o=n.get(i.id)||[];if(o.length===0)continue;const c={...i.variables};let u=0;for(const f of o)c[f]&&(delete c[f],u++);u>0&&(s.push({id:i.id,variables:Object.freeze(c)}),e.removedReferences+=u,e.affectedTemplates.push(i.id))}s.length>0&&await l.transaction("rw",l.template_prompts,async()=>{const i=new Date;for(const o of s)await l.template_prompts.update(o.id,{variables:o.variables,updated:i})})}return p.info("V4: Cleaned up invalid template references",e),{ok:!0,value:e}}catch(t){return p.error("V4: Failed to cleanup invalid references",t),{ok:!1,error:t instanceof Error?t:new Error("Failed to cleanup invalid references")}}}async enrichWithVariableListData(t){try{const e=new Set;for(const r of t)if(r.variables)for(const i of Object.values(r.variables))i.type==="list"&&i.listId&&e.add(i.listId);const a=await l.variableLists.where("id").anyOf(Array.from(e)).toArray(),s=new Map(a.map(r=>[r.id,r]));return{ok:!0,value:t.map(r=>{const i=Object.keys(r.variables||{}).length;let o=1;const c={},u=[];if(r.variables)for(const[w,b]of Object.entries(r.variables))if(b.type==="list"&&b.listId){const v=s.get(b.listId);v?(c[w]=v,v.category==="simple"&&v.values?o*=v.values.length:v.category==="attributed"&&v.items?o*=v.items.length:v.category==="tabular"&&v.itemCount&&(o*=v.itemCount)):u.push(b.listId)}else b.type==="value"&&b.values&&(o*=b.values.length);const f={...r,variableCount:i,combinationCount:o,tokenEstimate:Math.ceil(r.template.length/4),variableListData:Object.keys(c).length>0?Object.freeze(c):void 0,missingVariableLists:u.length>0?Object.freeze(u):void 0};return Object.freeze(f)})}}catch(e){return p.error("V4: Failed to enrich templates with variable list data",e),{ok:!1,error:e instanceof Error?e:new Error("Failed to enrich templates")}}}async validateTemplate(t,e){const a=[],s=[],n=/\{\{([^}]+)\}\}/g,r=new Set;let i;for(;(i=n.exec(t))!==null;)r.add(i[1].trim());t.trim()||a.push("Template cannot be empty");const o=(t.match(/\{\{/g)||[]).length,c=(t.match(/\}\}/g)||[]).length;o!==c&&a.push("Template has unclosed variable braces");const u=new Set(Object.keys(e||{})),f=Array.from(r).filter(b=>!u.has(b)),w=Array.from(u).filter(b=>!r.has(b));return f.length>0&&s.push(`Variables used in template but not defined: ${f.join(", ")}`),w.length>0&&s.push(`Variables defined but not used in template: ${w.join(", ")}`),{isValid:a.length===0,errors:a,warnings:s,extractedVariables:Array.from(r),missingVariables:f,unusedVariables:w}}async validateVariableListReferences(t){const e=[],a=Object.values(t).filter(s=>s.type==="list"&&s.listId).map(s=>s.listId);if(a.length>0){const s=await l.variableLists.where("id").anyOf(a).toArray(),n=new Set(s.map(i=>i.id)),r=a.filter(i=>!n.has(i));r.length>0&&e.push(`Referenced variable lists not found: ${r.join(", ")}`)}return{valid:e.length===0,errors:e}}deepFreezeVariables(t){const e={};for(const[a,s]of Object.entries(t))s.values?e[a]=Object.freeze({...s,values:Object.freeze([...s.values])}):e[a]=Object.freeze({...s});return e}deepCloneVariables(t){const e={};for(const[a,s]of Object.entries(t))s.values?e[a]={...s,values:[...s.values]}:e[a]={...s};return e}freezeUpdateData(t){t.variables&&(t.variables=Object.freeze(this.deepFreezeVariables(t.variables))),t.tags&&(t.tags=Object.freeze([...t.tags])),t.refusalWords&&(t.refusalWords=Object.freeze([...t.refusalWords]))}}const m=new x;function C(){const g=E(new Set),t=E(null),e=F(()=>g.value.size>0);function a(){t.value=null}async function s(d,y){g.value.add(d),t.value=null;try{const h=await y();return h.ok||(t.value=h.error),h}catch(h){const j=h instanceof Error?h:new Error("Command execution failed");return t.value=j,{ok:!1,error:j}}finally{g.value.delete(d)}}async function n(d){return s("create",()=>m.create(d))}async function r(d,y){return s("update",()=>m.update(d,y))}async function i(d){return s("delete",()=>m.delete(d))}async function o(d,y){return s("duplicate",()=>m.duplicate(d,y))}async function c(d,y,h){return s("linkVariable",()=>m.linkVariableList(d,y,h))}async function u(d,y){return s("unlinkVariable",()=>m.unlinkVariableList(d,y))}async function f(d,y){return s("updateReferences",()=>m.updateVariableListReferences(d,y))}async function w(d){return s("bulkCreate",()=>m.bulkCreate(d))}async function b(d){return s("bulkUpdate",()=>m.bulkUpdate(d))}async function v(d){return s("bulkDelete",()=>m.bulkDelete(d))}async function T(d){return s("import",()=>m.importTemplates(d))}async function O(d){return s("export",()=>m.exportTemplates(d))}async function I(d){return s("validate",()=>m.validateTemplateIntegrity(d))}async function L(){return s("cleanup",()=>m.cleanupInvalidReferences())}return{createTemplate:n,updateTemplate:r,deleteTemplate:i,duplicateTemplate:o,linkVariableList:c,unlinkVariableList:u,updateVariableListReferences:f,bulkCreateTemplates:w,bulkUpdateTemplates:b,bulkDeleteTemplates:v,importTemplates:T,exportTemplates:O,validateTemplateIntegrity:I,cleanupInvalidReferences:L,isExecuting:e,lastError:t,clearError:a}}export{C as u};
