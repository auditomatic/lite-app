const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-CPkYwVf3.js","./vendor-DdqHZeTC.js","./db-ftwlfnxb.js","./index-DXqFmLeW.css"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,r,o)=>((t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o)(t,"symbol"!=typeof r?r+"":r,o);import{c as r,f as o,d as n,D as s}from"./index-CPkYwVf3.js";import{a}from"./apiLogger-wE3EW76_.js";import{s as i}from"./safeJson-BfKuju6h.js";class c extends Error{constructor(e,t,r,o){super(e),this.provider=t,this.statusCode=r,this.details=o,this.name="LLMError"}}function p(e,t,r,o,n,s,i,c,p,u){return a.createAPILog({url:e,method:t,headers:r,body:o},{status:n.status,headers:Object.fromEntries(n.headers.entries()),body:s,timing_ms:i},c||{prompt_tokens:0,completion_tokens:0,total_tokens:0},p,u)}async function u(e,t,r){const o=await n.providers.get(r),s=o?.timeout_ms||6e4,a=new AbortController,i=setTimeout(()=>{a.abort()},s);try{const r=await fetch(e,{...t,signal:a.signal});return clearTimeout(i),r}catch(p){if(clearTimeout(i),p instanceof Error&&"AbortError"===p.name)throw new c(`API call timed out after ${s}ms`,r,408,{timeout_ms:s});throw p}}async function l(e,t){const r=o(),n=await r.loadSettings();switch(t.provider){case"openai":if(!n.openai_api_key)throw new c("OpenAI API key not configured","openai");return async function(e,t,r){const o=Date.now(),n=r?`${r}/https://api.openai.com/v1/chat/completions`:"https://api.openai.com/v1/chat/completions",s={model:e.model,messages:[{role:"user",content:e.prompt}],temperature:e.temperature,max_tokens:e.max_tokens};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";s.functions=[{name:"provide_answer",description:"Provides an answer to the prompt",parameters:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],s.function_call={name:"provide_answer"}}const a={"Content-Type":"application/json",Authorization:`Bearer ${t}`},l=await u(n,{method:"POST",headers:a,body:JSON.stringify(s),referrerPolicy:"no-referrer"},"openai");if(!l.ok){const e=await l.json().catch(()=>({error:{message:l.statusText}}));throw new c(e.error?.message||"OpenAI API error","openai",l.status,e)}const m=await l.text(),d=i(m),f=Date.now()-o;if(!d?.choices?.length)throw new c("Invalid OpenAI API response structure - missing choices array","openai",l.status,{received:d,raw_response:m.substring(0,500)});const _=d.choices[0].message,h=p(n,"POST",a,s,l,m,f,d.usage,"openai",e.model);let w="",g="";if(_.function_call){const e=_.function_call.arguments;w=e;try{const t=i(e);g=t&&"object"==typeof t?String(t.answer||""):e}catch(y){g=e}}else w=_.content||"",g=w;return{content:w,extracted_value:g,usage:d.usage,response_time:f,api_call_log:h}}(e,n.openai_api_key,n.cors_proxy);case"anthropic":if(!n.anthropic_api_key)throw new c("Anthropic API key not configured","anthropic");return async function(e,t,r){const o=Date.now(),n=r?`${r}/https://api.anthropic.com/v1/messages`:"https://api.anthropic.com/v1/messages",s={model:e.model,messages:[{role:"user",content:e.prompt}],max_tokens:e.max_tokens,temperature:e.temperature},a={"Content-Type":"application/json","x-api-key":t,"anthropic-version":"2023-06-01"};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";s.tools=[{name:"provide_answer",description:"Provides an answer to the prompt",input_schema:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],s.tool_choice={type:"tool",name:"provide_answer"},a["anthropic-beta"]="tools-2024-04-04"}const l=await u(n,{method:"POST",headers:a,body:JSON.stringify(s),referrerPolicy:"no-referrer"},"anthropic");if(!l.ok){const e=await l.json().catch(()=>({error:{message:l.statusText}}));throw new c(e.error?.message||"Anthropic API error","anthropic",l.status,e)}const m=await l.text(),d=i(m),f=Date.now()-o,_=p(n,"POST",a,s,l,m,f,d.usage,"anthropic",e.model);let h="",w="";if(!d?.content||!Array.isArray(d.content)||0===d.content.length)throw new c("Invalid Anthropic API response structure - missing or invalid content array","anthropic",l.status,{received:d,raw_response:m.substring(0,500)});const g=d.content.find(e=>"tool_use"===e.type);if(g&&g.input){try{h=JSON.stringify(g.input)}catch(y){console.warn("Failed to stringify tool use input:",y),h="[Complex Object]"}w=String(g.input?.answer||"")}else{const e=d.content.find(e=>"text"===e.type);h=e?.text||"",w=h}return{content:h,extracted_value:w,usage:{prompt_tokens:d.usage?.input_tokens||0,completion_tokens:d.usage?.output_tokens||0,total_tokens:(d.usage?.input_tokens||0)+(d.usage?.output_tokens||0)},response_time:f,api_call_log:_}}(e,n.anthropic_api_key,n.cors_proxy);case"ollama":return async function(e,t){const r=Date.now(),o={model:e.model.startsWith("ollama:")?e.model.substring(7):e.model,prompt:e.prompt,temperature:e.temperature,options:{num_predict:e.max_tokens},stream:!1};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";o.format={type:"object",properties:{answer:{type:t}},required:["answer"]},o.prompt=e.prompt+'\n\nPlease respond with valid JSON in the format: {"answer": <your_answer>}'}const n={"Content-Type":"application/json"},s=await u(`${t}/api/generate`,{method:"POST",headers:n,body:JSON.stringify(o)},"ollama");if(!s.ok){const e=await s.text();throw new c(`Ollama API error: ${e}`,"ollama",s.status)}const a=await s.text(),l=i(a),m=Date.now()-r,d=p(`${t}/api/generate`,"POST",n,o,s,a,m,{prompt_tokens:0,completion_tokens:0,total_tokens:0},"ollama",e.model);if(!l||"object"!=typeof l||"string"!=typeof l.response)throw new c("Invalid Ollama API response structure - missing or invalid response field","ollama",s.status,{received:l,raw_response:a.substring(0,500)});const f=l.response;let _=f;if("json"===e.output_format)try{const e=i(f);e&&"object"==typeof e&&"answer"in e&&(_=String(e.answer))}catch(h){_=f}return{content:f,extracted_value:_,response_time:m,api_call_log:d}}(e,n.ollama_base_url||"http://localhost:11434");case"openrouter":if(!n.openrouter_api_key)throw new c("OpenRouter API key not configured","openrouter");return async function(e,t,r){const o=Date.now(),n="https://openrouter.ai/api/v1",s=r?`${r}/${n}/chat/completions`:`${n}/chat/completions`,a={model:e.model,messages:[{role:"user",content:e.prompt}],temperature:e.temperature,max_tokens:e.max_tokens};if("json"===e.output_format){const t="number"===e.output_type?"number":"string";a.functions=[{name:"provide_answer",description:"Provides an answer to the prompt",parameters:{type:"object",properties:{answer:{type:t,description:"The answer value"}},required:["answer"]}}],a.function_call={name:"provide_answer"}}const l={"Content-Type":"application/json",Authorization:`Bearer ${t}`,"HTTP-Referer":window.location.origin,"X-Title":"Auditomatic Lite"},m=await u(s,{method:"POST",headers:l,body:JSON.stringify(a),referrerPolicy:"no-referrer"},"openrouter");if(!m.ok){const e=await m.json().catch(()=>({error:{message:m.statusText}}));let t=e.error?.message||"OpenRouter API error";throw 401===m.status&&t.includes("No auth credentials found")&&(t="Invalid OpenRouter API key. Please check your API key in Settings."),new c(t,"openrouter",m.status,e)}const d=await m.text(),f=i(d),_=Date.now()-o;if(!f?.choices?.length)throw new c("Invalid OpenRouter API response structure - missing choices array","openrouter",m.status,{received:f,raw_response:d.substring(0,500)});const h=f.choices[0].message,w=p(s,"POST",l,a,m,d,_,f.usage,"openrouter",e.model);let g="",y="";if(h.function_call){const e=h.function_call.arguments;g=e;try{const t=i(e);y=t&&"object"==typeof t?String(t.answer||""):e}catch(b){y=e}}else g=h.content||"",y=g;return{content:g,extracted_value:y,usage:f.usage,response_time:_,api_call_log:w}}(e,n.openrouter_api_key,n.cors_proxy);default:throw new c(`Unsupported provider: ${t.provider}`,t.provider)}}async function m(e,t,o){const{useModelsStore:n}=await r(async()=>{const{useModelsStore:e}=await import("./index-CPkYwVf3.js").then(e=>e.m);return{useModelsStore:e}},__vite__mapDeps([0,1,2,3]),import.meta.url),s=n().models.find(t=>t.id===e);if(!s)throw new Error(`Model ${e} not found`);return(await l({model:e,prompt:t,temperature:o?.temperature,max_tokens:o?.max_tokens,output_format:o?.output_format,output_type:o?.output_type},s)).content}const d=class e{constructor(){t(this,"dbService"),this.dbService=s.getInstance()}static getInstance(){return e.instance||(e.instance=new e),e.instance}async resolveDesignVariables(e,t=[]){const r={},o=e.variables||{};for(const[s,a]of Object.entries(o))Array.isArray(a)&&(r[s]=a);const n=e.variable_list_refs||{};for(const[s,a]of Object.entries(n)){let e=t.find(e=>e.id===a);if(!e){const t=await this.dbService.read("variable_lists",a);t.success&&t.data&&(e=t.data)}e&&e.values&&(r[s]=e.values)}return r}async resolveVariablesWithAttributes(e,t=[]){const r={},o={};if(e.variables)for(const[n,s]of Object.entries(e.variables))r[n]=s,o[n]=s.map(()=>({}));if(e.variable_list_refs)for(const[n,s]of Object.entries(e.variable_list_refs)){let e=t.find(e=>e.id===s);if(!e){const t=await this.dbService.read("variable_lists",s);t.success&&t.data&&(e=t.data)}e&&e.values&&(r[n]=e.values,"attributed"===e.category&&e.attributed_items?o[n]=e.attributed_items.map(e=>e.attributes):o[n]=e.values.map(()=>({})))}return{values:r,attributes:o}}extractTemplateVariables(e){if("string"!=typeof e)return[];const t=/\{\{([^}]+)\}\}/g,r=new Set;let o;for(;null!==(o=t.exec(e));){const e=o[1].trim();e&&/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)&&r.add(e)}return Array.from(r)}async validateTemplateVariables(e,t=[]){const r=this.extractTemplateVariables(e.prompt_template||""),o=await this.resolveDesignVariables(e,t),n=Object.keys(o),s=r.filter(e=>!n.includes(e)),a=n.filter(e=>!r.includes(e)),i=[];return a.length>0&&i.push(`Unused variables: ${a.join(", ")}`),{valid:0===s.length,missingVariables:s,unusedVariables:a,warnings:i}}processTemplate(e,t){let r=e;for(const[o,n]of Object.entries(t))if(!o.includes("_")||e.includes(`{{${o}}}`)){const e=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),t=new RegExp(`{{\\s*${e}\\s*}}`,"g");r=r.replace(t,n)}return r}generateCombinationsWithAttributes(e){const{values:t,attributes:r}=e,o=Object.keys(t);if(0===o.length)return[{}];const n=[];return function e(s,a){if(s===o.length)return void n.push({...a});const i=o[s],c=t[i],p=r[i]||[];for(let t=0;t<c.length;t++){const r=c[t],o=p[t]||{};a[i]=r;for(const[e,t]of Object.entries(o))a[`${i}_${e}`]=String(t);e(s+1,a),delete a[i];for(const e of Object.keys(o))delete a[`${i}_${e}`]}}(0,{}),n}};t(d,"instance");let f=d;export{c as L,f as V,l as c,m as t};
