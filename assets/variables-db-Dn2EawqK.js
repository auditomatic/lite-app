import{d as e,i as t}from"./index-D7qu21q1.js";import{ag as r,f as s,c as a,ah as i}from"./vendor-BxfGckcK.js";import{l as n}from"./db-COX2g2xv.js";const l=new class{parseCSV(e){const t=e.split("\n").map(e=>e.trim()).filter(Boolean);if(0===t.length)return{headers:[],rows:[]};const r=this.parseCSVLine(t[0]);if(0===r.length)return{headers:[],rows:[]};const s=[];for(let a=1;a<t.length;a++){const e=this.parseCSVLine(t[a]);if(e.every(e=>!e.trim()))continue;const i={};r.forEach((t,r)=>{i[t]=e[r]||""}),s.push(i)}return{headers:r,rows:s}}parseCSVLine(e){const t=[];let r="",s=!1,a=0;for(;a<e.length;){const i=e[a];'"'===i?s&&'"'===e[a+1]?(r+='"',a+=2):(s=!s,a++):","!==i||s?(r+=i,a++):(t.push(r.trim()),r="",a++)}return t.push(r.trim()),t}validateAttributedList(e,t){const r=[],s=[];if(0===e.length)return r.push("At least one item is required"),{isValid:!1,errors:r,warnings:s};const a=e.filter(e=>!e.value.trim());a.length>0&&r.push(`${a.length} items have empty values`);const i=e.map(e=>e.value.trim().toLowerCase()),n=i.filter((e,t)=>i.indexOf(e)!==t);n.length>0&&s.push(`Duplicate values found: ${[...new Set(n)].join(", ")}`);for(const o of t){const t=e.filter(e=>!e.attributes[o]?.trim());t.length>0&&r.push(`${t.length} items missing required attribute: ${o}`)}const l=new Set;e.forEach(e=>{Object.keys(e.attributes).forEach(e=>l.add(e))});return e.filter(e=>Array.from(l).some(t=>!(t in e.attributes))).length>0&&s.push("Some items missing optional attributes"),{isValid:0===r.length,errors:r,warnings:s}}getAttributeStats(e){const t={};return e.forEach(e=>{Object.entries(e.attributes).forEach(([e,r])=>{t[e]||(t[e]=new Set),r?.trim()&&t[e].add(r.trim())})}),t}convertToAttributedList(e,t=[]){return e.map(e=>({value:e.trim(),attributes:t.reduce((e,t)=>(e[t]="",e),{})}))}parseJSON(e){try{return JSON.parse(e)}catch(t){throw new Error("Invalid JSON format")}}csvToAttributedItems(e){const t=e.headers.find(e=>"value"===e.toLowerCase()||"name"===e.toLowerCase());if(!t)throw new Error('CSV must have a "value" or "name" column');const r=e.headers.filter(e=>e!==t);return e.rows.map(e=>({value:e[t]||"",attributes:r.reduce((t,r)=>(t[r]=e[r]||"",t),{})})).filter(e=>e.value.trim())}exportToCSV(e){if(0===e.length)return"";const t=Array.from(new Set(e.flatMap(e=>Object.keys(e.attributes)))).sort(),r=[["value",...t].join(",")];return e.forEach(e=>{const s=[this.escapeCSVValue(e.value),...t.map(t=>this.escapeCSVValue(e.attributes[t]||""))];r.push(s.join(","))}),r.join("\n")}escapeCSVValue(e){return e?e.includes(",")||e.includes('"')||e.includes("\n")?`"${e.replace(/"/g,'""')}"`:e:""}async getListValues(t){const r=await e.variableLists.get(t);return r?"simple"===r.category&&r.values?r.values:"attributed"===r.category&&r.items?r.items.map(e=>e.value):[]:[]}},o=r("variableLists",()=>{const r=s([]),l=s(!1),o=s(null);let u=null;const c=a(()=>r.value.filter(e=>"simple"===e.category)),d=a(()=>r.value.filter(e=>"attributed"===e.category)),v=a(()=>r.value.filter(e=>"refusal"===e.category)),m=a(()=>r.value.slice().sort((e,t)=>t.updated.getTime()-e.updated.getTime()));return{lists:r,isLoading:i(l),error:i(o),simpleLists:c,attributedLists:d,refusalLists:v,listsByDate:m,initialize:async function(){if(!u){l.value=!0,o.value=null;try{u=n(()=>e.variableLists.orderBy("updated").reverse().toArray()).subscribe({next:e=>{r.value=e,l.value=!1},error:e=>{console.error("Variable lists store subscription error:",e),o.value="Failed to load variable lists",l.value=!1}})}catch(t){console.error("Failed to initialize variable lists store:",t),o.value="Failed to initialize variable lists",l.value=!1}}},createList:async function(r){const s=new Date,a=t(),i={...r,id:a,created:s,updated:s};return await e.variableLists.add(i),a},updateList:async function(t,r){await e.variableLists.update(t,{...r,updated:new Date})},deleteList:async function(t){const r=(await e.designs.toArray()).filter(e=>e.variableBindings&&Object.values(e.variableBindings).some(e=>"list"===e.type&&e.listId===t));if(r.length>0){const e=r.map(e=>e.name).join(", ");throw new Error(`Cannot delete variable list - it is used in designs: ${e}`)}await e.variableLists.delete(t)},getList:async function(t){return await e.variableLists.get(t)},getAllLists:async function(){try{return await e.variableLists.toArray()}catch(t){return console.error("Failed to get all lists:",t),[]}},destroy:function(){u&&(u.unsubscribe(),u=null)}}});export{o as u,l as v};
