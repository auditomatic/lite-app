import{f as z,c as N,d as H,o as ne,b as ye,w as G,R as b,a0 as ae,_ as O,n as Ce,k as r,S as t,Z as $,V as _,q as be,a3 as he,F as Q,W as X,Y as v,G as L,u as x,r as ke,$ as K,e as $e,z as Te,p as we,a1 as Ie,X as Se}from"./vue-vendor-DPw1dQYc.js";import{e as ue,a as J,d as Pe,j as Y,f as xe,c as De}from"./index-B4E_mw1M.js";import{u as Ee}from"./useV4Templates-OY__Z4bY.js";import{a as ce}from"./useV4VariableLists-WRuVXP2X.js";import{u as oe}from"./useV4Models-BGiFLOq0.js";import{u as ie,a as Me}from"./useV4TrialCommands-Ch_dPyKy.js";import{u as Le}from"./execution-control-v4-BBBUVwqv.js";import{l as Z,T as le,aG as me,y as Ae,v as Ne,a5 as ve,aH as pe,W as Oe,F as Ve,G as ee,aI as ze,a8 as Re,a3 as je,a4 as Be,n as Fe,aj as Ue,o as Je,H as We,r as qe,t as Ke,aJ as Ge,p as He,M as fe,ae as Ye,ah as ge,Z as Ze,P as Qe,ao as Xe,a0 as et,$ as tt,u as te}from"./ui-vendor-CcBzucUW.js";import{G as at}from"./GenericModelSelectorModalV3-9adOUE4b.js";import{u as re}from"./useCostEstimation-rNo1SkHV.js";import"./utils-vendor--V4UhsOV.js";import"./useV4LiveQuery-CFmqtcF9.js";import"./useV4ProviderParameters-Del5tQ_D.js";function st(U){const{templates:D}=Ee(),{variableLists:a}=ce(),{enabledModels:I}=oe(),{runningTrials:p}=ie(),S=Le(),{createTrial:C}=Me(),c=z(null),m=z(""),y=z(""),k=z(1),P=z([]),R=z(!1),A=z(!1),u=N(()=>D.value||[]),i=N(()=>[]),E=N(()=>{if(!c.value)return 0;if(c.value.type==="template"){const d=c.value;if(!d.variables)return 1;let T=1;for(const[,j]of Object.entries(d.variables))if(j.type==="value"&&j.values)T*=j.values.length;else if(j.type==="list"&&j.listId){const W=a.value.find(q=>q.id===j.listId);W&&(W.category==="simple"?T*=W.values?.length||0:W.category==="attributed"?T*=W.items?.length||0:W.category==="tabular"&&(T*=W.itemCount||0))}return T}else return 0}),M=N(()=>E.value*P.value.length*k.value),B=N(()=>{let d=0;for(const T of P.value){const j=e(T);d+=j*E.value*k.value}return d}),F=N(()=>c.value!==null&&P.value.length>0&&m.value.trim()!=="");function w(d){c.value=d,m.value=V(d)}function V(d){const T=d||c.value;if(!T)return"New Trial";const j=new Date().toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return`${T.name} - ${j}`}function e(d){if(!c.value)return 0;const T=I.value.find(de=>de.provider===d.provider&&de.modelId===d.modelId);if(!T?.capabilities)return 0;const j=s(),W=d.parameters?.max_tokens||d.parameters?.maxTokens||256,q=ue(j,T.capabilities.inputCostPerToken)||0,_e=ue(W,T.capabilities.outputCostPerToken)||0;return q+_e}function s(){return c.value&&c.value.type==="template"?150:100}function o(d){P.value.push(d)}function n(d){P.value.splice(d,1)}async function g(){if(F.value){R.value=!0;try{const d=JSON.parse(JSON.stringify(c.value)),T={name:m.value,description:"",type:d.type,configurations:JSON.parse(JSON.stringify(P.value)),repeatCount:k.value,templateConfig:d.type==="template"?{template:d.template,variables:d.variables,parserId:d.parserId,outputType:d.outputType,extractPattern:d.extractPattern,refusalWords:d.refusalWords,rejectRefusalWords:d.rejectRefusalWords}:void 0,spreadsheetConfig:d.type==="spreadsheet"?{promptPattern:d.promptPattern,datasetId:d.datasetId,parserId:d.parserId}:void 0},j=await C(T);if(j.ok)return j.value;throw j.error}finally{R.value=!1}}}async function l(){const d=await g();if(d)return p.value.length>0?{trialId:d,needsConfirmation:!0,runningTrial:p.value[0]}:await f(d)}async function f(d){const T=await S.startTrialWithStreaming(d);if(T.ok){const j=T.value.progress$.subscribe({next:q=>{q.type},error:q=>{J.error("V4: Creation view stream error:",q)}}),W=T.value.calls$.subscribe({next:q=>{q.length},error:q=>{J.error("V4: Creation view calls stream error:",q)}});return setTimeout(()=>{j.unsubscribe(),W.unsubscribe()},1e3),{trialId:d,needsConfirmation:!1}}else throw T.error}async function h(){try{await S.initialize()}catch(d){J.error("V4: Failed to initialize execution control in creation view:",d)}if(U.value.type==="duplicate"&&U.value.sourceTrialId){const d=await Pe.trials.get(U.value.sourceTrialId);if(d){if(m.value=`Copy of ${d.name}`,k.value=d.repeatCount||1,d.configurations&&(P.value=d.configurations.map(T=>({name:T.modelSnapshot?.displayName||T.modelId,provider:T.provider,modelId:T.modelId,parameters:T.parameters||{}}))),d.type==="template"&&d.templateConfig?.template){const T=u.value.find(j=>j.template===d.templateConfig?.template);T&&w(T)}else if(d.type==="spreadsheet"&&d.spreadsheetConfig?.datasetId){const T=i.value.find(j=>j.datasetId===d.spreadsheetConfig?.datasetId);T&&w(T)}}}}return{selectedPrompt:c,trialName:m,description:y,repeatCount:k,configurations:P,creating:R,showModelSelector:A,templates:u,spreadsheets:i,variableLists:a,enabledModels:I,runningTrials:p,totalCombinations:E,totalExperiments:M,totalCost:B,canProceed:F,selectPrompt:w,generateTrialName:V,addConfiguration:o,removeConfiguration:n,getConfigCostPerCall:e,createTrialAsDraft:g,createAndStartTrial:l,initialize:h}}const nt={key:0,class:"preview-controls"},ot={class:"template-name"},it={key:0,class:"cycle-info"},lt={key:1,class:"variable-legend"},rt={class:"variable-value"},dt=H({__name:"TemplatePreviewV3",props:{template:{},variableLists:{default:()=>[]},cycling:{type:Boolean,default:!0},cyclingSpeed:{default:1e3},showControls:{type:Boolean,default:!1},displayMode:{default:"block"},showLegend:{type:Boolean,default:!1},maxLines:{default:0}},emits:["update:paused","back-to-select"],setup(U,{emit:D}){const a=U,I=D,p=z(0),S=z(!1);let C=null;const c=["variable-highlight-blue","variable-highlight-green","variable-highlight-purple","variable-highlight-orange","variable-highlight-pink","variable-highlight-teal"],m=N(()=>a.template.type==="template"?a.template.template:a.template.type==="spreadsheet"?a.template.promptPattern:""),y=N(()=>{if(a.template.type==="spreadsheet"){const o=a.template,n=a.variableLists.find(g=>g.id===o.datasetId);return n?.category==="tabular"&&n.tabularData?.rows?n.tabularData.rows.map(g=>{const l={};return Object.keys(g).forEach(f=>{let h=f.replace(/[^a-zA-Z0-9_]/g,"_");/^[a-zA-Z]/.test(h)||(h="col_"+h),h=h.replace(/_+/g,"_").replace(/_+$/,""),l[h]=String(g[f]||"")}),l}):[]}const w=[];if(a.template.variables){for(const[o,n]of Object.entries(a.template.variables))if(n.type==="value"&&n.values)w.push({name:o,values:[...n.values]});else if(n.type==="list"&&n.listId){const g=a.variableLists.find(l=>l.id===n.listId);g&&(g.category==="simple"&&g.values?w.push({name:o,values:[...g.values]}):g.category==="attributed"&&g.items&&w.push({name:o,values:g.items.map(l=>l.value)}))}}if(w.length===0)return[];const V=o=>o.reduce((n,g)=>n.flatMap(l=>g.map(f=>[...l,f])),[[]]),e=w.map(o=>o.values);return V(e).map(o=>{const n={};return w.forEach((g,l)=>{n[g.name]=o[l]}),n})}),k=N(()=>y.value.length),P=N(()=>y.value.length===0?null:y.value[p.value]||y.value[0]),R=N(()=>{const w=m.value;if(!w)return"";const V=P.value;if(!V||Object.keys(V).length===0)return i(w).replace(/\n/g,"<br>");let e=i(w);if(Object.keys(V).sort((o,n)=>n.length-o.length).forEach((o,n)=>{const g=V[o],l=i(g),f=u(n),h=new RegExp(`{{\\s*${E(o)}\\s*}}`,"g");e=e.replace(h,`<span class="${f} variable-value">${l}</span>`)}),e=e.replace(/\n/g,"<br>"),a.maxLines>0){const o=e.split("<br>");o.length>a.maxLines&&(e=o.slice(0,a.maxLines).join("<br>")+'<br><span class="line-clamp-indicator">...</span>')}return e}),A=N(()=>a.displayMode==="inline"&&a.maxLines>0?{display:"-webkit-box","-webkit-line-clamp":a.maxLines,"-webkit-box-orient":"vertical",overflow:"hidden"}:{});function u(w){return c[w%c.length]}function i(w){const V=document.createElement("div");return V.textContent=w,V.innerHTML}function E(w){return w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function M(){S.value=!S.value,I("update:paused",S.value)}function B(){!a.cycling||S.value||k.value<=1||(C=setInterval(()=>{p.value=(p.value+1)%k.value},a.cyclingSpeed))}function F(){C&&(clearInterval(C),C=null)}return ne(()=>{a.cycling&&!S.value&&B()}),ye(()=>{F()}),G(()=>S.value,w=>{w||!a.cycling?F():B()}),G(()=>a.cycling,w=>{w?S.value||B():(F(),p.value=0)}),G(()=>a.cyclingSpeed,()=>{a.cycling&&!S.value&&(F(),B())}),G(k,()=>{p.value=0}),(w,V)=>{const e=Z,s=le,o=be("dompurify-html");return v(),b("div",{class:ae(["template-preview",[`preview-${w.displayMode}`,{"preview-cycling":w.cycling&&!S.value}]])},[w.showControls?(v(),b("div",nt,[r(e,{type:"link",onClick:V[0]||(V[0]=n=>w.$emit("back-to-select")),class:"back-to-select"},{default:$(()=>[r(x(me)),V[1]||(V[1]=L(" Back to Select Template "))]),_:1,__:[1]}),t("h3",ot,_(a.template.name),1),r(e,{onClick:M,size:"small",type:S.value?"default":"primary",disabled:!w.cycling||k.value<=1},{default:$(()=>[L(_(S.value?"Start":"Pause")+" Variable Selection ",1)]),_:1},8,["type","disabled"]),w.cycling&&k.value>1?(v(),b("span",it,_(p.value+1)+" / "+_(k.value),1)):O("",!0),r(s,{color:a.template.type==="template"?"blue":"green",class:"source-badge"},{default:$(()=>[L(_(a.template.type==="template"?"Prompt Design":"Spreadsheet Design"),1)]),_:1},8,["color"])])):O("",!0),Ce(t("div",{class:"preview-content",style:he(A.value)},null,4),[[o,R.value,"template"]]),w.showLegend&&P.value&&Object.keys(P.value).length>0?(v(),b("div",lt,[(v(!0),b(Q,null,X(P.value,(n,g,l)=>(v(),b("div",{key:g,class:"legend-item"},[t("span",{class:ae(u(l))},_(g),3),t("span",rt,_(n),1)]))),128))])):O("",!0)],2)}}}),se=Y(dt,[["__scopeId","data-v-499c064e"]]),ut={class:"design-selection"},pt={class:"design-selector","data-testid":"template-design-selector"},ct={key:0,class:"no-designs-state"},mt={class:"no-designs-content"},vt={key:1,class:"no-designs-state"},ft={class:"no-designs-content"},gt={key:2,class:"design-list","data-testid":"design-list"},_t=["data-template-id","data-template-name","onClick"],yt={class:"design-header"},Ct={class:"design-title-section"},bt={class:"design-name"},ht={key:0,class:"design-inline-description"},kt={class:"design-date"},$t={class:"design-stats"},Tt={class:"stat-item"},wt={class:"stat-value"},It={class:"stat-item"},St={class:"stat-value"},Pt={class:"stat-item"},xt={class:"stat-value"},Dt={class:"design-selector","data-testid":"spreadsheet-design-selector"},Et={key:0,class:"no-designs-state"},Mt={class:"no-designs-content"},Lt={key:1,class:"design-list","data-testid":"design-list"},At=["data-spreadsheet-id","data-spreadsheet-name","onClick"],Nt={class:"design-header"},Ot={class:"design-title-section"},Vt={class:"design-name"},zt={key:0,class:"design-inline-description"},Rt={class:"design-date"},jt={class:"design-stats"},Bt={class:"stat-item"},Ft={class:"stat-value"},Ut={class:"stat-item"},Jt={class:"stat-value"},Wt={class:"stat-item"},qt={class:"stat-value"},Kt=H({__name:"TrialDesignSelectionV3",props:{templates:{},spreadsheets:{},variableLists:{}},emits:["select","create-template","create-spreadsheet"],setup(U){const D=xe(),a=U,I=z("template"),p=z(""),S=z(""),C=N(()=>{if(!p.value)return a.templates;const u=p.value.toLowerCase();return a.templates.filter(i=>i.name.toLowerCase().includes(u)||(i.description||"").toLowerCase().includes(u))}),c=N(()=>{if(!S.value)return a.spreadsheets;const u=S.value.toLowerCase();return a.spreadsheets.filter(i=>i.name.toLowerCase().includes(u)||(i.description||"").toLowerCase().includes(u))});function m(u){const i=typeof u=="string"?new Date(u):u,M=new Date().getTime()-i.getTime(),B=Math.floor(M/(1e3*60*60*24));if(B===0){const F=Math.floor(M/36e5);if(F===0){const w=Math.floor(M/6e4);return w<=1?"just now":`${w} min ago`}return F===1?"1 hour ago":`${F} hours ago`}else return B===1?"yesterday":B<7?`${B} days ago`:i.toLocaleDateString("en-US",{month:"short",day:"numeric"})}function y(u){return u.variables?Object.keys(u.variables).length:0}function k(u){if(!u.variables)return 1;let i=1;for(const[,E]of Object.entries(u.variables))if(E.type==="value"&&E.values)i*=E.values.length;else if(E.type==="list"&&E.listId){const M=a.variableLists.find(B=>B.id===E.listId);M&&(M.category==="simple"?i*=M.values?.length||0:M.category==="attributed"?i*=M.items?.length||0:M.category==="tabular"&&(i*=M.itemCount||0))}return i}function P(u){return a.variableLists.find(E=>E.id===u.datasetId)?.itemCount||0}function R(u){const i=a.variableLists.find(E=>E.id===u.datasetId);return i?.category==="tabular"&&i.tabularData?.columns?i.tabularData.columns.length:0}function A(u){if(!u)return"???";try{if("template"in u&&u.template)return`~${D.estimateTokens(u.template)}`;if("promptPattern"in u&&u.promptPattern)return`~${D.estimateTokens(u.promptPattern)}`}catch(i){J.warn("Failed to estimate tokens:",i)}return"???"}return(u,i)=>{const E=ve,M=Oe,B=Z,F=le,w=Ne,V=Ae;return v(),b("div",ut,[r(V,{activeKey:I.value,"onUpdate:activeKey":i[6]||(i[6]=e=>I.value=e),size:"large"},{default:$(()=>[r(w,{key:"template",tab:"Prompt Designs (one API call per combination)"},{default:$(()=>[t("div",pt,[r(E,{value:p.value,"onUpdate:value":i[0]||(i[0]=e=>p.value=e),placeholder:"Search prompt designs...",size:"large",class:"design-search","data-testid":"input-template-search",allowClear:""},{prefix:$(()=>[r(x(pe))]),_:1},8,["value"]),!u.templates||u.templates.length===0?(v(),b("div",ct,[t("div",mt,[r(M,{size:"large",tip:"Loading templates..."})])])):C.value.length===0?(v(),b("div",vt,[t("div",ft,[i[8]||(i[8]=t("p",null,"No prompt designs found",-1)),r(B,{type:"primary",onClick:i[1]||(i[1]=e=>u.$emit("create-template"))},{default:$(()=>[r(x(Ve)),i[7]||(i[7]=L(" Create Prompt Design "))]),_:1,__:[7]})])])):(v(),b("div",gt,[(v(!0),b(Q,null,X(C.value,e=>(v(),b("div",{key:e.id,class:"design-item","data-testid":"template-item","data-template-id":e.id,"data-template-name":e.name,onClick:s=>u.$emit("select",e)},[t("div",yt,[t("div",Ct,[t("h4",bt,[L(_(e.name)+" ",1),e.description?(v(),b("span",ht,"- "+_(e.description),1)):O("",!0)])]),t("span",kt,_(m(e.updated)),1)]),r(se,{template:e,"variable-lists":u.variableLists,cycling:!0,"show-controls":!1,"display-mode":"inline","max-lines":5,class:"design-preview"},null,8,["template","variable-lists"]),t("div",$t,[r(F,{size:"small",color:"blue",class:"output-type-tag"},{default:$(()=>[L(_(e.outputType||"text"),1)]),_:2},1024),t("span",Tt,[t("span",wt,_(y(e)),1),i[9]||(i[9]=t("span",{class:"stat-label"},"vars",-1))]),i[12]||(i[12]=t("span",{class:"stat-divider"},"•",-1)),t("span",It,[t("span",St,_(k(e)),1),i[10]||(i[10]=t("span",{class:"stat-label"},"combos",-1))]),i[13]||(i[13]=t("span",{class:"stat-divider"},"•",-1)),t("span",Pt,[t("span",xt,_(A(e)),1),i[11]||(i[11]=t("span",{class:"stat-label"},"tokens",-1))])])],8,_t))),128)),t("div",{class:"design-item design-item-create","data-testid":"btn-create-design",onClick:i[2]||(i[2]=e=>u.$emit("create-template"))},[r(x(ee),{style:{"font-size":"24px"}}),i[14]||(i[14]=t("span",null,"Create New Design",-1))])]))])]),_:1}),r(w,{key:"spreadsheet",tab:"Spreadsheet Designs (one API call per row)"},{default:$(()=>[t("div",Dt,[r(E,{value:S.value,"onUpdate:value":i[3]||(i[3]=e=>S.value=e),placeholder:"Search spreadsheet designs...",size:"large",class:"design-search","data-testid":"input-spreadsheet-search",allowClear:""},{prefix:$(()=>[r(x(pe))]),_:1},8,["value"]),c.value.length===0?(v(),b("div",Et,[t("div",Mt,[i[16]||(i[16]=t("p",null,"No spreadsheet designs found",-1)),r(B,{type:"primary",onClick:i[4]||(i[4]=e=>u.$emit("create-spreadsheet"))},{default:$(()=>[r(x(ze)),i[15]||(i[15]=L(" Create Spreadsheet Design "))]),_:1,__:[15]})])])):(v(),b("div",Lt,[(v(!0),b(Q,null,X(c.value,e=>(v(),b("div",{key:e.id,class:"design-item","data-testid":"spreadsheet-item","data-spreadsheet-id":e.id,"data-spreadsheet-name":e.name,onClick:s=>u.$emit("select",e)},[t("div",Nt,[t("div",Ot,[t("h4",Vt,[L(_(e.name)+" ",1),e.description?(v(),b("span",zt,"- "+_(e.description),1)):O("",!0)])]),t("span",Rt,_(m(e.updated)),1)]),r(se,{template:e,"variable-lists":u.variableLists,cycling:!0,"show-controls":!1,"display-mode":"inline","max-lines":5,class:"design-preview"},null,8,["template","variable-lists"]),t("div",jt,[r(F,{size:"small",color:"green",class:"output-type-tag"},{default:$(()=>[L(_(e.outputType||"text"),1)]),_:2},1024),t("span",Bt,[t("span",Ft,_(P(e)),1),i[17]||(i[17]=t("span",{class:"stat-label"},"rows",-1))]),i[20]||(i[20]=t("span",{class:"stat-divider"},"•",-1)),t("span",Ut,[t("span",Jt,_(R(e)),1),i[18]||(i[18]=t("span",{class:"stat-label"},"cols",-1))]),i[21]||(i[21]=t("span",{class:"stat-divider"},"•",-1)),t("span",Wt,[t("span",qt,_(A(e)),1),i[19]||(i[19]=t("span",{class:"stat-label"},"tokens",-1))])])],8,At))),128)),t("div",{class:"design-item design-item-create","data-testid":"btn-create-spreadsheet",onClick:i[5]||(i[5]=e=>u.$emit("create-spreadsheet"))},[r(x(ee),{style:{"font-size":"24px"}}),i[22]||(i[22]=t("span",null,"Create New Spreadsheet Design",-1))])]))])]),_:1})]),_:1},8,["activeKey"])])}}}),Gt=Y(Kt,[["__scopeId","data-v-db101528"]]),Ht={class:"trial-metadata-form"},Yt=H({__name:"TrialMetadataV3",props:{name:{},repeatCount:{default:1},description:{default:""},totalCombinations:{default:0}},emits:["update:name","update:repeatCount","update:description"],setup(U,{emit:D}){const a=U,I=D,p=ke({name:a.name,repeatCount:a.repeatCount,description:a.description||""}),S=N(()=>{if(a.totalCombinations>0&&p.repeatCount>1){const c=a.totalCombinations*p.repeatCount;return`Each prompt will be run ${p.repeatCount} times (${c} total calls)`}return"Number of times to run each prompt"});function C(){I("update:name",p.name),I("update:repeatCount",p.repeatCount),I("update:description",p.description)}return G(()=>a.name,c=>{p.name=c}),G(()=>a.repeatCount,c=>{p.repeatCount=c}),G(()=>a.description,c=>{p.description=c||""}),(c,m)=>{const y=ve,k=Fe,P=Be,R=Ue,A=je,u=Je,i=Re;return v(),b("div",Ht,[r(i,{layout:"vertical",model:p},{default:$(()=>[r(A,{gutter:24},{default:$(()=>[r(P,{span:18},{default:$(()=>[r(k,{label:"Trial Name",rules:[{required:!0,message:"Please enter a trial name"}]},{default:$(()=>[r(y,{value:p.name,"onUpdate:value":m[0]||(m[0]=E=>p.name=E),size:"large",placeholder:"e.g., GPT-4 Performance Test",onChange:C},null,8,["value"])]),_:1})]),_:1}),r(P,{span:6},{default:$(()=>[r(k,{label:"Repeat Count",help:S.value},{default:$(()=>[r(R,{value:p.repeatCount,"onUpdate:value":m[1]||(m[1]=E=>p.repeatCount=E),min:1,max:100,size:"large",style:{width:"100%"},onChange:C},null,8,["value"])]),_:1},8,["help"])]),_:1})]),_:1}),r(k,{label:"Description (Optional)"},{default:$(()=>[r(u,{value:p.description,"onUpdate:value":m[2]||(m[2]=E=>p.description=E),placeholder:"Add any notes about this trial...",rows:2,onChange:C},null,8,["value"])]),_:1})]),_:1},8,["model"])])}}}),Zt=Y(Yt,[["__scopeId","data-v-b945eb57"]]),Qt={class:"model-configuration"},Xt={key:0,class:"quick-add-section"},ea={class:"quick-add-models"},ta={class:"provider-name"},aa={class:"model-name"},sa={key:0,class:"param-info"},na={class:"configuration-table"},oa={class:"table-header"},ia={style:{display:"inline-flex","align-items":"center",gap:"0"}},la={key:0,class:"model-name-cell"},ra={class:"model-name"},da={class:"model-id"},ua={key:1,class:"parameter-tags"},pa={key:2,class:"cost-cell"},ca={class:"cost-value"},ma={key:0,class:"cost-summary"},va={class:"cost-summary-item"},fa={class:"cost-summary-item"},ga={class:"total-cost"},_a=H({__name:"ModelConfigurationV3",props:{configurations:{},totalCombinations:{},repeatCount:{},tokenData:{}},emits:["add-configuration","remove-configuration"],setup(U,{emit:D}){const a=U,I=D,{models:p}=oe(),{trials:S}=ie(),{estimateTotalCost:C,multiplyEstimate:c}=re(),m=z(!1),y=N(()=>{const e=new Map;if(S.value&&S.value.length>0){const l=S.value.filter(f=>f.status!=="draft").slice(0,10);for(const f of l)if(f.configurations){for(const h of f.configurations){const d=JSON.stringify(h.parameters||{}),T=`${h.provider}-${h.modelId}-${d}`;if(e.has(T)||e.set(T,h),e.size>=15)break}if(e.size>=15)break}}const s=new Set(a.configurations.map(l=>{const f=JSON.stringify(l.parameters||{});return`${l.provider}-${l.modelId}-${f}`})),o=Array.from(e.values()).filter(l=>{const f=JSON.stringify(l.parameters||{}),h=`${l.provider}-${l.modelId}-${f}`;if(s.has(h))return!1;const d=p.value?.find(T=>T.provider===l.provider&&T.modelId===l.modelId);return!(!d||!d.enabled)}),n=[{provider:"openai-chat",modelId:"gpt-4o-mini",params:{temperature:0,max_completion_tokens:1e3}},{provider:"openai-chat",modelId:"gpt-4.1-nano",params:{temperature:0,max_completion_tokens:500}},{provider:"anthropic",modelId:"claude-3-5-haiku-latest",params:{temperature:0,max_tokens:1e3}},{provider:"openrouter",modelId:"meta-llama/llama-4-maverick",params:{temperature:.8,max_tokens:2e3}},{provider:"openrouter",modelId:"mistralai/mistral-nemo",params:{temperature:.7,max_tokens:1500}},{provider:"ollama-generate",modelId:"qwen2.5:0.5b",params:{temperature:0,num_predict:500,stream:!1}},{provider:"ollama-generate",modelId:"llama3.2:1b",params:{temperature:0,num_predict:1e3,stream:!1}}],g=[];for(const l of n){const f=JSON.stringify(l.params),h=`${l.provider}-${l.modelId}-${f}`;if(!s.has(h)&&!e.has(h)){const d=p.value?.find(T=>T.provider===l.provider&&T.modelId===l.modelId);d&&d.enabled&&g.push({provider:l.provider,modelId:l.modelId,parameters:l.params,providerSnapshot:{},modelSnapshot:d})}}return[...o,...g].slice(0,10)}),k=[{title:"Model",key:"name",width:"35%"},{title:"Parameters",key:"parameters",width:"35%"},{title:"Cost",key:"cost",width:"20%"},{title:"",key:"actions",width:"10%"}],P=N(()=>a.configurations.map((e,s)=>({key:`${e.provider}-${e.modelId}-${s}`,...e}))),R=N(()=>a.totalCombinations*a.configurations.length*a.repeatCount),A=N(()=>a.tokenData?a.configurations.reduce((e,s)=>{const o=p.value?.find(l=>l.provider===s.provider&&l.modelId===s.modelId);if(!o)return e;const n=C(a.tokenData.totalTokens,a.tokenData.combinationCount,o,s.parameters),g=a.repeatCount>1?c(n,a.repeatCount):n;return e+g.cost.total.expected},0):0);function u(e){if(!a.tokenData)return"?? (no token data)";const s=p.value?.find(h=>h.provider===e.provider&&h.modelId===e.modelId);if(!s)return"?? (model not found)";const o=C(a.tokenData.totalTokens,a.tokenData.combinationCount,s,e.parameters);if(!o.meta.hasValidCost||o.cost.total.expected===-1)return"?? (no pricing data)";const n=a.repeatCount>1?c(o,a.repeatCount):o,g=n.cost.total.min,l=n.cost.total.max,f=n.cost.total.expected;return Math.abs(l-g)<1e-4?`$${i(f)}`:`$${i(g)}-$${i(l)}`}function i(e){if(e===0)return"0.00";if(e<.01){let s=2,o=e;for(;o<.1;)o*=10,s++;return e.toFixed(s)}return e<1?e.toFixed(3):e<10?e.toFixed(2):e<100?e.toFixed(1):Math.round(e).toLocaleString()}function E(e){const s={},o=["temperature","max_tokens","max_completion_tokens","num_predict","maxTokens","top_p","top_k","reasoning_effort"];for(const n of o)e[n]!==void 0&&e[n]!==null&&(s[n]=e[n]);for(const[n,g]of Object.entries(e))g!=null&&!o.includes(n)&&(s[n]=g);return s}function M(e){return e.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase())}function B(e){if(!e||Object.keys(e).length===0)return"";const s=[];return e.temperature!==void 0&&s.push(`T:${e.temperature}`),e.max_tokens!==void 0?s.push(`${e.max_tokens}t`):e.maxTokens!==void 0?s.push(`${e.maxTokens}t`):e.num_predict!==void 0&&s.push(`${e.num_predict}t`),e.top_p!==void 0&&s.push(`p:${e.top_p}`),s.length>0?`(${s.join(", ")})`:""}function F(e){const s=De.validateParameters(e.provider,e.modelId,e.parameters||{});if(!s.valid){J.error("Quick Add validation failed:",{provider:e.provider,modelId:e.modelId,parameters:e.parameters,errors:s.errors}),alert(`Cannot add model configuration: ${s.errors?.join(", ")||"Invalid parameters"}`);return}const o={name:e.modelSnapshot?.displayName||e.modelId,provider:e.provider,modelId:e.modelId,parameters:{...e.parameters}};I("add-configuration",o)}function w(e){I("add-configuration",e),m.value=!1}function V(e){I("remove-configuration",e)}return(e,s)=>{const o=Z,n=We,g=le,l=qe;return v(),b("div",Qt,[y.value.length>0?(v(),b("div",Xt,[s[2]||(s[2]=t("h4",null,"Quick Add Recent Models",-1)),t("div",ea,[(v(!0),b(Q,null,X(y.value,f=>(v(),K(o,{key:`${f.provider}-${f.modelId}-${JSON.stringify(f.parameters)}`,size:"small",onClick:h=>F(f),class:"quick-add-button",title:`Add ${f.modelSnapshot?.displayName||f.modelId} (${f.provider}) with recent parameters`},{default:$(()=>[r(x(ee)),t("span",ta,_(f.provider)+"/",1),t("span",aa,_(f.modelSnapshot?.displayName||f.modelId),1),B(f.parameters)?(v(),b("span",sa,_(B(f.parameters)),1)):O("",!0)]),_:2},1032,["onClick","title"]))),128))])])):O("",!0),t("div",na,[t("div",oa,[t("h3",ia,[r(n,{placement:"topLeft"},{title:$(()=>s[3]||(s[3]=[L(" Add models to test with your template and configure their parameters like temperature, max tokens, etc. ")])),default:$(()=>[s[4]||(s[4]=t("span",null,"Model Configurations to Test",-1))]),_:1,__:[4]}),s[6]||(s[6]=t("span",null,"  ",-1)),r(o,{type:"primary",size:"small",onClick:s[0]||(s[0]=f=>m.value=!0)},{default:$(()=>[r(x(ee)),s[5]||(s[5]=L(" Add Model "))]),_:1,__:[5]})])]),r(l,{columns:k,"data-source":P.value,pagination:!1,locale:{emptyText:"No models configured. Add at least one model to proceed."},"row-key":"key"},{bodyCell:$(({column:f,record:h,index:d})=>[f.key==="name"?(v(),b("div",la,[t("span",ra,_(h.name),1),t("span",da,_(h.provider)+":"+_(h.modelId),1)])):f.key==="parameters"?(v(),b("div",ua,[(v(!0),b(Q,null,X(E(h.parameters),(T,j)=>(v(),K(g,{key:j},{default:$(()=>[L(_(M(j))+": "+_(T),1)]),_:2},1024))),128))])):f.key==="cost"?(v(),b("div",pa,[t("span",ca,_(u(h)),1),s[7]||(s[7]=t("span",{class:"cost-label"},"total trial cost",-1))])):f.key==="actions"?(v(),K(o,{key:3,type:"text",danger:"",size:"small",onClick:T=>V(d)},{default:$(()=>[r(x(Ke))]),_:2},1032,["onClick"])):O("",!0)]),_:1},8,["data-source"]),e.configurations.length>0?(v(),b("div",ma,[t("div",va,[s[8]||(s[8]=t("span",null,"Total experiments:",-1)),t("strong",null,_(R.value),1)]),t("div",fa,[s[9]||(s[9]=t("span",null,"Estimated total cost:",-1)),t("strong",ga,"$"+_(i(A.value)),1)])])):O("",!0)]),r(at,{visible:m.value,"onUpdate:visible":s[1]||(s[1]=f=>m.value=f),mode:"trial","trial-context":{totalCombinations:e.totalCombinations,tokenData:e.tokenData??null},"existing-configurations":e.configurations,onAddConfiguration:w},null,8,["visible","trial-context","existing-configurations"])])}}}),ya=Y(_a,[["__scopeId","data-v-1d4ece19"]]),Ca={class:"trial-configuration"},ba={class:"configuration-sections"},ha={class:"config-section"},ka={class:"config-section"},$a=["aria-expanded"],Ta={class:"section-title"},wa={class:"expand-hint"},Ia={key:0,class:"design-info"},Sa={class:"design-stats"},Pa={class:"stat"},xa={class:"stat-value"},Da={class:"stat"},Ea={class:"stat-value"},Ma={class:"config-section"},La=H({__name:"TrialConfiguration",setup(U){const D=$e("trialCreation"),{calculateTemplateTokens:a,calculatePromptTokens:I}=re(),p=z(!1),S=z(!1),C=N(()=>D.selectedPrompt.value),c=N(()=>{const m=C.value;if(!m)return null;try{if(m.type==="template"){const y=m.template,k=m.variables,P=D.variableLists?.value;return y?a(y,k||{},P||[]):null}else if(m.type==="spreadsheet"){const y=m.promptPattern;if(!y)return null;const k=I(y),P=D.totalCombinations.value;return{totalTokens:k*P,combinationCount:P,perCallAverage:k}}else return null}catch(y){return J.error("Error calculating tokenData:",y),null}});return(m,y)=>(v(),b("div",Ca,[t("div",ba,[t("section",ha,[y[6]||(y[6]=t("h2",{class:"section-title"},"Trial Details",-1)),r(Zt,{name:x(D).trialName.value,"repeat-count":x(D).repeatCount.value,description:x(D).description?.value||"","total-combinations":x(D).totalCombinations.value,"onUpdate:name":y[0]||(y[0]=k=>x(D).trialName.value=k),"onUpdate:repeatCount":y[1]||(y[1]=k=>x(D).repeatCount.value=k),"onUpdate:description":y[2]||(y[2]=k=>x(D).description.value=k)},null,8,["name","repeat-count","description","total-combinations"])]),t("section",ka,[t("button",{class:"collapsible-header",onClick:y[3]||(y[3]=k=>p.value=!p.value),"aria-expanded":p.value},[r(x(Ge),{class:ae([{expanded:p.value},"expand-icon"])},null,8,["class"]),t("h2",Ta,[y[7]||(y[7]=L("Selected Design Preview ")),t("span",wa,"(click to "+_(p.value?"collapse":"expand")+")",1)])],8,$a),p.value?(v(),b("div",Ia,[r(se,{template:C.value,"variable-lists":x(D).variableLists.value,cycling:S.value,"show-controls":!0,"display-mode":"block","show-legend":!0,"onUpdate:paused":y[4]||(y[4]=k=>S.value=!k),onBackToSelect:y[5]||(y[5]=k=>m.$emit("back"))},null,8,["template","variable-lists","cycling"]),t("div",Sa,[t("div",Pa,[y[8]||(y[8]=t("span",{class:"stat-label"},"Total Combinations:",-1)),t("span",xa,_(x(D).totalCombinations.value),1)]),t("div",Da,[y[9]||(y[9]=t("span",{class:"stat-label"},"Total Input Tokens:",-1)),t("span",Ea,_(c.value!==null?`${c.value.totalTokens.toLocaleString()} total (${c.value.combinationCount.toLocaleString()} calls)`:"??"),1)])])])):O("",!0)]),t("section",Ma,[y[10]||(y[10]=t("h2",{class:"section-title"},"Add Models and Set Parameters",-1)),r(ya,{configurations:x(D).configurations.value,"total-combinations":x(D).totalCombinations.value,"repeat-count":x(D).repeatCount.value,"token-data":c.value,onAddConfiguration:x(D).addConfiguration,onRemoveConfiguration:x(D).removeConfiguration},null,8,["configurations","total-combinations","repeat-count","token-data","onAddConfiguration","onRemoveConfiguration"])])])]))}}),Aa=Y(La,[["__scopeId","data-v-794621cc"]]),Na={class:"trial-submission"},Oa={class:"review-section"},Va={class:"summary-card"},za={class:"summary-item"},Ra={class:"value"},ja={class:"summary-item"},Ba={class:"value"},Fa={class:"summary-item"},Ua={class:"value"},Ja={key:0,class:"summary-item"},Wa={class:"value"},qa={key:1,class:"summary-item"},Ka={class:"value"},Ga={class:"summary-item"},Ha={class:"value"},Ya={key:2,class:"summary-item"},Za={class:"value"},Qa={class:"summary-item"},Xa={class:"value highlight"},es={key:3,class:"summary-item"},ts={key:0,class:"value highlight"},as={key:1,class:"value"},ss={class:"configurations-review"},ns={class:"config-header"},os={class:"config-name"},is={class:"config-model"},ls={class:"config-params"},rs={key:0,class:"running-trials-warning"},ds={class:"action-buttons"},us={key:0},ps={key:1},cs={key:2},ms=H({__name:"TrialSubmission",props:{trialConfig:{},design:{}},emits:["back","create-draft","create-and-start","export-python"],setup(U,{emit:D}){const a=U,I=D,{runningTrials:p}=ie(),{variableLists:S}=ce(),{models:C}=oe(),{calculateTemplateTokens:c,calculatePromptTokens:m,estimateTotalCost:y,sumEstimates:k}=re(),P=z(null),R=z(!1),A=z(!1),u=N(()=>p.value.length>0),i=N(()=>p.value.length),E=N(()=>{if(!a.trialConfig.configurations)return 0;let o=1;if(a.design.type==="template"&&a.design.variables)for(const[,g]of Object.entries(a.design.variables)){const l=g;if(l.type==="value"&&l.values)o*=l.values.length;else if(l.type==="list"&&l.listId){const f=S.value?.find(h=>h.id===l.listId);f&&(f.category==="simple"?o*=f.values?.length||0:f.category==="attributed"?o*=f.items?.length||0:f.category==="tabular"&&(o*=f.itemCount||0))}}else a.design.type==="spreadsheet"&&(o=S.value?.find(l=>l.id===a.design.datasetId)?.itemCount||0);const n=a.trialConfig.repeatCount||1;return o*a.trialConfig.configurations.length*n}),M=N(()=>{if(!a.trialConfig.configurations||a.trialConfig.configurations.length===0)return-1;let o=null;if(a.design.type==="template"){const l=a.trialConfig.templateConfig?.template||a.design.template||"",f=a.trialConfig.templateConfig?.variables||a.design.variables||{};o=c(l,f,S.value)}else if(a.design.type==="spreadsheet"){const l=a.trialConfig.spreadsheetConfig?.promptPattern||a.design.promptPattern||"",f=m(l),h=E.value/a.trialConfig.configurations.length;o={totalTokens:f*h,combinationCount:h,perCallAverage:f}}if(!o||o.totalTokens===0)return J.error("TrialSubmission: No prompt content found for cost estimation",{type:a.design.type,hasTemplate:!!a.trialConfig.templateConfig?.template||!!a.design.template,hasPromptPattern:!!a.trialConfig.spreadsheetConfig?.promptPattern||!!a.design.promptPattern}),-1;const n=a.trialConfig.configurations.map(l=>{const f=C.value?.find(h=>h.provider===l.provider&&h.modelId===l.modelId);return f?y(o.totalTokens,o.combinationCount,f,l.parameters):null}).filter(Boolean);return n.length===0?-1:k(n).cost.total.expected});function B(o){const n=[];"temperature"in o&&n.push(`temperature=${o.temperature}`),"max_tokens"in o&&n.push(`max_tokens=${o.max_tokens}`),"top_p"in o&&n.push(`top_p=${o.top_p}`);const g=Object.keys(o).length-n.length;return g>0&&n.push(`+${g} more`),n.join(", ")}function F(){return{name:a.trialConfig.name||"",description:a.trialConfig.description,type:a.design.type,configurations:a.trialConfig.configurations||[],repeatCount:a.trialConfig.repeatCount||1,templateConfig:a.trialConfig.templateConfig,spreadsheetConfig:a.trialConfig.spreadsheetConfig}}async function w(){P.value="draft";try{const o=F();I("create-draft",o)}finally{P.value=null}}async function V(){R.value=!0;try{const o=F();I("export-python",o)}finally{R.value=!1}}function e(){u.value||M.value>10&&M.value!==-1?A.value=!0:s()}async function s(){A.value=!1,P.value="start";try{const o=F();I("create-and-start",o)}finally{P.value=null}}return(o,n)=>{const g=Z,l=He,f=fe;return v(),b("div",Na,[r(g,{type:"link",onClick:n[0]||(n[0]=h=>o.$emit("back")),class:"back-button"},{default:$(()=>[r(x(Ye)),n[3]||(n[3]=L(" Back to Configuration "))]),_:1,__:[3]}),t("div",Oa,[n[15]||(n[15]=t("h2",null,"Review & Create Trial",-1)),t("div",Va,[n[13]||(n[13]=t("h3",null,"Trial Summary",-1)),t("div",za,[n[4]||(n[4]=t("span",{class:"label"},"Name:",-1)),t("span",Ra,_(o.trialConfig.name),1)]),t("div",ja,[n[5]||(n[5]=t("span",{class:"label"},"Type:",-1)),t("span",Ba,_(o.design.type==="template"?"Template":"Spreadsheet"),1)]),t("div",Fa,[n[6]||(n[6]=t("span",{class:"label"},"Design:",-1)),t("span",Ua,_(o.design.name),1)]),o.design.type==="template"?(v(),b("div",Ja,[n[7]||(n[7]=t("span",{class:"label"},"Variables:",-1)),t("span",Wa,_(Object.keys(o.design.variables||{}).length)+" variables configured ",1)])):O("",!0),o.design.type==="spreadsheet"?(v(),b("div",qa,[n[8]||(n[8]=t("span",{class:"label"},"Dataset:",-1)),t("span",Ka,_(o.design.rowCount)+" rows",1)])):O("",!0),t("div",Ga,[n[9]||(n[9]=t("span",{class:"label"},"Model Configurations:",-1)),t("span",Ha,_(o.trialConfig.configurations?.length||0)+" models",1)]),o.trialConfig.repeatCount&&o.trialConfig.repeatCount>1?(v(),b("div",Ya,[n[10]||(n[10]=t("span",{class:"label"},"Repeat Count:",-1)),t("span",Za,_(o.trialConfig.repeatCount)+" times per prompt",1)])):O("",!0),t("div",Qa,[n[11]||(n[11]=t("span",{class:"label"},"Total API Calls:",-1)),t("span",Xa,_(E.value),1)]),M.value!==-1?(v(),b("div",es,[n[12]||(n[12]=t("span",{class:"label"},"Estimated Cost:",-1)),M.value>0?(v(),b("span",ts,"$"+_(M.value.toFixed(4)),1)):(v(),b("span",as,"Unable to estimate (no prompt content)"))])):O("",!0)]),t("div",ss,[n[14]||(n[14]=t("h3",null,"Model Configurations",-1)),(v(!0),b(Q,null,X(o.trialConfig.configurations,(h,d)=>(v(),b("div",{key:`review-config-${d}`,class:"config-review-item"},[t("div",ns,[t("span",os,_(h.name||h.modelId),1),t("span",is,_(h.provider)+":"+_(h.modelId),1)]),t("div",ls,_(B(h.parameters)),1)]))),128))]),u.value?(v(),b("div",rs,[r(l,{message:"Running Trials Detected",description:`You have ${i.value} trial(s) currently running. Starting a new trial may affect performance.`,type:"warning","show-icon":""},null,8,["description"])])):O("",!0)]),t("div",ds,[r(g,{size:"large",onClick:w,loading:P.value==="draft"},{default:$(()=>[r(x(ge)),n[16]||(n[16]=L(" Create as Draft "))]),_:1,__:[16]},8,["loading"]),r(g,{size:"large",onClick:V,loading:R.value},{default:$(()=>[r(x(Ze)),n[17]||(n[17]=L(" Export to Python "))]),_:1,__:[17]},8,["loading"]),r(g,{type:"primary",size:"large",onClick:e,loading:P.value==="start"},{default:$(()=>[r(x(Qe)),n[18]||(n[18]=L(" Create and Start "))]),_:1,__:[18]},8,["loading"])]),r(f,{visible:A.value,"onUpdate:visible":n[1]||(n[1]=h=>A.value=h),title:"Confirm Trial Creation",onOk:s,onCancel:n[2]||(n[2]=h=>A.value=!1)},{default:$(()=>[n[19]||(n[19]=t("p",null,"You are about to create and start a trial with:",-1)),t("ul",null,[t("li",null,_(E.value)+" API calls",1),M.value>0?(v(),b("li",us,"Estimated cost: $"+_(M.value.toFixed(4)),1)):M.value===-1?(v(),b("li",ps,"Cost estimation unavailable")):O("",!0),u.value?(v(),b("li",cs,_(i.value)+" other trial(s) running",1)):O("",!0)]),n[20]||(n[20]=t("p",null,"Do you want to proceed?",-1))]),_:1,__:[19,20]},8,["visible"])])}}}),vs=Y(ms,[["__scopeId","data-v-b8e71998"]]),fs={class:"conflict-content"},gs={class:"warning-section"},_s={class:"warning-text"},ys={class:"trial-info"},Cs={class:"summary-grid"},bs={class:"summary-item"},hs={class:"value"},ks={class:"summary-item"},$s={class:"value"},Ts={key:0,class:"summary-item"},ws={class:"value"},Is={class:"modal-footer"},Ss=H({__name:"TrialConflictModal",props:{visible:{type:Boolean},runningTrial:{},trialConfig:{},totalApiCalls:{},estimatedCost:{}},emits:["update:visible","cancel","create-draft"],setup(U,{emit:D}){const a=U,I=D,p=z(!1);function S(){I("update:visible",!1),I("cancel")}async function C(){if(a.trialConfig){p.value=!0;try{I("create-draft",a.trialConfig),I("update:visible",!1)}finally{p.value=!1}}}return(c,m)=>{const y=Z,k=fe;return v(),K(k,{visible:c.visible,title:"Running Trial Detected",closable:!1,"mask-closable":!1,width:"600px",onCancel:S},{footer:$(()=>[t("div",Is,[r(y,{onClick:S,disabled:p.value},{default:$(()=>m[8]||(m[8]=[L(" Cancel ")])),_:1,__:[8]},8,["disabled"]),r(y,{type:"primary",onClick:C,loading:p.value},{default:$(()=>[r(x(ge)),m[9]||(m[9]=L(" Create Draft "))]),_:1,__:[9]},8,["loading"])])]),default:$(()=>[t("div",fs,[t("div",gs,[r(x(Xe),{class:"warning-icon"}),t("div",_s,[m[2]||(m[2]=t("h3",null,"Another trial is currently running",-1)),t("p",null,[m[0]||(m[0]=L(' The trial "')),t("strong",null,_(c.runningTrial?.name),1),m[1]||(m[1]=L('" is currently executing. You can only run one trial at a time. '))])])]),m[7]||(m[7]=t("div",{class:"message-section"},[t("p",null,"You can only run one trial at a time. Your new trial will be saved as a draft and you can start it manually after the current trial finishes, or you can pause or cancel the running trial, then start your new draft trial.")],-1)),t("div",ys,[m[6]||(m[6]=t("h4",null,"New Trial Summary:",-1)),t("div",Cs,[t("div",bs,[m[3]||(m[3]=t("span",{class:"label"},"Name:",-1)),t("span",hs,_(c.trialConfig?.name),1)]),t("div",ks,[m[4]||(m[4]=t("span",{class:"label"},"API Calls:",-1)),t("span",$s,_(c.totalApiCalls),1)]),c.estimatedCost>0?(v(),b("div",Ts,[m[5]||(m[5]=t("span",{class:"label"},"Estimated Cost:",-1)),t("span",ws,"$"+_(c.estimatedCost.toFixed(4)),1)])):O("",!0)])])])]),_:1},8,["visible"])}}}),Ps=Y(Ss,[["__scopeId","data-v-6c2d242e"]]),xs={class:"trial-creation-content"},Ds={class:"step-content"},Es={key:1,class:"modal-footer"},Ms={key:2,class:"create-actions"},Ls={key:2,class:"view-footer"},As={key:0,class:"validation-errors"},Ns={class:"create-actions"},Os=H({__name:"TrialCreationContent",props:{mode:{},initialData:{}},emits:["cancel","create-template","create-spreadsheet","created","created-and-started","export-python"],setup(U,{expose:D,emit:a}){const I=U,p=a,S=N(()=>({type:I.initialData?.type||"create",sourceTrialId:I.initialData?.sourceTrialId})),C=st(Te(S));we("trialCreation",C);const c=z(0),m=z(!1),y=z(null),k=z(null),P=z(null);D({currentStep:c});const R=N(()=>{if(I.mode==="view")return C.selectedPrompt.value!==null&&C.canProceed.value&&C.configurations.value.length>0;switch(c.value){case 0:return C.selectedPrompt.value!==null;case 1:return C.canProceed.value;default:return!0}}),A=N(()=>{const e=[];return C.selectedPrompt.value||e.push("Select a template or spreadsheet"),C.configurations.value.length===0&&e.push("Add at least one model configuration"),C.trialName.value.trim()===""&&e.push("Enter a trial name"),e.join(" • ")});function u(){const e=JSON.parse(JSON.stringify(C.selectedPrompt.value));return{name:C.trialName.value,description:C.description?.value||"",type:e.type,configurations:JSON.parse(JSON.stringify(C.configurations.value)),repeatCount:C.repeatCount.value,templateConfig:e.type==="template"?{template:e.template,variables:e.variables,parserId:e.parserId,outputType:e.outputType,extractPattern:e.extractPattern,refusalWords:e.refusalWords,rejectRefusalWords:e.rejectRefusalWords}:void 0,spreadsheetConfig:e.type==="spreadsheet"?{promptPattern:e.promptPattern,datasetId:e.datasetId}:void 0}}function i(e){C.selectPrompt(e),I.mode==="view"&&(c.value=1)}async function E(){try{const e=await C.createTrialAsDraft();e&&p("created",e)}catch(e){J.error("Failed to create draft trial:",e)}}async function M(){try{const e=await C.createAndStartTrial();e&&(e.needsConfirmation?(y.value=u(),k.value=e.trialId,P.value="runningTrial"in e?e.runningTrial:null,m.value=!0):p("created-and-started",e.trialId))}catch(e){J.error("Failed to create and start trial:",e)}}async function B(){p("export-python",u())}function F(){V()}async function w(){try{k.value&&p("created",k.value),V()}catch(e){J.error("Failed to handle draft creation:",e)}}function V(){m.value=!1,y.value=null,k.value=null,P.value=null}return ne(async()=>{if(await C.initialize(),I.initialData?.templateId&&I.initialData?.promptSource==="template"){const e=()=>{const s=C.templates.value.find(o=>o.id===I.initialData?.templateId);return s?(C.selectPrompt(s),c.value=1,!0):!1};if(!e()){const s=G(()=>C.templates.value,()=>{e()&&s()},{immediate:!0});setTimeout(()=>s(),3e3)}}}),G(c,()=>{I.mode==="view"&&window.scrollTo(0,0)}),(e,s)=>{const o=tt,n=et,g=Z;return v(),b("div",xs,[e.mode==="modal"?(v(),K(n,{key:0,current:c.value,class:"creation-steps"},{default:$(()=>[r(o,{title:"Select Design"}),r(o,{title:"Configure Trial"}),r(o,{title:"Review & Create"})]),_:1},8,["current"])):O("",!0),t("div",Ds,[c.value===0?(v(),K(Gt,{key:0,templates:x(C).templates.value,spreadsheets:x(C).spreadsheets.value,"variable-lists":x(C).variableLists.value,onSelect:i,onCreateTemplate:s[0]||(s[0]=l=>e.$emit("create-template")),onCreateSpreadsheet:s[1]||(s[1]=l=>e.$emit("create-spreadsheet"))},null,8,["templates","spreadsheets","variable-lists"])):c.value===1?(v(),K(Aa,{key:1,onBack:s[2]||(s[2]=l=>c.value--)})):c.value===2?(v(),K(vs,{key:2,"trial-config":u(),design:x(C).selectedPrompt.value,onBack:s[3]||(s[3]=l=>c.value--),onCreateDraft:E,onCreateAndStart:M,onExportPython:B},null,8,["trial-config","design"])):O("",!0)]),I.mode==="modal"?(v(),b("div",Es,[r(g,{onClick:s[4]||(s[4]=l=>e.$emit("cancel"))},{default:$(()=>s[8]||(s[8]=[L("Cancel")])),_:1,__:[8]}),c.value>0?(v(),K(g,{key:0,onClick:s[5]||(s[5]=l=>c.value--)},{default:$(()=>s[9]||(s[9]=[L(" Back ")])),_:1,__:[9]})):O("",!0),c.value<2?(v(),K(g,{key:1,type:"primary",disabled:!R.value,onClick:s[6]||(s[6]=l=>c.value++)},{default:$(()=>s[10]||(s[10]=[L(" Next ")])),_:1,__:[10]},8,["disabled"])):O("",!0),c.value===2?(v(),b("div",Ms,[r(g,{type:"primary",disabled:!R.value,onClick:E},{default:$(()=>s[11]||(s[11]=[L(" Create Draft ")])),_:1,__:[11]},8,["disabled"]),r(g,{type:"primary",disabled:!R.value,onClick:M},{default:$(()=>s[12]||(s[12]=[L(" Create & Start ")])),_:1,__:[12]},8,["disabled"])])):O("",!0)])):O("",!0),I.mode==="view"?(v(),b("div",Ls,[R.value?O("",!0):(v(),b("div",As,_(A.value),1)),t("div",Ns,[r(g,{size:"large",disabled:!R.value,onClick:B},{default:$(()=>s[13]||(s[13]=[L(" Export Python ")])),_:1,__:[13]},8,["disabled"]),r(g,{type:"primary",size:"large",disabled:!R.value,onClick:E},{default:$(()=>s[14]||(s[14]=[L(" Create Draft ")])),_:1,__:[14]},8,["disabled"]),r(g,{type:"primary",size:"large",disabled:!R.value,onClick:M},{default:$(()=>s[15]||(s[15]=[L(" Create & Start ")])),_:1,__:[15]},8,["disabled"])])])):O("",!0),r(Ps,{visible:m.value,"onUpdate:visible":s[7]||(s[7]=l=>m.value=l),"running-trial":P.value,"trial-config":y.value,"total-api-calls":x(C).totalExperiments.value,"estimated-cost":x(C).totalCost.value,onCancel:F,onCreateDraft:w},null,8,["visible","running-trial","trial-config","total-api-calls","estimated-cost"])])}}}),Vs=Y(Os,[["__scopeId","data-v-eb2d9f4b"]]),zs={class:"trial-creation-view"},Rs={class:"creation-header"},js={class:"header-title"},Bs={class:"creation-content"},Fs=H({__name:"TrialCreationV3",setup(U){const D=Ie(),a=Se(),I=z(),p=z(null);async function S(){const A=D.query;if(A.duplicate){const u=A.duplicate;I.value={type:"duplicate",sourceTrialId:u}}else A.designId&&A.promptSource==="template"&&(I.value={type:"create",templateId:A.designId,promptSource:"template"})}function C(){a.push("/trials")}function c(){p.value&&(p.value.currentStep=0)}async function m(A){te.success("Trial created as draft"),a.push({path:"/trials",query:{trialId:A,tab:"details"}})}async function y(A){te.success("Trial created and started"),a.push({path:"/trials",query:{trialId:A,tab:"tasks"}})}async function k(){te.info("Python export not yet implemented")}function P(){a.push("/templates/new")}function R(){a.push("/spreadsheet")}return ne(()=>{S()}),(A,u)=>{const i=Z;return v(),b("div",zs,[t("div",Rs,[t("div",js,[u[1]||(u[1]=t("h1",null,"Create New Trial",-1)),p.value?.currentStep===1?(v(),K(i,{key:0,type:"link",class:"back-button",onClick:c},{default:$(()=>[r(x(me)),u[0]||(u[0]=L(" Back to Select Template "))]),_:1,__:[0]})):O("",!0)]),r(i,{onClick:C},{default:$(()=>u[2]||(u[2]=[L("Cancel")])),_:1,__:[2]})]),t("div",Bs,[r(Vs,{ref_key:"creationContentRef",ref:p,mode:"view","initial-data":I.value,onCancel:C,onCreated:m,onCreatedAndStarted:y,onExportPython:k,onCreateTemplate:P,onCreateSpreadsheet:R},null,8,["initial-data"])])])}}}),an=Y(Fs,[["__scopeId","data-v-38a5dd3b"]]);export{an as default};
