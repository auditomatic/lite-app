const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/jszip.min-IL64wIBN.js","assets/ui-vendor-Cd_RpDPr.js","assets/vue-vendor-DPw1dQYc.js","assets/utils-vendor-CmlljHD3.js","assets/data-vendor-BDABXsBx.js","assets/index-CMsjb5lT.js","assets/index-cTUJCLSS.css"])))=>i.map(i=>d[i]);
var T=Object.defineProperty;var P=(a,e,t)=>e in a?T(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var _=(a,e,t)=>P(a,typeof e!="symbol"?e+"":e,t);import{a as p,_ as g}from"./index-CMsjb5lT.js";import{TrialBundleExportService as S}from"./trial-bundle.service-GGVyvOk1.js";import{k as w}from"./ui-vendor-Cd_RpDPr.js";import{f as h,c as b}from"./vue-vendor-DPw1dQYc.js";import"./utils-vendor-CmlljHD3.js";import"./data-vendor-BDABXsBx.js";let v=null;async function k(){return v||(v=(await g(async()=>{const{default:a}=await import("./jszip.min-IL64wIBN.js").then(e=>e.j);return{default:a}},__vite__mapDeps([0,1,2,3,4]))).default),v}class B{constructor(){_(this,"trialBundleService",new S);_(this,"RUNTIME_VERSION","1.0.0");_(this,"REQUIRED_PACKAGES",["requests>=2.28.0","pandas>=2.0.0","openpyxl>=3.0.0","jsonpath-ng>=1.5.0","pydantic>=2.0.0","click>=8.0.0","rich>=13.0.0","python-dotenv>=1.0.0"])}async exportTrialBundle(e,t={}){try{const r=await this.trialBundleService.exportTrialBundle(e,{includeResults:!1,skipDownload:!0});if(!r.ok)return{ok:!1,error:r.error};const n=r.value.bundle.configuration.trial,{db:u}=await g(async()=>{const{db:f}=await import("./index-CMsjb5lT.js").then(y=>y.v);return{db:f}},__vite__mapDeps([5,2,1,3,4,6])),o=await u.apiCalls.where("trialId").equals(e).toArray(),d=await this.buildTrialConfig(n,o),s=await this.getPythonRuntime(t.runtimeVersion||this.RUNTIME_VERSION),l=await k(),i=new l,c=i.folder("auditomatic_trial");for(const[f,y]of Object.entries(s.package))c.file(f,y);const E=i.folder("data");if(E.file("trial_config.json",JSON.stringify(d,null,2)),t.includeApiKeys){const f=this.getApiKeysTemplate(n);E.file("api_keys.json",JSON.stringify(f,null,2))}i.folder("output"),i.file("requirements.txt",s.requirements),i.file("run.py",s.runScript),i.file("README.md",s.readme);const m=await i.generateAsync({type:"blob"}),I=new Date().toISOString().split("T")[0],R=`${n.name.replace(/[^a-zA-Z0-9-_]/g,"_")}_export_${I}.zip`,A={zipBlob:m,filename:R,sizeBytes:m.size,manifest:{runtimeVersion:this.RUNTIME_VERSION,trialId:n.id,trialName:n.name,apiCallCount:o.length,requiredPackages:this.REQUIRED_PACKAGES}};return Math.round(m.size/1024),o.length,{ok:!0,value:A}}catch(r){return p.error("PYTHON_BUNDLE: Export failed",r),{ok:!1,error:r instanceof Error?r:new Error("Export failed")}}}async buildTrialConfig(e,t){const r=await this.trialBundleService.exportTrialBundle(e.id,{includeResults:!1,skipDownload:!0});if(!r.ok)throw r.error;return{version:"1.0",metadata:{trial_id:e.id,trial_name:e.name,export_date:new Date().toISOString(),runtime_version:this.RUNTIME_VERSION},trial:r.value.bundle.configuration.trial,api_calls:t.map(n=>({id:n.id,order:n.order,trialId:n.trialId,configurationIndex:n.configurationIndex,prompt:n.prompt,variables:n.variables||{},variableIndices:n.variableIndices||{},status:"pending",created:n.created})),api_keys:{}}}async getPythonRuntime(e){return this.loadActualRuntimeFiles(e)}getApiKeysTemplate(e){const t={},r=new Set;for(const n of e.configurations)n.providerSnapshot?.auth?.type!=="none"&&r.add(n.provider);for(const n of r)t[n]="YOUR_API_KEY_HERE";return t}async loadActualRuntimeFiles(e){if(e!=="1.0.0")throw new Error(`Unsupported runtime version: ${e}`);const{getRuntimeFiles:t}=await g(async()=>{const{getRuntimeFiles:r}=await import("./python-runtime-v1.0.0-Csl3nLQv.js");return{getRuntimeFiles:r}},[]);return t()}}function F(){const a=new B,e=h(!1),t=h(0),r=h(null),n=b(()=>e.value?"exporting":r.value?.ok?"success":r.value?.error?"error":"idle");async function u(s,l={}){try{e.value=!0,t.value=0,l.showProgress!==!1&&w.loading({content:"Preparing Python bundle export...",key:"python-export",duration:0}),t.value=30;const i=await a.exportTrialBundle(s,{includeApiKeys:l.includeApiKeys});if(!i.ok)throw i.error;return t.value=70,l.showProgress!==!1&&w.loading({content:"Downloading bundle...",key:"python-export",duration:0}),typeof window<"u"&&(window.__TAURI__||window.__TAURI_INTERNALS__)?await N(i.value.zipBlob,i.value.filename):await x(i.value.zipBlob,i.value.filename),t.value=100,r.value=i,l.showProgress!==!1&&w.success({content:`Python bundle exported successfully! (${Math.round(i.value.sizeBytes/1024)}KB)`,key:"python-export",duration:3}),{ok:!0,value:void 0}}catch(i){p.error("Python bundle export failed:",i);const c=i instanceof Error?i.message:"Export failed";return r.value={ok:!1,error:c},l.showProgress!==!1&&w.error({content:`Export failed: ${c}`,key:"python-export",duration:5}),{ok:!1,error:i instanceof Error?i:new Error(c)}}finally{e.value=!1}}async function o(s){return{estimatedSize:"50-100KB",requiresApiKeys:!0,runtimeVersion:"1.0.0"}}function d(){e.value=!1,t.value=0,r.value=null}return{isExporting:e,exportProgress:t,exportStatus:n,lastExportResult:r,exportPythonBundle:u,getExportInfo:o,resetExportState:d}}async function x(a,e){const t=window.URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(t)}async function N(a,e){try{const t=window.__TAURI__||window.__TAURI_INTERNALS__;if(!t?.dialog?.save||!t?.fs?.writeFile)throw new Error("Tauri dialog or fs API not available");const{save:r}=t.dialog,{writeFile:n}=t.fs,u=await r({defaultPath:e,filters:[{name:"ZIP Archive",extensions:["zip"]}]});if(u){const o=await a.arrayBuffer(),d=new Uint8Array(o);await n(u,d)}}catch(t){p.warn("Tauri save failed, falling back to browser download:",t),await x(a,e)}}export{F as usePythonBundleManagement};
